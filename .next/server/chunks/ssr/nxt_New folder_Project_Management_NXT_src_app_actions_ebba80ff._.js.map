{"version":3,"sources":["../../../../../../../nxt/New%20folder/Project_Management_NXT/src/app/actions/settings.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/app/actions/project-notifications.ts"],"sourcesContent":["\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { unstable_noStore as noStore } from \"next/cache\"\r\nimport bcrypt from \"bcryptjs\"\r\nimport { hasPermissionWithoutRoleBypass } from \"@/lib/rbac-helpers\"\r\n\r\n// Check if user is system administrator\r\nasync function checkAdmin() {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { authorized: false, session: null }\r\n\r\n    const isAuthorized = await hasPermissionWithoutRoleBypass(\r\n        parseInt(session.user.id),\r\n        \"admin.access\"\r\n    )\r\n    return { authorized: isAuthorized, session }\r\n}\r\n\r\n// Get all system settings\r\nexport async function getAllSettings() {\r\n    const { authorized, session } = await checkAdmin()\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized: Only system administrators can access settings\" }\r\n    }\r\n\r\n    try {\r\n        const settings = await prisma.systemSetting.findMany({\r\n            orderBy: [\r\n                { category: \"asc\" },\r\n                { key: \"asc\" }\r\n            ],\r\n            include: {\r\n                updater: {\r\n                    select: {\r\n                        id: true,\r\n                        username: true,\r\n                        email: true\r\n                    }\r\n                }\r\n            }\r\n        })\r\n\r\n        // Group settings by category\r\n        const grouped: Record<string, any[]> = {}\r\n        settings.forEach(setting => {\r\n            if (!grouped[setting.category]) {\r\n                grouped[setting.category] = []\r\n            }\r\n            grouped[setting.category].push({\r\n                id: setting.id,\r\n                key: setting.key,\r\n                value: JSON.parse(setting.value),\r\n                category: setting.category,\r\n                description: setting.description,\r\n                updatedAt: setting.updatedAt,\r\n                updatedBy: setting.updater\r\n            })\r\n        })\r\n\r\n        return { success: true, settings: grouped }\r\n    } catch (e: any) {\r\n        console.error(\"getAllSettings Error:\", e)\r\n        return { error: \"Failed to fetch settings\", details: e.message }\r\n    }\r\n\r\n}\r\n\r\n\r\n// Get public system settings (branding) - No auth required\r\nexport async function getPublicSystemSettings() {\r\n    noStore()\r\n    try {\r\n        const setting = await prisma.systemSetting.findUnique({\r\n            where: { key: \"general\" }\r\n        })\r\n\r\n        if (!setting) {\r\n            return {\r\n                success: true,\r\n                settings: {\r\n                    systemName: \"Qeema PMS\",\r\n                    systemLogo: \"/assets/logo.png\",\r\n                    allowRegistration: true\r\n                }\r\n            }\r\n        }\r\n\r\n        const value = JSON.parse(setting.value)\r\n        return {\r\n            success: true,\r\n            settings: {\r\n                systemName: value.systemName || \"Qeema PMS\",\r\n                systemLogo: value.systemLogo || \"/assets/logo.png\",\r\n                allowRegistration: value.allowRegistration !== undefined ? value.allowRegistration : true\r\n            }\r\n        }\r\n    } catch (e: any) {\r\n        console.error(\"getPublicSystemSettings Error:\", e)\r\n        // Return defaults on error to avoid breaking UI\r\n        return {\r\n            success: true,\r\n            settings: {\r\n                systemName: \"Qeema PMS\",\r\n                systemLogo: \"/assets/logo.png\",\r\n                allowRegistration: true\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// Get a specific setting by key\r\nexport async function getSetting(key: string) {\r\n    const { authorized, session } = await checkAdmin()\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        const setting = await prisma.systemSetting.findUnique({\r\n            where: { key },\r\n            include: {\r\n                updater: {\r\n                    select: {\r\n                        id: true,\r\n                        username: true,\r\n                        email: true\r\n                    }\r\n                }\r\n            }\r\n        })\r\n\r\n        if (!setting) {\r\n            return { error: \"Setting not found\" }\r\n        }\r\n\r\n        return {\r\n            success: true,\r\n            setting: {\r\n                id: setting.id,\r\n                key: setting.key,\r\n                value: JSON.parse(setting.value),\r\n                category: setting.category,\r\n                description: setting.description,\r\n                updatedAt: setting.updatedAt,\r\n                updatedBy: setting.updater\r\n            }\r\n        }\r\n    } catch (e: any) {\r\n        console.error(\"getSetting Error:\", e)\r\n        return { error: \"Failed to fetch setting\", details: e.message }\r\n    }\r\n}\r\n\r\n// Update a system setting\r\nexport async function updateSetting(\r\n    key: string,\r\n    value: any,\r\n    reason?: string,\r\n    category?: string // Optional category for auto-creation\r\n) {\r\n    const { authorized, session } = await checkAdmin()\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        // Get existing setting\r\n        const existing = await prisma.systemSetting.findUnique({\r\n            where: { key }\r\n        })\r\n\r\n        if (!existing) {\r\n            if (category) {\r\n                // Auto-create if category is provided\r\n                return await createSetting(key, category, value, \"Auto-created via update\")\r\n            }\r\n            return { error: \"Setting not found\" }\r\n        }\r\n\r\n        const oldValue = existing.value\r\n        const newValue = JSON.stringify(value)\r\n\r\n        // Update setting\r\n        const updated = await prisma.systemSetting.update({\r\n            where: { key },\r\n            data: {\r\n                value: newValue,\r\n                updatedBy: parseInt(session.user.id)\r\n            }\r\n        })\r\n\r\n        // Log the change\r\n        await prisma.settingsChangeLog.create({\r\n            data: {\r\n                settingKey: key,\r\n                oldValue: oldValue,\r\n                newValue: newValue,\r\n                reason: reason || null,\r\n                userId: parseInt(session.user.id),\r\n                settingId: updated.id\r\n            }\r\n        })\r\n\r\n        revalidatePath(\"/\", \"layout\")\r\n        return { success: true, setting: updated }\r\n    } catch (e: any) {\r\n        console.error(\"updateSetting Error:\", e)\r\n        return { error: \"Failed to update setting\", details: e.message }\r\n    }\r\n}\r\n\r\n// Create a new system setting\r\nexport async function createSetting(\r\n    key: string,\r\n    category: string,\r\n    value: any,\r\n    description?: string\r\n) {\r\n    const { authorized, session } = await checkAdmin()\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        // Check if setting already exists\r\n        const existing = await prisma.systemSetting.findUnique({\r\n            where: { key }\r\n        })\r\n\r\n        if (existing) {\r\n            return { error: \"Setting with this key already exists\" }\r\n        }\r\n\r\n        const newSetting = await prisma.systemSetting.create({\r\n            data: {\r\n                key,\r\n                category,\r\n                value: JSON.stringify(value),\r\n                description: description || null,\r\n                updatedBy: parseInt(session.user.id)\r\n            }\r\n        })\r\n\r\n        // Log the creation\r\n        await prisma.settingsChangeLog.create({\r\n            data: {\r\n                settingKey: key,\r\n                oldValue: null,\r\n                newValue: JSON.stringify(value),\r\n                reason: \"Setting created\",\r\n                userId: parseInt(session.user.id),\r\n                settingId: newSetting.id\r\n            }\r\n        })\r\n\r\n        revalidatePath(\"/dashboard/settings\")\r\n        return { success: true, setting: newSetting }\r\n    } catch (e: any) {\r\n        console.error(\"createSetting Error:\", e)\r\n        return { error: \"Failed to create setting\", details: e.message }\r\n    }\r\n}\r\n\r\n// Get settings change log\r\nexport async function getSettingsChangeLog(\r\n    settingKey?: string,\r\n    limit: number = 50,\r\n    offset: number = 0\r\n) {\r\n    const { authorized, session } = await checkAdmin()\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        const where = settingKey ? { settingKey } : {}\r\n\r\n        const logs = await prisma.settingsChangeLog.findMany({\r\n            where,\r\n            include: {\r\n                user: {\r\n                    select: {\r\n                        id: true,\r\n                        username: true,\r\n                        email: true\r\n                    }\r\n                },\r\n                setting: {\r\n                    select: {\r\n                        key: true,\r\n                        category: true\r\n                    }\r\n                }\r\n            },\r\n            orderBy: { createdAt: \"desc\" },\r\n            take: limit,\r\n            skip: offset\r\n        })\r\n\r\n        const total = await prisma.settingsChangeLog.count({ where })\r\n\r\n        return {\r\n            success: true,\r\n            logs: logs.map(log => ({\r\n                id: log.id,\r\n                settingKey: log.settingKey,\r\n                category: log.setting?.category,\r\n                oldValue: log.oldValue ? JSON.parse(log.oldValue) : null,\r\n                newValue: JSON.parse(log.newValue),\r\n                reason: log.reason,\r\n                changedBy: log.user,\r\n                createdAt: log.createdAt\r\n            })),\r\n            total,\r\n            limit,\r\n            offset\r\n        }\r\n    } catch (e: any) {\r\n        console.error(\"getSettingsChangeLog Error:\", e)\r\n        return { error: \"Failed to fetch change log\", details: e.message }\r\n    }\r\n}\r\n\r\n// Initialize default settings (run once on system setup)\r\nexport async function initializeDefaultSettings() {\r\n    const { authorized, session } = await checkAdmin()\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        const defaultSettings = [\r\n            {\r\n                key: \"general\",\r\n                category: \"general\",\r\n                value: {\r\n                    systemName: \"Project Management System\",\r\n                    systemLogo: \"/assets/logo.png\",\r\n                    defaultLanguage: \"en\",\r\n                    defaultTimezone: \"UTC\",\r\n                    workingDays: [1, 2, 3, 4, 5], // Monday to Friday\r\n                    defaultWorkingHours: {\r\n                        start: \"09:00\",\r\n                        end: \"17:00\"\r\n                    }\r\n                },\r\n                description: \"General system settings\"\r\n            },\r\n            {\r\n                key: \"tasks\",\r\n                category: \"tasks\",\r\n                value: {\r\n                    statuses: [\r\n                        {\r\n                            id: 1,\r\n                            name: \"Pending\",\r\n                            key: \"pending\",\r\n                            order: 1,\r\n                            color: \"#fbbf24\",\r\n                            isFinal: false,\r\n                            isDefault: true\r\n                        },\r\n                        {\r\n                            id: 2,\r\n                            name: \"Waiting\",\r\n                            key: \"waiting\",\r\n                            order: 2,\r\n                            color: \"#f97316\",\r\n                            isFinal: false,\r\n                            isDefault: false\r\n                        },\r\n                        {\r\n                            id: 3,\r\n                            name: \"In Progress\",\r\n                            key: \"in_progress\",\r\n                            order: 3,\r\n                            color: \"#3b82f6\",\r\n                            isFinal: false,\r\n                            isDefault: false\r\n                        },\r\n                        {\r\n                            id: 4,\r\n                            name: \"Review\",\r\n                            key: \"review\",\r\n                            order: 4,\r\n                            color: \"#a855f7\",\r\n                            isFinal: false,\r\n                            isDefault: false\r\n                        },\r\n                        {\r\n                            id: 5,\r\n                            name: \"Completed\",\r\n                            key: \"completed\",\r\n                            order: 5,\r\n                            color: \"#10b981\",\r\n                            isFinal: true,\r\n                            isDefault: false\r\n                        }\r\n                    ],\r\n                    priorities: [\r\n                        {\r\n                            id: 1,\r\n                            name: \"Low\",\r\n                            key: \"low\",\r\n                            weight: 1,\r\n                            color: \"#6b7280\",\r\n                            isDefault: false\r\n                        },\r\n                        {\r\n                            id: 2,\r\n                            name: \"Normal\",\r\n                            key: \"normal\",\r\n                            weight: 2,\r\n                            color: \"#3b82f6\",\r\n                            isDefault: true\r\n                        },\r\n                        {\r\n                            id: 3,\r\n                            name: \"High\",\r\n                            key: \"high\",\r\n                            weight: 3,\r\n                            color: \"#f59e0b\",\r\n                            isDefault: false\r\n                        },\r\n                        {\r\n                            id: 4,\r\n                            name: \"Urgent\",\r\n                            key: \"urgent\",\r\n                            weight: 4,\r\n                            color: \"#ef4444\",\r\n                            isDefault: false\r\n                        }\r\n                    ]\r\n                },\r\n                description: \"Task statuses and priority levels\"\r\n            },\r\n            {\r\n                key: \"today_tasks\",\r\n                category: \"today_tasks\",\r\n                value: {\r\n                    dailyResetTime: \"00:00\",\r\n                    resetTimezoneSource: \"system\",\r\n                    autoCarryOver: true,\r\n                    carryOverRules: {\r\n                        excludeBlocked: true,\r\n                        incompleteOnly: true,\r\n                        maxDays: 7\r\n                    },\r\n                    adminOverridePermissions: true\r\n                },\r\n                description: \"Today's Tasks configuration\"\r\n            },\r\n            {\r\n                key: \"dependencies\",\r\n                category: \"dependencies\",\r\n                value: {\r\n                    allowMultipleDependencies: true,\r\n                    allowCrossTeamDependencies: true,\r\n                    allowCrossProjectDependencies: false,\r\n                    autoBlockTasks: true,\r\n                    allowAdminManualUnblock: true\r\n                },\r\n                description: \"Task dependency rules\"\r\n            },\r\n            {\r\n                key: \"permissions\",\r\n                category: \"permissions\",\r\n                value: {\r\n                    admin: {\r\n                        taskCreation: true,\r\n                        taskAssignment: true,\r\n                        todayTasksManagement: true,\r\n                        dependencyManagement: true,\r\n                        projectCreation: true,\r\n                        userManagement: true\r\n                    },\r\n                    team_lead: {\r\n                        taskCreation: true,\r\n                        taskAssignment: true,\r\n                        todayTasksManagement: true,\r\n                        dependencyManagement: true,\r\n                        projectCreation: false,\r\n                        userManagement: false\r\n                    },\r\n                    developer: {\r\n                        taskCreation: false,\r\n                        taskAssignment: false,\r\n                        todayTasksManagement: false,\r\n                        dependencyManagement: false,\r\n                        projectCreation: false,\r\n                        userManagement: false\r\n                    }\r\n                },\r\n                description: \"Default permissions by role\"\r\n            },\r\n            {\r\n                key: \"notifications\",\r\n                category: \"notifications\",\r\n                value: {\r\n                    notifyOnTodayTaskAssignment: true,\r\n                    notifyOnTaskBlocked: true,\r\n                    notifyOnDependencyCompleted: true,\r\n                    notifyOnTaskOverdue: true,\r\n                    notifyOnStatusChange: false\r\n                },\r\n                description: \"System-wide notification preferences\"\r\n            },\r\n            {\r\n                key: \"audit\",\r\n                category: \"audit\",\r\n                value: {\r\n                    enableSettingsChangeLogs: true,\r\n                    enableOverrideLogs: true,\r\n                    logRetentionPolicy: {\r\n                        retentionDays: 365,\r\n                        archiveAfterDays: 90,\r\n                        maxLogSizeMB: 100\r\n                    }\r\n                },\r\n                description: \"Audit and logging configuration\"\r\n            }\r\n        ]\r\n\r\n        const created = []\r\n        for (const setting of defaultSettings) {\r\n            const existing = await prisma.systemSetting.findUnique({\r\n                where: { key: setting.key }\r\n            })\r\n\r\n            if (!existing) {\r\n                const newSetting = await prisma.systemSetting.create({\r\n                    data: {\r\n                        key: setting.key,\r\n                        category: setting.category,\r\n                        value: JSON.stringify(setting.value),\r\n                        description: setting.description,\r\n                        updatedBy: parseInt(session.user.id)\r\n                    }\r\n                })\r\n                created.push(newSetting)\r\n            }\r\n        }\r\n\r\n        return { success: true, created: created.length, message: `Initialized ${created.length} default settings` }\r\n    } catch (e: any) {\r\n        console.error(\"initializeDefaultSettings Error:\", e)\r\n        return { error: \"Failed to initialize settings\", details: e.message }\r\n    }\r\n}\r\n\r\n// Update user profile\r\nexport async function updateProfile(formData: FormData) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        const username = formData.get(\"username\") as string\r\n        const email = formData.get(\"email\") as string\r\n\r\n        if (!username || !email) {\r\n            return { error: \"Username and email are required\" }\r\n        }\r\n\r\n        const userId = parseInt(session.user.id)\r\n\r\n        // Check if username or email is already taken by another user\r\n        const existingUser = await prisma.user.findFirst({\r\n            where: {\r\n                AND: [\r\n                    { id: { not: userId } },\r\n                    {\r\n                        OR: [\r\n                            { username },\r\n                            { email }\r\n                        ]\r\n                    }\r\n                ]\r\n            }\r\n        })\r\n\r\n        if (existingUser) {\r\n            return { error: \"Username or email already taken\" }\r\n        }\r\n\r\n        // Update user profile\r\n        await prisma.user.update({\r\n            where: { id: userId },\r\n            data: {\r\n                username,\r\n                email\r\n            }\r\n        })\r\n\r\n        // Log activity\r\n        try {\r\n            await prisma.activityLog.create({\r\n                data: {\r\n                    userId: userId,\r\n                    action: \"update_profile\",\r\n                    description: \"User updated their profile\",\r\n                    entityType: \"user\",\r\n                    entityId: userId\r\n                }\r\n            })\r\n        } catch (logError) {\r\n            console.error(\"Failed to log activity:\", logError)\r\n            // Don't fail the operation if logging fails\r\n        }\r\n\r\n        revalidatePath(\"/dashboard/settings\")\r\n        return { success: true, message: \"Profile updated successfully\" }\r\n    } catch (e: any) {\r\n        console.error(\"updateProfile Error:\", e)\r\n        return { error: \"Failed to update profile\", details: e.message }\r\n    }\r\n}\r\n\r\n// Change user password\r\nexport async function changePassword(formData: FormData) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        const currentPassword = formData.get(\"currentPassword\") as string\r\n        const newPassword = formData.get(\"newPassword\") as string\r\n\r\n        if (!currentPassword || !newPassword) {\r\n            return { error: \"Current password and new password are required\" }\r\n        }\r\n\r\n        if (newPassword.length < 6) {\r\n            return { error: \"New password must be at least 6 characters long\" }\r\n        }\r\n\r\n        const userId = parseInt(session.user.id)\r\n\r\n        // Get user with password hash\r\n        const user = await prisma.user.findUnique({\r\n            where: { id: userId },\r\n            select: { id: true, passwordHash: true }\r\n        })\r\n\r\n        if (!user) {\r\n            return { error: \"User not found\" }\r\n        }\r\n\r\n        // Verify current password\r\n        const isValidPassword = await bcrypt.compare(currentPassword, user.passwordHash)\r\n        if (!isValidPassword) {\r\n            return { error: \"Current password is incorrect\" }\r\n        }\r\n\r\n        // Hash new password\r\n        const hashedPassword = await bcrypt.hash(newPassword, 10)\r\n\r\n        // Update password\r\n        await prisma.user.update({\r\n            where: { id: userId },\r\n            data: { passwordHash: hashedPassword }\r\n        })\r\n\r\n        // Log activity\r\n        try {\r\n            await prisma.activityLog.create({\r\n                data: {\r\n                    userId: userId,\r\n                    action: \"change_password\",\r\n                    description: \"User changed their password\",\r\n                    entityType: \"user\",\r\n                    entityId: userId\r\n                }\r\n            })\r\n        } catch (logError) {\r\n            console.error(\"Failed to log activity:\", logError)\r\n            // Don't fail the operation if logging fails\r\n        }\r\n\r\n        return { success: true, message: \"Password changed successfully\" }\r\n    } catch (e: any) {\r\n        console.error(\"changePassword Error:\", e)\r\n        return { error: \"Failed to change password\", details: e.message }\r\n    }\r\n}\r\n","\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport { revalidatePath } from \"next/cache\"\r\n\r\n// Get all notifications for a project (paginated)\r\nexport async function getProjectNotifications(\r\n  projectId: number,\r\n  filters?: {\r\n    type?: string\r\n    isRead?: boolean\r\n    limit?: number\r\n    offset?: number\r\n  }\r\n) {\r\n  try {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session?.user?.id) {\r\n      return { success: false, error: \"Unauthorized\" }\r\n    }\r\n\r\n    const userId = parseInt(session.user.id)\r\n\r\n    // Verify user has access to the project\r\n    const projectUser = await prisma.projectUser.findFirst({\r\n      where: {\r\n        projectId,\r\n        userId,\r\n        leftAt: null, // User is still active in the project\r\n      },\r\n    })\r\n\r\n    if (!projectUser) {\r\n      return { success: false, error: \"Access denied to this project\" }\r\n    }\r\n\r\n    const limit = filters?.limit || 20\r\n    const offset = filters?.offset || 0\r\n\r\n    const where: any = {\r\n      projectId,\r\n      userId,\r\n    }\r\n\r\n    if (filters?.type) {\r\n      where.type = filters.type\r\n    }\r\n\r\n    if (filters?.isRead !== undefined) {\r\n      where.isRead = filters.isRead\r\n    }\r\n\r\n    const [notifications, total] = await Promise.all([\r\n      prisma.projectNotification.findMany({\r\n        where,\r\n        orderBy: [\r\n          { isUrgent: \"desc\" },\r\n          { requiresAcknowledgment: \"desc\" },\r\n          { createdAt: \"desc\" }\r\n        ],\r\n        take: limit,\r\n        skip: offset,\r\n      }),\r\n      prisma.projectNotification.count({ where }),\r\n    ])\r\n\r\n    return {\r\n      success: true,\r\n      notifications,\r\n      total,\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error fetching project notifications:\", error)\r\n    return { success: false, error: \"Failed to fetch notifications\" }\r\n  }\r\n}\r\n\r\n// Get total unread notification count across all projects for a user\r\nexport async function getAllProjectsUnreadNotificationCount() {\r\n  try {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session?.user?.id) {\r\n      return { success: false, error: \"Unauthorized\" }\r\n    }\r\n\r\n    const userId = parseInt(session.user.id)\r\n\r\n    // Get all projects the user is part of OR has tasks assigned to\r\n    const projectUsers = await prisma.projectUser.findMany({\r\n      where: {\r\n        userId,\r\n        leftAt: null,\r\n      },\r\n      select: { projectId: true },\r\n    })\r\n\r\n    // Also get projects where user has assigned tasks\r\n    let tasksWithProjects: { projectId: number }[] = []\r\n    try {\r\n      tasksWithProjects = await prisma.task.findMany({\r\n        where: {\r\n          assignees: {\r\n            some: { id: userId }\r\n          }\r\n        },\r\n        select: {\r\n          projectId: true\r\n        }\r\n      })\r\n    } catch (error: any) {\r\n      // If task model is not available, just use projectUsers\r\n      console.warn(\"[Notifications] Could not fetch tasks, using only ProjectUser:\", error?.message)\r\n      tasksWithProjects = []\r\n    }\r\n\r\n    const projectIdsFromUsers = projectUsers.map((pu) => pu.projectId)\r\n    const projectIdsFromTasks = tasksWithProjects.map(t => t.projectId)\r\n    // Remove duplicates using Set\r\n    const allProjectIds = [...new Set([...projectIdsFromUsers, ...projectIdsFromTasks])]\r\n\r\n    if (allProjectIds.length === 0) {\r\n      return { success: true, count: 0 }\r\n    }\r\n\r\n    let count = 0\r\n    try {\r\n      count = await prisma.projectNotification.count({\r\n        where: {\r\n          projectId: { in: allProjectIds },\r\n          userId,\r\n          isRead: false,\r\n        },\r\n      })\r\n    } catch (error: any) {\r\n      // If ProjectNotification model is not available, return 0\r\n      console.error(\"[Notifications] ProjectNotification model not available. Please run 'npx prisma generate':\", error?.message)\r\n      return { success: true, count: 0 }\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      count,\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"Error fetching all projects unread count:\", error)\r\n    console.error(\"Error details:\", {\r\n      message: error?.message,\r\n      stack: error?.stack,\r\n      name: error?.name\r\n    })\r\n    return {\r\n      success: false,\r\n      error: error?.message || \"Failed to fetch unread count\",\r\n      details: error?.stack\r\n    }\r\n  }\r\n}\r\n\r\n// Get recent notifications across all projects for a user\r\nexport async function getAllProjectsNotifications(limit: number = 15) {\r\n  try {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session?.user?.id) {\r\n      return { success: false, error: \"Unauthorized\" }\r\n    }\r\n\r\n    const userId = parseInt(session.user.id)\r\n\r\n    // Get all projects the user is part of OR has tasks assigned to\r\n    const projectUsers = await prisma.projectUser.findMany({\r\n      where: {\r\n        userId,\r\n        leftAt: null,\r\n      },\r\n      select: { projectId: true },\r\n    })\r\n\r\n    // Also get projects where user has assigned tasks\r\n    let tasksWithProjects: { projectId: number }[] = []\r\n    try {\r\n      tasksWithProjects = await prisma.task.findMany({\r\n        where: {\r\n          assignees: {\r\n            some: { id: userId }\r\n          }\r\n        },\r\n        select: {\r\n          projectId: true\r\n        }\r\n      })\r\n    } catch (error: any) {\r\n      // If task model is not available, just use projectUsers\r\n      console.warn(\"[Notifications] Could not fetch tasks, using only ProjectUser:\", error?.message)\r\n      tasksWithProjects = []\r\n    }\r\n\r\n    const projectIdsFromUsers = projectUsers.map((pu) => pu.projectId)\r\n    const projectIdsFromTasks = tasksWithProjects.map(t => t.projectId)\r\n    // Remove duplicates using Set\r\n    const allProjectIds = [...new Set([...projectIdsFromUsers, ...projectIdsFromTasks])]\r\n\r\n    console.log(`[Notifications] User ${userId} has access to projects:`, allProjectIds)\r\n\r\n    if (allProjectIds.length === 0) {\r\n      console.log(`[Notifications] No projects found for user ${userId}`)\r\n      return { success: true, notifications: [] }\r\n    }\r\n\r\n    // Check if ProjectNotification model exists\r\n    if (!prisma.projectNotification) {\r\n      console.error(\"[Notifications] ProjectNotification model not found. Please run 'npx prisma generate'\")\r\n      return { success: true, notifications: [] }\r\n    }\r\n\r\n    let notifications: any[] = []\r\n    try {\r\n      notifications = await prisma.projectNotification.findMany({\r\n        where: {\r\n          projectId: { in: allProjectIds },\r\n          userId,\r\n        },\r\n        include: {\r\n          project: {\r\n            select: { id: true, name: true },\r\n          },\r\n        },\r\n        orderBy: { createdAt: \"desc\" },\r\n        take: limit,\r\n      })\r\n    } catch (error: any) {\r\n      // If ProjectNotification model is not available, return empty array\r\n      console.error(\"[Notifications] Error accessing ProjectNotification model. Please run 'npx prisma generate':\", error?.message)\r\n      return { success: true, notifications: [] }\r\n    }\r\n\r\n    console.log(`[Notifications] Found ${notifications.length} notifications for user ${userId}`)\r\n\r\n    return {\r\n      success: true,\r\n      notifications,\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"Error fetching all projects notifications:\", error)\r\n    console.error(\"Error details:\", {\r\n      message: error?.message,\r\n      stack: error?.stack,\r\n      name: error?.name\r\n    })\r\n    return {\r\n      success: false,\r\n      error: error?.message || \"Failed to fetch notifications\",\r\n      details: error?.stack\r\n    }\r\n  }\r\n}\r\n\r\n// Get unread notification count for a project\r\nexport async function getProjectUnreadNotificationCount(projectId: number) {\r\n  try {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session?.user?.id) {\r\n      return { success: false, error: \"Unauthorized\" }\r\n    }\r\n\r\n    const userId = parseInt(session.user.id)\r\n\r\n    // Verify user has access to the project\r\n    const projectUser = await prisma.projectUser.findFirst({\r\n      where: {\r\n        projectId,\r\n        userId,\r\n        leftAt: null,\r\n      },\r\n    })\r\n\r\n    if (!projectUser) {\r\n      return { success: false, error: \"Access denied to this project\" }\r\n    }\r\n\r\n    const count = await prisma.projectNotification.count({\r\n      where: {\r\n        projectId,\r\n        userId,\r\n        isRead: false,\r\n      },\r\n    })\r\n\r\n    return {\r\n      success: true,\r\n      count,\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error fetching unread count:\", error)\r\n    return { success: false, error: \"Failed to fetch unread count\" }\r\n  }\r\n}\r\n\r\n// Mark a notification as read\r\nexport async function markProjectNotificationAsRead(\r\n  projectId: number,\r\n  notificationId: number\r\n) {\r\n  try {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session?.user?.id) {\r\n      return { success: false, error: \"Unauthorized\" }\r\n    }\r\n\r\n    const userId = parseInt(session.user.id)\r\n\r\n    // Verify notification belongs to user and project\r\n    const notification = await prisma.projectNotification.findFirst({\r\n      where: {\r\n        id: notificationId,\r\n        projectId,\r\n        userId,\r\n      },\r\n    })\r\n\r\n    if (!notification) {\r\n      return { success: false, error: \"Notification not found\" }\r\n    }\r\n\r\n    // Prevent marking urgent notifications that require acknowledgment as read\r\n    // They can only be marked as read after acknowledgment\r\n    if (notification.isUrgent && notification.requiresAcknowledgment && !notification.acknowledgedAt) {\r\n      return {\r\n        success: false,\r\n        error: \"Urgent notifications cannot be marked as read until acknowledged. Please acknowledge the urgent project first.\"\r\n      }\r\n    }\r\n\r\n    await prisma.projectNotification.update({\r\n      where: { id: notificationId },\r\n      data: { isRead: true },\r\n    })\r\n\r\n    revalidatePath(`/dashboard/projects/${projectId}`)\r\n    revalidatePath(`/dashboard/projects/${projectId}/notifications`)\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"Error marking notification as read:\", error)\r\n    return { success: false, error: \"Failed to mark notification as read\" }\r\n  }\r\n}\r\n\r\n// Mark all project notifications as read\r\nexport async function markAllProjectNotificationsAsRead(projectId: number) {\r\n  try {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session?.user?.id) {\r\n      return { success: false, error: \"Unauthorized\" }\r\n    }\r\n\r\n    const userId = parseInt(session.user.id)\r\n\r\n    // Verify user has access to the project\r\n    const projectUser = await prisma.projectUser.findFirst({\r\n      where: {\r\n        projectId,\r\n        userId,\r\n        leftAt: null,\r\n      },\r\n    })\r\n\r\n    if (!projectUser) {\r\n      return { success: false, error: \"Access denied to this project\" }\r\n    }\r\n\r\n    // Don't mark urgent notifications that require acknowledgment as read\r\n    await prisma.projectNotification.updateMany({\r\n      where: {\r\n        projectId,\r\n        userId,\r\n        isRead: false,\r\n        OR: [\r\n          { isUrgent: false },\r\n          { requiresAcknowledgment: false },\r\n          { acknowledgedAt: { not: null } }\r\n        ]\r\n      },\r\n      data: {\r\n        isRead: true,\r\n      },\r\n    })\r\n\r\n    revalidatePath(`/dashboard/projects/${projectId}`)\r\n    revalidatePath(`/dashboard/projects/${projectId}/notifications`)\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"Error marking all notifications as read:\", error)\r\n    return { success: false, error: \"Failed to mark all notifications as read\" }\r\n  }\r\n}\r\n\r\n// Get user's notification preferences for a project\r\nexport async function getProjectNotificationPreferences(projectId: number) {\r\n  try {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session?.user?.id) {\r\n      return { success: false, error: \"Unauthorized\" }\r\n    }\r\n\r\n    const userId = parseInt(session.user.id)\r\n\r\n    // Verify user has access to the project\r\n    const projectUser = await prisma.projectUser.findFirst({\r\n      where: {\r\n        projectId,\r\n        userId,\r\n        leftAt: null,\r\n      },\r\n    })\r\n\r\n    if (!projectUser) {\r\n      return { success: false, error: \"Access denied to this project\" }\r\n    }\r\n\r\n    let preferences = await prisma.projectNotificationPreference.findUnique({\r\n      where: {\r\n        projectId_userId: {\r\n          projectId,\r\n          userId,\r\n        },\r\n      },\r\n    })\r\n\r\n    // Create default preferences if they don't exist\r\n    if (!preferences) {\r\n      preferences = await prisma.projectNotificationPreference.create({\r\n        data: {\r\n          projectId,\r\n          userId,\r\n          soundEnabled: true,\r\n          taskNotifications: true,\r\n          dependencyNotifications: true,\r\n          todayTaskNotifications: true,\r\n          projectAdminNotifications: true,\r\n        },\r\n      })\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      preferences,\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error fetching notification preferences:\", error)\r\n    return { success: false, error: \"Failed to fetch preferences\" }\r\n  }\r\n}\r\n\r\n// Update user's notification preferences for a project\r\nexport async function updateProjectNotificationPreferences(\r\n  projectId: number,\r\n  preferences: {\r\n    soundEnabled?: boolean\r\n    taskNotifications?: boolean\r\n    dependencyNotifications?: boolean\r\n    todayTaskNotifications?: boolean\r\n    projectAdminNotifications?: boolean\r\n  }\r\n) {\r\n  try {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session?.user?.id) {\r\n      return { success: false, error: \"Unauthorized\" }\r\n    }\r\n\r\n    const userId = parseInt(session.user.id)\r\n\r\n    // Verify user has access to the project\r\n    const projectUser = await prisma.projectUser.findFirst({\r\n      where: {\r\n        projectId,\r\n        userId,\r\n        leftAt: null,\r\n      },\r\n    })\r\n\r\n    if (!projectUser) {\r\n      return { success: false, error: \"Access denied to this project\" }\r\n    }\r\n\r\n    await prisma.projectNotificationPreference.upsert({\r\n      where: {\r\n        projectId_userId: {\r\n          projectId,\r\n          userId,\r\n        },\r\n      },\r\n      create: {\r\n        projectId,\r\n        userId,\r\n        soundEnabled: preferences.soundEnabled ?? true,\r\n        taskNotifications: preferences.taskNotifications ?? true,\r\n        dependencyNotifications: preferences.dependencyNotifications ?? true,\r\n        todayTaskNotifications: preferences.todayTaskNotifications ?? true,\r\n        projectAdminNotifications: preferences.projectAdminNotifications ?? true,\r\n      },\r\n      update: preferences,\r\n    })\r\n\r\n    revalidatePath(`/dashboard/projects/${projectId}/notifications`)\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"Error updating notification preferences:\", error)\r\n    return { success: false, error: \"Failed to update preferences\" }\r\n  }\r\n}\r\n\r\n// Create a project notification (internal use)\r\nexport async function createProjectNotification(\r\n  projectId: number,\r\n  userId: number,\r\n  options: {\r\n    type: string\r\n    entityType: string\r\n    entityId: number | null\r\n    title: string\r\n    message: string\r\n    soundRequired?: boolean\r\n    isUrgent?: boolean\r\n    requiresAcknowledgment?: boolean\r\n  }\r\n) {\r\n  const {\r\n    type,\r\n    entityType,\r\n    entityId,\r\n    title,\r\n    message,\r\n    soundRequired = false,\r\n    isUrgent = false,\r\n    requiresAcknowledgment = false\r\n  } = options\r\n  try {\r\n    // Verify user is part of the project OR assigned to a task in the project\r\n    let projectUser = await prisma.projectUser.findFirst({\r\n      where: {\r\n        projectId,\r\n        userId,\r\n        leftAt: null,\r\n      },\r\n    })\r\n\r\n    // If user is not in ProjectUser, check if they're assigned to a task in this project\r\n    if (!projectUser && (entityType === \"task\" || entityType === \"comment_mention\") && entityId) {\r\n      const task = await prisma.task.findFirst({\r\n        where: {\r\n          id: entityId,\r\n          projectId,\r\n          assignees: {\r\n            some: { id: userId }\r\n          }\r\n        }\r\n      })\r\n\r\n      if (task) {\r\n        // User is assigned to a task in this project, so they should receive notifications\r\n        // Optionally, we could auto-add them to ProjectUser here, but for now we'll just allow the notification\r\n        projectUser = null // We'll allow notification even without ProjectUser entry\r\n      } else {\r\n        // User is not assigned to this task and not in project\r\n        return { success: false, error: \"User not in project or assigned to task\" }\r\n      }\r\n    } else if (!projectUser && entityType === \"comment\" && entityId) {\r\n      // For comments, check if user is assigned to the task the comment is on\r\n      const comment = await prisma.comment.findUnique({\r\n        where: { id: entityId },\r\n        select: { taskId: true }\r\n      })\r\n\r\n      if (comment && comment.taskId) {\r\n        const task = await prisma.task.findFirst({\r\n          where: {\r\n            id: comment.taskId,\r\n            projectId,\r\n            assignees: {\r\n              some: { id: userId }\r\n            }\r\n          }\r\n        })\r\n\r\n        if (task) {\r\n          projectUser = null // Allow notification\r\n        } else {\r\n          return { success: false, error: \"User not assigned to the task related to this comment\" }\r\n        }\r\n      } else {\r\n        return { success: false, error: \"Comment or related task not found\" }\r\n      }\r\n    } else if (!projectUser) {\r\n      // For non-task/non-comment notifications, user must be in ProjectUser\r\n      return { success: false, error: \"User not in project\" }\r\n    }\r\n\r\n    // Check user's notification preferences\r\n    const preferences = await prisma.projectNotificationPreference.findUnique({\r\n      where: {\r\n        projectId_userId: {\r\n          projectId,\r\n          userId,\r\n        },\r\n      },\r\n    })\r\n\r\n    // Determine if notification should be created based on preferences\r\n    let shouldNotify = true\r\n\r\n    if (!soundRequired) {\r\n      // Non-critical notifications respect user preferences\r\n      switch (type) {\r\n        case \"task\":\r\n          if (preferences && !preferences.taskNotifications) {\r\n            shouldNotify = false\r\n          }\r\n          break\r\n        case \"dependency\":\r\n          if (preferences && !preferences.dependencyNotifications) {\r\n            shouldNotify = false\r\n          }\r\n          break\r\n        case \"today_task\":\r\n          if (preferences && !preferences.todayTaskNotifications) {\r\n            shouldNotify = false\r\n          }\r\n          break\r\n        case \"project_admin\":\r\n          if (preferences && !preferences.projectAdminNotifications) {\r\n            shouldNotify = false\r\n          }\r\n          break\r\n      }\r\n    }\r\n    // Critical notifications (soundRequired = true) always notify\r\n\r\n    if (!shouldNotify) {\r\n      return { success: true, skipped: true }\r\n    }\r\n\r\n    const notification = await prisma.projectNotification.create({\r\n      data: {\r\n        projectId,\r\n        userId,\r\n        type,\r\n        entityType,\r\n        entityId,\r\n        title,\r\n        message,\r\n        soundRequired,\r\n        isUrgent,\r\n        requiresAcknowledgment,\r\n      },\r\n    })\r\n\r\n    console.log(`[Notifications] Created notification for user ${userId} in project ${projectId}:`, {\r\n      id: notification.id,\r\n      type,\r\n      title,\r\n      soundRequired\r\n    })\r\n\r\n    // Revalidate project pages\r\n    revalidatePath(`/dashboard/projects/${projectId}`)\r\n    revalidatePath(`/dashboard/projects/${projectId}/notifications`)\r\n\r\n    return {\r\n      success: true,\r\n      notification,\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error creating project notification:\", error)\r\n    return { success: false, error: \"Failed to create notification\" }\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}