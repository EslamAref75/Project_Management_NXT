module.exports=[153544,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(449597);async function g(a,b){try{let f=await (0,d.getServerSession)(e.authOptions);if(!f?.user?.id)return{success:!1,error:"Unauthorized"};let g=parseInt(f.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:g,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let h=b?.limit||20,i=b?.offset||0,j={projectId:a,userId:g};b?.type&&(j.type=b.type),b?.isRead!==void 0&&(j.isRead=b.isRead);let[k,l]=await Promise.all([c.prisma.projectNotification.findMany({where:j,orderBy:[{isUrgent:"desc"},{requiresAcknowledgment:"desc"},{createdAt:"desc"}],take:h,skip:i}),c.prisma.projectNotification.count({where:j})]);return{success:!0,notifications:k,total:l}}catch(a){return console.error("Error fetching project notifications:",a),{success:!1,error:"Failed to fetch notifications"}}}async function h(){try{let a=await (0,d.getServerSession)(e.authOptions);if(!a?.user?.id)return{success:!1,error:"Unauthorized"};let b=parseInt(a.user.id),f=await c.prisma.projectUser.findMany({where:{userId:b,leftAt:null},select:{projectId:!0}}),g=[];try{g=await c.prisma.task.findMany({where:{assignees:{some:{id:b}}},select:{projectId:!0}})}catch(a){console.warn("[Notifications] Could not fetch tasks, using only ProjectUser:",a?.message),g=[]}let h=f.map(a=>a.projectId),i=g.map(a=>a.projectId),j=[...new Set([...h,...i])];if(0===j.length)return{success:!0,count:0};let k=0;try{k=await c.prisma.projectNotification.count({where:{projectId:{in:j},userId:b,isRead:!1}})}catch(a){return console.error("[Notifications] ProjectNotification model not available. Please run 'npx prisma generate':",a?.message),{success:!0,count:0}}return{success:!0,count:k}}catch(a){return console.error("Error fetching all projects unread count:",a),console.error("Error details:",{message:a?.message,stack:a?.stack,name:a?.name}),{success:!1,error:a?.message||"Failed to fetch unread count",details:a?.stack}}}async function i(a=15){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id),g=await c.prisma.projectUser.findMany({where:{userId:f,leftAt:null},select:{projectId:!0}}),h=[];try{h=await c.prisma.task.findMany({where:{assignees:{some:{id:f}}},select:{projectId:!0}})}catch(a){console.warn("[Notifications] Could not fetch tasks, using only ProjectUser:",a?.message),h=[]}let i=g.map(a=>a.projectId),j=h.map(a=>a.projectId),k=[...new Set([...i,...j])];if(console.log(`[Notifications] User ${f} has access to projects:`,k),0===k.length)return console.log(`[Notifications] No projects found for user ${f}`),{success:!0,notifications:[]};if(!c.prisma.projectNotification)return console.error("[Notifications] ProjectNotification model not found. Please run 'npx prisma generate'"),{success:!0,notifications:[]};let l=[];try{l=await c.prisma.projectNotification.findMany({where:{projectId:{in:k},userId:f},include:{project:{select:{id:!0,name:!0}}},orderBy:{createdAt:"desc"},take:a})}catch(a){return console.error("[Notifications] Error accessing ProjectNotification model. Please run 'npx prisma generate':",a?.message),{success:!0,notifications:[]}}return console.log(`[Notifications] Found ${l.length} notifications for user ${f}`),{success:!0,notifications:l}}catch(a){return console.error("Error fetching all projects notifications:",a),console.error("Error details:",{message:a?.message,stack:a?.stack,name:a?.name}),{success:!1,error:a?.message||"Failed to fetch notifications",details:a?.stack}}}async function j(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:f,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let g=await c.prisma.projectNotification.count({where:{projectId:a,userId:f,isRead:!1}});return{success:!0,count:g}}catch(a){return console.error("Error fetching unread count:",a),{success:!1,error:"Failed to fetch unread count"}}}async function k(a,b){try{let g=await (0,d.getServerSession)(e.authOptions);if(!g?.user?.id)return{success:!1,error:"Unauthorized"};let h=parseInt(g.user.id),i=await c.prisma.projectNotification.findFirst({where:{id:b,projectId:a,userId:h}});if(!i)return{success:!1,error:"Notification not found"};if(i.isUrgent&&i.requiresAcknowledgment&&!i.acknowledgedAt)return{success:!1,error:"Urgent notifications cannot be marked as read until acknowledged. Please acknowledge the urgent project first."};return await c.prisma.projectNotification.update({where:{id:b},data:{isRead:!0}}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error marking notification as read:",a),{success:!1,error:"Failed to mark notification as read"}}}async function l(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let g=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:g,leftAt:null}}))return{success:!1,error:"Access denied to this project"};return await c.prisma.projectNotification.updateMany({where:{projectId:a,userId:g,isRead:!1,OR:[{isUrgent:!1},{requiresAcknowledgment:!1},{acknowledgedAt:{not:null}}]},data:{isRead:!0}}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error marking all notifications as read:",a),{success:!1,error:"Failed to mark all notifications as read"}}}async function m(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:f,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let g=await c.prisma.projectNotificationPreference.findUnique({where:{projectId_userId:{projectId:a,userId:f}}});return g||(g=await c.prisma.projectNotificationPreference.create({data:{projectId:a,userId:f,soundEnabled:!0,taskNotifications:!0,dependencyNotifications:!0,todayTaskNotifications:!0,projectAdminNotifications:!0}})),{success:!0,preferences:g}}catch(a){return console.error("Error fetching notification preferences:",a),{success:!1,error:"Failed to fetch preferences"}}}async function n(a,b){try{let g=await (0,d.getServerSession)(e.authOptions);if(!g?.user?.id)return{success:!1,error:"Unauthorized"};let h=parseInt(g.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:h,leftAt:null}}))return{success:!1,error:"Access denied to this project"};return await c.prisma.projectNotificationPreference.upsert({where:{projectId_userId:{projectId:a,userId:h}},create:{projectId:a,userId:h,soundEnabled:b.soundEnabled??!0,taskNotifications:b.taskNotifications??!0,dependencyNotifications:b.dependencyNotifications??!0,todayTaskNotifications:b.todayTaskNotifications??!0,projectAdminNotifications:b.projectAdminNotifications??!0},update:b}),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error updating notification preferences:",a),{success:!1,error:"Failed to update preferences"}}}async function o(a,b,d){let{type:e,entityType:g,entityId:h,title:i,message:j,soundRequired:k=!1,isUrgent:l=!1,requiresAcknowledgment:m=!1}=d;try{let d=await c.prisma.projectUser.findFirst({where:{projectId:a,userId:b,leftAt:null}});if(!d&&("task"===g||"comment_mention"===g)&&h){if(!await c.prisma.task.findFirst({where:{id:h,projectId:a,assignees:{some:{id:b}}}}))return{success:!1,error:"User not in project or assigned to task"};d=null}else if(!d&&"comment"===g&&h){let e=await c.prisma.comment.findUnique({where:{id:h},select:{taskId:!0}});if(!e||!e.taskId)return{success:!1,error:"Comment or related task not found"};if(!await c.prisma.task.findFirst({where:{id:e.taskId,projectId:a,assignees:{some:{id:b}}}}))return{success:!1,error:"User not assigned to the task related to this comment"};d=null}else if(!d)return{success:!1,error:"User not in project"};let n=await c.prisma.projectNotificationPreference.findUnique({where:{projectId_userId:{projectId:a,userId:b}}}),o=!0;if(!k)switch(e){case"task":n&&!n.taskNotifications&&(o=!1);break;case"dependency":n&&!n.dependencyNotifications&&(o=!1);break;case"today_task":n&&!n.todayTaskNotifications&&(o=!1);break;case"project_admin":n&&!n.projectAdminNotifications&&(o=!1)}if(!o)return{success:!0,skipped:!0};let p=await c.prisma.projectNotification.create({data:{projectId:a,userId:b,type:e,entityType:g,entityId:h,title:i,message:j,soundRequired:k,isUrgent:l,requiresAcknowledgment:m}});return console.log(`[Notifications] Created notification for user ${b} in project ${a}:`,{id:p.id,type:e,title:i,soundRequired:k}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0,notification:p}}catch(a){return console.error("Error creating project notification:",a),{success:!1,error:"Failed to create notification"}}}(0,a.i(287907).ensureServerEntryExports)([g,h,i,j,k,l,m,n,o]),(0,b.registerServerReference)(g,"60e11d18f808d2843f4d06a35ea4ad9027dd8b4de1",null),(0,b.registerServerReference)(h,"00686a7231b739e4fe9b8305b757bc0e83827b9865",null),(0,b.registerServerReference)(i,"4004a0aae390e2c1aeb900c79065f312ac43d90f8d",null),(0,b.registerServerReference)(j,"40c45036bf2dcfbc3a3b624285c3d3d3366fc5ed73",null),(0,b.registerServerReference)(k,"60691655a7ad6aec29ab9691d8571a0d380be93da1",null),(0,b.registerServerReference)(l,"40c086aae8b4c1ddec14829c213410ee4c5d2ec0b4",null),(0,b.registerServerReference)(m,"4073df5af18efe51e33e158abaa2dd30f11932484d",null),(0,b.registerServerReference)(n,"60d7258dffa20b5ae58a4ac333313c2a6cc4aeb7a7",null),(0,b.registerServerReference)(o,"705f7777ed9cdc6c32f418ba57dcb7f4b84f8c002a",null),a.s(["createProjectNotification",()=>o,"getAllProjectsNotifications",()=>i,"getAllProjectsUnreadNotificationCount",()=>h,"getProjectNotificationPreferences",()=>m,"getProjectNotifications",()=>g,"getProjectUnreadNotificationCount",()=>j,"markAllProjectNotificationsAsRead",()=>l,"markProjectNotificationAsRead",()=>k,"updateProjectNotificationPreferences",()=>n])},476662,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(661698),g=a.i(449597),h=a.i(797180),i=a.i(57693),j=a.i(287907);let k=f.z.object({username:f.z.string().min(3,"Username must be at least 3 characters"),email:f.z.string().email("Invalid email"),password:f.z.string().min(6,"Password must be at least 6 characters"),role:f.z.string().default("developer"),teamId:f.z.coerce.number().optional()}),l=async()=>await c.prisma.user.findMany({include:{team:{select:{id:!0,name:!0}}},orderBy:{username:"asc"}}),m=(0,g.unstable_cache)(l,["all-users"],{revalidate:300,tags:["users"]});async function n(){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");return await m()}async function o(a){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");return await c.prisma.user.findUnique({where:{id:a},include:{team:{select:{id:!0,name:!0}},roles:{include:{role:!0}}}})}async function p(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized",code:"UNAUTHORIZED"};try{await (0,i.requirePermission)(parseInt(b.user.id),"user.create")}catch(a){return(0,i.handleAuthorizationError)(a)}let f=a.get("username"),j=a.get("email"),l=a.get("password"),m=a.get("role"),n=a.get("teamId"),o=k.safeParse({username:f,email:j,password:l,role:m,teamId:n?parseInt(n):void 0});if(!o.success)return{error:"Validation failed",code:"VALIDATION_FAILED"};try{let a=await h.default.hash(o.data.password,10),d=await c.prisma.role.findUnique({where:{name:o.data.role}}),e=await c.prisma.user.create({data:{username:o.data.username,email:o.data.email,role:o.data.role,passwordHash:a,teamId:o.data.teamId}});return d&&await c.prisma.userRole.create({data:{userId:e.id,roleId:d.id,scopeType:"global",scopeId:0}}),console.log(`[RBAC] User ${b.user.name||b.user.email} created user ${e.username}`),(0,g.revalidatePath)("/dashboard/users"),(0,g.revalidatePath)("/dashboard/teams"),{success:!0,code:"USER_CREATED"}}catch(a){return console.error("Create User Error:",a),{error:"Failed to create user (Email/Username might be taken)",code:"CREATE_FAILED"}}}async function q(a,b){let f=await (0,d.getServerSession)(e.authOptions);if(!f)return{error:"Unauthorized",code:"UNAUTHORIZED"};try{await (0,i.requirePermission)(parseInt(f.user.id),"user.update")}catch(a){return(0,i.handleAuthorizationError)(a)}let h=b.get("role"),j=b.get("teamId")?parseInt(b.get("teamId")):null;try{return await c.prisma.user.update({where:{id:a},data:{role:h,teamId:j}}),console.log(`[RBAC] User ${f.user.name||f.user.email} updated user ${a}`),(0,g.revalidatePath)("/dashboard/users"),{success:!0,code:"USER_UPDATED"}}catch(a){return{error:"Failed to update user",code:"UPDATE_FAILED"}}}async function r(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized",code:"UNAUTHORIZED"};try{await (0,i.requirePermission)(parseInt(b.user.id),"user.delete")}catch(a){return(0,i.handleAuthorizationError)(a)}if(parseInt(b.user.id)===a)return{error:"Cannot delete your own account",code:"SELF_DELETE"};try{let d=await c.prisma.user.findUnique({where:{id:a},include:{projectsManaged:{where:{NOT:{status:"completed"}},select:{id:!0,name:!0}},teamsLed:{select:{id:!0,name:!0}},timeLogs:{select:{id:!0},take:1},comments:{select:{id:!0},take:1},uploadedFiles:{select:{id:!0},take:1}}});if(!d)return{error:"User not found",code:"NOT_FOUND"};if(d.projectsManaged.length>0){let a=d.projectsManaged.map(a=>a.name).join(", ");return{error:`Cannot delete: User is managing ${d.projectsManaged.length} active project(s) (${a}). Please reassign the project manager first.`,code:"HAS_ACTIVE_PROJECTS"}}if(d.teamsLed.length>0){let a=d.teamsLed.map(a=>a.name).join(", ");return{error:`Cannot delete: User is leading ${d.teamsLed.length} team(s) (${a}). Please reassign the team lead first.`,code:"IS_TEAM_LEAD"}}if(d.timeLogs.length>0||d.comments.length>0||d.uploadedFiles.length>0)return{error:"Cannot delete: User has associated history (Time Logs, Comments, or Files). Please deactivate the user instead to preserve data integrity.",code:"HAS_HISTORY"};return await c.prisma.$transaction(async b=>{for(let c of(await b.activityLog.updateMany({where:{performedById:a},data:{performedById:null}}),await b.activityLog.updateMany({where:{affectedUserId:a},data:{affectedUserId:null}}),await b.project.updateMany({where:{createdById:a},data:{createdById:null}}),await b.task.updateMany({where:{createdById:a},data:{createdById:null}}),await b.task.findMany({where:{assignees:{some:{id:a}}},select:{id:!0}})))await b.task.update({where:{id:c.id},data:{assignees:{disconnect:{id:a}}}});await b.teamMember.deleteMany({where:{userId:a}}),await b.projectUser.deleteMany({where:{userId:a}}),await b.user.delete({where:{id:a}})}),console.log(`[RBAC] User ${a} deleted by ${b.user.name||b.user.email}`),(0,g.revalidatePath)("/dashboard/users"),(0,g.revalidatePath)("/dashboard/teams"),{success:!0,code:"USER_DELETED"}}catch(a){if(console.error("Delete user error:",a),"P2003"===a.code)return{error:"Cannot delete user due to existing database dependencies (Foreign Key). Please deactivate instead.",code:"HAS_HISTORY"};return{error:`Failed to delete user: ${a.message||"Unknown error"}`,code:"DELETE_FAILED"}}}async function s(a,b){let f=await (0,d.getServerSession)(e.authOptions);if(!f)return{error:"Unauthorized",code:"UNAUTHORIZED"};try{await (0,i.requirePermission)(parseInt(f.user.id),"user.update")}catch(a){return(0,i.handleAuthorizationError)(a)}if(parseInt(f.user.id)===a&&!b)return{error:"Cannot deactivate your own account",code:"SELF_DEACTIVATE"};try{let d=await c.prisma.user.update({where:{id:a},data:{isActive:b}});return console.log(`[RBAC] User ${f.user.name||f.user.email} ${b?"activated":"deactivated"} user ${d.username}`),(0,g.revalidatePath)("/dashboard/users"),{success:!0,code:b?"USER_ACTIVATED":"USER_DEACTIVATED"}}catch(a){return console.error("Toggle status error:",a),{error:"Failed to update user status",code:"UPDATE_FAILED"}}}async function t(a,b){if(!await (0,d.getServerSession)(e.authOptions))return{error:"Unauthorized"};try{return await c.prisma.user.update({where:{id:a},data:{teamId:b}}),(0,g.revalidatePath)("/dashboard/users"),{success:!0}}catch(a){return{error:"Failed to update user team"}}}(0,j.ensureServerEntryExports)([n,o,p,q,r,s,t]),(0,b.registerServerReference)(n,"0078a5996050e1da89a66893bd05780e75185392cb",null),(0,b.registerServerReference)(o,"406fd270e8a350e38c78e4b79321560707aa26fd1a",null),(0,b.registerServerReference)(p,"401fc4e21517ebfbd3eebabb3ac6ad3bf2fb7443a7",null),(0,b.registerServerReference)(q,"60e1fb0fb657783a6424ba7525af9dca8a6316a12b",null),(0,b.registerServerReference)(r,"40abdcd9a05b7e5b6a27a4efd7412defa3f340c60c",null),(0,b.registerServerReference)(s,"60b33fdd6fc55215f2569d47e96e5d33d33f4f707f",null),(0,b.registerServerReference)(t,"6020ac488ab0f44300111f3a8024b04b647106d187",null),a.s(["createUser",()=>p,"deleteUser",()=>r,"getUser",()=>o,"getUsers",()=>n,"toggleUserStatus",()=>s,"updateUser",()=>q,"updateUserTeam",()=>t])},274660,a=>{"use strict";var b=a.i(962460),c=a.i(153544),d=a.i(476662);a.s([],44378),a.i(44378),a.s(["0033db22356cbf8845a3517099b63dfc38d1147299",()=>b.getPublicSystemSettings,"00686a7231b739e4fe9b8305b757bc0e83827b9865",()=>c.getAllProjectsUnreadNotificationCount,"0078a5996050e1da89a66893bd05780e75185392cb",()=>d.getUsers,"4004a0aae390e2c1aeb900c79065f312ac43d90f8d",()=>c.getAllProjectsNotifications,"401fc4e21517ebfbd3eebabb3ac6ad3bf2fb7443a7",()=>d.createUser,"406fd270e8a350e38c78e4b79321560707aa26fd1a",()=>d.getUser,"40abdcd9a05b7e5b6a27a4efd7412defa3f340c60c",()=>d.deleteUser,"6020ac488ab0f44300111f3a8024b04b647106d187",()=>d.updateUserTeam,"60691655a7ad6aec29ab9691d8571a0d380be93da1",()=>c.markProjectNotificationAsRead,"60b33fdd6fc55215f2569d47e96e5d33d33f4f707f",()=>d.toggleUserStatus,"60e1fb0fb657783a6424ba7525af9dca8a6316a12b",()=>d.updateUser],274660)}];

//# sourceMappingURL=nxt_New%20folder_Project_Management_NXT_4cb7d5a4._.js.map