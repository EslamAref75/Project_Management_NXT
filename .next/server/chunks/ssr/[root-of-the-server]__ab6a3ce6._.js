module.exports=[792509,(a,b,c)=>{b.exports=a.x("url",()=>require("url"))},921517,(a,b,c)=>{b.exports=a.x("http",()=>require("http"))},254799,(a,b,c)=>{b.exports=a.x("crypto",()=>require("crypto"))},449719,(a,b,c)=>{b.exports=a.x("assert",()=>require("assert"))},145706,(a,b,c)=>{b.exports=a.x("querystring",()=>require("querystring"))},500874,(a,b,c)=>{b.exports=a.x("buffer",()=>require("buffer"))},406461,(a,b,c)=>{b.exports=a.x("zlib",()=>require("zlib"))},524836,(a,b,c)=>{b.exports=a.x("https",()=>require("https"))},427699,(a,b,c)=>{b.exports=a.x("events",()=>require("events"))},504166,a=>{a.v({name:"openid-client",version:"5.7.1",description:"OpenID Connect Relying Party (RP, Client) implementation for Node.js runtime, supports passportjs",keywords:["auth","authentication","basic","certified","client","connect","dynamic","electron","hybrid","identity","implicit","oauth","oauth2","oidc","openid","passport","relying party","strategy"],homepage:"https://github.com/panva/openid-client",repository:"panva/openid-client",funding:{url:"https://github.com/sponsors/panva"},license:"MIT",author:"Filip Skokan <panva.ip@gmail.com>",exports:{types:"./types/index.d.ts",import:"./lib/index.mjs",require:"./lib/index.js"},main:"./lib/index.js",types:"./types/index.d.ts",files:["lib","types/index.d.ts"],scripts:{format:"npx prettier --loglevel silent --write ./lib ./test ./certification ./types",test:"mocha test/**/*.test.js"},dependencies:{jose:"^4.15.9","lru-cache":"^6.0.0","object-hash":"^2.2.0","oidc-token-hash":"^5.0.3"},devDependencies:{"@types/node":"^16.18.106","@types/passport":"^1.0.16",base64url:"^3.0.1",chai:"^4.5.0",mocha:"^10.7.3",nock:"^13.5.5",prettier:"^2.8.8","readable-mock-req":"^0.2.2",sinon:"^9.2.4",timekeeper:"^2.3.1"},"standard-version":{scripts:{postchangelog:"sed -i '' -e 's/### \\[/## [/g' CHANGELOG.md"},types:[{type:"feat",section:"Features"},{type:"fix",section:"Fixes"},{type:"chore",hidden:!0},{type:"docs",hidden:!0},{type:"style",hidden:!0},{type:"refactor",section:"Refactor",hidden:!1},{type:"perf",section:"Performance",hidden:!1},{type:"test",hidden:!0}]}})},57693,662338,a=>{"use strict";var b=a.i(347656);let c=new Map;async function d(a,d){let e=`${a}:${d||"global"}`,f=c.get(e);if(f&&f.expiresAt>Date.now())return f.permissions;let g=await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...d?[{scopeType:"project",scopeId:d}]:[]]},include:{role:{include:{permissions:{include:{permission:!0}}}}}}),h=new Set;for(let a of g)for(let b of a.role.permissions)h.add(b.permission.key);let i=Array.from(h);return c.set(e,{permissions:i,expiresAt:Date.now()+3e5}),i}async function e(a,c){return(await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...c?[{scopeType:"project",scopeId:c}]:[]]},include:{role:!0}})).map(a=>({role:a.role,scopeType:a.scopeType,scopeId:a.scopeId}))}function f(a,b){let d=`${a}:${b||"global"}`;c.delete(d)}a.s(["clearPermissionCache",()=>f,"getUserPermissions",()=>d,"getUserRoles",()=>e],662338);class g extends Error{code;constructor(a,b="UNAUTHORIZED"){super(a),this.code=b,this.name="UnauthorizedError"}}class h extends Error{code;constructor(a,b="FORBIDDEN"){super(a),this.code=b,this.name="ForbiddenError"}}class i extends Error{code;constructor(a,b="NOT_FOUND"){super(a),this.code=b,this.name="NotFoundError"}}async function j(a,b,c){if(!await k(a,b,c))throw new g(`Permission denied: ${b}`,"PERMISSION_DENIED")}async function k(a,c,d){try{for(let e of(await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...d?[{scopeType:"project",scopeId:d}]:[]]},include:{role:{include:{permissions:{include:{permission:!0}}}}}})))for(let a of e.role.permissions)if(a.permission.key===c)return!0;return!1}catch(b){return console.error(`Error checking permission ${c} for user ${a}:`,b),!1}}function l(a){return a instanceof g||a instanceof h?{error:a.message,code:a.code,status:403,success:!1}:a instanceof i?{error:a.message,code:a.code,status:404,success:!1}:(console.error("Unknown authorization error:",a),{error:"Authorization failed",code:"AUTHORIZATION_ERROR",status:500,success:!1})}a.s(["handleAuthorizationError",()=>l,"hasPermissionWithoutRoleBypass",()=>k,"requirePermission",()=>j],57693)},126695,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(541265);async function e(a){console.log("[ActivityLogger] ====== START LOGGING ======"),console.log("[ActivityLogger] Received params:",JSON.stringify(a,null,2));try{let b=function a(b){let c={...b};for(let a of["password","passwordHash","password_hash","token","secret","apiKey","api_key","accessToken","refreshToken"])a in c&&(c[a]="[REDACTED]");for(let b in c)"object"!=typeof c[b]||null===c[b]||Array.isArray(c[b])||(c[b]=a(c[b]));return c}(a.actionDetails||{});console.log("[ActivityLogger] Sanitized details:",JSON.stringify(b,null,2)),console.log("[ActivityLogger] Logging activity:",{actionType:a.actionType,actionCategory:a.actionCategory,actionSummary:a.actionSummary,performedById:a.performedById});try{let d=await c.prisma.activityLog.create({data:{actionType:a.actionType,actionCategory:a.actionCategory,actionSummary:a.actionSummary,actionDetails:Object.keys(b).length>0?JSON.stringify(b):null,performedById:a.performedById,affectedUserId:a.affectedUserId||null,projectId:a.projectId||null,entityType:a.entityType||null,entityId:a.entityId||null,ipAddress:a.ipAddress||await f(),userAgent:a.userAgent||await g(),action:a.actionType,description:a.actionSummary,userId:a.performedById}});console.log("[ActivityLogger] ✅ Successfully logged activity with ID:",d.id),console.log("[ActivityLogger] ====== END LOGGING (SUCCESS) ======");return}catch(b){if(console.error("[ActivityLogger] ❌ Schema error occurred:"),console.error("[ActivityLogger] Error message:",b.message),console.error("[ActivityLogger] Error code:",b.code),console.error("[ActivityLogger] Error meta:",JSON.stringify(b.meta,null,2)),b.message?.includes("no such column")||"P2003"===b.code||"P2011"===b.code){console.warn("[ActivityLogger] New columns not found, using legacy schema. Please run migration."),await c.prisma.$executeRawUnsafe(`
          INSERT INTO activity_logs (action, description, entity_type, entity_id, ip_address, user_id, created_at)
          VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
        `,a.actionType,a.actionSummary,a.entityType||null,a.entityId||null,a.ipAddress||await f()||null,a.performedById),console.log("[ActivityLogger] ✅ Logged using legacy schema"),console.log("[ActivityLogger] ====== END LOGGING (LEGACY) ======");return}throw console.error("[ActivityLogger] ❌ Unknown schema error, rethrowing"),b}}catch(a){console.error("[ActivityLogger] ❌❌❌ CRITICAL ERROR - Failed to log activity ❌❌❌"),console.error("[ActivityLogger] Error message:",a?.message||a),console.error("[ActivityLogger] Error code:",a?.code),console.error("[ActivityLogger] Error meta:",JSON.stringify(a?.meta,null,2)),console.error("[ActivityLogger] Error stack:",a?.stack),console.error("[ActivityLogger] ====== END LOGGING (ERROR) ======")}}async function f(){try{let a=await (0,d.headers)(),b=a.get("x-forwarded-for"),c=a.get("x-real-ip");if(b)return b.split(",")[0].trim();if(c)return c;return null}catch{return null}}async function g(){try{return(await (0,d.headers)()).get("user-agent")||null}catch{return null}}(0,a.i(287907).ensureServerEntryExports)([e]),(0,b.registerServerReference)(e,"40daa1d9c7314de4957a7669434db12aaa24630ba4",null),a.s(["logActivity",()=>e])},476662,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(661698),g=a.i(449597),h=a.i(797180),i=a.i(57693),j=a.i(287907);let k=f.z.object({username:f.z.string().min(3,"Username must be at least 3 characters"),email:f.z.string().email("Invalid email"),password:f.z.string().min(6,"Password must be at least 6 characters"),role:f.z.string().default("developer"),teamId:f.z.coerce.number().optional()}),l=async()=>await c.prisma.user.findMany({include:{team:{select:{id:!0,name:!0}}},orderBy:{username:"asc"}}),m=(0,g.unstable_cache)(l,["all-users"],{revalidate:300,tags:["users"]});async function n(){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");return await m()}async function o(a){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");return await c.prisma.user.findUnique({where:{id:a},include:{team:{select:{id:!0,name:!0}},roles:{include:{role:!0}}}})}async function p(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized",code:"UNAUTHORIZED"};try{await (0,i.requirePermission)(parseInt(b.user.id),"user.create")}catch(a){return(0,i.handleAuthorizationError)(a)}let f=a.get("username"),j=a.get("email"),l=a.get("password"),m=a.get("role"),n=a.get("teamId"),o=k.safeParse({username:f,email:j,password:l,role:m,teamId:n?parseInt(n):void 0});if(!o.success)return{error:"Validation failed",code:"VALIDATION_FAILED"};try{let a=await h.default.hash(o.data.password,10),d=await c.prisma.role.findUnique({where:{name:o.data.role}}),e=await c.prisma.user.create({data:{username:o.data.username,email:o.data.email,role:o.data.role,passwordHash:a,teamId:o.data.teamId}});return d&&await c.prisma.userRole.create({data:{userId:e.id,roleId:d.id,scopeType:"global",scopeId:0}}),console.log(`[RBAC] User ${b.user.name||b.user.email} created user ${e.username}`),(0,g.revalidatePath)("/dashboard/users"),(0,g.revalidatePath)("/dashboard/teams"),{success:!0,code:"USER_CREATED"}}catch(a){return console.error("Create User Error:",a),{error:"Failed to create user (Email/Username might be taken)",code:"CREATE_FAILED"}}}async function q(a,b){let f=await (0,d.getServerSession)(e.authOptions);if(!f)return{error:"Unauthorized",code:"UNAUTHORIZED"};try{await (0,i.requirePermission)(parseInt(f.user.id),"user.update")}catch(a){return(0,i.handleAuthorizationError)(a)}let h=b.get("role"),j=b.get("teamId")?parseInt(b.get("teamId")):null;try{return await c.prisma.user.update({where:{id:a},data:{role:h,teamId:j}}),console.log(`[RBAC] User ${f.user.name||f.user.email} updated user ${a}`),(0,g.revalidatePath)("/dashboard/users"),{success:!0,code:"USER_UPDATED"}}catch(a){return{error:"Failed to update user",code:"UPDATE_FAILED"}}}async function r(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized",code:"UNAUTHORIZED"};try{await (0,i.requirePermission)(parseInt(b.user.id),"user.delete")}catch(a){return(0,i.handleAuthorizationError)(a)}if(parseInt(b.user.id)===a)return{error:"Cannot delete your own account",code:"SELF_DELETE"};try{let d=await c.prisma.user.findUnique({where:{id:a},include:{projectsManaged:{where:{NOT:{status:"completed"}},select:{id:!0,name:!0}},teamsLed:{select:{id:!0,name:!0}},timeLogs:{select:{id:!0},take:1},comments:{select:{id:!0},take:1},uploadedFiles:{select:{id:!0},take:1}}});if(!d)return{error:"User not found",code:"NOT_FOUND"};if(d.projectsManaged.length>0){let a=d.projectsManaged.map(a=>a.name).join(", ");return{error:`Cannot delete: User is managing ${d.projectsManaged.length} active project(s) (${a}). Please reassign the project manager first.`,code:"HAS_ACTIVE_PROJECTS"}}if(d.teamsLed.length>0){let a=d.teamsLed.map(a=>a.name).join(", ");return{error:`Cannot delete: User is leading ${d.teamsLed.length} team(s) (${a}). Please reassign the team lead first.`,code:"IS_TEAM_LEAD"}}if(d.timeLogs.length>0||d.comments.length>0||d.uploadedFiles.length>0)return{error:"Cannot delete: User has associated history (Time Logs, Comments, or Files). Please deactivate the user instead to preserve data integrity.",code:"HAS_HISTORY"};return await c.prisma.$transaction(async b=>{for(let c of(await b.activityLog.updateMany({where:{performedById:a},data:{performedById:null}}),await b.activityLog.updateMany({where:{affectedUserId:a},data:{affectedUserId:null}}),await b.project.updateMany({where:{createdById:a},data:{createdById:null}}),await b.task.updateMany({where:{createdById:a},data:{createdById:null}}),await b.task.findMany({where:{assignees:{some:{id:a}}},select:{id:!0}})))await b.task.update({where:{id:c.id},data:{assignees:{disconnect:{id:a}}}});await b.teamMember.deleteMany({where:{userId:a}}),await b.projectUser.deleteMany({where:{userId:a}}),await b.user.delete({where:{id:a}})}),console.log(`[RBAC] User ${a} deleted by ${b.user.name||b.user.email}`),(0,g.revalidatePath)("/dashboard/users"),(0,g.revalidatePath)("/dashboard/teams"),{success:!0,code:"USER_DELETED"}}catch(a){if(console.error("Delete user error:",a),"P2003"===a.code)return{error:"Cannot delete user due to existing database dependencies (Foreign Key). Please deactivate instead.",code:"HAS_HISTORY"};return{error:`Failed to delete user: ${a.message||"Unknown error"}`,code:"DELETE_FAILED"}}}async function s(a,b){let f=await (0,d.getServerSession)(e.authOptions);if(!f)return{error:"Unauthorized",code:"UNAUTHORIZED"};try{await (0,i.requirePermission)(parseInt(f.user.id),"user.update")}catch(a){return(0,i.handleAuthorizationError)(a)}if(parseInt(f.user.id)===a&&!b)return{error:"Cannot deactivate your own account",code:"SELF_DEACTIVATE"};try{let d=await c.prisma.user.update({where:{id:a},data:{isActive:b}});return console.log(`[RBAC] User ${f.user.name||f.user.email} ${b?"activated":"deactivated"} user ${d.username}`),(0,g.revalidatePath)("/dashboard/users"),{success:!0,code:b?"USER_ACTIVATED":"USER_DEACTIVATED"}}catch(a){return console.error("Toggle status error:",a),{error:"Failed to update user status",code:"UPDATE_FAILED"}}}async function t(a,b){if(!await (0,d.getServerSession)(e.authOptions))return{error:"Unauthorized"};try{return await c.prisma.user.update({where:{id:a},data:{teamId:b}}),(0,g.revalidatePath)("/dashboard/users"),{success:!0}}catch(a){return{error:"Failed to update user team"}}}(0,j.ensureServerEntryExports)([n,o,p,q,r,s,t]),(0,b.registerServerReference)(n,"0078a5996050e1da89a66893bd05780e75185392cb",null),(0,b.registerServerReference)(o,"406fd270e8a350e38c78e4b79321560707aa26fd1a",null),(0,b.registerServerReference)(p,"401fc4e21517ebfbd3eebabb3ac6ad3bf2fb7443a7",null),(0,b.registerServerReference)(q,"60e1fb0fb657783a6424ba7525af9dca8a6316a12b",null),(0,b.registerServerReference)(r,"40abdcd9a05b7e5b6a27a4efd7412defa3f340c60c",null),(0,b.registerServerReference)(s,"60b33fdd6fc55215f2569d47e96e5d33d33f4f707f",null),(0,b.registerServerReference)(t,"6020ac488ab0f44300111f3a8024b04b647106d187",null),a.s(["createUser",()=>p,"deleteUser",()=>r,"getUser",()=>o,"getUsers",()=>n,"toggleUserStatus",()=>s,"updateUser",()=>q,"updateUserTeam",()=>t])}];

//# sourceMappingURL=%5Broot-of-the-server%5D__ab6a3ce6._.js.map