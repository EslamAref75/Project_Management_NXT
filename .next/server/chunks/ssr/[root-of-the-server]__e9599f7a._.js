module.exports=[792509,(a,b,c)=>{b.exports=a.x("url",()=>require("url"))},921517,(a,b,c)=>{b.exports=a.x("http",()=>require("http"))},254799,(a,b,c)=>{b.exports=a.x("crypto",()=>require("crypto"))},449719,(a,b,c)=>{b.exports=a.x("assert",()=>require("assert"))},145706,(a,b,c)=>{b.exports=a.x("querystring",()=>require("querystring"))},500874,(a,b,c)=>{b.exports=a.x("buffer",()=>require("buffer"))},406461,(a,b,c)=>{b.exports=a.x("zlib",()=>require("zlib"))},524836,(a,b,c)=>{b.exports=a.x("https",()=>require("https"))},427699,(a,b,c)=>{b.exports=a.x("events",()=>require("events"))},504166,a=>{a.v({name:"openid-client",version:"5.7.1",description:"OpenID Connect Relying Party (RP, Client) implementation for Node.js runtime, supports passportjs",keywords:["auth","authentication","basic","certified","client","connect","dynamic","electron","hybrid","identity","implicit","oauth","oauth2","oidc","openid","passport","relying party","strategy"],homepage:"https://github.com/panva/openid-client",repository:"panva/openid-client",funding:{url:"https://github.com/sponsors/panva"},license:"MIT",author:"Filip Skokan <panva.ip@gmail.com>",exports:{types:"./types/index.d.ts",import:"./lib/index.mjs",require:"./lib/index.js"},main:"./lib/index.js",types:"./types/index.d.ts",files:["lib","types/index.d.ts"],scripts:{format:"npx prettier --loglevel silent --write ./lib ./test ./certification ./types",test:"mocha test/**/*.test.js"},dependencies:{jose:"^4.15.9","lru-cache":"^6.0.0","object-hash":"^2.2.0","oidc-token-hash":"^5.0.3"},devDependencies:{"@types/node":"^16.18.106","@types/passport":"^1.0.16",base64url:"^3.0.1",chai:"^4.5.0",mocha:"^10.7.3",nock:"^13.5.5",prettier:"^2.8.8","readable-mock-req":"^0.2.2",sinon:"^9.2.4",timekeeper:"^2.3.1"},"standard-version":{scripts:{postchangelog:"sed -i '' -e 's/### \\[/## [/g' CHANGELOG.md"},types:[{type:"feat",section:"Features"},{type:"fix",section:"Fixes"},{type:"chore",hidden:!0},{type:"docs",hidden:!0},{type:"style",hidden:!0},{type:"refactor",section:"Refactor",hidden:!1},{type:"perf",section:"Performance",hidden:!1},{type:"test",hidden:!0}]}})},57693,662338,a=>{"use strict";var b=a.i(347656);let c=new Map;async function d(a,d){let e=`${a}:${d||"global"}`,f=c.get(e);if(f&&f.expiresAt>Date.now())return f.permissions;let g=await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...d?[{scopeType:"project",scopeId:d}]:[]]},include:{role:{include:{permissions:{include:{permission:!0}}}}}}),h=new Set;for(let a of g)for(let b of a.role.permissions)h.add(b.permission.key);let i=Array.from(h);return c.set(e,{permissions:i,expiresAt:Date.now()+3e5}),i}async function e(a,c){return(await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...c?[{scopeType:"project",scopeId:c}]:[]]},include:{role:!0}})).map(a=>({role:a.role,scopeType:a.scopeType,scopeId:a.scopeId}))}function f(a,b){let d=`${a}:${b||"global"}`;c.delete(d)}a.s(["clearPermissionCache",()=>f,"getUserPermissions",()=>d,"getUserRoles",()=>e],662338);class g extends Error{code;constructor(a,b="UNAUTHORIZED"){super(a),this.code=b,this.name="UnauthorizedError"}}class h extends Error{code;constructor(a,b="FORBIDDEN"){super(a),this.code=b,this.name="ForbiddenError"}}class i extends Error{code;constructor(a,b="NOT_FOUND"){super(a),this.code=b,this.name="NotFoundError"}}async function j(a,b,c){if(!await k(a,b,c))throw new g(`Permission denied: ${b}`,"PERMISSION_DENIED")}async function k(a,c,d){try{for(let e of(await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...d?[{scopeType:"project",scopeId:d}]:[]]},include:{role:{include:{permissions:{include:{permission:!0}}}}}})))for(let a of e.role.permissions)if(a.permission.key===c)return!0;return!1}catch(b){return console.error(`Error checking permission ${c} for user ${a}:`,b),!1}}function l(a){return a instanceof g||a instanceof h?{error:a.message,code:a.code,status:403,success:!1}:a instanceof i?{error:a.message,code:a.code,status:404,success:!1}:(console.error("Unknown authorization error:",a),{error:"Authorization failed",code:"AUTHORIZATION_ERROR",status:500,success:!1})}a.s(["handleAuthorizationError",()=>l,"hasPermissionWithoutRoleBypass",()=>k,"requirePermission",()=>j],57693)},962460,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(449597),g=a.i(797180),h=a.i(57693);async function i(){let a=await (0,d.getServerSession)(e.authOptions);return a?{authorized:await (0,h.hasPermissionWithoutRoleBypass)(parseInt(a.user.id),"admin.access"),session:a}:{authorized:!1,session:null}}async function j(){let{authorized:a,session:b}=await i();if(!a||!b)return{error:"Unauthorized: Only system administrators can access settings"};try{let a=await c.prisma.systemSetting.findMany({orderBy:[{category:"asc"},{key:"asc"}],include:{updater:{select:{id:!0,username:!0,email:!0}}}}),b={};return a.forEach(a=>{b[a.category]||(b[a.category]=[]),b[a.category].push({id:a.id,key:a.key,value:JSON.parse(a.value),category:a.category,description:a.description,updatedAt:a.updatedAt,updatedBy:a.updater})}),{success:!0,settings:b}}catch(a){return console.error("getAllSettings Error:",a),{error:"Failed to fetch settings",details:a.message}}}async function k(){(0,f.unstable_noStore)();try{let a=await c.prisma.systemSetting.findUnique({where:{key:"general"}});if(!a)return{success:!0,settings:{systemName:"Qeema PMS",systemLogo:"/assets/logo.png",allowRegistration:!0}};let b=JSON.parse(a.value);return{success:!0,settings:{systemName:b.systemName||"Qeema PMS",systemLogo:b.systemLogo||"/assets/logo.png",allowRegistration:void 0===b.allowRegistration||b.allowRegistration}}}catch(a){return console.error("getPublicSystemSettings Error:",a),{success:!0,settings:{systemName:"Qeema PMS",systemLogo:"/assets/logo.png",allowRegistration:!0}}}}async function l(a){let{authorized:b,session:d}=await i();if(!b||!d)return{error:"Unauthorized"};try{let b=await c.prisma.systemSetting.findUnique({where:{key:a},include:{updater:{select:{id:!0,username:!0,email:!0}}}});if(!b)return{error:"Setting not found"};return{success:!0,setting:{id:b.id,key:b.key,value:JSON.parse(b.value),category:b.category,description:b.description,updatedAt:b.updatedAt,updatedBy:b.updater}}}catch(a){return console.error("getSetting Error:",a),{error:"Failed to fetch setting",details:a.message}}}async function m(a,b,d,e){let{authorized:g,session:h}=await i();if(!g||!h)return{error:"Unauthorized"};try{let g=await c.prisma.systemSetting.findUnique({where:{key:a}});if(!g){if(e)return await n(a,e,b,"Auto-created via update");return{error:"Setting not found"}}let i=g.value,j=JSON.stringify(b),k=await c.prisma.systemSetting.update({where:{key:a},data:{value:j,updatedBy:parseInt(h.user.id)}});return await c.prisma.settingsChangeLog.create({data:{settingKey:a,oldValue:i,newValue:j,reason:d||null,userId:parseInt(h.user.id),settingId:k.id}}),(0,f.revalidatePath)("/","layout"),{success:!0,setting:k}}catch(a){return console.error("updateSetting Error:",a),{error:"Failed to update setting",details:a.message}}}async function n(a,b,d,e){let{authorized:g,session:h}=await i();if(!g||!h)return{error:"Unauthorized"};try{if(await c.prisma.systemSetting.findUnique({where:{key:a}}))return{error:"Setting with this key already exists"};let g=await c.prisma.systemSetting.create({data:{key:a,category:b,value:JSON.stringify(d),description:e||null,updatedBy:parseInt(h.user.id)}});return await c.prisma.settingsChangeLog.create({data:{settingKey:a,oldValue:null,newValue:JSON.stringify(d),reason:"Setting created",userId:parseInt(h.user.id),settingId:g.id}}),(0,f.revalidatePath)("/dashboard/settings"),{success:!0,setting:g}}catch(a){return console.error("createSetting Error:",a),{error:"Failed to create setting",details:a.message}}}async function o(a,b=50,d=0){let{authorized:e,session:f}=await i();if(!e||!f)return{error:"Unauthorized"};try{let e=a?{settingKey:a}:{},f=await c.prisma.settingsChangeLog.findMany({where:e,include:{user:{select:{id:!0,username:!0,email:!0}},setting:{select:{key:!0,category:!0}}},orderBy:{createdAt:"desc"},take:b,skip:d}),g=await c.prisma.settingsChangeLog.count({where:e});return{success:!0,logs:f.map(a=>({id:a.id,settingKey:a.settingKey,category:a.setting?.category,oldValue:a.oldValue?JSON.parse(a.oldValue):null,newValue:JSON.parse(a.newValue),reason:a.reason,changedBy:a.user,createdAt:a.createdAt})),total:g,limit:b,offset:d}}catch(a){return console.error("getSettingsChangeLog Error:",a),{error:"Failed to fetch change log",details:a.message}}}async function p(){let{authorized:a,session:b}=await i();if(!a||!b)return{error:"Unauthorized"};try{let a=[{key:"general",category:"general",value:{systemName:"Project Management System",systemLogo:"/assets/logo.png",defaultLanguage:"en",defaultTimezone:"UTC",workingDays:[1,2,3,4,5],defaultWorkingHours:{start:"09:00",end:"17:00"}},description:"General system settings"},{key:"tasks",category:"tasks",value:{statuses:[{id:1,name:"Pending",key:"pending",order:1,color:"#fbbf24",isFinal:!1,isDefault:!0},{id:2,name:"Waiting",key:"waiting",order:2,color:"#f97316",isFinal:!1,isDefault:!1},{id:3,name:"In Progress",key:"in_progress",order:3,color:"#3b82f6",isFinal:!1,isDefault:!1},{id:4,name:"Review",key:"review",order:4,color:"#a855f7",isFinal:!1,isDefault:!1},{id:5,name:"Completed",key:"completed",order:5,color:"#10b981",isFinal:!0,isDefault:!1}],priorities:[{id:1,name:"Low",key:"low",weight:1,color:"#6b7280",isDefault:!1},{id:2,name:"Normal",key:"normal",weight:2,color:"#3b82f6",isDefault:!0},{id:3,name:"High",key:"high",weight:3,color:"#f59e0b",isDefault:!1},{id:4,name:"Urgent",key:"urgent",weight:4,color:"#ef4444",isDefault:!1}]},description:"Task statuses and priority levels"},{key:"today_tasks",category:"today_tasks",value:{dailyResetTime:"00:00",resetTimezoneSource:"system",autoCarryOver:!0,carryOverRules:{excludeBlocked:!0,incompleteOnly:!0,maxDays:7},adminOverridePermissions:!0},description:"Today's Tasks configuration"},{key:"dependencies",category:"dependencies",value:{allowMultipleDependencies:!0,allowCrossTeamDependencies:!0,allowCrossProjectDependencies:!1,autoBlockTasks:!0,allowAdminManualUnblock:!0},description:"Task dependency rules"},{key:"permissions",category:"permissions",value:{admin:{taskCreation:!0,taskAssignment:!0,todayTasksManagement:!0,dependencyManagement:!0,projectCreation:!0,userManagement:!0},team_lead:{taskCreation:!0,taskAssignment:!0,todayTasksManagement:!0,dependencyManagement:!0,projectCreation:!1,userManagement:!1},developer:{taskCreation:!1,taskAssignment:!1,todayTasksManagement:!1,dependencyManagement:!1,projectCreation:!1,userManagement:!1}},description:"Default permissions by role"},{key:"notifications",category:"notifications",value:{notifyOnTodayTaskAssignment:!0,notifyOnTaskBlocked:!0,notifyOnDependencyCompleted:!0,notifyOnTaskOverdue:!0,notifyOnStatusChange:!1},description:"System-wide notification preferences"},{key:"audit",category:"audit",value:{enableSettingsChangeLogs:!0,enableOverrideLogs:!0,logRetentionPolicy:{retentionDays:365,archiveAfterDays:90,maxLogSizeMB:100}},description:"Audit and logging configuration"}],d=[];for(let e of a)if(!await c.prisma.systemSetting.findUnique({where:{key:e.key}})){let a=await c.prisma.systemSetting.create({data:{key:e.key,category:e.category,value:JSON.stringify(e.value),description:e.description,updatedBy:parseInt(b.user.id)}});d.push(a)}return{success:!0,created:d.length,message:`Initialized ${d.length} default settings`}}catch(a){return console.error("initializeDefaultSettings Error:",a),{error:"Failed to initialize settings",details:a.message}}}async function q(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};try{let d=a.get("username"),e=a.get("email");if(!d||!e)return{error:"Username and email are required"};let g=parseInt(b.user.id);if(await c.prisma.user.findFirst({where:{AND:[{id:{not:g}},{OR:[{username:d},{email:e}]}]}}))return{error:"Username or email already taken"};await c.prisma.user.update({where:{id:g},data:{username:d,email:e}});try{await c.prisma.activityLog.create({data:{userId:g,action:"update_profile",description:"User updated their profile",entityType:"user",entityId:g}})}catch(a){console.error("Failed to log activity:",a)}return(0,f.revalidatePath)("/dashboard/settings"),{success:!0,message:"Profile updated successfully"}}catch(a){return console.error("updateProfile Error:",a),{error:"Failed to update profile",details:a.message}}}async function r(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};try{let d=a.get("currentPassword"),e=a.get("newPassword");if(!d||!e)return{error:"Current password and new password are required"};if(e.length<6)return{error:"New password must be at least 6 characters long"};let f=parseInt(b.user.id),h=await c.prisma.user.findUnique({where:{id:f},select:{id:!0,passwordHash:!0}});if(!h)return{error:"User not found"};if(!await g.default.compare(d,h.passwordHash))return{error:"Current password is incorrect"};let i=await g.default.hash(e,10);await c.prisma.user.update({where:{id:f},data:{passwordHash:i}});try{await c.prisma.activityLog.create({data:{userId:f,action:"change_password",description:"User changed their password",entityType:"user",entityId:f}})}catch(a){console.error("Failed to log activity:",a)}return{success:!0,message:"Password changed successfully"}}catch(a){return console.error("changePassword Error:",a),{error:"Failed to change password",details:a.message}}}(0,a.i(287907).ensureServerEntryExports)([j,k,l,m,n,o,p,q,r]),(0,b.registerServerReference)(j,"007e87ba61b31694665ed5a2760917aca0012a5804",null),(0,b.registerServerReference)(k,"0033db22356cbf8845a3517099b63dfc38d1147299",null),(0,b.registerServerReference)(l,"4026a74581aa372e707f7e9425f5c768011a945151",null),(0,b.registerServerReference)(m,"7856a9cd98bf3a731a97f71b1b70c5ad4d859adbb2",null),(0,b.registerServerReference)(n,"78fb7dd63cbd70865d3475dc975e9fa1593831d593",null),(0,b.registerServerReference)(o,"70b427cd64ca79bb572257b00709719ab51716cf24",null),(0,b.registerServerReference)(p,"00c0f288754b226caea3cc3ea08416b1a0ffe772c7",null),(0,b.registerServerReference)(q,"4014896b5d2affbb03c83dbddeb66e1724203ab137",null),(0,b.registerServerReference)(r,"4030a94bd5b3ca5815ae2cd1d1725e523f9f88fa17",null),a.s(["changePassword",()=>r,"getPublicSystemSettings",()=>k,"updateProfile",()=>q,"updateSetting",()=>m])}];

//# sourceMappingURL=%5Broot-of-the-server%5D__e9599f7a._.js.map