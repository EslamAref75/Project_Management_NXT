{"version":3,"sources":["../../../../../../../nxt/New%20folder/Project_Management_NXT/src/app/actions/tasks.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/app/actions/dependencies.ts"],"sourcesContent":["\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport { z } from \"zod\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { createProjectNotification } from \"./project-notifications\"\r\nimport { logActivity } from \"@/lib/activity-logger\"\r\nimport { hasPermissionWithoutRoleBypass, handleAuthorizationError } from \"@/lib/rbac-helpers\"\r\nimport { PERMISSIONS } from \"@/lib/permissions\"\r\nimport { isTaskBlocked } from \"./dependencies\"\r\n\r\nconst createTaskSchema = z.object({\r\n    title: z.string().min(1, \"Title is required\"),\r\n    description: z.string().optional(),\r\n    priority: z.string().default(\"normal\"),\r\n    projectId: z.coerce.number(),\r\n    assigneeIds: z.string().optional().transform((str, ctx) => {\r\n        if (!str || str === '' || str === '[]') return []\r\n        try {\r\n            const parsed = JSON.parse(str)\r\n            return Array.isArray(parsed) ? parsed as number[] : []\r\n        } catch (e) {\r\n            return []\r\n        }\r\n    }),\r\n    dueDate: z.string().optional()\r\n})\r\n\r\nexport async function getTasksWithFilters(params: {\r\n    search?: string\r\n    projectId?: string[]\r\n    status?: string[]\r\n    priority?: string[]\r\n    assigneeId?: string\r\n    dependencyState?: string\r\n    startDate?: string\r\n    endDate?: string\r\n    dateFilterType?: \"dueDate\" | \"createdDate\"\r\n    page?: number\r\n    limit?: number\r\n}) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    const {\r\n        search = \"\",\r\n        projectId = [],\r\n        status = [],\r\n        priority = [],\r\n        assigneeId,\r\n        dependencyState,\r\n        startDate,\r\n        endDate,\r\n        dateFilterType = \"dueDate\",\r\n        page = 1,\r\n        limit = 20,\r\n    } = params\r\n\r\n    try {\r\n        const where: any = {}\r\n\r\n        // Search filter\r\n        const searchConditions: any[] = []\r\n        if (search) {\r\n            // SQLite doesn't support mode: \"insensitive\", but LIKE is case-insensitive by default\r\n            searchConditions.push(\r\n                { title: { contains: search } },\r\n                { project: { name: { contains: search } } },\r\n                { assignees: { some: { username: { contains: search } } } }\r\n            )\r\n        }\r\n\r\n        // Project filter\r\n        if (projectId.length > 0) {\r\n            where.projectId = { in: projectId.map((id) => parseInt(id)) }\r\n        }\r\n\r\n        // Status filter - support both status IDs (for dynamic statuses) and legacy status names\r\n        const statusConditions: any[] = []\r\n        if (status.length > 0) {\r\n            const statusIds: number[] = []\r\n            const statusNames: string[] = []\r\n\r\n            status.forEach(s => {\r\n                const id = parseInt(s)\r\n                if (!isNaN(id)) {\r\n                    statusIds.push(id)\r\n                } else {\r\n                    statusNames.push(s)\r\n                }\r\n            })\r\n\r\n            if (statusIds.length > 0) {\r\n                statusConditions.push({ taskStatusId: { in: statusIds } })\r\n            }\r\n            if (statusNames.length > 0) {\r\n                statusConditions.push({ status: { in: statusNames }, taskStatusId: null })\r\n            }\r\n        }\r\n\r\n        // Combine search and status filters properly\r\n        if (searchConditions.length > 0 && statusConditions.length > 0) {\r\n            // Both search and status: AND them together\r\n            where.AND = [\r\n                { OR: searchConditions },\r\n                { OR: statusConditions }\r\n            ]\r\n        } else if (searchConditions.length > 0) {\r\n            // Only search\r\n            where.OR = searchConditions\r\n        } else if (statusConditions.length > 0) {\r\n            // Only status\r\n            where.OR = statusConditions\r\n        }\r\n\r\n        // Priority filter\r\n        if (priority.length > 0) {\r\n            where.priority = { in: priority }\r\n        }\r\n\r\n        // Assignee filter\r\n        if (assigneeId) {\r\n            if (assigneeId === \"me\") {\r\n                where.assignees = { some: { id: parseInt(session.user.id) } }\r\n            } else {\r\n                where.assignees = { some: { id: parseInt(assigneeId) } }\r\n            }\r\n        }\r\n\r\n        // Date range filter\r\n        if (startDate || endDate) {\r\n            const dateField = dateFilterType === \"createdDate\" ? \"createdAt\" : \"dueDate\"\r\n            const dateConditions: any[] = []\r\n            if (startDate) {\r\n                dateConditions.push({ [dateField]: { gte: new Date(startDate) } })\r\n            }\r\n            if (endDate) {\r\n                dateConditions.push({ [dateField]: { lte: new Date(endDate) } })\r\n            }\r\n            if (dateConditions.length > 0) {\r\n                where.AND = [...(where.AND || []), ...dateConditions]\r\n            }\r\n        }\r\n\r\n        // Dependency state filter\r\n        if (dependencyState && dependencyState !== \"all\") {\r\n            if (dependencyState === \"blocked\") {\r\n                where.OR = [\r\n                    ...(where.OR || []),\r\n                    { status: \"waiting\" },\r\n                    {\r\n                        dependencies: {\r\n                            some: {\r\n                                dependsOnTask: {\r\n                                    status: { not: \"completed\" },\r\n                                },\r\n                            },\r\n                        },\r\n                    },\r\n                ]\r\n            } else if (dependencyState === \"free\") {\r\n                where.dependencies = { none: {} }\r\n                where.status = { not: \"waiting\" }\r\n            } else if (dependencyState === \"blocking\") {\r\n                where.dependents = { some: {} }\r\n            }\r\n        }\r\n\r\n        // Role-based filtering\r\n        if (session.user.role !== \"admin\") {\r\n            // For non-admins, show only tasks they're assigned to or created\r\n            const userConditions = [\r\n                { assignees: { some: { id: parseInt(session.user.id) } } },\r\n                { createdById: parseInt(session.user.id) },\r\n            ]\r\n\r\n            if (where.OR) {\r\n                where.AND = [...(where.AND || []), { OR: [...where.OR, ...userConditions] }]\r\n                delete where.OR\r\n            } else {\r\n                where.OR = userConditions\r\n            }\r\n        }\r\n\r\n        const skip = (page - 1) * limit\r\n\r\n        const [tasks, total] = await Promise.all([\r\n            prisma.task.findMany({\r\n                where,\r\n                skip,\r\n                take: limit,\r\n                orderBy: { createdAt: \"desc\" },\r\n                select: {\r\n                    id: true,\r\n                    title: true,\r\n                    description: true,\r\n                    priority: true,\r\n                    status: true,\r\n                    dueDate: true,\r\n                    projectId: true,\r\n                    createdAt: true,\r\n                    createdById: true,\r\n                    assignees: {\r\n                        select: {\r\n                            id: true,\r\n                            username: true,\r\n                            email: true,\r\n                            avatarUrl: true,\r\n                        },\r\n                    },\r\n                    project: {\r\n                        select: {\r\n                            id: true,\r\n                            name: true,\r\n                        },\r\n                    },\r\n                    _count: {\r\n                        select: {\r\n                            dependencies: true,\r\n                            dependents: true,\r\n                        },\r\n                    },\r\n                },\r\n            }),\r\n            prisma.task.count({ where }),\r\n        ])\r\n\r\n        return {\r\n            success: true,\r\n            tasks,\r\n            total,\r\n            page,\r\n            limit,\r\n        }\r\n    } catch (error: any) {\r\n        console.error(\"Error fetching tasks with filters:\", error)\r\n        return {\r\n            error: error.message || \"Failed to fetch tasks\",\r\n        }\r\n    }\r\n}\r\n\r\nexport async function createTask(formData: FormData) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    const projectId = formData.get(\"projectId\")\r\n    const projectIdNum = projectId ? parseInt(projectId as string) : undefined\r\n\r\n    // Check permission using RBAC (no role-based bypass)\r\n    const hasPermission = await hasPermissionWithoutRoleBypass(\r\n        parseInt(session.user.id),\r\n        PERMISSIONS.TASK.CREATE,\r\n        projectIdNum // projectId for project-scoped permissions\r\n    )\r\n\r\n    if (!hasPermission) {\r\n        return { error: \"Permission denied: You don't have permission to create tasks\" }\r\n    }\r\n\r\n    const title = formData.get(\"title\")\r\n    const description = formData.get(\"description\")\r\n    const priority = formData.get(\"priority\")\r\n    const assigneeIds = formData.get(\"assigneeIds\")\r\n    const dueDate = formData.get(\"dueDate\")\r\n\r\n    const validated = createTaskSchema.safeParse({\r\n        title, description, priority, projectId, assigneeIds, dueDate\r\n    })\r\n\r\n    if (!validated.success) {\r\n        console.error(\"Validation errors:\", validated.error.format())\r\n        return { error: \"Validation failed\" }\r\n    }\r\n\r\n    try {\r\n        const assigneeIds = validated.data.assigneeIds && validated.data.assigneeIds.length > 0\r\n            ? validated.data.assigneeIds\r\n            : []\r\n\r\n        const task = await prisma.task.create({\r\n            data: {\r\n                title: validated.data.title,\r\n                description: validated.data.description,\r\n                priority: validated.data.priority,\r\n                projectId: validated.data.projectId,\r\n                createdById: parseInt(session.user.id),\r\n                dueDate: validated.data.dueDate ? new Date(validated.data.dueDate) : null,\r\n                ...(assigneeIds.length > 0 && {\r\n                    assignees: {\r\n                        connect: assigneeIds.map(id => ({ id }))\r\n                    }\r\n                })\r\n            },\r\n            include: {\r\n                assignees: true,\r\n                project: true\r\n            }\r\n        })\r\n\r\n        // Create notifications for assigned users\r\n        if (assigneeIds.length > 0) {\r\n            for (const userId of assigneeIds) {\r\n                await createProjectNotification(\r\n                    validated.data.projectId,\r\n                    userId,\r\n                    {\r\n                        type: \"task\",\r\n                        entityType: \"task\",\r\n                        entityId: task.id,\r\n                        title: \"Task Assigned\",\r\n                        message: `You have been assigned to task \"${task.title}\"`,\r\n                        soundRequired: true\r\n                    }\r\n                )\r\n            }\r\n        }\r\n\r\n        // Log activity\r\n        await logActivity({\r\n            actionType: \"task_created\",\r\n            actionCategory: \"task\",\r\n            actionSummary: `Task \"${task.title}\" created`,\r\n            actionDetails: {\r\n                taskId: task.id,\r\n                taskTitle: task.title,\r\n                projectId: validated.data.projectId,\r\n            },\r\n            performedById: parseInt(session.user.id),\r\n            projectId: validated.data.projectId,\r\n            entityType: \"task\",\r\n            entityId: task.id,\r\n        })\r\n\r\n        revalidatePath(`/dashboard/projects/${validated.data.projectId}`)\r\n        revalidatePath(\"/dashboard/tasks\")\r\n        return { success: true }\r\n    } catch (e: any) {\r\n        console.error(e)\r\n        return { error: \"Failed to create task\", details: e.message }\r\n    }\r\n}\r\n\r\nexport async function getTask(id: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) throw new Error(\"Unauthorized\")\r\n\r\n    const task = await prisma.task.findUnique({\r\n        where: { id },\r\n        select: {\r\n            id: true,\r\n            title: true,\r\n            description: true,\r\n            priority: true,\r\n            status: true,\r\n            dueDate: true,\r\n            projectId: true,\r\n            createdAt: true,\r\n            createdById: true,\r\n            startedAt: true,\r\n            completedAt: true,\r\n            taskStatusId: true,\r\n            teamId: true,\r\n            assignees: {\r\n                select: {\r\n                    id: true,\r\n                    username: true,\r\n                    email: true,\r\n                    avatarUrl: true,\r\n                },\r\n            },\r\n            project: {\r\n                select: {\r\n                    id: true,\r\n                    name: true,\r\n                },\r\n            },\r\n            taskStatus: {\r\n                select: {\r\n                    id: true,\r\n                    name: true,\r\n                    color: true,\r\n                },\r\n            },\r\n            team: {\r\n                select: {\r\n                    id: true,\r\n                    name: true,\r\n                },\r\n            },\r\n            creator: {\r\n                select: {\r\n                    id: true,\r\n                    username: true,\r\n                    email: true,\r\n                    avatarUrl: true,\r\n                },\r\n            },\r\n            attachments: {\r\n                select: {\r\n                    id: true,\r\n                    fileName: true,\r\n                    fileUrl: true,\r\n                    fileSize: true,\r\n                    uploadedAt: true,\r\n                },\r\n            },\r\n            comments: {\r\n                select: {\r\n                    id: true,\r\n                    content: true,\r\n                    createdAt: true,\r\n                    author: {\r\n                        select: {\r\n                            id: true,\r\n                            username: true,\r\n                            email: true,\r\n                            avatarUrl: true,\r\n                        },\r\n                    },\r\n                },\r\n                orderBy: { createdAt: \"desc\" },\r\n            },\r\n            subtasks: {\r\n                select: {\r\n                    id: true,\r\n                    title: true,\r\n                    status: true,\r\n                    // completed: true, // Removed as it doesn't exist on Subtask model\r\n                    createdAt: true,\r\n                    assignedTo: {\r\n                        select: {\r\n                            id: true,\r\n                            username: true,\r\n                            avatarUrl: true,\r\n                        },\r\n                    },\r\n                },\r\n                orderBy: { createdAt: \"asc\" },\r\n            },\r\n            dependencies: {\r\n                select: {\r\n                    // id: true, // Removed as TaskDependency has composite key\r\n                    dependsOnTaskId: true,\r\n                    dependsOnTask: {\r\n                        select: {\r\n                            id: true,\r\n                            title: true,\r\n                            status: true,\r\n                            assignees: {\r\n                                select: {\r\n                                    id: true,\r\n                                    username: true,\r\n                                    avatarUrl: true,\r\n                                },\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n                orderBy: { createdAt: \"desc\" },\r\n            },\r\n            dependents: {\r\n                select: {\r\n                    // id: true, // Removed as TaskDependency has composite key\r\n                    taskId: true,\r\n                    task: {\r\n                        select: {\r\n                            id: true,\r\n                            title: true,\r\n                            status: true,\r\n                            assignees: {\r\n                                select: {\r\n                                    id: true,\r\n                                    username: true,\r\n                                    avatarUrl: true,\r\n                                },\r\n                            },\r\n                        },\r\n                    },\r\n                },\r\n            },\r\n            _count: {\r\n                select: {\r\n                    subtasks: true,\r\n                    dependencies: true,\r\n                    dependents: true,\r\n                    comments: true,\r\n                },\r\n            },\r\n        },\r\n    })\r\n\r\n    return task\r\n}\r\n\r\nexport async function getAllTasks() {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) throw new Error(\"Unauthorized\")\r\n\r\n    const tasks = await prisma.task.findMany({\r\n        select: {\r\n            id: true,\r\n            title: true,\r\n            description: true,\r\n            priority: true,\r\n            status: true,\r\n            dueDate: true,\r\n            projectId: true,\r\n            createdAt: true,\r\n            createdById: true,\r\n            assignees: {\r\n                select: {\r\n                    id: true,\r\n                    username: true,\r\n                    email: true,\r\n                    avatarUrl: true\r\n                }\r\n            },\r\n            project: {\r\n                select: {\r\n                    id: true,\r\n                    name: true,\r\n                    status: true\r\n                }\r\n            },\r\n            _count: {\r\n                select: {\r\n                    subtasks: true,\r\n                    dependencies: true\r\n                }\r\n            }\r\n        },\r\n        orderBy: { dueDate: \"asc\" }\r\n    })\r\n\r\n    return tasks\r\n}\r\n\r\nexport async function getMyTasks() {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) throw new Error(\"Unauthorized\")\r\n    const userId = parseInt(session.user.id)\r\n\r\n    const tasks = await prisma.task.findMany({\r\n        where: {\r\n            assignees: {\r\n                some: {\r\n                    id: userId\r\n                }\r\n            }\r\n        },\r\n        select: {\r\n            id: true,\r\n            title: true,\r\n            description: true,\r\n            priority: true,\r\n            status: true,\r\n            dueDate: true,\r\n            projectId: true,\r\n            createdAt: true,\r\n            assignees: {\r\n                select: {\r\n                    id: true,\r\n                    username: true,\r\n                    email: true,\r\n                    avatarUrl: true\r\n                }\r\n            },\r\n            project: {\r\n                select: {\r\n                    id: true,\r\n                    name: true\r\n                }\r\n            },\r\n            _count: {\r\n                select: {\r\n                    dependencies: true\r\n                }\r\n            }\r\n        },\r\n        orderBy: { dueDate: \"asc\" }\r\n    })\r\n\r\n    return tasks\r\n}\r\n\r\nconst updateTaskSchema = z.object({\r\n    title: z.string().min(1, \"Title is required\").optional().or(z.literal(\"\")),\r\n    description: z.string().optional().nullable(),\r\n    priority: z.enum([\"normal\", \"urgent\", \"high\", \"low\"]).optional(),\r\n    status: z.enum([\"pending\", \"waiting\", \"in_progress\", \"review\", \"completed\"]).optional(),\r\n    dueDate: z.string().optional().or(z.literal(\"\")),\r\n    assigneeIds: z.string().transform((str, ctx) => {\r\n        try {\r\n            const parsed = JSON.parse(str)\r\n            return Array.isArray(parsed) ? parsed as number[] : []\r\n        } catch (e) {\r\n            return []\r\n        }\r\n    }).optional(),\r\n})\r\n\r\nexport async function updateTask(taskId: number, formData: FormData) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    const existingTask = await prisma.task.findUnique({\r\n        where: { id: taskId },\r\n        select: { id: true, createdById: true, projectId: true, assignees: { select: { id: true } } }\r\n    })\r\n\r\n    if (!existingTask) {\r\n        return { error: \"Task not found\" }\r\n    }\r\n\r\n    // Check permission using RBAC (no role-based bypass)\r\n    const hasPermission = await hasPermissionWithoutRoleBypass(\r\n        parseInt(session.user.id),\r\n        PERMISSIONS.TASK.UPDATE,\r\n        existingTask.projectId // projectId for project-scoped permissions\r\n    )\r\n\r\n    // Also allow creator or assignee to update\r\n    const isCreator = existingTask.createdById === parseInt(session.user.id)\r\n    const isAssignee = existingTask.assignees.some(a => a.id === parseInt(session.user.id))\r\n\r\n    if (!hasPermission && !isCreator && !isAssignee) {\r\n        return { error: \"Permission denied: You don't have permission to update this task\" }\r\n    }\r\n\r\n    // Extract form data\r\n    const title = formData.get(\"title\") as string | null\r\n    const description = formData.get(\"description\") as string | null\r\n    const priority = formData.get(\"priority\") as string | null\r\n    const status = formData.get(\"status\") as string | null\r\n    const dueDate = formData.get(\"dueDate\") as string | null\r\n    const assigneeIds = formData.get(\"assigneeIds\") as string | null\r\n\r\n    // Check specific permissions for priority and status changes\r\n    if (priority) {\r\n        const hasPriorityPermission = await hasPermissionWithoutRoleBypass(\r\n            parseInt(session.user.id),\r\n            PERMISSIONS.TASK.CHANGE_PRIORITY,\r\n            existingTask.projectId\r\n        )\r\n        if (!hasPriorityPermission && !isCreator) {\r\n            return { error: \"Permission denied: You don't have permission to change task priority\" }\r\n        }\r\n    }\r\n\r\n    if (status) {\r\n        const hasStatusPermission = await hasPermissionWithoutRoleBypass(\r\n            parseInt(session.user.id),\r\n            PERMISSIONS.TASK.CHANGE_STATUS,\r\n            existingTask.projectId\r\n        )\r\n        if (!hasStatusPermission && !isCreator && !isAssignee) {\r\n            return { error: \"Permission denied: You don't have permission to change task status\" }\r\n        }\r\n    }\r\n\r\n    const validated = updateTaskSchema.safeParse({\r\n        title: title || undefined,\r\n        description: description || undefined,\r\n        priority: priority || undefined,\r\n        status: status || undefined,\r\n        dueDate: dueDate || undefined,\r\n        assigneeIds: assigneeIds || undefined\r\n    })\r\n\r\n    if (!validated.success) {\r\n        console.error(\"Validation errors:\", validated.error.format())\r\n        return { error: \"Validation failed\", details: JSON.stringify(validated.error.format(), null, 2) }\r\n    }\r\n\r\n    try {\r\n        const currentTask = await prisma.task.findUnique({\r\n            where: { id: taskId },\r\n            select: {\r\n                id: true,\r\n                title: true,\r\n                description: true,\r\n                priority: true,\r\n                status: true,\r\n                dueDate: true,\r\n                assignees: { select: { id: true } },\r\n                project: { select: { id: true } }\r\n            }\r\n        })\r\n\r\n        if (!currentTask) {\r\n            return { error: \"Task not found\" }\r\n        }\r\n\r\n        const updateData: any = {}\r\n\r\n        if (validated.data.title !== undefined && validated.data.title.trim() !== \"\") {\r\n            updateData.title = validated.data.title.trim()\r\n        }\r\n        if (validated.data.description !== undefined) {\r\n            updateData.description = validated.data.description || null\r\n        }\r\n        if (validated.data.priority !== undefined) {\r\n            updateData.priority = validated.data.priority\r\n        }\r\n        if (validated.data.status !== undefined) {\r\n            updateData.status = validated.data.status\r\n        }\r\n        if (validated.data.dueDate !== undefined) {\r\n            if (validated.data.dueDate && validated.data.dueDate.trim() !== \"\") {\r\n                updateData.dueDate = new Date(validated.data.dueDate)\r\n            } else {\r\n                updateData.dueDate = null\r\n            }\r\n        }\r\n\r\n        if (validated.data.assigneeIds !== undefined) {\r\n            // Check permission for task assignment (no role-based bypass)\r\n            const hasAssignPermission = await hasPermissionWithoutRoleBypass(\r\n                parseInt(session.user.id),\r\n                PERMISSIONS.TASK.ASSIGN,\r\n                existingTask.projectId\r\n            )\r\n\r\n            if (!hasAssignPermission && !isCreator) {\r\n                return { error: \"Permission denied: You don't have permission to assign tasks\" }\r\n            }\r\n\r\n            const newAssigneeIds = validated.data.assigneeIds\r\n            const currentAssigneeIds = currentTask.assignees.map(a => a.id)\r\n\r\n            const hasChanged =\r\n                newAssigneeIds.length !== currentAssigneeIds.length ||\r\n                !newAssigneeIds.every(id => currentAssigneeIds.includes(id)) ||\r\n                !currentAssigneeIds.every(id => newAssigneeIds.includes(id))\r\n\r\n            if (hasChanged) {\r\n                updateData.assignees = {\r\n                    set: newAssigneeIds.map(id => ({ id }))\r\n                }\r\n\r\n                const newlyAssigned = newAssigneeIds.filter(\r\n                    id => !currentAssigneeIds.includes(id)\r\n                )\r\n\r\n                const removedAssignees = currentAssigneeIds.filter(\r\n                    id => !newAssigneeIds.includes(id)\r\n                )\r\n\r\n                for (const userId of newlyAssigned) {\r\n                    await createProjectNotification(\r\n                        existingTask.projectId,\r\n                        userId,\r\n                        {\r\n                            type: \"task\",\r\n                            entityType: \"task\",\r\n                            entityId: taskId,\r\n                            title: \"Task Assigned\",\r\n                            message: `You have been assigned to task \"${currentTask.title || 'this task'}\"`,\r\n                            soundRequired: true\r\n                        }\r\n                    )\r\n                }\r\n\r\n                for (const userId of removedAssignees) {\r\n                    await createProjectNotification(\r\n                        existingTask.projectId,\r\n                        userId,\r\n                        {\r\n                            type: \"task\",\r\n                            entityType: \"task\",\r\n                            entityId: taskId,\r\n                            title: \"Task Assignment Removed\",\r\n                            message: `You have been removed from task \"${currentTask.title || 'this task'}\"`,\r\n                            soundRequired: false\r\n                        }\r\n                    )\r\n                }\r\n            }\r\n        }\r\n\r\n        if (Object.keys(updateData).length === 0) {\r\n            return { error: \"No changes to update\" }\r\n        }\r\n\r\n        const updatedTask = await prisma.task.update({\r\n            where: { id: taskId },\r\n            data: updateData,\r\n            include: { assignees: true }\r\n        })\r\n\r\n        await logActivity({\r\n            actionType: \"task_updated\",\r\n            actionCategory: \"task\",\r\n            actionSummary: `Task \"${updatedTask.title || currentTask.title}\" updated`,\r\n            actionDetails: {\r\n                taskId,\r\n            },\r\n            performedById: parseInt(session.user.id),\r\n            projectId: existingTask.projectId,\r\n            entityType: \"task\",\r\n            entityId: taskId,\r\n        })\r\n\r\n        revalidatePath(`/dashboard/projects/${existingTask.projectId}`)\r\n        revalidatePath(`/dashboard/projects/${existingTask.projectId}/tasks/${taskId}`)\r\n        revalidatePath(\"/dashboard/tasks\")\r\n        return { success: true }\r\n    } catch (e: any) {\r\n        console.error(\"Task update error:\", e)\r\n        return {\r\n            error: \"Failed to update task\",\r\n            details: e.message || \"Unknown error occurred. Check console for details.\"\r\n        }\r\n    }\r\n}\r\n\r\nexport async function updateTaskStatus(taskId: number, status: string | number, projectId: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    // Check permission using RBAC (no role-based bypass)\r\n    const hasPermission = await hasPermissionWithoutRoleBypass(\r\n        parseInt(session.user.id),\r\n        PERMISSIONS.TASK.CHANGE_STATUS,\r\n        projectId // projectId for project-scoped permissions\r\n    )\r\n\r\n    try {\r\n        const task = await prisma.task.findUnique({\r\n            where: { id: taskId },\r\n            select: {\r\n                id: true,\r\n                title: true,\r\n                createdById: true,\r\n                completedAt: true,\r\n                startedAt: true,\r\n                taskStatusId: true,\r\n                assignees: {\r\n                    select: {\r\n                        id: true,\r\n                        username: true,\r\n                    },\r\n                },\r\n                taskStatus: {\r\n                    select: {\r\n                        id: true,\r\n                        name: true,\r\n                        isActive: true,\r\n                        isFinal: true,\r\n                        isBlocking: true,\r\n                    },\r\n                },\r\n            },\r\n        })\r\n\r\n        if (!task) {\r\n            return { error: \"Task not found\" }\r\n        }\r\n\r\n        // Also allow creator or assignee to change status\r\n        const isCreator = task.createdById === parseInt(session.user.id)\r\n        const isAssignee = task.assignees.some(a => a.id === parseInt(session.user.id))\r\n\r\n        if (!hasPermission && !isCreator && !isAssignee) {\r\n            return { error: \"Permission denied: You don't have permission to change task status\" }\r\n        }\r\n\r\n        if (!task) {\r\n            return { error: \"Task not found\" }\r\n        }\r\n\r\n        // Check if status is a number (taskStatusId) or string (legacy status)\r\n        const taskStatusId = typeof status === \"number\" ? status : parseInt(status as string)\r\n        const isTaskStatusId = !isNaN(taskStatusId) && taskStatusId > 0\r\n\r\n        let statusName = status as string\r\n        let updateData: any = {}\r\n\r\n        if (isTaskStatusId) {\r\n            // Fetch the task status to get its name\r\n            const taskStatus = await prisma.taskStatus.findUnique({\r\n                where: { id: taskStatusId },\r\n                select: { name: true, isActive: true, isFinal: true, isBlocking: true } // Added isBlocking\r\n            })\r\n\r\n            if (!taskStatus) {\r\n                return { error: \"Task status not found\" }\r\n            }\r\n\r\n            if (!taskStatus.isActive) {\r\n                return { error: \"Cannot assign inactive task status\" }\r\n            }\r\n\r\n            // Check if attempting to complete a blocked task\r\n            if (taskStatus.isFinal) {\r\n                const blocked = await isTaskBlocked(taskId)\r\n                if (blocked) {\r\n                    return { error: \"Cannot complete task: This task is blocked by incomplete dependencies.\" }\r\n                }\r\n            }\r\n\r\n            // Logic for startedAt and completedAt\r\n            if (taskStatus.isFinal) {\r\n                updateData.completedAt = new Date();\r\n                updateData.status = \"completed\"; // Sync legacy field\r\n            } else {\r\n                // If moving out of final, clear completedAt\r\n                if (task.completedAt) {\r\n                    updateData.completedAt = null;\r\n                    updateData.status = \"in_progress\"; // Default fallback\r\n                }\r\n\r\n                // If starting (isBlocking usually implies in-progress/working) or explicitly \"in_progress\"\r\n                if ((taskStatus.name === 'in_progress' || taskStatus.isBlocking) && !task.startedAt) {\r\n                    updateData.startedAt = new Date();\r\n                }\r\n            }\r\n\r\n            updateData.taskStatusId = taskStatusId\r\n            // Sync legacy status field for compatibility\r\n            if (taskStatus.name === \"pending\" || taskStatus.name === \"waiting\" || taskStatus.name === \"in_progress\" || taskStatus.name === \"review\" || taskStatus.name === \"completed\") {\r\n                statusName = taskStatus.name\r\n                updateData.status = statusName\r\n            }\r\n        } else {\r\n            // Check if attempting to complete a blocked task (legacy status)\r\n            if (statusName === \"completed\") {\r\n                const blocked = await isTaskBlocked(taskId)\r\n                if (blocked) {\r\n                    return { error: \"Cannot complete task: This task is blocked by incomplete dependencies.\" }\r\n                }\r\n            }\r\n\r\n            // Legacy string status\r\n            updateData = { status: statusName }\r\n        }\r\n\r\n        await prisma.task.update({\r\n            where: { id: taskId },\r\n            data: updateData\r\n        })\r\n\r\n        // Create notifications for status changes\r\n        for (const assignee of task.assignees) {\r\n            await createProjectNotification(\r\n                projectId,\r\n                assignee.id,\r\n                {\r\n                    type: \"task\",\r\n                    entityType: \"task\",\r\n                    entityId: taskId,\r\n                    title: \"Task Status Updated\",\r\n                    message: `Task \"${task.title}\" status changed to ${status}`,\r\n                    soundRequired: status === \"completed\" || status === \"waiting\"\r\n                }\r\n            )\r\n        }\r\n\r\n        await logActivity({\r\n            actionType: \"task_status_updated\",\r\n            actionCategory: \"task\",\r\n            actionSummary: `Task \"${task.title}\" status updated to ${status}`,\r\n            actionDetails: {\r\n                taskId,\r\n                status,\r\n            },\r\n            performedById: parseInt(session.user.id),\r\n            projectId,\r\n            entityType: \"task\",\r\n            entityId: taskId,\r\n        })\r\n\r\n        revalidatePath(`/dashboard/projects/${projectId}`)\r\n        revalidatePath(`/dashboard/projects/${projectId}/tasks/${taskId}`)\r\n        revalidatePath(\"/dashboard/tasks\")\r\n        return { success: true }\r\n    } catch (e: any) {\r\n        console.error(e)\r\n        return { error: \"Failed to update task status\", details: e.message }\r\n    }\r\n}\r\n\r\nexport async function deleteTask(taskId: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    const task = await prisma.task.findUnique({\r\n        where: { id: taskId },\r\n        select: { id: true, createdById: true, projectId: true, title: true }\r\n    })\r\n\r\n    if (!task) {\r\n        return { error: \"Task not found\" }\r\n    }\r\n\r\n    // Check permission using RBAC (no role-based bypass)\r\n    const hasPermission = await hasPermissionWithoutRoleBypass(\r\n        parseInt(session.user.id),\r\n        PERMISSIONS.TASK.DELETE,\r\n        task.projectId // projectId for project-scoped permissions\r\n    )\r\n\r\n    // Also allow creator to delete their own tasks\r\n    const isCreator = task.createdById === parseInt(session.user.id)\r\n\r\n    if (!hasPermission && !isCreator) {\r\n        return { error: \"Permission denied: You don't have permission to delete this task\" }\r\n    }\r\n\r\n    try {\r\n        await prisma.task.delete({\r\n            where: { id: taskId }\r\n        })\r\n\r\n        await logActivity({\r\n            actionType: \"task_deleted\",\r\n            actionCategory: \"task\",\r\n            actionSummary: `Task \"${task.title}\" deleted`,\r\n            actionDetails: {\r\n                taskId,\r\n                taskTitle: task.title,\r\n            },\r\n            performedById: parseInt(session.user.id),\r\n            projectId: task.projectId,\r\n            entityType: \"task\",\r\n            entityId: taskId,\r\n        })\r\n\r\n        revalidatePath(`/dashboard/projects/${task.projectId}`)\r\n        revalidatePath(\"/dashboard/tasks\")\r\n        return { success: true }\r\n    } catch (e: any) {\r\n        console.error(e)\r\n        return { error: \"Failed to delete task\", details: e.message }\r\n    }\r\n}\r\n","\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport { z } from \"zod\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { createProjectNotification } from \"./project-notifications\"\r\nimport { logActivity } from \"@/lib/activity-logger\"\r\n\r\nconst createDependencySchema = z.object({\r\n    taskId: z.coerce.number(),\r\n    dependsOnTaskId: z.coerce.number(),\r\n    dependencyType: z.enum([\"finish_to_start\"]).default(\"finish_to_start\")\r\n})\r\n\r\n/**\r\n * Check if creating a dependency would create a circular dependency\r\n */\r\nasync function checkCircularDependency(\r\n    taskId: number,\r\n    dependsOnTaskId: number\r\n): Promise<boolean> {\r\n    // Self-dependency check\r\n    if (taskId === dependsOnTaskId) {\r\n        return true\r\n    }\r\n\r\n    // Check if dependsOnTaskId depends on taskId (direct circular)\r\n    const directCircular = await prisma.taskDependency.findUnique({\r\n        where: {\r\n            taskId_dependsOnTaskId: {\r\n                taskId: dependsOnTaskId,\r\n                dependsOnTaskId: taskId\r\n            }\r\n        }\r\n    })\r\n\r\n    if (directCircular) {\r\n        return true\r\n    }\r\n\r\n    // Check transitive circular dependencies using DFS\r\n    const visited = new Set<number>()\r\n    const stack: number[] = [dependsOnTaskId]\r\n\r\n    while (stack.length > 0) {\r\n        const currentTaskId = stack.pop()!\r\n\r\n        if (currentTaskId === taskId) {\r\n            return true // Circular dependency found\r\n        }\r\n\r\n        if (visited.has(currentTaskId)) {\r\n            continue\r\n        }\r\n\r\n        visited.add(currentTaskId)\r\n\r\n        // Get all tasks that currentTaskId depends on\r\n        const dependencies = await prisma.taskDependency.findMany({\r\n            where: { taskId: currentTaskId },\r\n            select: { dependsOnTaskId: true }\r\n        })\r\n\r\n        for (const dep of dependencies) {\r\n            if (!visited.has(dep.dependsOnTaskId)) {\r\n                stack.push(dep.dependsOnTaskId)\r\n            }\r\n        }\r\n    }\r\n\r\n    return false\r\n}\r\n\r\n/**\r\n * Check if all prerequisite tasks are completed\r\n */\r\nasync function areAllPrerequisitesCompleted(taskId: number): Promise<boolean> {\r\n    const dependencies = await prisma.taskDependency.findMany({\r\n        where: { taskId },\r\n        include: {\r\n            dependsOnTask: {\r\n                select: { status: true }\r\n            }\r\n        }\r\n    })\r\n\r\n    if (dependencies.length === 0) {\r\n        return true // No dependencies, so all are \"completed\"\r\n    }\r\n\r\n    return dependencies.every(\r\n        dep => dep.dependsOnTask.status === \"completed\"\r\n    )\r\n}\r\n\r\n/**\r\n * Update task blocking status based on dependencies\r\n */\r\nasync function updateTaskBlockingStatus(taskId: number) {\r\n    const task = await prisma.task.findUnique({\r\n        where: { id: taskId },\r\n        include: {\r\n            dependencies: {\r\n                include: {\r\n                    dependsOnTask: {\r\n                        select: { status: true, id: true, title: true }\r\n                    }\r\n                }\r\n            },\r\n            project: {\r\n                select: { id: true }\r\n            }\r\n        }\r\n    })\r\n\r\n    if (!task) return\r\n\r\n    // ... logic ...\r\n    const allCompleted = await areAllPrerequisitesCompleted(taskId)\r\n    const hasDependencies = task.dependencies.length > 0\r\n\r\n    console.log(`Checking blocking status for task ${taskId}:`, {\r\n        hasDependencies,\r\n        allCompleted,\r\n        currentStatus: task.status\r\n    })\r\n\r\n    // If task has dependencies and not all are completed, block it\r\n    if (hasDependencies && !allCompleted) {\r\n        // Only set to \"waiting\" if it's not already in a valid state\r\n        if (task.status !== \"waiting\" && task.status !== \"completed\") {\r\n            const updated = await prisma.task.update({\r\n                where: { id: taskId },\r\n                data: { status: \"waiting\" },\r\n                include: { assignees: true }\r\n            })\r\n            console.log(\"Updated task to WAITING:\", updated.id)\r\n\r\n            // Notify assignees that task is blocked\r\n            for (const assignee of updated.assignees) {\r\n                await createProjectNotification(\r\n                    task.project.id,\r\n                    assignee.id,\r\n                    {\r\n                        type: \"dependency\",\r\n                        entityType: \"task\",\r\n                        entityId: taskId,\r\n                        title: \"Task Blocked\",\r\n                        message: `Task \"${task.title}\" is now blocked by incomplete dependencies`,\r\n                        soundRequired: true // Critical notification\r\n                    }\r\n                )\r\n            }\r\n        }\r\n    } else if (hasDependencies && allCompleted) {\r\n        // All prerequisites completed, unblock if it was waiting\r\n        if (task.status === \"waiting\") {\r\n            const updated = await prisma.task.update({\r\n                where: { id: taskId },\r\n                data: { status: \"pending\" },\r\n                include: { assignees: true }\r\n            })\r\n            console.log(\"Updated task to PENDING (unblocked):\", updated.id)\r\n\r\n            // Notify assignees that task is unblocked\r\n            for (const assignee of updated.assignees) {\r\n                await createProjectNotification(\r\n                    task.project.id,\r\n                    assignee.id,\r\n                    {\r\n                        type: \"dependency\",\r\n                        entityType: \"task\",\r\n                        entityId: taskId,\r\n                        title: \"Task Unblocked\",\r\n                        message: `Task \"${task.title}\" is no longer blocked. All prerequisites are completed.`,\r\n                        soundRequired: true // Critical notification\r\n                    }\r\n                )\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Create a task dependency\r\n */\r\nexport async function createTaskDependency(formData: FormData) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    const taskId = formData.get(\"taskId\")\r\n    const dependsOnTaskId = formData.get(\"dependsOnTaskId\")\r\n    const dependencyType = formData.get(\"dependencyType\") || \"finish_to_start\"\r\n\r\n    const validated = createDependencySchema.safeParse({\r\n        taskId,\r\n        dependsOnTaskId,\r\n        dependencyType\r\n    })\r\n\r\n    if (!validated.success) {\r\n        return { error: \"Validation failed\", details: validated.error.format() }\r\n    }\r\n\r\n    try {\r\n        // Verify both tasks exist and belong to the same project\r\n        const [task, dependsOnTask] = await Promise.all([\r\n            prisma.task.findUnique({\r\n                where: { id: validated.data.taskId },\r\n                select: { projectId: true, id: true, title: true }\r\n            }),\r\n            prisma.task.findUnique({\r\n                where: { id: validated.data.dependsOnTaskId },\r\n                select: { projectId: true, id: true, title: true, assignees: true }\r\n            })\r\n        ])\r\n\r\n        if (!task || !dependsOnTask) {\r\n            return { error: \"One or both tasks not found\" }\r\n        }\r\n\r\n        if (task.projectId !== dependsOnTask.projectId) {\r\n            return { error: \"Tasks must belong to the same project\" }\r\n        }\r\n\r\n        // Self-dependency check\r\n        if (validated.data.taskId === validated.data.dependsOnTaskId) {\r\n            return { error: \"A task cannot depend on itself.\" }\r\n        }\r\n\r\n        // Check for circular dependencies\r\n        const isCircular = await checkCircularDependency(\r\n            validated.data.taskId,\r\n            validated.data.dependsOnTaskId\r\n        )\r\n\r\n        if (isCircular) {\r\n            return { error: \"Circular dependency detected. Cannot create this dependency.\" }\r\n        }\r\n\r\n        // Check if dependency already exists\r\n        const existing = await prisma.taskDependency.findUnique({\r\n            where: {\r\n                taskId_dependsOnTaskId: {\r\n                    taskId: validated.data.taskId,\r\n                    dependsOnTaskId: validated.data.dependsOnTaskId\r\n                }\r\n            }\r\n        })\r\n\r\n        if (existing) {\r\n            // Revalidate paths even if dependency exists, to ensure UI is up to date\r\n            revalidatePath(`/dashboard/projects/${task.projectId}`)\r\n            revalidatePath(`/dashboard/projects/${task.projectId}/tasks/${validated.data.taskId}`)\r\n            return {\r\n                error: \"Dependency already exists\",\r\n                success: true // Indicate it exists, so UI can refresh\r\n            }\r\n        }\r\n\r\n        // Create the dependency\r\n        const createdDependency = await prisma.taskDependency.create({\r\n            data: {\r\n                taskId: validated.data.taskId,\r\n                dependsOnTaskId: validated.data.dependsOnTaskId,\r\n                dependencyType: validated.data.dependencyType,\r\n                createdById: parseInt(session.user.id)\r\n            },\r\n            include: {\r\n                dependsOnTask: {\r\n                    select: {\r\n                        id: true,\r\n                        title: true,\r\n                        status: true\r\n                    }\r\n                }\r\n            }\r\n        })\r\n\r\n        console.log(\"âœ… Dependency created successfully:\", {\r\n            taskId: createdDependency.taskId,\r\n            dependsOnTaskId: createdDependency.dependsOnTaskId,\r\n            dependsOnTaskTitle: createdDependency.dependsOnTask.title\r\n        })\r\n\r\n        // Update blocking status\r\n        await updateTaskBlockingStatus(validated.data.taskId)\r\n\r\n        // Create project notifications\r\n        const dependentTask = await prisma.task.findUnique({\r\n            where: { id: validated.data.taskId },\r\n            include: { assignees: true }\r\n        })\r\n\r\n        // Notify prerequisite task assignees that another task depends on them\r\n        for (const assignee of dependsOnTask.assignees) {\r\n            await createProjectNotification(\r\n                task.projectId,\r\n                assignee.id,\r\n                {\r\n                    type: \"dependency\",\r\n                    entityType: \"task\",\r\n                    entityId: dependsOnTask.id,\r\n                    title: \"Task Dependency Added\",\r\n                    message: `Task \"${task.title}\" now depends on your task \"${dependsOnTask.title}\"`,\r\n                    soundRequired: false\r\n                }\r\n            )\r\n        }\r\n\r\n        // Notify dependent task assignees about the dependency (critical - task is blocked)\r\n        if (dependentTask) {\r\n            for (const assignee of dependentTask.assignees) {\r\n                await createProjectNotification(\r\n                    task.projectId,\r\n                    assignee.id,\r\n                    {\r\n                        type: \"dependency\",\r\n                        entityType: \"task\",\r\n                        entityId: validated.data.taskId,\r\n                        title: \"Task Blocked by Dependency\",\r\n                        message: `Your task \"${task.title}\" is now waiting for \"${dependsOnTask.title}\" to be completed`,\r\n                        soundRequired: true // Critical notification - task is blocked\r\n                    }\r\n                )\r\n            }\r\n\r\n            // Log task blocked activity\r\n            await logActivity({\r\n                actionType: \"task_blocked\",\r\n                actionCategory: \"dependency\",\r\n                actionSummary: `Task \"${task.title}\" blocked by dependency`,\r\n                actionDetails: {\r\n                    taskId: task.id,\r\n                    taskTitle: task.title,\r\n                    dependsOnTaskId: dependsOnTask.id,\r\n                    dependsOnTaskTitle: dependsOnTask.title,\r\n                },\r\n                performedById: parseInt(session.user.id),\r\n                affectedUserId: dependentTask.assignees.map(a => a.id)[0] || undefined,\r\n                projectId: task.projectId,\r\n                entityType: \"task\",\r\n                entityId: validated.data.taskId,\r\n            })\r\n        }\r\n\r\n        // Log activity\r\n        await logActivity({\r\n            actionType: \"dependency_added\",\r\n            actionCategory: \"dependency\",\r\n            actionSummary: `Dependency added: Task \"${task.title}\" depends on \"${dependsOnTask.title}\"`,\r\n            actionDetails: {\r\n                taskId: task.id,\r\n                taskTitle: task.title,\r\n                dependsOnTaskId: dependsOnTask.id,\r\n                dependsOnTaskTitle: dependsOnTask.title,\r\n            },\r\n            performedById: parseInt(session.user.id),\r\n            projectId: task.projectId,\r\n            entityType: \"task_dependency\",\r\n            entityId: validated.data.taskId,\r\n        })\r\n\r\n        // Verify the dependency was created by querying it back\r\n        const verifyDependency = await prisma.taskDependency.findUnique({\r\n            where: {\r\n                taskId_dependsOnTaskId: {\r\n                    taskId: validated.data.taskId,\r\n                    dependsOnTaskId: validated.data.dependsOnTaskId\r\n                }\r\n            },\r\n            include: {\r\n                dependsOnTask: {\r\n                    select: {\r\n                        id: true,\r\n                        title: true\r\n                    }\r\n                }\r\n            }\r\n        })\r\n\r\n        if (!verifyDependency) {\r\n            console.error(\"âŒ Dependency creation verification failed!\")\r\n            return { error: \"Dependency was not created successfully\" }\r\n        }\r\n\r\n        console.log(\"âœ… Dependency verified:\", {\r\n            taskId: verifyDependency.taskId,\r\n            dependsOnTaskId: verifyDependency.dependsOnTaskId,\r\n            dependsOnTaskTitle: verifyDependency.dependsOnTask.title\r\n        })\r\n\r\n        // Revalidate both project page and task detail page\r\n        revalidatePath(`/dashboard/projects/${task.projectId}`)\r\n        revalidatePath(`/dashboard/projects/${task.projectId}/tasks/${validated.data.taskId}`)\r\n        return { success: true }\r\n    } catch (e: any) {\r\n        console.error(\"Dependency Creation Error:\", e)\r\n        return { error: \"Failed to create dependency\", details: e.message }\r\n    }\r\n}\r\n\r\n/**\r\n * Remove a task dependency\r\n */\r\nexport async function removeTaskDependency(\r\n    taskId: number | string,\r\n    dependsOnTaskId: number | string\r\n) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    const tId = Number(taskId)\r\n    const dId = Number(dependsOnTaskId)\r\n\r\n    console.log(`Attempting to remove dependency: Task ${tId} depends on ${dId}`)\r\n\r\n    try {\r\n        const dependency = await prisma.taskDependency.findUnique({\r\n            where: {\r\n                taskId_dependsOnTaskId: {\r\n                    taskId: tId,\r\n                    dependsOnTaskId: dId\r\n                }\r\n            },\r\n            include: {\r\n                task: { select: { projectId: true, id: true, title: true } },\r\n                dependsOnTask: { select: { id: true, title: true } }\r\n            }\r\n        })\r\n\r\n        if (!dependency) {\r\n            console.error(`Dependency not found: Task ${tId} -> ${dId}`)\r\n            // Check if it exists in reverse? No.\r\n            return { error: \"Dependency not found\" }\r\n        }\r\n\r\n        await prisma.taskDependency.delete({\r\n            where: {\r\n                taskId_dependsOnTaskId: {\r\n                    taskId: tId,\r\n                    dependsOnTaskId: dId\r\n                }\r\n            }\r\n        })\r\n        console.log(`Successfully removed dependency: Task ${tId} -> ${dId}`)\r\n\r\n        // Recalculate blocking status\r\n        await updateTaskBlockingStatus(tId)\r\n\r\n        // Log activity\r\n        await logActivity({\r\n            actionType: \"dependency_removed\",\r\n            actionCategory: \"dependency\",\r\n            actionSummary: `Dependency removed: Task \"${dependency.task.title}\" no longer depends on \"${dependency.dependsOnTask.title}\"`,\r\n            actionDetails: {\r\n                taskId: dependency.task.id,\r\n                taskTitle: dependency.task.title,\r\n                dependsOnTaskId: dependency.dependsOnTask.id,\r\n                dependsOnTaskTitle: dependency.dependsOnTask.title,\r\n            },\r\n            performedById: parseInt(session.user.id),\r\n            projectId: dependency.task.projectId,\r\n            entityType: \"task_dependency\",\r\n            entityId: tId,\r\n        })\r\n\r\n        revalidatePath(`/dashboard/projects/${dependency.task.projectId}`)\r\n        revalidatePath(`/dashboard/projects/${dependency.task.projectId}/tasks/${tId}`)\r\n\r\n        return { success: true }\r\n    } catch (e: any) {\r\n        console.error(\"Dependency Removal Error:\", e)\r\n        return { error: \"Failed to remove dependency\", details: e.message }\r\n    }\r\n}\r\n\r\n/**\r\n * Get all dependencies for a task\r\n */\r\nexport async function getTaskDependencies(taskId: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) throw new Error(\"Unauthorized\")\r\n\r\n    const dependencies = await prisma.taskDependency.findMany({\r\n        where: { taskId },\r\n        include: {\r\n            dependsOnTask: {\r\n                select: {\r\n                    id: true,\r\n                    title: true,\r\n                    status: true,\r\n                    assignees: {\r\n                        select: {\r\n                            id: true,\r\n                            username: true,\r\n                            avatarUrl: true,\r\n                            team: {\r\n                                select: {\r\n                                    id: true,\r\n                                    name: true\r\n                                }\r\n                            }\r\n                        }\r\n                    },\r\n                    team: {\r\n                        select: {\r\n                            id: true,\r\n                            name: true\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        orderBy: { createdAt: \"desc\" }\r\n    })\r\n\r\n    return dependencies\r\n}\r\n\r\n/**\r\n * Get all tasks that depend on a given task\r\n */\r\nexport async function getTaskDependents(taskId: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) throw new Error(\"Unauthorized\")\r\n\r\n    const dependents = await prisma.taskDependency.findMany({\r\n        where: { dependsOnTaskId: taskId },\r\n        include: {\r\n            task: {\r\n                select: {\r\n                    id: true,\r\n                    title: true,\r\n                    status: true,\r\n                    assignees: {\r\n                        select: {\r\n                            id: true,\r\n                            username: true,\r\n                            avatarUrl: true,\r\n                            team: {\r\n                                select: {\r\n                                    id: true,\r\n                                    name: true\r\n                                }\r\n                            }\r\n                        }\r\n                    },\r\n                    team: {\r\n                        select: {\r\n                            id: true,\r\n                            name: true\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        orderBy: { createdAt: \"desc\" }\r\n    })\r\n\r\n    return dependents\r\n}\r\n\r\n/**\r\n * Get available tasks for dependency creation (same project, not self, not creating circular)\r\n */\r\nexport async function getAvailableDependencyTasks(taskId: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) throw new Error(\"Unauthorized\")\r\n\r\n    const task = await prisma.task.findUnique({\r\n        where: { id: taskId },\r\n        select: { projectId: true }\r\n    })\r\n\r\n    if (!task) {\r\n        throw new Error(\"Task not found\")\r\n    }\r\n\r\n    // Get all tasks in the same project, excluding the current task\r\n    // Include completed tasks for reference (as per requirements)\r\n    // Show ALL tasks - circular dependency check will be done on submit\r\n    const availableTasks = await prisma.task.findMany({\r\n        where: {\r\n            projectId: task.projectId,\r\n            id: { not: taskId }\r\n        },\r\n        select: {\r\n            id: true,\r\n            title: true,\r\n            status: true,\r\n            assignees: {\r\n                select: {\r\n                    id: true,\r\n                    username: true,\r\n                    avatarUrl: true,\r\n                    team: {\r\n                        select: {\r\n                            id: true,\r\n                            name: true\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            team: {\r\n                select: {\r\n                    id: true,\r\n                    name: true\r\n                }\r\n            }\r\n        },\r\n        orderBy: { createdAt: \"desc\" }\r\n    })\r\n\r\n    // Return all tasks - circular dependency validation happens on creation\r\n    console.log(`Found ${availableTasks.length} tasks in project ${task.projectId} for task ${taskId}`)\r\n    return availableTasks\r\n}\r\n\r\n/**\r\n * Check if a task is blocked by dependencies\r\n */\r\nexport async function isTaskBlocked(taskId: number): Promise<boolean> {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) throw new Error(\"Unauthorized\")\r\n\r\n    const allCompleted = await areAllPrerequisitesCompleted(taskId)\r\n    const hasDependencies = await prisma.taskDependency.count({\r\n        where: { taskId }\r\n    }) > 0\r\n\r\n    return hasDependencies && !allCompleted\r\n}\r\n\r\n"],"names":[],"mappings":"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"}