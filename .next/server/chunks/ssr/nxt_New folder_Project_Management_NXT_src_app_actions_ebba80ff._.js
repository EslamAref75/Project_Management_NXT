module.exports=[962460,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(449597),g=a.i(797180),h=a.i(57693);async function i(){let a=await (0,d.getServerSession)(e.authOptions);return a?{authorized:await (0,h.hasPermissionWithoutRoleBypass)(parseInt(a.user.id),"admin.access"),session:a}:{authorized:!1,session:null}}async function j(){let{authorized:a,session:b}=await i();if(!a||!b)return{error:"Unauthorized: Only system administrators can access settings"};try{let a=await c.prisma.systemSetting.findMany({orderBy:[{category:"asc"},{key:"asc"}],include:{updater:{select:{id:!0,username:!0,email:!0}}}}),b={};return a.forEach(a=>{b[a.category]||(b[a.category]=[]),b[a.category].push({id:a.id,key:a.key,value:JSON.parse(a.value),category:a.category,description:a.description,updatedAt:a.updatedAt,updatedBy:a.updater})}),{success:!0,settings:b}}catch(a){return console.error("getAllSettings Error:",a),{error:"Failed to fetch settings",details:a.message}}}async function k(){(0,f.unstable_noStore)();try{let a=await c.prisma.systemSetting.findUnique({where:{key:"general"}});if(!a)return{success:!0,settings:{systemName:"Qeema PMS",systemLogo:"/assets/logo.png",allowRegistration:!0}};let b=JSON.parse(a.value);return{success:!0,settings:{systemName:b.systemName||"Qeema PMS",systemLogo:b.systemLogo||"/assets/logo.png",allowRegistration:void 0===b.allowRegistration||b.allowRegistration}}}catch(a){return console.error("getPublicSystemSettings Error:",a),{success:!0,settings:{systemName:"Qeema PMS",systemLogo:"/assets/logo.png",allowRegistration:!0}}}}async function l(a){let{authorized:b,session:d}=await i();if(!b||!d)return{error:"Unauthorized"};try{let b=await c.prisma.systemSetting.findUnique({where:{key:a},include:{updater:{select:{id:!0,username:!0,email:!0}}}});if(!b)return{error:"Setting not found"};return{success:!0,setting:{id:b.id,key:b.key,value:JSON.parse(b.value),category:b.category,description:b.description,updatedAt:b.updatedAt,updatedBy:b.updater}}}catch(a){return console.error("getSetting Error:",a),{error:"Failed to fetch setting",details:a.message}}}async function m(a,b,d,e){let{authorized:g,session:h}=await i();if(!g||!h)return{error:"Unauthorized"};try{let g=await c.prisma.systemSetting.findUnique({where:{key:a}});if(!g){if(e)return await n(a,e,b,"Auto-created via update");return{error:"Setting not found"}}let i=g.value,j=JSON.stringify(b),k=await c.prisma.systemSetting.update({where:{key:a},data:{value:j,updatedBy:parseInt(h.user.id)}});return await c.prisma.settingsChangeLog.create({data:{settingKey:a,oldValue:i,newValue:j,reason:d||null,userId:parseInt(h.user.id),settingId:k.id}}),(0,f.revalidatePath)("/","layout"),{success:!0,setting:k}}catch(a){return console.error("updateSetting Error:",a),{error:"Failed to update setting",details:a.message}}}async function n(a,b,d,e){let{authorized:g,session:h}=await i();if(!g||!h)return{error:"Unauthorized"};try{if(await c.prisma.systemSetting.findUnique({where:{key:a}}))return{error:"Setting with this key already exists"};let g=await c.prisma.systemSetting.create({data:{key:a,category:b,value:JSON.stringify(d),description:e||null,updatedBy:parseInt(h.user.id)}});return await c.prisma.settingsChangeLog.create({data:{settingKey:a,oldValue:null,newValue:JSON.stringify(d),reason:"Setting created",userId:parseInt(h.user.id),settingId:g.id}}),(0,f.revalidatePath)("/dashboard/settings"),{success:!0,setting:g}}catch(a){return console.error("createSetting Error:",a),{error:"Failed to create setting",details:a.message}}}async function o(a,b=50,d=0){let{authorized:e,session:f}=await i();if(!e||!f)return{error:"Unauthorized"};try{let e=a?{settingKey:a}:{},f=await c.prisma.settingsChangeLog.findMany({where:e,include:{user:{select:{id:!0,username:!0,email:!0}},setting:{select:{key:!0,category:!0}}},orderBy:{createdAt:"desc"},take:b,skip:d}),g=await c.prisma.settingsChangeLog.count({where:e});return{success:!0,logs:f.map(a=>({id:a.id,settingKey:a.settingKey,category:a.setting?.category,oldValue:a.oldValue?JSON.parse(a.oldValue):null,newValue:JSON.parse(a.newValue),reason:a.reason,changedBy:a.user,createdAt:a.createdAt})),total:g,limit:b,offset:d}}catch(a){return console.error("getSettingsChangeLog Error:",a),{error:"Failed to fetch change log",details:a.message}}}async function p(){let{authorized:a,session:b}=await i();if(!a||!b)return{error:"Unauthorized"};try{let a=[{key:"general",category:"general",value:{systemName:"Project Management System",systemLogo:"/assets/logo.png",defaultLanguage:"en",defaultTimezone:"UTC",workingDays:[1,2,3,4,5],defaultWorkingHours:{start:"09:00",end:"17:00"}},description:"General system settings"},{key:"tasks",category:"tasks",value:{statuses:[{id:1,name:"Pending",key:"pending",order:1,color:"#fbbf24",isFinal:!1,isDefault:!0},{id:2,name:"Waiting",key:"waiting",order:2,color:"#f97316",isFinal:!1,isDefault:!1},{id:3,name:"In Progress",key:"in_progress",order:3,color:"#3b82f6",isFinal:!1,isDefault:!1},{id:4,name:"Review",key:"review",order:4,color:"#a855f7",isFinal:!1,isDefault:!1},{id:5,name:"Completed",key:"completed",order:5,color:"#10b981",isFinal:!0,isDefault:!1}],priorities:[{id:1,name:"Low",key:"low",weight:1,color:"#6b7280",isDefault:!1},{id:2,name:"Normal",key:"normal",weight:2,color:"#3b82f6",isDefault:!0},{id:3,name:"High",key:"high",weight:3,color:"#f59e0b",isDefault:!1},{id:4,name:"Urgent",key:"urgent",weight:4,color:"#ef4444",isDefault:!1}]},description:"Task statuses and priority levels"},{key:"today_tasks",category:"today_tasks",value:{dailyResetTime:"00:00",resetTimezoneSource:"system",autoCarryOver:!0,carryOverRules:{excludeBlocked:!0,incompleteOnly:!0,maxDays:7},adminOverridePermissions:!0},description:"Today's Tasks configuration"},{key:"dependencies",category:"dependencies",value:{allowMultipleDependencies:!0,allowCrossTeamDependencies:!0,allowCrossProjectDependencies:!1,autoBlockTasks:!0,allowAdminManualUnblock:!0},description:"Task dependency rules"},{key:"permissions",category:"permissions",value:{admin:{taskCreation:!0,taskAssignment:!0,todayTasksManagement:!0,dependencyManagement:!0,projectCreation:!0,userManagement:!0},team_lead:{taskCreation:!0,taskAssignment:!0,todayTasksManagement:!0,dependencyManagement:!0,projectCreation:!1,userManagement:!1},developer:{taskCreation:!1,taskAssignment:!1,todayTasksManagement:!1,dependencyManagement:!1,projectCreation:!1,userManagement:!1}},description:"Default permissions by role"},{key:"notifications",category:"notifications",value:{notifyOnTodayTaskAssignment:!0,notifyOnTaskBlocked:!0,notifyOnDependencyCompleted:!0,notifyOnTaskOverdue:!0,notifyOnStatusChange:!1},description:"System-wide notification preferences"},{key:"audit",category:"audit",value:{enableSettingsChangeLogs:!0,enableOverrideLogs:!0,logRetentionPolicy:{retentionDays:365,archiveAfterDays:90,maxLogSizeMB:100}},description:"Audit and logging configuration"}],d=[];for(let e of a)if(!await c.prisma.systemSetting.findUnique({where:{key:e.key}})){let a=await c.prisma.systemSetting.create({data:{key:e.key,category:e.category,value:JSON.stringify(e.value),description:e.description,updatedBy:parseInt(b.user.id)}});d.push(a)}return{success:!0,created:d.length,message:`Initialized ${d.length} default settings`}}catch(a){return console.error("initializeDefaultSettings Error:",a),{error:"Failed to initialize settings",details:a.message}}}async function q(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};try{let d=a.get("username"),e=a.get("email");if(!d||!e)return{error:"Username and email are required"};let g=parseInt(b.user.id);if(await c.prisma.user.findFirst({where:{AND:[{id:{not:g}},{OR:[{username:d},{email:e}]}]}}))return{error:"Username or email already taken"};await c.prisma.user.update({where:{id:g},data:{username:d,email:e}});try{await c.prisma.activityLog.create({data:{userId:g,action:"update_profile",description:"User updated their profile",entityType:"user",entityId:g}})}catch(a){console.error("Failed to log activity:",a)}return(0,f.revalidatePath)("/dashboard/settings"),{success:!0,message:"Profile updated successfully"}}catch(a){return console.error("updateProfile Error:",a),{error:"Failed to update profile",details:a.message}}}async function r(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};try{let d=a.get("currentPassword"),e=a.get("newPassword");if(!d||!e)return{error:"Current password and new password are required"};if(e.length<6)return{error:"New password must be at least 6 characters long"};let f=parseInt(b.user.id),h=await c.prisma.user.findUnique({where:{id:f},select:{id:!0,passwordHash:!0}});if(!h)return{error:"User not found"};if(!await g.default.compare(d,h.passwordHash))return{error:"Current password is incorrect"};let i=await g.default.hash(e,10);await c.prisma.user.update({where:{id:f},data:{passwordHash:i}});try{await c.prisma.activityLog.create({data:{userId:f,action:"change_password",description:"User changed their password",entityType:"user",entityId:f}})}catch(a){console.error("Failed to log activity:",a)}return{success:!0,message:"Password changed successfully"}}catch(a){return console.error("changePassword Error:",a),{error:"Failed to change password",details:a.message}}}(0,a.i(287907).ensureServerEntryExports)([j,k,l,m,n,o,p,q,r]),(0,b.registerServerReference)(j,"007e87ba61b31694665ed5a2760917aca0012a5804",null),(0,b.registerServerReference)(k,"0033db22356cbf8845a3517099b63dfc38d1147299",null),(0,b.registerServerReference)(l,"4026a74581aa372e707f7e9425f5c768011a945151",null),(0,b.registerServerReference)(m,"7856a9cd98bf3a731a97f71b1b70c5ad4d859adbb2",null),(0,b.registerServerReference)(n,"78fb7dd63cbd70865d3475dc975e9fa1593831d593",null),(0,b.registerServerReference)(o,"70b427cd64ca79bb572257b00709719ab51716cf24",null),(0,b.registerServerReference)(p,"00c0f288754b226caea3cc3ea08416b1a0ffe772c7",null),(0,b.registerServerReference)(q,"4014896b5d2affbb03c83dbddeb66e1724203ab137",null),(0,b.registerServerReference)(r,"4030a94bd5b3ca5815ae2cd1d1725e523f9f88fa17",null),a.s(["changePassword",()=>r,"getPublicSystemSettings",()=>k,"updateProfile",()=>q,"updateSetting",()=>m])},153544,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(449597);async function g(a,b){try{let f=await (0,d.getServerSession)(e.authOptions);if(!f?.user?.id)return{success:!1,error:"Unauthorized"};let g=parseInt(f.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:g,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let h=b?.limit||20,i=b?.offset||0,j={projectId:a,userId:g};b?.type&&(j.type=b.type),b?.isRead!==void 0&&(j.isRead=b.isRead);let[k,l]=await Promise.all([c.prisma.projectNotification.findMany({where:j,orderBy:[{isUrgent:"desc"},{requiresAcknowledgment:"desc"},{createdAt:"desc"}],take:h,skip:i}),c.prisma.projectNotification.count({where:j})]);return{success:!0,notifications:k,total:l}}catch(a){return console.error("Error fetching project notifications:",a),{success:!1,error:"Failed to fetch notifications"}}}async function h(){try{let a=await (0,d.getServerSession)(e.authOptions);if(!a?.user?.id)return{success:!1,error:"Unauthorized"};let b=parseInt(a.user.id),f=await c.prisma.projectUser.findMany({where:{userId:b,leftAt:null},select:{projectId:!0}}),g=[];try{g=await c.prisma.task.findMany({where:{assignees:{some:{id:b}}},select:{projectId:!0}})}catch(a){console.warn("[Notifications] Could not fetch tasks, using only ProjectUser:",a?.message),g=[]}let h=f.map(a=>a.projectId),i=g.map(a=>a.projectId),j=[...new Set([...h,...i])];if(0===j.length)return{success:!0,count:0};let k=0;try{k=await c.prisma.projectNotification.count({where:{projectId:{in:j},userId:b,isRead:!1}})}catch(a){return console.error("[Notifications] ProjectNotification model not available. Please run 'npx prisma generate':",a?.message),{success:!0,count:0}}return{success:!0,count:k}}catch(a){return console.error("Error fetching all projects unread count:",a),console.error("Error details:",{message:a?.message,stack:a?.stack,name:a?.name}),{success:!1,error:a?.message||"Failed to fetch unread count",details:a?.stack}}}async function i(a=15){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id),g=await c.prisma.projectUser.findMany({where:{userId:f,leftAt:null},select:{projectId:!0}}),h=[];try{h=await c.prisma.task.findMany({where:{assignees:{some:{id:f}}},select:{projectId:!0}})}catch(a){console.warn("[Notifications] Could not fetch tasks, using only ProjectUser:",a?.message),h=[]}let i=g.map(a=>a.projectId),j=h.map(a=>a.projectId),k=[...new Set([...i,...j])];if(console.log(`[Notifications] User ${f} has access to projects:`,k),0===k.length)return console.log(`[Notifications] No projects found for user ${f}`),{success:!0,notifications:[]};if(!c.prisma.projectNotification)return console.error("[Notifications] ProjectNotification model not found. Please run 'npx prisma generate'"),{success:!0,notifications:[]};let l=[];try{l=await c.prisma.projectNotification.findMany({where:{projectId:{in:k},userId:f},include:{project:{select:{id:!0,name:!0}}},orderBy:{createdAt:"desc"},take:a})}catch(a){return console.error("[Notifications] Error accessing ProjectNotification model. Please run 'npx prisma generate':",a?.message),{success:!0,notifications:[]}}return console.log(`[Notifications] Found ${l.length} notifications for user ${f}`),{success:!0,notifications:l}}catch(a){return console.error("Error fetching all projects notifications:",a),console.error("Error details:",{message:a?.message,stack:a?.stack,name:a?.name}),{success:!1,error:a?.message||"Failed to fetch notifications",details:a?.stack}}}async function j(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:f,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let g=await c.prisma.projectNotification.count({where:{projectId:a,userId:f,isRead:!1}});return{success:!0,count:g}}catch(a){return console.error("Error fetching unread count:",a),{success:!1,error:"Failed to fetch unread count"}}}async function k(a,b){try{let g=await (0,d.getServerSession)(e.authOptions);if(!g?.user?.id)return{success:!1,error:"Unauthorized"};let h=parseInt(g.user.id),i=await c.prisma.projectNotification.findFirst({where:{id:b,projectId:a,userId:h}});if(!i)return{success:!1,error:"Notification not found"};if(i.isUrgent&&i.requiresAcknowledgment&&!i.acknowledgedAt)return{success:!1,error:"Urgent notifications cannot be marked as read until acknowledged. Please acknowledge the urgent project first."};return await c.prisma.projectNotification.update({where:{id:b},data:{isRead:!0}}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error marking notification as read:",a),{success:!1,error:"Failed to mark notification as read"}}}async function l(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let g=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:g,leftAt:null}}))return{success:!1,error:"Access denied to this project"};return await c.prisma.projectNotification.updateMany({where:{projectId:a,userId:g,isRead:!1,OR:[{isUrgent:!1},{requiresAcknowledgment:!1},{acknowledgedAt:{not:null}}]},data:{isRead:!0}}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error marking all notifications as read:",a),{success:!1,error:"Failed to mark all notifications as read"}}}async function m(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:f,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let g=await c.prisma.projectNotificationPreference.findUnique({where:{projectId_userId:{projectId:a,userId:f}}});return g||(g=await c.prisma.projectNotificationPreference.create({data:{projectId:a,userId:f,soundEnabled:!0,taskNotifications:!0,dependencyNotifications:!0,todayTaskNotifications:!0,projectAdminNotifications:!0}})),{success:!0,preferences:g}}catch(a){return console.error("Error fetching notification preferences:",a),{success:!1,error:"Failed to fetch preferences"}}}async function n(a,b){try{let g=await (0,d.getServerSession)(e.authOptions);if(!g?.user?.id)return{success:!1,error:"Unauthorized"};let h=parseInt(g.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:h,leftAt:null}}))return{success:!1,error:"Access denied to this project"};return await c.prisma.projectNotificationPreference.upsert({where:{projectId_userId:{projectId:a,userId:h}},create:{projectId:a,userId:h,soundEnabled:b.soundEnabled??!0,taskNotifications:b.taskNotifications??!0,dependencyNotifications:b.dependencyNotifications??!0,todayTaskNotifications:b.todayTaskNotifications??!0,projectAdminNotifications:b.projectAdminNotifications??!0},update:b}),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error updating notification preferences:",a),{success:!1,error:"Failed to update preferences"}}}async function o(a,b,d){let{type:e,entityType:g,entityId:h,title:i,message:j,soundRequired:k=!1,isUrgent:l=!1,requiresAcknowledgment:m=!1}=d;try{let d=await c.prisma.projectUser.findFirst({where:{projectId:a,userId:b,leftAt:null}});if(!d&&("task"===g||"comment_mention"===g)&&h){if(!await c.prisma.task.findFirst({where:{id:h,projectId:a,assignees:{some:{id:b}}}}))return{success:!1,error:"User not in project or assigned to task"};d=null}else if(!d&&"comment"===g&&h){let e=await c.prisma.comment.findUnique({where:{id:h},select:{taskId:!0}});if(!e||!e.taskId)return{success:!1,error:"Comment or related task not found"};if(!await c.prisma.task.findFirst({where:{id:e.taskId,projectId:a,assignees:{some:{id:b}}}}))return{success:!1,error:"User not assigned to the task related to this comment"};d=null}else if(!d)return{success:!1,error:"User not in project"};let n=await c.prisma.projectNotificationPreference.findUnique({where:{projectId_userId:{projectId:a,userId:b}}}),o=!0;if(!k)switch(e){case"task":n&&!n.taskNotifications&&(o=!1);break;case"dependency":n&&!n.dependencyNotifications&&(o=!1);break;case"today_task":n&&!n.todayTaskNotifications&&(o=!1);break;case"project_admin":n&&!n.projectAdminNotifications&&(o=!1)}if(!o)return{success:!0,skipped:!0};let p=await c.prisma.projectNotification.create({data:{projectId:a,userId:b,type:e,entityType:g,entityId:h,title:i,message:j,soundRequired:k,isUrgent:l,requiresAcknowledgment:m}});return console.log(`[Notifications] Created notification for user ${b} in project ${a}:`,{id:p.id,type:e,title:i,soundRequired:k}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0,notification:p}}catch(a){return console.error("Error creating project notification:",a),{success:!1,error:"Failed to create notification"}}}(0,a.i(287907).ensureServerEntryExports)([g,h,i,j,k,l,m,n,o]),(0,b.registerServerReference)(g,"60e11d18f808d2843f4d06a35ea4ad9027dd8b4de1",null),(0,b.registerServerReference)(h,"00686a7231b739e4fe9b8305b757bc0e83827b9865",null),(0,b.registerServerReference)(i,"4004a0aae390e2c1aeb900c79065f312ac43d90f8d",null),(0,b.registerServerReference)(j,"40c45036bf2dcfbc3a3b624285c3d3d3366fc5ed73",null),(0,b.registerServerReference)(k,"60691655a7ad6aec29ab9691d8571a0d380be93da1",null),(0,b.registerServerReference)(l,"40c086aae8b4c1ddec14829c213410ee4c5d2ec0b4",null),(0,b.registerServerReference)(m,"4073df5af18efe51e33e158abaa2dd30f11932484d",null),(0,b.registerServerReference)(n,"60d7258dffa20b5ae58a4ac333313c2a6cc4aeb7a7",null),(0,b.registerServerReference)(o,"705f7777ed9cdc6c32f418ba57dcb7f4b84f8c002a",null),a.s(["createProjectNotification",()=>o,"getAllProjectsNotifications",()=>i,"getAllProjectsUnreadNotificationCount",()=>h,"getProjectNotificationPreferences",()=>m,"getProjectNotifications",()=>g,"getProjectUnreadNotificationCount",()=>j,"markAllProjectNotificationsAsRead",()=>l,"markProjectNotificationAsRead",()=>k,"updateProjectNotificationPreferences",()=>n])}];

//# sourceMappingURL=nxt_New%20folder_Project_Management_NXT_src_app_actions_ebba80ff._.js.map