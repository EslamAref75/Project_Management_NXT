{"version":3,"sources":["../../../../../../../nxt/New%20folder/Project_Management_NXT/src/app/actions/task-statuses.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/.next-internal/server/app/dashboard/projects/%5Bid%5D/tasks/%5BtaskId%5D/page/actions.js%20%28server%20actions%20loader%29","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/app/actions/subtasks.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/app/actions/comments.ts"],"sourcesContent":["\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { z } from \"zod\"\r\nimport { logActivity } from \"@/lib/activity-logger\"\r\nimport { hasPermissionWithoutRoleBypass } from \"@/lib/rbac-helpers\"\r\nimport { PERMISSIONS } from \"@/lib/permissions\"\r\n\r\n// Helper function to check task status management permission (no role-based bypass)\r\nasync function checkTaskStatusPermission(userId: number): Promise<boolean> {\r\n    return hasPermissionWithoutRoleBypass(\r\n        userId,\r\n        PERMISSIONS.SETTINGS.TASK_STATUS_MANAGE\r\n    )\r\n}\r\n\r\nconst taskStatusSchema = z.object({\r\n    name: z.string().min(1, \"Name is required\"),\r\n    color: z.string().regex(/^#[0-9A-Fa-f]{6}$/, \"Color must be a valid hex color\"),\r\n    isDefault: z.boolean(),\r\n    isFinal: z.boolean(),\r\n    isBlocking: z.boolean(),\r\n    orderIndex: z.number().int().min(0),\r\n    isActive: z.boolean(),\r\n})\r\n\r\nexport async function getTaskStatuses(includeInactive = false) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    try {\r\n        // Check if TaskStatus model exists in Prisma client\r\n        if (!prisma.taskStatus) {\r\n            return { \r\n                error: \"TaskStatus model not found. Please stop the dev server, run 'npx prisma generate', and restart the server.\",\r\n                details: \"Prisma client needs to be regenerated after adding the TaskStatus model\"\r\n            }\r\n        }\r\n\r\n        const where = includeInactive ? {} : { isActive: true }\r\n        \r\n        const taskStatuses = await prisma.taskStatus.findMany({\r\n            where,\r\n            orderBy: [\r\n                { orderIndex: \"asc\" },\r\n                { name: \"asc\" }\r\n            ],\r\n        })\r\n\r\n        return { success: true, taskStatuses }\r\n    } catch (error: any) {\r\n        console.error(\"Error fetching task statuses:\", error)\r\n        \r\n        // Check if it's a model not found error\r\n        if (error.message?.includes(\"taskStatus\") || error.message?.includes(\"does not exist\")) {\r\n            return { \r\n                error: \"TaskStatus model not found. Please stop the dev server, run 'npx prisma generate', and restart the server.\",\r\n                details: error.message\r\n            }\r\n        }\r\n        \r\n        return { error: \"Failed to fetch task statuses\", details: error.message }\r\n    }\r\n}\r\n\r\nexport async function createTaskStatus(formData: FormData) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    const hasPermission = await checkTaskStatusPermission(parseInt(session.user.id))\r\n    if (!hasPermission) {\r\n        return { error: \"Permission denied: You don't have permission to manage task statuses\" }\r\n    }\r\n\r\n    // Check if TaskStatus model exists in Prisma client\r\n    if (!prisma.taskStatus) {\r\n        return { \r\n            error: \"TaskStatus model not found. Please stop the dev server, run 'npx prisma generate', and restart the server.\",\r\n            details: \"Prisma client needs to be regenerated after adding the TaskStatus model\"\r\n        }\r\n    }\r\n\r\n    const name = formData.get(\"name\")\r\n    const color = formData.get(\"color\") || \"#6b7280\"\r\n    const isDefaultValue = formData.get(\"isDefault\")\r\n    const isFinalValue = formData.get(\"isFinal\")\r\n    const isBlockingValue = formData.get(\"isBlocking\")\r\n    const orderIndex = formData.get(\"orderIndex\")\r\n    const isActiveValue = formData.get(\"isActive\")\r\n    \r\n    // Handle boolean values - FormData returns strings, so convert properly\r\n    const isDefault = String(isDefaultValue) === \"true\"\r\n    const isFinal = String(isFinalValue) === \"true\"\r\n    const isBlocking = String(isBlockingValue) === \"true\"\r\n    const isActive = String(isActiveValue) === \"true\"\r\n    \r\n    console.log(\"Creating task status with values:\", {\r\n        name,\r\n        color,\r\n        isDefault,\r\n        isFinal,\r\n        isBlocking,\r\n        orderIndex: orderIndex ? parseInt(orderIndex as string) : 0,\r\n        isActive,\r\n    })\r\n\r\n    // If setting as default, unset other defaults\r\n    if (isDefault) {\r\n        try {\r\n            await prisma.taskStatus.updateMany({\r\n                where: { isDefault: true },\r\n                data: { isDefault: false },\r\n            })\r\n        } catch (error: any) {\r\n            if (error.message?.includes(\"taskStatus\") || error.message?.includes(\"does not exist\")) {\r\n                console.warn(\"TaskStatus model not available, skipping default status update\")\r\n            } else {\r\n                throw error\r\n            }\r\n        }\r\n    }\r\n\r\n    const validated = taskStatusSchema.safeParse({\r\n        name,\r\n        color,\r\n        isDefault,\r\n        isFinal,\r\n        isBlocking,\r\n        orderIndex: orderIndex ? parseInt(orderIndex as string) : 0,\r\n        isActive,\r\n    })\r\n\r\n    if (!validated.success) {\r\n        console.error(\"Validation failed:\", validated.error.format())\r\n        return { error: \"Validation failed\", details: validated.error.format() }\r\n    }\r\n\r\n    try {\r\n        console.log(\"Creating task status with validated data:\", validated.data)\r\n        const taskStatus = await prisma.taskStatus.create({\r\n            data: validated.data,\r\n        })\r\n        console.log(\"Task status created successfully:\", taskStatus)\r\n\r\n        // Log activity\r\n        try {\r\n            await logActivity({\r\n                actionType: \"task_status_created\",\r\n                actionCategory: \"settings\",\r\n                actionSummary: `Task status \"${taskStatus.name}\" created`,\r\n                actionDetails: {\r\n                    statusId: taskStatus.id,\r\n                    statusName: taskStatus.name,\r\n                    color: taskStatus.color,\r\n                    isDefault: taskStatus.isDefault,\r\n                    isFinal: taskStatus.isFinal,\r\n                    isBlocking: taskStatus.isBlocking,\r\n                },\r\n                performedById: parseInt(session.user.id),\r\n                entityType: \"task_status\",\r\n                entityId: taskStatus.id,\r\n            })\r\n        } catch (logError) {\r\n            console.error(\"Failed to log activity:\", logError)\r\n            // Don't fail the creation if logging fails\r\n        }\r\n\r\n        revalidatePath(\"/dashboard/settings/projects\")\r\n        revalidatePath(\"/dashboard/tasks\")\r\n        \r\n        return { success: true, taskStatus }\r\n    } catch (error: any) {\r\n        console.error(\"Error creating task status:\", error)\r\n        console.error(\"Error details:\", {\r\n            code: error.code,\r\n            meta: error.meta,\r\n            message: error.message,\r\n        })\r\n        \r\n        // Check if table doesn't exist\r\n        if (error.code === \"P2021\" || error.message?.includes(\"does not exist\") || error.message?.includes(\"no such table\")) {\r\n            return { \r\n                error: \"Database table not found. Please run the migration: npx prisma db execute --file prisma/migrations/manual_add_task_statuses.sql --schema prisma/schema.prisma\",\r\n                details: error.message \r\n            }\r\n        }\r\n        \r\n        if (error.code === \"P2002\") {\r\n            return { error: \"A task status with this name already exists\" }\r\n        }\r\n        \r\n        return { error: \"Failed to create task status\", details: error.message }\r\n    }\r\n}\r\n\r\nexport async function updateTaskStatus(id: number, formData: FormData) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    if (session.user.role !== \"admin\") {\r\n        return { error: \"Only admins can update task statuses\" }\r\n    }\r\n\r\n    const existingStatus = await prisma.taskStatus.findUnique({\r\n        where: { id },\r\n    })\r\n\r\n    if (!existingStatus) {\r\n        return { error: \"Task status not found\" }\r\n    }\r\n\r\n    const name = formData.get(\"name\")\r\n    const color = formData.get(\"color\") || \"#6b7280\"\r\n    const isDefaultValue = formData.get(\"isDefault\")\r\n    const isFinalValue = formData.get(\"isFinal\")\r\n    const isBlockingValue = formData.get(\"isBlocking\")\r\n    const isActiveValue = formData.get(\"isActive\")\r\n    const orderIndex = formData.get(\"orderIndex\")\r\n    \r\n    // Handle boolean values - FormData returns strings, so convert properly\r\n    const isDefault = String(isDefaultValue) === \"true\"\r\n    const isFinal = String(isFinalValue) === \"true\"\r\n    const isBlocking = String(isBlockingValue) === \"true\"\r\n    const isActive = String(isActiveValue) === \"true\"\r\n    \r\n    console.log(\"Update - Parsed form values:\", {\r\n        name,\r\n        color,\r\n        isDefaultValue,\r\n        isDefault,\r\n        isFinalValue,\r\n        isFinal,\r\n        isBlockingValue,\r\n        isBlocking,\r\n        isActiveValue,\r\n        isActive,\r\n        orderIndex\r\n    })\r\n\r\n    // If setting as default, unset other defaults\r\n    if (isDefault && !existingStatus.isDefault) {\r\n        try {\r\n            await prisma.taskStatus.updateMany({\r\n                where: { isDefault: true },\r\n                data: { isDefault: false },\r\n            })\r\n        } catch (error: any) {\r\n            console.error(\"Error unsetting other defaults:\", error)\r\n        }\r\n    }\r\n\r\n    const validated = taskStatusSchema.safeParse({\r\n        name,\r\n        color,\r\n        isDefault,\r\n        isFinal,\r\n        isBlocking,\r\n        orderIndex: orderIndex ? parseInt(orderIndex as string) : existingStatus.orderIndex,\r\n        isActive,\r\n    })\r\n\r\n    if (!validated.success) {\r\n        console.error(\"Validation failed:\", validated.error.format())\r\n        return { error: \"Validation failed\", details: validated.error.format() }\r\n    }\r\n\r\n    try {\r\n        const oldValues = {\r\n            name: existingStatus.name,\r\n            color: existingStatus.color,\r\n            isDefault: existingStatus.isDefault,\r\n            isFinal: existingStatus.isFinal,\r\n            isBlocking: existingStatus.isBlocking,\r\n            isActive: existingStatus.isActive,\r\n            orderIndex: existingStatus.orderIndex,\r\n        }\r\n\r\n        const taskStatus = await prisma.taskStatus.update({\r\n            where: { id },\r\n            data: validated.data,\r\n        })\r\n\r\n        // Log activity\r\n        try {\r\n            await logActivity({\r\n                actionType: \"task_status_updated\",\r\n                actionCategory: \"settings\",\r\n                actionSummary: `Task status \"${taskStatus.name}\" updated`,\r\n                actionDetails: {\r\n                    statusId: taskStatus.id,\r\n                    oldValues,\r\n                    newValues: {\r\n                        name: taskStatus.name,\r\n                        color: taskStatus.color,\r\n                        isDefault: taskStatus.isDefault,\r\n                        isFinal: taskStatus.isFinal,\r\n                        isBlocking: taskStatus.isBlocking,\r\n                        isActive: taskStatus.isActive,\r\n                        orderIndex: taskStatus.orderIndex,\r\n                    },\r\n                },\r\n                performedById: parseInt(session.user.id),\r\n                entityType: \"task_status\",\r\n                entityId: taskStatus.id,\r\n            })\r\n        } catch (logError) {\r\n            console.error(\"Failed to log activity:\", logError)\r\n        }\r\n\r\n        revalidatePath(\"/dashboard/settings/projects\")\r\n        revalidatePath(\"/dashboard/tasks\")\r\n\r\n        return { success: true, taskStatus }\r\n    } catch (error: any) {\r\n        console.error(\"Error updating task status:\", error)\r\n        \r\n        if (error.code === \"P2002\") {\r\n            return { error: \"A task status with this name already exists\" }\r\n        }\r\n        \r\n        return { error: \"Failed to update task status\", details: error.message }\r\n    }\r\n}\r\n\r\nexport async function deleteTaskStatus(id: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    if (session.user.role !== \"admin\") {\r\n        return { error: \"Only admins can delete task statuses\" }\r\n    }\r\n\r\n    const status = await prisma.taskStatus.findUnique({\r\n        where: { id },\r\n        include: {\r\n            tasks: {\r\n                take: 1,\r\n            },\r\n        },\r\n    })\r\n\r\n    if (!status) {\r\n        return { error: \"Task status not found\" }\r\n    }\r\n\r\n    if (status.tasks.length > 0) {\r\n        return { \r\n            error: \"Cannot delete task status. It is assigned to existing tasks. Please deactivate it instead.\",\r\n            details: `${status.tasks.length} task(s) are using this status`\r\n        }\r\n    }\r\n\r\n    try {\r\n        await prisma.taskStatus.delete({\r\n            where: { id },\r\n        })\r\n\r\n        // Log activity\r\n        try {\r\n            await logActivity({\r\n                actionType: \"task_status_deleted\",\r\n                actionCategory: \"settings\",\r\n                actionSummary: `Task status \"${status.name}\" deleted`,\r\n                actionDetails: {\r\n                    statusId: status.id,\r\n                    statusName: status.name,\r\n                },\r\n                performedById: parseInt(session.user.id),\r\n                entityType: \"task_status\",\r\n                entityId: status.id,\r\n            })\r\n        } catch (logError) {\r\n            console.error(\"Failed to log activity:\", logError)\r\n        }\r\n\r\n        revalidatePath(\"/dashboard/settings/projects\")\r\n        revalidatePath(\"/dashboard/tasks\")\r\n\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        console.error(\"Error deleting task status:\", error)\r\n        return { error: \"Failed to delete task status\", details: error.message }\r\n    }\r\n}\r\n\r\nexport async function toggleTaskStatusActive(id: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    if (session.user.role !== \"admin\") {\r\n        return { error: \"Only admins can toggle task statuses\" }\r\n    }\r\n\r\n    const status = await prisma.taskStatus.findUnique({\r\n        where: { id },\r\n    })\r\n\r\n    if (!status) {\r\n        return { error: \"Task status not found\" }\r\n    }\r\n\r\n    try {\r\n        const newActiveState = !status.isActive\r\n        const updatedStatus = await prisma.taskStatus.update({\r\n            where: { id },\r\n            data: { isActive: newActiveState },\r\n        })\r\n\r\n        // Log activity\r\n        try {\r\n            await logActivity({\r\n                actionType: \"task_status_toggled\",\r\n                actionCategory: \"settings\",\r\n                actionSummary: `Task status \"${status.name}\" ${newActiveState ? \"activated\" : \"deactivated\"}`,\r\n                actionDetails: {\r\n                    statusId: status.id,\r\n                    statusName: status.name,\r\n                    oldValue: status.isActive,\r\n                    newValue: newActiveState,\r\n                },\r\n                performedById: parseInt(session.user.id),\r\n                entityType: \"task_status\",\r\n                entityId: status.id,\r\n            })\r\n        } catch (logError) {\r\n            console.error(\"Failed to log activity:\", logError)\r\n        }\r\n\r\n        revalidatePath(\"/dashboard/settings/projects\")\r\n        revalidatePath(\"/dashboard/tasks\")\r\n\r\n        return { success: true, taskStatus: updatedStatus }\r\n    } catch (error: any) {\r\n        console.error(\"Error toggling task status:\", error)\r\n        return { error: \"Failed to toggle task status\", details: error.message }\r\n    }\r\n}\r\n\r\nexport async function reorderTaskStatuses(ids: number[]) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    if (session.user.role !== \"admin\") {\r\n        return { error: \"Only admins can reorder task statuses\" }\r\n    }\r\n\r\n    try {\r\n        // Update order index for each status\r\n        const updates = ids.map((id, index) =>\r\n            prisma.taskStatus.update({\r\n                where: { id },\r\n                data: { orderIndex: index },\r\n            })\r\n        )\r\n\r\n        await Promise.all(updates)\r\n\r\n        // Log activity\r\n        try {\r\n            await logActivity({\r\n                actionType: \"task_statuses_reordered\",\r\n                actionCategory: \"settings\",\r\n                actionSummary: \"Task statuses reordered\",\r\n                actionDetails: {\r\n                    newOrder: ids,\r\n                },\r\n                performedById: parseInt(session.user.id),\r\n                entityType: \"task_status\",\r\n                entityId: ids[0] || 0,\r\n            })\r\n        } catch (logError) {\r\n            console.error(\"Failed to log activity:\", logError)\r\n        }\r\n\r\n        revalidatePath(\"/dashboard/settings/projects\")\r\n        revalidatePath(\"/dashboard/tasks\")\r\n\r\n        return { success: true }\r\n    } catch (error: any) {\r\n        console.error(\"Error reordering task statuses:\", error)\r\n        return { error: \"Failed to reorder task statuses\", details: error.message }\r\n    }\r\n}\r\n\r\n","export {getPublicSystemSettings as '0033db22356cbf8845a3517099b63dfc38d1147299'} from 'ACTIONS_MODULE0'\nexport {getAllProjectsUnreadNotificationCount as '00686a7231b739e4fe9b8305b757bc0e83827b9865'} from 'ACTIONS_MODULE1'\nexport {getAllProjectsNotifications as '4004a0aae390e2c1aeb900c79065f312ac43d90f8d'} from 'ACTIONS_MODULE1'\nexport {markProjectNotificationAsRead as '60691655a7ad6aec29ab9691d8571a0d380be93da1'} from 'ACTIONS_MODULE1'\nexport {getAllTasks as '000fbd81a81ae8a8928c77cb3ace462c34a924fe15'} from 'ACTIONS_MODULE2'\nexport {getMyTasks as '00176f3ab9f7a89d717fcba315d11e24c1f7818b0b'} from 'ACTIONS_MODULE2'\nexport {createTask as '402d88094f0d43ffbbdb2cc55981130389e939c098'} from 'ACTIONS_MODULE2'\nexport {getTasksWithFilters as '403db43b4fa87e3c4395d96062ae591067c02e1975'} from 'ACTIONS_MODULE2'\nexport {getTask as '408efdebfc4004ac6153e7e7c6e1bfcf2efead0da8'} from 'ACTIONS_MODULE2'\nexport {deleteTask as '40db1cdcc45db655c6914f09995d8097bcc488bbce'} from 'ACTIONS_MODULE2'\nexport {updateTask as '6066449d29d31fc61eee331d63571737ef28220e06'} from 'ACTIONS_MODULE2'\nexport {updateTaskStatus as '709a22b83fb95b514103e9a68c206c65a10f984982'} from 'ACTIONS_MODULE2'\nexport {getAllProjectsUnreadNotificationCount as '00686a7231b739e4fe9b8305b757bc0e83827b9865'} from 'ACTIONS_MODULE1'\nexport {getAllProjectsNotifications as '4004a0aae390e2c1aeb900c79065f312ac43d90f8d'} from 'ACTIONS_MODULE1'\nexport {getProjectNotificationPreferences as '4073df5af18efe51e33e158abaa2dd30f11932484d'} from 'ACTIONS_MODULE1'\nexport {markAllProjectNotificationsAsRead as '40c086aae8b4c1ddec14829c213410ee4c5d2ec0b4'} from 'ACTIONS_MODULE1'\nexport {getProjectUnreadNotificationCount as '40c45036bf2dcfbc3a3b624285c3d3d3366fc5ed73'} from 'ACTIONS_MODULE1'\nexport {markProjectNotificationAsRead as '60691655a7ad6aec29ab9691d8571a0d380be93da1'} from 'ACTIONS_MODULE1'\nexport {updateProjectNotificationPreferences as '60d7258dffa20b5ae58a4ac333313c2a6cc4aeb7a7'} from 'ACTIONS_MODULE1'\nexport {getProjectNotifications as '60e11d18f808d2843f4d06a35ea4ad9027dd8b4de1'} from 'ACTIONS_MODULE1'\nexport {createProjectNotification as '705f7777ed9cdc6c32f418ba57dcb7f4b84f8c002a'} from 'ACTIONS_MODULE1'\nexport {logActivity as '40daa1d9c7314de4957a7669434db12aaa24630ba4'} from 'ACTIONS_MODULE3'\nexport {getTaskDependents as '4009825537fe252354e189caeeedab8c017606c70b'} from 'ACTIONS_MODULE4'\nexport {getTaskDependencies as '401205bebba1cf3dc7d8ff35126dbeee53f67d0ee7'} from 'ACTIONS_MODULE4'\nexport {isTaskBlocked as '402619b555ef898d642e1eaa38261c5090360b7909'} from 'ACTIONS_MODULE4'\nexport {createTaskDependency as '40b408831ea3954e375d99f8ba4ff27359527e7e4b'} from 'ACTIONS_MODULE4'\nexport {getAvailableDependencyTasks as '40dd61ff2058f534f42f49da426a52f160b4b04ec1'} from 'ACTIONS_MODULE4'\nexport {removeTaskDependency as '604f3a4a12d21d9ff500f2582d8b0d2c84fbc7c29b'} from 'ACTIONS_MODULE4'\nexport {getUsers as '0078a5996050e1da89a66893bd05780e75185392cb'} from 'ACTIONS_MODULE5'\nexport {createUser as '401fc4e21517ebfbd3eebabb3ac6ad3bf2fb7443a7'} from 'ACTIONS_MODULE5'\nexport {getUser as '406fd270e8a350e38c78e4b79321560707aa26fd1a'} from 'ACTIONS_MODULE5'\nexport {deleteUser as '40abdcd9a05b7e5b6a27a4efd7412defa3f340c60c'} from 'ACTIONS_MODULE5'\nexport {updateUserTeam as '6020ac488ab0f44300111f3a8024b04b647106d187'} from 'ACTIONS_MODULE5'\nexport {toggleUserStatus as '60b33fdd6fc55215f2569d47e96e5d33d33f4f707f'} from 'ACTIONS_MODULE5'\nexport {updateUser as '60e1fb0fb657783a6424ba7525af9dca8a6316a12b'} from 'ACTIONS_MODULE5'\nexport {createSubtask as '4092279ff8e6ca25b90aeb832f385d51d9d7c60d48'} from 'ACTIONS_MODULE6'\nexport {updateSubtask as '600329ba0ba9cc97651d7734bbf3d4a35a31ef80d5'} from 'ACTIONS_MODULE6'\nexport {deleteSubtask as '403f8a5c068c0438ff16759bb9ee34241fe1078c6f'} from 'ACTIONS_MODULE6'\nexport {removeTaskDependency as '604f3a4a12d21d9ff500f2582d8b0d2c84fbc7c29b'} from 'ACTIONS_MODULE4'\nexport {createTaskDependency as '40b408831ea3954e375d99f8ba4ff27359527e7e4b'} from 'ACTIONS_MODULE4'\nexport {getAvailableDependencyTasks as '40dd61ff2058f534f42f49da426a52f160b4b04ec1'} from 'ACTIONS_MODULE4'\nexport {createComment as '40a65e7babeb7969d8364ec60bd423ee1c78b2ae4a'} from 'ACTIONS_MODULE7'\nexport {updateTask as '6066449d29d31fc61eee331d63571737ef28220e06'} from 'ACTIONS_MODULE2'\nexport {deleteTask as '40db1cdcc45db655c6914f09995d8097bcc488bbce'} from 'ACTIONS_MODULE2'\nexport {updateTaskStatus as '709a22b83fb95b514103e9a68c206c65a10f984982'} from 'ACTIONS_MODULE2'\nexport {getTaskStatuses as '4086c7fd748133615eeab378484f8213d761238fbf'} from 'ACTIONS_MODULE8'\n","\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { z } from \"zod\"\r\n\r\nconst createSubtaskSchema = z.object({\r\n    parentTaskId: z.number(),\r\n    title: z.string().min(1, \"Title is required\"),\r\n    description: z.string().optional(),\r\n    priority: z.enum([\"low\", \"medium\", \"high\", \"critical\", \"normal\"]).default(\"normal\"),\r\n    startDate: z.string().optional().nullable(), // ISO string from form\r\n    dueDate: z.string().optional().nullable(),\r\n    estimatedHours: z.number().min(0).default(0),\r\n    assignedToId: z.number().optional().nullable(),\r\n    teamId: z.number().optional().nullable(),\r\n})\r\n\r\nexport async function createSubtask(formData: z.input<typeof createSubtaskSchema>) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    const result = createSubtaskSchema.safeParse(formData)\r\n    if (!result.success) {\r\n        console.error(\"Validation failed object:\", JSON.stringify(result, null, 2))\r\n        const formatted = result.error.flatten()\r\n        console.error(\"Flattened errors:\", formatted)\r\n\r\n        const firstFieldError = Object.values(formatted.fieldErrors)[0]?.[0]\r\n        const firstFormError = formatted.formErrors[0]\r\n\r\n        return { error: firstFieldError || firstFormError || \"Invalid input\" }\r\n    }\r\n\r\n    const { parentTaskId, title, description, priority, startDate, dueDate, estimatedHours, assignedToId, teamId } = result.data\r\n    const userId = parseInt(session.user.id)\r\n\r\n    try {\r\n        // Verify parent task exists\r\n        const parentTask = await prisma.task.findUnique({\r\n            where: { id: parentTaskId }\r\n        })\r\n\r\n        if (!parentTask) {\r\n            return { error: \"Parent task not found\" }\r\n        }\r\n\r\n        const subtask = await prisma.subtask.create({\r\n            data: {\r\n                title,\r\n                description,\r\n                priority,\r\n                startDate: startDate ? new Date(startDate) : null,\r\n                dueDate: dueDate ? new Date(dueDate) : null,\r\n                estimatedHours,\r\n                parentTaskId,\r\n                createdById: userId,\r\n                assignedToId,\r\n                teamId,\r\n            }\r\n        })\r\n\r\n        revalidatePath(`/dashboard/projects/${parentTask.projectId}/tasks/${parentTaskId}`)\r\n        revalidatePath(`/dashboard/tasks/${parentTaskId}`)\r\n        revalidatePath(`/dashboard/tasks`)\r\n        return { success: true, subtask }\r\n    } catch (e: any) {\r\n        console.error(\"Create Subtask Error:\", e)\r\n        return { error: \"Failed to create subtask\" }\r\n    }\r\n}\r\n\r\nexport async function getSubtasks(parentTaskId: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    try {\r\n        const subtasks = await prisma.subtask.findMany({\r\n            where: { parentTaskId },\r\n            include: {\r\n                assignedTo: {\r\n                    select: {\r\n                        id: true,\r\n                        username: true,\r\n                        avatarUrl: true\r\n                    }\r\n                },\r\n                creator: {\r\n                    select: {\r\n                        username: true\r\n                    }\r\n                }\r\n            },\r\n            orderBy: { createdAt: 'asc' }\r\n        })\r\n        return { subtasks }\r\n    } catch (e) {\r\n        return { error: \"Failed to fetch subtasks\" }\r\n    }\r\n}\r\n\r\n\r\nexport async function updateSubtask(subtaskId: number, data: Partial<z.infer<typeof createSubtaskSchema>> & { status?: string }) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    try {\r\n        const subtask = await prisma.subtask.update({\r\n            where: { id: subtaskId },\r\n            data: {\r\n                ...data,\r\n                // Cast start/due dates if present because Zod schema might differ slightly from Prisma expect\r\n                startDate: data.startDate === null ? null : (data.startDate ? new Date(data.startDate) : undefined),\r\n                dueDate: data.dueDate === null ? null : (data.dueDate ? new Date(data.dueDate) : undefined),\r\n            },\r\n            include: { parentTask: true }\r\n        })\r\n\r\n        if (subtask.parentTask) {\r\n            revalidatePath(`/dashboard/projects/${subtask.parentTask.projectId}/tasks/${subtask.parentTaskId}`)\r\n        }\r\n\r\n        revalidatePath(`/dashboard/tasks/${subtask.parentTaskId}`)\r\n        revalidatePath(`/dashboard/tasks`)\r\n        return { success: true, subtask }\r\n    } catch (e) {\r\n        console.error(\"Update Subtask Error:\", e)\r\n        return { error: \"Failed to update subtask\" }\r\n    }\r\n}\r\n\r\nexport async function deleteSubtask(subtaskId: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    try {\r\n        const subtask = await prisma.subtask.delete({\r\n            where: { id: subtaskId },\r\n            include: { parentTask: true }\r\n        })\r\n\r\n        if (subtask.parentTask) {\r\n            revalidatePath(`/dashboard/projects/${subtask.parentTask.projectId}/tasks/${subtask.parentTaskId}`)\r\n        }\r\n\r\n        revalidatePath(`/dashboard/tasks/${subtask.parentTaskId}`)\r\n        revalidatePath(`/dashboard/tasks`)\r\n        return { success: true }\r\n    } catch (e) {\r\n        return { error: \"Failed to delete subtask\" }\r\n    }\r\n}\r\n","\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport { z } from \"zod\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { createProjectNotification } from \"./project-notifications\"\r\n\r\nconst commentSchema = z.object({\r\n    content: z.string().min(1, \"Content is required\"),\r\n    taskId: z.coerce.number(),\r\n    projectId: z.coerce.number(), // Needed for revalidation\r\n})\r\n\r\n// Extract @mentions from text (format: @username)\r\nfunction extractMentions(text: string): string[] {\r\n    const mentionRegex = /@([\\w.-]+)/g\r\n    const matches = text.match(mentionRegex)\r\n    if (!matches) return []\r\n    // Remove @ symbol and return unique usernames\r\n    return [...new Set(matches.map(m => m.substring(1)))]\r\n}\r\n\r\nexport async function createComment(formData: FormData) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { error: \"Unauthorized\" }\r\n\r\n    const content = formData.get(\"content\") as string\r\n    const taskId = formData.get(\"taskId\")\r\n    const projectId = formData.get(\"projectId\")\r\n\r\n    const validated = commentSchema.safeParse({ content, taskId, projectId })\r\n\r\n    if (!validated.success) {\r\n        return { error: \"Validation failed\" }\r\n    }\r\n\r\n    try {\r\n        // Get the task to access project info\r\n        const task = await prisma.task.findUnique({\r\n            where: { id: validated.data.taskId },\r\n            select: { id: true, title: true, projectId: true }\r\n        })\r\n\r\n        if (!task) {\r\n            return { error: \"Task not found\" }\r\n        }\r\n\r\n        // Create the comment\r\n        const comment = await prisma.comment.create({\r\n            data: {\r\n                content: validated.data.content,\r\n                taskId: validated.data.taskId,\r\n                userId: parseInt(session.user.id)\r\n            }\r\n        })\r\n\r\n        // Extract mentions from content\r\n        const mentionedUsernames = extractMentions(validated.data.content)\r\n        console.log(\"ðŸ“ Comment Content:\", validated.data.content)\r\n        console.log(\"ðŸ‘€ Extracted Mentions:\", mentionedUsernames)\r\n\r\n        if (mentionedUsernames.length > 0) {\r\n            // Get mentioned users\r\n            const mentionedUsers = await prisma.user.findMany({\r\n                where: {\r\n                    username: { in: mentionedUsernames }\r\n                },\r\n                select: { id: true, username: true }\r\n            })\r\n            console.log(\"ðŸ‘¥ Found Mentioned Users:\", mentionedUsers)\r\n\r\n            const author = await prisma.user.findUnique({\r\n                where: { id: parseInt(session.user.id) },\r\n                select: { username: true }\r\n            })\r\n\r\n            // Create mention records and notifications\r\n            for (const user of mentionedUsers) {\r\n                // Don't notify if user mentions themselves\r\n                if (user.id === parseInt(session.user.id)) {\r\n                    console.log(\"ðŸš« Skipping self-mention for user:\", user.username)\r\n                    continue\r\n                }\r\n\r\n                // Create mention record\r\n                await prisma.commentMention.create({\r\n                    data: {\r\n                        commentId: comment.id,\r\n                        userId: user.id\r\n                    }\r\n                })\r\n\r\n                // Create notification for mentioned user\r\n                console.log(\"ðŸ”” Creating notification for:\", user.username)\r\n                await createProjectNotification(\r\n                    validated.data.projectId,\r\n                    user.id,\r\n                    {\r\n                        type: \"comment_mention\",\r\n                        entityType: \"comment_mention\",\r\n                        entityId: validated.data.taskId,\r\n                        title: \"You were mentioned in a comment\",\r\n                        message: `${author?.username || \"Someone\"} mentioned you in a comment on task \"${task.title}\"`,\r\n                        soundRequired: true,\r\n                        isUrgent: false,\r\n                        requiresAcknowledgment: false\r\n                    }\r\n                )\r\n            }\r\n        }\r\n\r\n        // precise path revalidation\r\n        revalidatePath(`/dashboard/projects/${validated.data.projectId}/tasks/${validated.data.taskId}`)\r\n        return { success: true }\r\n    } catch (e) {\r\n        console.error(e)\r\n        return { error: \"Failed to create comment\" }\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}