module.exports=[462266,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(661698),g=a.i(449597),h=a.i(126695),i=a.i(57693),j=a.i(766050),k=a.i(287907);let l=f.z.object({name:f.z.string().min(1,"Name is required"),type:f.z.string().optional(),projectTypeId:f.z.coerce.number().optional().nullable(),projectStatusId:f.z.coerce.number().optional().nullable(),description:f.z.string().optional(),scope:f.z.string().optional(),status:f.z.string().optional(),startDate:f.z.string().optional(),endDate:f.z.string().optional(),projectManagerId:f.z.coerce.number().optional()});async function m(){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");return await c.prisma.project.findMany({orderBy:{createdAt:"desc"},select:{id:!0,name:!0,description:!0,status:!0,type:!0,projectStatusId:!0,projectTypeId:!0,projectManagerId:!0,startDate:!0,endDate:!0,createdAt:!0,createdById:!0,projectManager:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}},_count:{select:{tasks:!0,projectUsers:!0,notifications:!0}}}})}async function n(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};let{search:f="",category:g=[],status:h=[],priority:j=[],startDate:k,endDate:l,projectManager:m,page:n=1,limit:o=12}=a;try{let a={};if(f&&(a.name={contains:f}),g.length>0&&(a.type={in:g}),h.length>0){let b=[],c=[];h.forEach(a=>{let d=parseInt(a);isNaN(d)?c.push(a):b.push(d)});let d=[];b.length>0&&d.push({projectStatusId:{in:b}});let e=c.filter(a=>"active"!==a&&"completed"!==a);e.length>0&&d.push({status:{in:e},projectStatusId:null}),c.includes("active")&&(d.push({status:"active"}),d.push({projectStatus:{isActive:!0}})),c.includes("completed")&&(d.push({status:"completed"}),d.push({projectStatus:{isFinal:!0}})),d.length>0&&(a.OR=d),j.length>0&&(a.priority={in:j})}if(k||l){let b=[];k&&b.push({startDate:{gte:new Date(k)}}),l&&b.push({endDate:{lte:new Date(l)}}),b.length>0&&(a.AND=[...a.AND||[],...b])}if(m&&(a.projectManagerId=parseInt(m)),!await (0,i.hasPermissionWithoutRoleBypass)(parseInt(b.user.id),"project.viewAll")){let c=[{projectManagerId:parseInt(b.user.id)},{createdById:parseInt(b.user.id)}];a.OR?(a.AND=[...a.AND||[],{OR:[...a.OR,...c]}],delete a.OR):a.OR=c}let[d,e]=await Promise.all([c.prisma.project.findMany({where:a,skip:(n-1)*o,take:o,orderBy:{createdAt:"desc"},select:{id:!0,name:!0,description:!0,status:!0,type:!0,projectStatusId:!0,projectTypeId:!0,projectManagerId:!0,startDate:!0,endDate:!0,createdAt:!0,createdById:!0,projectManager:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}},_count:{select:{tasks:!0,projectUsers:!0,notifications:!0}}}}),c.prisma.project.count({where:a})]);return{success:!0,projects:d,total:e,page:n,limit:o}}catch(a){return console.error("Error fetching projects with filters:",a),{error:a.message||"Failed to fetch projects"}}}async function o(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};if(!await (0,i.hasPermissionWithoutRoleBypass)(parseInt(b.user.id),j.PERMISSIONS.PROJECT.CREATE))return{error:"Permission denied: You don't have permission to create projects"};let f=a.get("name"),k=a.get("type"),m=a.get("projectTypeId"),n=a.get("description"),o=a.get("scope"),p=a.get("startDate"),q=a.get("endDate"),r=a.get("projectManagerId"),s=k||"";if(m)try{let a=await c.prisma.projectType.findUnique({where:{id:parseInt(m)},select:{name:!0}});a&&(s=a.name)}catch(a){console.error("Error fetching project type:",a)}let t=l.safeParse({name:f,type:s||void 0,projectTypeId:m?parseInt(m):null,description:n,scope:o,startDate:p,endDate:q,projectManagerId:r});if(!t.success)return console.error(t.error),{error:"Validation failed",details:t.error.format()};try{let a=await c.prisma.project.create({data:{name:t.data.name,type:t.data.type||"",projectTypeId:t.data.projectTypeId,description:t.data.description,scope:t.data.scope,status:t.data.status,startDate:t.data.startDate?new Date(t.data.startDate):null,endDate:t.data.endDate?new Date(t.data.endDate):null,projectManagerId:t.data.projectManagerId&&t.data.projectManagerId>0?t.data.projectManagerId:null,createdById:parseInt(b.user.id)}});try{await (0,h.logActivity)({actionType:"project_created",actionCategory:"project",actionSummary:`Project "${a.name}" created`,actionDetails:{projectId:a.id,projectName:a.name,projectType:a.type,status:a.status},performedById:parseInt(b.user.id),projectId:a.id,entityType:"project",entityId:a.id}),console.log("[Project Creation] Activity logging completed")}catch(a){console.error("[Project Creation] Failed to log activity:",a)}return(0,g.revalidatePath)("/dashboard/projects"),(0,g.revalidatePath)("/dashboard"),{success:!0}}catch(a){return console.error(a),{error:"Failed to create project"}}}async function p(a){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");let[b,f,g]=await Promise.all([c.prisma.project.findUnique({where:{id:a},select:{id:!0,name:!0,description:!0,status:!0,type:!0,priority:!0,projectStatusId:!0,projectTypeId:!0,projectManagerId:!0,startDate:!0,endDate:!0,createdAt:!0,createdById:!0,urgentMarkedAt:!0,urgentMarkedById:!0,projectType:{select:{id:!0,name:!0}},projectStatus:{select:{id:!0,name:!0}},projectManager:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}},urgentMarkedBy:{select:{id:!0,username:!0}},_count:{select:{tasks:!0,projectUsers:!0,projectTeams:!0}}}}),c.prisma.task.findMany({where:{projectId:a},orderBy:{createdAt:"desc"},select:{id:!0,title:!0,description:!0,status:!0,taskStatusId:!0,priority:!0,dueDate:!0,createdAt:!0,assignees:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}},attachments:{select:{id:!0,fileName:!0,fileUrl:!0,fileType:!0,fileSize:!0}},dependencies:{select:{dependencyType:!0,dependsOnTaskId:!0,dependsOnTask:{select:{id:!0,title:!0,status:!0,taskStatusId:!0}}}}}}),c.prisma.projectTeam.findMany({where:{projectId:a},select:{id:!0,teamId:!0,team:{select:{id:!0,name:!0,description:!0,teamLead:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}},members:{select:{id:!0,userId:!0,user:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}}}}}}}})]);return b?{...b,tasks:f,projectTeams:g}:null}async function q(a,b){let f=await (0,d.getServerSession)(e.authOptions);if(!f)return{error:"Unauthorized"};let h=await c.prisma.project.findUnique({where:{id:a},select:{id:!0,createdById:!0}});if(!h)return{error:"Project not found"};let k=await (0,i.hasPermissionWithoutRoleBypass)(parseInt(f.user.id),j.PERMISSIONS.PROJECT.UPDATE,a),m=h.createdById===parseInt(f.user.id);if(!k&&!m)return{error:"Permission denied: You don't have permission to update this project"};let n=b.get("name"),o=b.get("type"),p=b.get("projectTypeId"),q=b.get("projectStatusId"),r=b.get("description"),s=b.get("scope"),t=b.get("status"),u=b.get("startDate"),v=b.get("endDate"),w=b.get("projectManagerId"),x=o||"";if(p)try{let a=await c.prisma.projectType.findUnique({where:{id:parseInt(p)},select:{name:!0}});a&&(x=a.name)}catch(a){console.error("Error fetching project type:",a)}let y=t||"";if(q&&c.prisma.projectStatus)try{let a=await c.prisma.projectStatus.findUnique({where:{id:parseInt(q)},select:{name:!0}});a&&(y=a.name)}catch(a){console.error("Error fetching project status:",a)}let z=l.safeParse({name:n,type:x||void 0,projectTypeId:p?parseInt(p):null,projectStatusId:q?parseInt(q):null,description:r,scope:s,status:y||void 0,startDate:u,endDate:v,projectManagerId:w});if(!z.success)return console.error(z.error),{error:"Validation failed",details:z.error.format()};try{return await c.prisma.project.update({where:{id:a},data:{name:z.data.name,type:z.data.type||"",projectTypeId:z.data.projectTypeId,projectStatusId:z.data.projectStatusId,description:z.data.description,scope:z.data.scope,status:y||z.data.status||"",startDate:z.data.startDate?new Date(z.data.startDate):null,endDate:z.data.endDate?new Date(z.data.endDate):null,projectManagerId:z.data.projectManagerId&&z.data.projectManagerId>0?z.data.projectManagerId:null}}),(0,g.revalidatePath)("/dashboard/projects"),(0,g.revalidatePath)(`/dashboard/projects/${a}`),(0,g.revalidatePath)("/dashboard"),{success:!0}}catch(a){return console.error(a),{error:"Failed to update project",details:a.message}}}async function r(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};let f=await c.prisma.project.findUnique({where:{id:a},select:{id:!0,createdById:!0,name:!0}});if(!f)return{error:"Project not found"};let h=await (0,i.hasPermissionWithoutRoleBypass)(parseInt(b.user.id),j.PERMISSIONS.PROJECT.DELETE,a),k=f.createdById===parseInt(b.user.id);if(!h&&!k)return{error:"Permission denied: You don't have permission to delete this project"};let l=await c.prisma.task.count({where:{projectId:a}});try{return await c.prisma.project.delete({where:{id:a}}),console.log(`Project ${a} deleted successfully${l>0?` along with ${l} task(s)`:""}`),(0,g.revalidatePath)("/dashboard/projects"),(0,g.revalidatePath)("/dashboard"),{success:!0}}catch(a){return console.error(a),{error:"Failed to delete project",details:a.message}}}(0,k.ensureServerEntryExports)([m,n,o,p,q,r]),(0,b.registerServerReference)(m,"003ae2a452e6e1e8ebee86f206a9903396d5df13b8",null),(0,b.registerServerReference)(n,"406144e6cbbfbe91083d4680cc56756da14a65698a",null),(0,b.registerServerReference)(o,"401e3f4be30a5d5dbee04214aa788c798e018c4c21",null),(0,b.registerServerReference)(p,"402c9fcdaf734573eeb364d1e92aac14ecf31bcfb9",null),(0,b.registerServerReference)(q,"601c00162e3e64028c2b657a9e3982df01dad141d5",null),(0,b.registerServerReference)(r,"40fdba31998d7a3efe7c944c688cf93002e917af7b",null),a.s(["createProject",()=>o,"deleteProject",()=>r,"getProject",()=>p,"getProjects",()=>m,"getProjectsWithFilters",()=>n,"updateProject",()=>q])},194893,407716,555163,a=>{"use strict";let b=Symbol.for("constructDateFrom");function c(a,c){return"function"==typeof a?a(c):a&&"object"==typeof a&&b in a?a[b](c):a instanceof Date?new a.constructor(c):new Date(c)}function d(a,b){return c(b||a,a)}a.s(["constructFromSymbol",0,b,"millisecondsInDay",0,864e5,"millisecondsInHour",0,36e5,"millisecondsInWeek",0,6048e5,"minutesInDay",0,1440,"minutesInMonth",0,43200],407716),a.s(["constructFrom",()=>c],555163),a.s(["toDate",()=>d],194893)},114678,a=>{"use strict";var b=a.i(194893);function c(a,c){let d=(0,b.toDate)(a,c?.in);return d.setHours(0,0,0,0),d}a.s(["startOfDay",()=>c])},416219,a=>{"use strict";var b=a.i(194893);function c(a,c){let d=(0,b.toDate)(a,c?.in);return d.setHours(23,59,59,999),d}a.s(["endOfDay",()=>c])},285839,443585,a=>{"use strict";var b=a.i(555163),c=a.i(194893);function d(a,d,e){let f=(0,c.toDate)(a,e?.in);return isNaN(d)?(0,b.constructFrom)(e?.in||a,NaN):(d&&f.setDate(f.getDate()+d),f)}function e(a,b,c){return d(a,-b,c)}a.s(["addDays",()=>d],443585),a.s(["subDays",()=>e],285839)},263919,a=>{"use strict";var b=a.i(347656),c=a.i(114678),d=a.i(285839),e=a.i(443585);async function f(a,d,e,f){let g=(0,c.startOfDay)(new Date),h=await b.prisma.statSnapshot.findFirst({where:{entityType:a,entityId:d,metricKey:e,date:g}});h?h.value!==f&&await b.prisma.statSnapshot.update({where:{id:h.id},data:{value:f}}):await b.prisma.statSnapshot.create({data:{entityType:a,entityId:d,metricKey:e,value:f,date:g}})}async function g(a,i,j,k,l="daily"){let m,n=(0,c.startOfDay)(new Date);if("daily"===l)m=(0,d.subDays)(n,1);else m=(0,e.addDays)(n,-7,void 0);await f(a,i,j,k);let o=await b.prisma.statSnapshot.findFirst({where:{entityType:a,entityId:i,metricKey:j,date:m}});if(!o){let c=await b.prisma.statSnapshot.findFirst({where:{entityType:a,entityId:i,metricKey:j,date:{lt:n}},orderBy:{date:"desc"}});return c?h(k,c.value):null}return h(k,o.value)}function h(a,b){if(0===b)return{direction:a>0?"up":"neutral",value:a,percentage:100*(a>0)};let c=a-b,d=Math.round(c/b*100),e="neutral";return c>0&&(e="up"),c<0&&(e="down"),{direction:e,value:Math.abs(c),percentage:Math.abs(d)}}a.s(["getStatTrend",()=>g],263919)},188417,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(114678),g=a.i(416219),h=a.i(57693),i=a.i(449597),j=a.i(263919),k=a.i(287907);let l=async a=>{try{let b=await c.prisma.task.aggregate({where:{projectId:a},_count:{id:!0}}),[d,e,f,g,h]=await Promise.all([c.prisma.task.count({where:{projectId:a,OR:[{taskStatus:{isFinal:!0}},{status:"completed",taskStatusId:null}]}}),c.prisma.task.count({where:{projectId:a,OR:[{taskStatus:{isFinal:!1}},{status:"in_progress",taskStatusId:null}]}}),c.prisma.task.count({where:{projectId:a,OR:[{taskStatus:{isBlocking:!0}},{status:"waiting",taskStatusId:null}]}}),c.prisma.task.count({where:{projectId:a,dueDate:{lt:new Date},OR:[{taskStatus:{isFinal:!1}},{status:{not:"completed"},taskStatusId:null}]}}),c.prisma.task.count({where:{projectId:a,priority:{in:["high","urgent"]},OR:[{taskStatus:{isFinal:!1}},{status:{not:"completed"},taskStatusId:null}]}})]);return{success:!0,data:{totalTasks:b._count.id,completedTasks:d,inProgressTasks:e,blockedTasks:f,overdueTasks:g,urgentTasks:h}}}catch(a){return console.error("Error fetching project stats:",a),{success:!1,error:a.message}}},m=(0,i.unstable_cache)(l,["project-stats"],{revalidate:60,tags:["project-stats"]});async function n(a){return await (0,d.getServerSession)(e.authOptions)?await m(a):{success:!1,error:"Unauthorized"}}let o=async(a,b)=>{try{let d={};b||(d.OR=[{projectManagerId:a},{createdById:a},{projectUsers:{some:{userId:a}}}]);let[e,f]=await Promise.all([c.prisma.project.count({where:d}),c.prisma.project.groupBy({by:["status","projectStatusId"],where:d,_count:{id:!0}})]),g=0,h=0,i=0;for(let a of f)("active"===a.status||null===a.status)&&(g+=a._count.id),"completed"===a.status&&(h+=a._count.id);return i=await c.prisma.project.count({where:{...d,priority:"urgent"}}),{success:!0,data:{total:e,active:g,completed:h,urgent:i}}}catch(a){return console.error("Error fetching all projects stats:",a),{success:!1,error:a.message}}},p=(0,i.unstable_cache)(o,["all-projects-stats"],{revalidate:60,tags:["projects-stats"]});async function q(){let a=await (0,d.getServerSession)(e.authOptions);if(!a)return{success:!1,error:"Unauthorized"};let b=parseInt(a.user.id),c=await (0,h.hasPermissionWithoutRoleBypass)(b,"project.viewAll");return await p(b,c)}let r=async(a,b,d)=>{try{let e=(0,f.startOfDay)(new Date),h=(0,g.endOfDay)(new Date),i={};if(b||(i.project={OR:[{projectManagerId:a},{createdById:a},{projectUsers:{some:{userId:a}}}]}),d.projectId&&"all"!==d.projectId){let a=Array.isArray(d.projectId)?d.projectId.map(a=>parseInt(a.toString())):[parseInt(d.projectId.toString())];a.length>0&&(i.projectId={in:a})}let j={...i};delete j.OR,delete j.AND;let k=[];if(i.project&&k.push({project:i.project}),i.projectId&&k.push({projectId:i.projectId}),i.priority&&k.push({priority:i.priority}),i.dueDate&&k.push({dueDate:i.dueDate}),d.priority&&d.priority.length>0){let a=Array.isArray(d.priority)?d.priority:[d.priority];a.length>0&&k.push({priority:{in:a}})}if(d.statusId&&"all"!==d.statusId){let a=Array.isArray(d.statusId)?d.statusId:[d.statusId],b=[],c=[];a.forEach(a=>{"legacy_active"===a?c.push("active"):"legacy_on_hold"===a?c.push("on_hold"):"string"==typeof a&&isNaN(parseInt(a))?c.push(a):b.push(parseInt(a.toString()))});let e=[];b.length>0&&e.push({taskStatusId:{in:b}}),c.length>0&&e.push({status:{in:c},taskStatusId:null}),e.length>0&&k.push({OR:e})}if(d.search&&k.push({OR:[{title:{contains:d.search}},{description:{contains:d.search}}]}),d.dateRange&&(d.dateRange.from||d.dateRange.to)){let a={};d.dateRange.from&&(a.gte=d.dateRange.from),d.dateRange.to&&(a.lte=d.dateRange.to),k.push({dueDate:a})}let[l,m,n,o,p,q,r]=await Promise.all([c.prisma.task.count({where:{AND:k}}),c.prisma.task.count({where:{AND:[...k,{assignees:{some:{id:a}}}]}}),c.prisma.task.count({where:{AND:[...k,{plannedDate:{gte:e,lte:h}},{OR:[{taskStatus:{isFinal:!1}},{status:{not:"completed"},taskStatusId:null}]}]}}),c.prisma.task.count({where:{AND:[...k,{OR:[{taskStatus:{isBlocking:!0}},{status:"waiting",taskStatusId:null}]}]}}),c.prisma.task.count({where:{AND:[...k,{dueDate:{lt:new Date}},{OR:[{taskStatus:{isFinal:!1}},{status:{not:"completed"},taskStatusId:null}]}]}}),c.prisma.task.count({where:{AND:[...k,{updatedAt:{gte:e,lte:h}},{OR:[{taskStatus:{isFinal:!0}},{status:"completed",taskStatusId:null}]}]}}),c.prisma.task.count({where:{AND:[...k,{OR:[{taskStatus:{isFinal:!0}},{status:"completed",taskStatusId:null}]}]}})]);return{success:!0,data:{totalTasks:l,myTasks:m,todayTasks:n,blockedTasks:o,overdueTasks:p,completedToday:q,totalCompletedTasks:r}}}catch(a){return console.error("Error fetching task stats:",a),{success:!1,error:a.message}}};async function s(a={}){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{success:!1,error:"Unauthorized"};let c=parseInt(b.user.id),f="admin"===(b.user.role||"developer");if(a.search||a.dateRange&&(a.dateRange.from||a.dateRange.to))return await r(c,f,a);JSON.stringify(a);let g=(0,i.unstable_cache)(async(a,b,c)=>r(a,b,c),["task-stats-filtered"],{revalidate:30,tags:["task-stats"]});return await g(c,f,a)}async function t(a={},b="daily"){if(!await (0,d.getServerSession)(e.authOptions))return{success:!1,error:"Unauthorized"};try{let[c,d]=await Promise.all([q(),s(a)]);if(!c.success||!d.success)throw Error(c.error||d.error||"Failed to fetch stats");let e=c.data,f=d.data,g="global",h=null;if(a.projectId&&"all"!==a.projectId&&!Array.isArray(a.projectId)){let b=parseInt(a.projectId.toString());isNaN(b)||(g="project",h=b)}let i={total_projects:e.total,active_projects:e.active,total_tasks:f.totalTasks,completed_tasks:f.totalCompletedTasks,overdue_tasks:f.overdueTasks,blocked_tasks:f.blockedTasks},k={};for(let[c,d]of Object.entries(i)){let e=a.statusId&&"all"!==a.statusId||a.search||a.priority||a.dateRange,f=null;e||(f=await (0,j.getStatTrend)(g,h,c,d,b)),k[c]={value:d,trend:f}}return{success:!0,data:k}}catch(a){return console.error("Error fetching summary stats with trends:",a),{success:!1,error:a.message}}}(0,k.ensureServerEntryExports)([n,q,s,t]),(0,b.registerServerReference)(n,"408c06bc00554e58667a6497e03286e21786a0b4de",null),(0,b.registerServerReference)(q,"0067b4066470cdfc7051409a87b3c7ea74b1f3dbad",null),(0,b.registerServerReference)(s,"4092a06687f1e4d6d11b97639f194f16619a7c015f",null),(0,b.registerServerReference)(t,"60e05fd890f5d06ad446fdd4907a3fbe4311fe3ac9",null),a.s(["getAllProjectsStats",()=>q,"getProjectStats",()=>n,"getSummaryStatsWithTrends",()=>t,"getTaskStats",()=>s])}];

//# sourceMappingURL=nxt_New%20folder_Project_Management_NXT_3dfbc34e._.js.map