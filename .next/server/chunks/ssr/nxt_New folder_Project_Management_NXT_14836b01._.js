module.exports=[153544,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(449597);async function g(a,b){try{let f=await (0,d.getServerSession)(e.authOptions);if(!f?.user?.id)return{success:!1,error:"Unauthorized"};let g=parseInt(f.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:g,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let h=b?.limit||20,i=b?.offset||0,j={projectId:a,userId:g};b?.type&&(j.type=b.type),b?.isRead!==void 0&&(j.isRead=b.isRead);let[k,l]=await Promise.all([c.prisma.projectNotification.findMany({where:j,orderBy:[{isUrgent:"desc"},{requiresAcknowledgment:"desc"},{createdAt:"desc"}],take:h,skip:i}),c.prisma.projectNotification.count({where:j})]);return{success:!0,notifications:k,total:l}}catch(a){return console.error("Error fetching project notifications:",a),{success:!1,error:"Failed to fetch notifications"}}}async function h(){try{let a=await (0,d.getServerSession)(e.authOptions);if(!a?.user?.id)return{success:!1,error:"Unauthorized"};let b=parseInt(a.user.id),f=await c.prisma.projectUser.findMany({where:{userId:b,leftAt:null},select:{projectId:!0}}),g=[];try{g=await c.prisma.task.findMany({where:{assignees:{some:{id:b}}},select:{projectId:!0}})}catch(a){console.warn("[Notifications] Could not fetch tasks, using only ProjectUser:",a?.message),g=[]}let h=f.map(a=>a.projectId),i=g.map(a=>a.projectId),j=[...new Set([...h,...i])];if(0===j.length)return{success:!0,count:0};let k=0;try{k=await c.prisma.projectNotification.count({where:{projectId:{in:j},userId:b,isRead:!1}})}catch(a){return console.error("[Notifications] ProjectNotification model not available. Please run 'npx prisma generate':",a?.message),{success:!0,count:0}}return{success:!0,count:k}}catch(a){return console.error("Error fetching all projects unread count:",a),console.error("Error details:",{message:a?.message,stack:a?.stack,name:a?.name}),{success:!1,error:a?.message||"Failed to fetch unread count",details:a?.stack}}}async function i(a=15){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id),g=await c.prisma.projectUser.findMany({where:{userId:f,leftAt:null},select:{projectId:!0}}),h=[];try{h=await c.prisma.task.findMany({where:{assignees:{some:{id:f}}},select:{projectId:!0}})}catch(a){console.warn("[Notifications] Could not fetch tasks, using only ProjectUser:",a?.message),h=[]}let i=g.map(a=>a.projectId),j=h.map(a=>a.projectId),k=[...new Set([...i,...j])];if(console.log(`[Notifications] User ${f} has access to projects:`,k),0===k.length)return console.log(`[Notifications] No projects found for user ${f}`),{success:!0,notifications:[]};if(!c.prisma.projectNotification)return console.error("[Notifications] ProjectNotification model not found. Please run 'npx prisma generate'"),{success:!0,notifications:[]};let l=[];try{l=await c.prisma.projectNotification.findMany({where:{projectId:{in:k},userId:f},include:{project:{select:{id:!0,name:!0}}},orderBy:{createdAt:"desc"},take:a})}catch(a){return console.error("[Notifications] Error accessing ProjectNotification model. Please run 'npx prisma generate':",a?.message),{success:!0,notifications:[]}}return console.log(`[Notifications] Found ${l.length} notifications for user ${f}`),{success:!0,notifications:l}}catch(a){return console.error("Error fetching all projects notifications:",a),console.error("Error details:",{message:a?.message,stack:a?.stack,name:a?.name}),{success:!1,error:a?.message||"Failed to fetch notifications",details:a?.stack}}}async function j(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:f,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let g=await c.prisma.projectNotification.count({where:{projectId:a,userId:f,isRead:!1}});return{success:!0,count:g}}catch(a){return console.error("Error fetching unread count:",a),{success:!1,error:"Failed to fetch unread count"}}}async function k(a,b){try{let g=await (0,d.getServerSession)(e.authOptions);if(!g?.user?.id)return{success:!1,error:"Unauthorized"};let h=parseInt(g.user.id),i=await c.prisma.projectNotification.findFirst({where:{id:b,projectId:a,userId:h}});if(!i)return{success:!1,error:"Notification not found"};if(i.isUrgent&&i.requiresAcknowledgment&&!i.acknowledgedAt)return{success:!1,error:"Urgent notifications cannot be marked as read until acknowledged. Please acknowledge the urgent project first."};return await c.prisma.projectNotification.update({where:{id:b},data:{isRead:!0}}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error marking notification as read:",a),{success:!1,error:"Failed to mark notification as read"}}}async function l(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let g=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:g,leftAt:null}}))return{success:!1,error:"Access denied to this project"};return await c.prisma.projectNotification.updateMany({where:{projectId:a,userId:g,isRead:!1,OR:[{isUrgent:!1},{requiresAcknowledgment:!1},{acknowledgedAt:{not:null}}]},data:{isRead:!0}}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error marking all notifications as read:",a),{success:!1,error:"Failed to mark all notifications as read"}}}async function m(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:f,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let g=await c.prisma.projectNotificationPreference.findUnique({where:{projectId_userId:{projectId:a,userId:f}}});return g||(g=await c.prisma.projectNotificationPreference.create({data:{projectId:a,userId:f,soundEnabled:!0,taskNotifications:!0,dependencyNotifications:!0,todayTaskNotifications:!0,projectAdminNotifications:!0}})),{success:!0,preferences:g}}catch(a){return console.error("Error fetching notification preferences:",a),{success:!1,error:"Failed to fetch preferences"}}}async function n(a,b){try{let g=await (0,d.getServerSession)(e.authOptions);if(!g?.user?.id)return{success:!1,error:"Unauthorized"};let h=parseInt(g.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:h,leftAt:null}}))return{success:!1,error:"Access denied to this project"};return await c.prisma.projectNotificationPreference.upsert({where:{projectId_userId:{projectId:a,userId:h}},create:{projectId:a,userId:h,soundEnabled:b.soundEnabled??!0,taskNotifications:b.taskNotifications??!0,dependencyNotifications:b.dependencyNotifications??!0,todayTaskNotifications:b.todayTaskNotifications??!0,projectAdminNotifications:b.projectAdminNotifications??!0},update:b}),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error updating notification preferences:",a),{success:!1,error:"Failed to update preferences"}}}async function o(a,b,d){let{type:e,entityType:g,entityId:h,title:i,message:j,soundRequired:k=!1,isUrgent:l=!1,requiresAcknowledgment:m=!1}=d;try{let d=await c.prisma.projectUser.findFirst({where:{projectId:a,userId:b,leftAt:null}});if(!d&&("task"===g||"comment_mention"===g)&&h){if(!await c.prisma.task.findFirst({where:{id:h,projectId:a,assignees:{some:{id:b}}}}))return{success:!1,error:"User not in project or assigned to task"};d=null}else if(!d&&"comment"===g&&h){let e=await c.prisma.comment.findUnique({where:{id:h},select:{taskId:!0}});if(!e||!e.taskId)return{success:!1,error:"Comment or related task not found"};if(!await c.prisma.task.findFirst({where:{id:e.taskId,projectId:a,assignees:{some:{id:b}}}}))return{success:!1,error:"User not assigned to the task related to this comment"};d=null}else if(!d)return{success:!1,error:"User not in project"};let n=await c.prisma.projectNotificationPreference.findUnique({where:{projectId_userId:{projectId:a,userId:b}}}),o=!0;if(!k)switch(e){case"task":n&&!n.taskNotifications&&(o=!1);break;case"dependency":n&&!n.dependencyNotifications&&(o=!1);break;case"today_task":n&&!n.todayTaskNotifications&&(o=!1);break;case"project_admin":n&&!n.projectAdminNotifications&&(o=!1)}if(!o)return{success:!0,skipped:!0};let p=await c.prisma.projectNotification.create({data:{projectId:a,userId:b,type:e,entityType:g,entityId:h,title:i,message:j,soundRequired:k,isUrgent:l,requiresAcknowledgment:m}});return console.log(`[Notifications] Created notification for user ${b} in project ${a}:`,{id:p.id,type:e,title:i,soundRequired:k}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0,notification:p}}catch(a){return console.error("Error creating project notification:",a),{success:!1,error:"Failed to create notification"}}}(0,a.i(287907).ensureServerEntryExports)([g,h,i,j,k,l,m,n,o]),(0,b.registerServerReference)(g,"60e11d18f808d2843f4d06a35ea4ad9027dd8b4de1",null),(0,b.registerServerReference)(h,"00686a7231b739e4fe9b8305b757bc0e83827b9865",null),(0,b.registerServerReference)(i,"4004a0aae390e2c1aeb900c79065f312ac43d90f8d",null),(0,b.registerServerReference)(j,"40c45036bf2dcfbc3a3b624285c3d3d3366fc5ed73",null),(0,b.registerServerReference)(k,"60691655a7ad6aec29ab9691d8571a0d380be93da1",null),(0,b.registerServerReference)(l,"40c086aae8b4c1ddec14829c213410ee4c5d2ec0b4",null),(0,b.registerServerReference)(m,"4073df5af18efe51e33e158abaa2dd30f11932484d",null),(0,b.registerServerReference)(n,"60d7258dffa20b5ae58a4ac333313c2a6cc4aeb7a7",null),(0,b.registerServerReference)(o,"705f7777ed9cdc6c32f418ba57dcb7f4b84f8c002a",null),a.s(["createProjectNotification",()=>o,"getAllProjectsNotifications",()=>i,"getAllProjectsUnreadNotificationCount",()=>h,"getProjectNotificationPreferences",()=>m,"getProjectNotifications",()=>g,"getProjectUnreadNotificationCount",()=>j,"markAllProjectNotificationsAsRead",()=>l,"markProjectNotificationAsRead",()=>k,"updateProjectNotificationPreferences",()=>n])},285839,443585,a=>{"use strict";var b=a.i(555163),c=a.i(194893);function d(a,d,e){let f=(0,c.toDate)(a,e?.in);return isNaN(d)?(0,b.constructFrom)(e?.in||a,NaN):(d&&f.setDate(f.getDate()+d),f)}function e(a,b,c){return d(a,-b,c)}a.s(["addDays",()=>d],443585),a.s(["subDays",()=>e],285839)},194893,407716,555163,a=>{"use strict";let b=Symbol.for("constructDateFrom");function c(a,c){return"function"==typeof a?a(c):a&&"object"==typeof a&&b in a?a[b](c):a instanceof Date?new a.constructor(c):new Date(c)}function d(a,b){return c(b||a,a)}a.s(["constructFromSymbol",0,b,"millisecondsInDay",0,864e5,"millisecondsInHour",0,36e5,"millisecondsInWeek",0,6048e5,"minutesInDay",0,1440,"minutesInMonth",0,43200],407716),a.s(["constructFrom",()=>c],555163),a.s(["toDate",()=>d],194893)},114678,a=>{"use strict";var b=a.i(194893);function c(a,c){let d=(0,b.toDate)(a,c?.in);return d.setHours(0,0,0,0),d}a.s(["startOfDay",()=>c])},273054,a=>{"use strict";var b=a.i(555163);function c(a,...d){let e=b.constructFrom.bind(null,a||d.find(a=>"object"==typeof a));return d.map(e)}a.s(["normalizeDates",()=>c])},25254,a=>{"use strict";var b=a.i(194893);function c(a){let c=(0,b.toDate)(a),d=new Date(Date.UTC(c.getFullYear(),c.getMonth(),c.getDate(),c.getHours(),c.getMinutes(),c.getSeconds(),c.getMilliseconds()));return d.setUTCFullYear(c.getFullYear()),a-d}a.s(["getTimezoneOffsetInMilliseconds",()=>c])},269477,a=>{"use strict";var b=a.i(25254),c=a.i(273054),d=a.i(407716),e=a.i(114678);function f(a,f,g){let[h,i]=(0,c.normalizeDates)(g?.in,a,f),j=(0,e.startOfDay)(h),k=(0,e.startOfDay)(i);return Math.round((j-(0,b.getTimezoneOffsetInMilliseconds)(j)-(k-(0,b.getTimezoneOffsetInMilliseconds)(k)))/d.millisecondsInDay)}a.s(["differenceInCalendarDays",()=>f])},602076,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(443585),g=a.i(285839),h=a.i(273054),i=a.i(269477);function j(a,b){let c=a.getFullYear()-b.getFullYear()||a.getMonth()-b.getMonth()||a.getDate()-b.getDate()||a.getHours()-b.getHours()||a.getMinutes()-b.getMinutes()||a.getSeconds()-b.getSeconds()||a.getMilliseconds()-b.getMilliseconds();return c<0?-1:c>0?1:c}async function k(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b||!b.user||!b.user.id)return{error:"Unauthorized"};let k=parseInt(b.user.id),l=b.user.role;if("project"===a.entityType){if(!a.entityId)return{error:"Project ID required"};let b=await c.prisma.project.findUnique({where:{id:a.entityId},select:{projectManagerId:!0}});if(!b)return{error:"Project not found"};if(b.projectManagerId!==k&&"admin"!==l&&"system_admin"!==l&&!await c.prisma.projectUser.findFirst({where:{projectId:a.entityId,userId:k}}))return{error:"Forbidden: You do not have access to this project"}}let{periodA:m}=a,n=new Date(m.start),o=new Date(m.end),p=function(a,b,c){let[d,e]=(0,h.normalizeDates)(void 0,a,b),f=j(d,e),g=Math.abs((0,i.differenceInCalendarDays)(d,e));d.setDate(d.getDate()-f*g);let k=Number(j(d,e)===-f),l=f*(g-k);return 0===l?0:l}(o,n)+1,q={start:(0,g.subDays)(n,p),end:(0,g.subDays)(n,1)},r={};"project"===a.entityType&&(r.projectId=a.entityId),"team"===a.entityType&&(r.teamId=a.entityId),"user"===a.entityType&&(r.assignees={some:{id:a.entityId}});let s=async a=>c.prisma.task.findMany({where:{...r,createdAt:{lte:a.end}},include:{dependencies:{include:{dependsOnTask:!0}},assignees:!0}}),[t,u]=await Promise.all([s({start:n,end:o}),s(q)]),v=(a,b)=>{let c=a.filter(a=>"completed"===a.status&&a.completedAt&&a.completedAt>=b.start&&a.completedAt<=b.end),d=c.reduce((a,b)=>a+b.estimatedHours,0),e=a.filter(a=>a.dueDate&&a.dueDate>=b.start&&a.dueDate<=b.end).length,f=e>0?c.length/e*100:0,g=a.filter(a=>"completed"!==a.status&&"cancelled"!==a.status),h=g.filter(a=>a.dependencies.some(a=>a.dependsOnTask&&"completed"!==a.dependsOnTask.status)),i=g.length>0?h.length/g.length*100:0,j=a.filter(a=>a.dueDate&&a.dueDate<b.end&&(!a.completedAt||a.completedAt>b.end)).length;return{velocity:d,completionRate:f,blockedRatio:i,overdueCount:j,activeTasks:g}},w=v(t,{start:n,end:o}),x=v(u,q),y=(a,b,c)=>{let d=a-b,e=0;0!==b?e=Math.round((a-b)/Math.abs(b)*100):0!==a&&(e=100);let f="neutral";return d>.1&&(f="up"),d<-.1&&(f="down"),{value:Math.round(10*a)/10,unit:c,trend:f,delta:Math.round(10*d)/10,percentChange:e}},z=[],A=t.filter(a=>a.dependencies.some(b=>{let c=b.dependsOnTask;return c&&c.completedAt&&a.plannedDate&&c.completedAt>a.plannedDate})).length;A>0&&z.push({name:"Dependency Delay",description:`${A} tasks were delayed by upstream dependencies.`,severity:A>3?"high":"medium",impactedKpis:["velocity","blockedRatio"],count:A});let B=t.filter(a=>"urgent"===a.priority&&a.createdAt>=m.start&&a.createdAt<=m.end);B.length>0&&z.push({name:"Urgent Task Load",description:`${B.length} urgent tasks disrupted the flow.`,severity:B.length>2?"high":"medium",impactedKpis:["velocity","completionRate"],count:B.length}),w.activeTasks.length;let C=w.activeTasks.reduce((a,b)=>a+b.estimatedHours,0),D=(w.velocity+x.velocity)/2,E=null,F=null,G=[],H=0;C>0&&(D>0?(E=C/D,F=(0,f.addDays)(new Date,Math.ceil(7*E))):(G.push("Zero velocity - cannot predict completion"),H+=5)),w.blockedRatio>10&&(G.push("High blocked ratio (>10%)"),H+=3),w.overdueCount>x.overdueCount&&(G.push("Growing overdue backlog"),H+=2);let I="low";return H>=3&&(I="medium"),H>=6&&(I="high"),{summary:{velocity:y(w.velocity,x.velocity,"hrs"),completionRate:y(w.completionRate,x.completionRate,"%"),blockedRatio:y(w.blockedRatio,x.blockedRatio,"%"),overdueTasks:y(w.overdueCount,x.overdueCount,"tasks"),overallRisk:I},causes:z,forecast:{predictedCompletionDate:F,weeksRemaining:E?Math.round(10*E)/10:null,riskLevel:I,confidenceScore:80*(D>0),riskFactors:G},actions:[]}}catch(a){return console.error("Error generating progress report:",a),{error:a.message||"Failed to generate report"}}}(0,a.i(287907).ensureServerEntryExports)([k]),(0,b.registerServerReference)(k,"40cb366c952aa9f33058dfcd245b147872e9dc1a09",null),a.s(["getProgressReport",()=>k],602076)},289160,a=>{"use strict";var b=a.i(962460),c=a.i(153544),d=a.i(602076);a.s([],194569),a.i(194569),a.s(["0033db22356cbf8845a3517099b63dfc38d1147299",()=>b.getPublicSystemSettings,"00686a7231b739e4fe9b8305b757bc0e83827b9865",()=>c.getAllProjectsUnreadNotificationCount,"4004a0aae390e2c1aeb900c79065f312ac43d90f8d",()=>c.getAllProjectsNotifications,"40cb366c952aa9f33058dfcd245b147872e9dc1a09",()=>d.getProgressReport,"60691655a7ad6aec29ab9691d8571a0d380be93da1",()=>c.markProjectNotificationAsRead],289160)}];

//# sourceMappingURL=nxt_New%20folder_Project_Management_NXT_14836b01._.js.map