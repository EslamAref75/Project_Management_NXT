{"version":3,"sources":["turbopack:///[project]/nxt/New folder/Project_Management_NXT/node_modules/openid-client/package.json","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/lib/rbac-helpers.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/lib/rbac.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/lib/activity-logger.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/lib/permissions.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/app/actions/rbac.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/lib/file-upload-validator.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/app/actions/user-settings.ts","../../../../../../../nxt/New%20folder/Project_Management_NXT/.next-internal/server/app/dashboard/settings/page/actions.js%20%28server%20actions%20loader%29","../../../../../../../nxt/New%20folder/Project_Management_NXT/src/app/actions/logo-upload.ts"],"sourcesContent":["{\"name\":\"openid-client\",\"version\":\"5.7.1\",\"description\":\"OpenID Connect Relying Party (RP, Client) implementation for Node.js runtime, supports passportjs\",\"keywords\":[\"auth\",\"authentication\",\"basic\",\"certified\",\"client\",\"connect\",\"dynamic\",\"electron\",\"hybrid\",\"identity\",\"implicit\",\"oauth\",\"oauth2\",\"oidc\",\"openid\",\"passport\",\"relying party\",\"strategy\"],\"homepage\":\"https://github.com/panva/openid-client\",\"repository\":\"panva/openid-client\",\"funding\":{\"url\":\"https://github.com/sponsors/panva\"},\"license\":\"MIT\",\"author\":\"Filip Skokan <panva.ip@gmail.com>\",\"exports\":{\"types\":\"./types/index.d.ts\",\"import\":\"./lib/index.mjs\",\"require\":\"./lib/index.js\"},\"main\":\"./lib/index.js\",\"types\":\"./types/index.d.ts\",\"files\":[\"lib\",\"types/index.d.ts\"],\"scripts\":{\"format\":\"npx prettier --loglevel silent --write ./lib ./test ./certification ./types\",\"test\":\"mocha test/**/*.test.js\"},\"dependencies\":{\"jose\":\"^4.15.9\",\"lru-cache\":\"^6.0.0\",\"object-hash\":\"^2.2.0\",\"oidc-token-hash\":\"^5.0.3\"},\"devDependencies\":{\"@types/node\":\"^16.18.106\",\"@types/passport\":\"^1.0.16\",\"base64url\":\"^3.0.1\",\"chai\":\"^4.5.0\",\"mocha\":\"^10.7.3\",\"nock\":\"^13.5.5\",\"prettier\":\"^2.8.8\",\"readable-mock-req\":\"^0.2.2\",\"sinon\":\"^9.2.4\",\"timekeeper\":\"^2.3.1\"},\"standard-version\":{\"scripts\":{\"postchangelog\":\"sed -i '' -e 's/### \\\\[/## [/g' CHANGELOG.md\"},\"types\":[{\"type\":\"feat\",\"section\":\"Features\"},{\"type\":\"fix\",\"section\":\"Fixes\"},{\"type\":\"chore\",\"hidden\":true},{\"type\":\"docs\",\"hidden\":true},{\"type\":\"style\",\"hidden\":true},{\"type\":\"refactor\",\"section\":\"Refactor\",\"hidden\":false},{\"type\":\"perf\",\"section\":\"Performance\",\"hidden\":false},{\"type\":\"test\",\"hidden\":true}]}}","/**\r\n * RBAC Helper Functions - Proper Authorization Without Role Bypasses\r\n * \r\n * These functions ensure that all permission checks go through the RBAC system,\r\n * preventing authorization bypasses from legacy role-based checks.\r\n */\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { hasPermission, clearPermissionCache } from \"@/lib/rbac\"\r\n\r\n/**\r\n * Custom error classes for authorization\r\n */\r\nexport class UnauthorizedError extends Error {\r\n  constructor(message: string, public code: string = \"UNAUTHORIZED\") {\r\n    super(message)\r\n    this.name = \"UnauthorizedError\"\r\n  }\r\n}\r\n\r\nexport class ForbiddenError extends Error {\r\n  constructor(message: string, public code: string = \"FORBIDDEN\") {\r\n    super(message)\r\n    this.name = \"ForbiddenError\"\r\n  }\r\n}\r\n\r\nexport class NotFoundError extends Error {\r\n  constructor(message: string, public code: string = \"NOT_FOUND\") {\r\n    super(message)\r\n    this.name = \"NotFoundError\"\r\n  }\r\n}\r\n\r\n/**\r\n * Require specific permission - throws UnauthorizedError if denied\r\n * This is the ONLY way to check permissions - no role-based bypasses\r\n *\r\n * @param userId - User ID to check\r\n * @param permission - Permission key (e.g., \"project.delete\")\r\n * @param projectId - Optional project ID for resource-scoped permissions\r\n * @throws UnauthorizedError if permission denied\r\n *\r\n * @example\r\n * await requirePermission(userId, \"project.delete\", projectId)\r\n */\r\nexport async function requirePermission(\r\n  userId: number,\r\n  permission: string,\r\n  projectId?: number\r\n): Promise<void> {\r\n  // Check permission through RBAC system ONLY\r\n  // No role checks, no bypasses\r\n  const allowed = await hasPermissionWithoutRoleBypass(userId, permission, projectId)\r\n\r\n  if (!allowed) {\r\n    throw new UnauthorizedError(`Permission denied: ${permission}`, \"PERMISSION_DENIED\")\r\n  }\r\n}\r\n\r\n/**\r\n * Require any of multiple permissions\r\n * Throws error if user has none of them\r\n *\r\n * @param userId - User ID\r\n * @param permissions - Array of permission keys\r\n * @param projectId - Optional project ID\r\n * @throws UnauthorizedError if all permissions denied\r\n */\r\nexport async function requireAnyPermission(\r\n  userId: number,\r\n  permissions: string[],\r\n  projectId?: number\r\n): Promise<void> {\r\n  // Check if user has at least one permission\r\n  for (const permission of permissions) {\r\n    const allowed = await hasPermissionWithoutRoleBypass(userId, permission, projectId)\r\n    if (allowed) return\r\n  }\r\n\r\n  throw new UnauthorizedError(\r\n    `Permission denied: requires one of [${permissions.join(\", \")}]`,\r\n    \"PERMISSION_DENIED\"\r\n  )\r\n}\r\n\r\n/**\r\n * Check permission WITHOUT role-based bypasses\r\n * This is the core RBAC check - pure permission system\r\n *\r\n * @param userId - User ID\r\n * @param permission - Permission key\r\n * @param projectId - Optional project ID\r\n * @returns true if user has the permission\r\n */\r\nexport async function hasPermissionWithoutRoleBypass(\r\n  userId: number,\r\n  permission: string,\r\n  projectId?: number\r\n): Promise<boolean> {\r\n  // Check through RBAC system only\r\n  // The old hasPermission() function had bypasses for admin role\r\n  // We use a pure RBAC check here\r\n\r\n  try {\r\n    // Get user's roles and their permissions\r\n    const userRoles = await prisma.userRole.findMany({\r\n      where: {\r\n        userId,\r\n        OR: [\r\n          { scopeType: null }, // Global roles\r\n          { scopeType: \"global\" },\r\n          ...(projectId ? [{ scopeType: \"project\", scopeId: projectId }] : []),\r\n        ],\r\n      },\r\n      include: {\r\n        role: {\r\n          include: {\r\n            permissions: {\r\n              include: {\r\n                permission: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    })\r\n\r\n    // Check if any role has the permission\r\n    for (const userRole of userRoles) {\r\n      for (const rolePermission of userRole.role.permissions) {\r\n        if (rolePermission.permission.key === permission) {\r\n          return true\r\n        }\r\n      }\r\n    }\r\n\r\n    return false\r\n  } catch (error) {\r\n    console.error(`Error checking permission ${permission} for user ${userId}:`, error)\r\n    // Fail secure - deny access on error\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Verify user can access a project with specific permission\r\n * Throws error if project doesn't exist or user lacks permission\r\n *\r\n * @param userId - User ID\r\n * @param projectId - Project ID\r\n * @param permission - Permission key (e.g., \"project.delete\")\r\n * @throws NotFoundError if project doesn't exist\r\n * @throws UnauthorizedError if permission denied\r\n */\r\nexport async function verifyProjectAccess(\r\n  userId: number,\r\n  projectId: number,\r\n  permission: string\r\n): Promise<void> {\r\n  // 1. Verify project exists\r\n  const project = await prisma.project.findUnique({\r\n    where: { id: projectId },\r\n    select: { id: true },\r\n  })\r\n\r\n  if (!project) {\r\n    throw new NotFoundError(`Project ${projectId} not found`)\r\n  }\r\n\r\n  // 2. Check permission through RBAC (no bypasses)\r\n  const allowed = await hasPermissionWithoutRoleBypass(userId, permission, projectId)\r\n\r\n  if (!allowed) {\r\n    throw new UnauthorizedError(\r\n      `You don't have permission to ${permission} on this project`,\r\n      \"PROJECT_ACCESS_DENIED\"\r\n    )\r\n  }\r\n}\r\n\r\n/**\r\n * Verify user can access a task with specific permission\r\n * Throws error if task doesn't exist or user lacks permission\r\n *\r\n * @param userId - User ID\r\n * @param taskId - Task ID\r\n * @param permission - Permission key (e.g., \"task.update\")\r\n * @throws NotFoundError if task doesn't exist\r\n * @throws UnauthorizedError if permission denied\r\n */\r\nexport async function verifyTaskAccess(\r\n  userId: number,\r\n  taskId: number,\r\n  permission: string\r\n): Promise<void> {\r\n  // 1. Get task and its project\r\n  const task = await prisma.task.findUnique({\r\n    where: { id: taskId },\r\n    select: {\r\n      id: true,\r\n      projectId: true,\r\n    },\r\n  })\r\n\r\n  if (!task) {\r\n    throw new NotFoundError(`Task ${taskId} not found`)\r\n  }\r\n\r\n  // 2. Check permission on the project\r\n  // Tasks are scoped to projects, so we check project-level permissions\r\n  const allowed = await hasPermissionWithoutRoleBypass(userId, permission, task.projectId)\r\n\r\n  if (!allowed) {\r\n    throw new UnauthorizedError(\r\n      `You don't have permission to ${permission} on this task`,\r\n      \"TASK_ACCESS_DENIED\"\r\n    )\r\n  }\r\n}\r\n\r\n/**\r\n * Verify user is project owner/creator\r\n * Used for operations that should only be available to the creator\r\n *\r\n * @param userId - User ID\r\n * @param projectId - Project ID\r\n * @throws NotFoundError if project doesn't exist\r\n * @throws UnauthorizedError if not the creator\r\n */\r\nexport async function verifyProjectOwner(userId: number, projectId: number): Promise<void> {\r\n  const project = await prisma.project.findUnique({\r\n    where: { id: projectId },\r\n    select: { id: true, createdById: true },\r\n  })\r\n\r\n  if (!project) {\r\n    throw new NotFoundError(`Project ${projectId} not found`)\r\n  }\r\n\r\n  if (project.createdById !== userId) {\r\n    throw new UnauthorizedError(`You are not the owner of this project`, \"NOT_OWNER\")\r\n  }\r\n}\r\n\r\n/**\r\n * Check if user is admin through RBAC (has admin role in system)\r\n * Does NOT grant automatic permissions - must still check individual permissions\r\n *\r\n * @param userId - User ID\r\n * @returns true if user has the \"admin\" role\r\n * @deprecated - Use specific permission checks instead\r\n */\r\nexport async function isAdminUser(userId: number): Promise<boolean> {\r\n  const adminRole = await prisma.userRole.findFirst({\r\n    where: {\r\n      userId,\r\n      role: {\r\n        name: \"admin\",\r\n      },\r\n    },\r\n  })\r\n\r\n  return !!adminRole\r\n}\r\n\r\n/**\r\n * Clear permission cache when user roles change\r\n * Must be called after updating user permissions/roles\r\n *\r\n * @param userId - User ID whose cache to clear\r\n * @param projectId - Optional project ID for project-scoped changes\r\n */\r\nexport function invalidateUserPermissionCache(userId: number, projectId?: number): void {\r\n  clearPermissionCache(userId, projectId)\r\n}\r\n\r\n/**\r\n * Clear all permission caches (use sparingly)\r\n */\r\nexport function invalidateAllPermissionCaches(): void {\r\n  clearPermissionCache(0, undefined) // This clears all caches\r\n}\r\n\r\n/**\r\n * Handle authorization errors in server actions\r\n *\r\n * @param error - Error thrown during authorization\r\n * @returns Response object with error details\r\n *\r\n * @example\r\n * try {\r\n *   await requirePermission(userId, 'project.delete')\r\n * } catch (error) {\r\n *   return handleAuthorizationError(error)\r\n * }\r\n */\r\nexport function handleAuthorizationError(\r\n  error: unknown\r\n): { error: string; code: string; status: number; success: false } {\r\n  if (error instanceof UnauthorizedError) {\r\n    return { error: error.message, code: error.code, status: 403, success: false }\r\n  }\r\n\r\n  if (error instanceof ForbiddenError) {\r\n    return { error: error.message, code: error.code, status: 403, success: false }\r\n  }\r\n\r\n  if (error instanceof NotFoundError) {\r\n    return { error: error.message, code: error.code, status: 404, success: false }\r\n  }\r\n\r\n  console.error(\"Unknown authorization error:\", error)\r\n  return {\r\n    error: \"Authorization failed\",\r\n    code: \"AUTHORIZATION_ERROR\",\r\n    status: 500,\r\n    success: false\r\n  }\r\n}\r\n","/**\r\n * RBAC Permission Checking Utilities\r\n */\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { PERMISSIONS } from \"./permissions\"\r\n\r\n/**\r\n * Cache for user permissions (in-memory, can be replaced with Redis in production)\r\n */\r\nconst permissionCache = new Map<string, { permissions: string[], expiresAt: number }>()\r\n\r\nconst CACHE_TTL = 5 * 60 * 1000 // 5 minutes\r\n\r\n/**\r\n * Get all permissions for a user (with caching)\r\n */\r\nexport async function getUserPermissions(\r\n  userId: number,\r\n  projectId?: number\r\n): Promise<string[]> {\r\n  const cacheKey = `${userId}:${projectId || \"global\"}`\r\n  const cached = permissionCache.get(cacheKey)\r\n  \r\n  if (cached && cached.expiresAt > Date.now()) {\r\n    return cached.permissions\r\n  }\r\n\r\n  // Get all user roles (global and project-scoped)\r\n  const userRoles = await prisma.userRole.findMany({\r\n    where: {\r\n      userId,\r\n      OR: [\r\n        { scopeType: null }, // Global roles\r\n        { scopeType: \"global\" },\r\n        ...(projectId ? [{ scopeType: \"project\", scopeId: projectId }] : []),\r\n      ],\r\n    },\r\n    include: {\r\n      role: {\r\n        include: {\r\n          permissions: {\r\n            include: {\r\n              permission: true,\r\n            },\r\n          },\r\n        },\r\n      },\r\n    },\r\n  })\r\n\r\n  // Collect all unique permissions\r\n  const permissionSet = new Set<string>()\r\n  \r\n  for (const userRole of userRoles) {\r\n    for (const rolePermission of userRole.role.permissions) {\r\n      permissionSet.add(rolePermission.permission.key)\r\n    }\r\n  }\r\n\r\n  const permissions = Array.from(permissionSet)\r\n\r\n  // Cache the result\r\n  permissionCache.set(cacheKey, {\r\n    permissions,\r\n    expiresAt: Date.now() + CACHE_TTL,\r\n  })\r\n\r\n  return permissions\r\n}\r\n\r\n/**\r\n * Check if user has a specific permission\r\n * ⚠️ DEPRECATED - This function has role-based bypasses\r\n * Use hasPermissionWithoutRoleBypass() from rbac-helpers.ts instead\r\n * \r\n * @deprecated - Use hasPermissionWithoutRoleBypass() for new code\r\n */\r\nexport async function hasPermission(\r\n  userId: number,\r\n  permission: string,\r\n  projectId?: number\r\n): Promise<boolean> {\r\n  // Legacy implementation with bypasses - kept for backward compatibility only\r\n  // DO NOT USE IN NEW CODE - this bypasses RBAC\r\n  const user = await prisma.user.findUnique({\r\n    where: { id: userId },\r\n    select: { role: true },\r\n  })\r\n\r\n  // ⚠️ LEGACY BYPASS - Should not exist in new code\r\n  if (user?.role === \"admin\" || user?.role === \"project_manager\") {\r\n    return true\r\n  }\r\n\r\n  // Check RBAC permissions\r\n  const permissions = await getUserPermissions(userId, projectId)\r\n  return permissions.includes(permission)\r\n}\r\n\r\n/**\r\n * ⛔ DEPRECATED - DO NOT USE\r\n * This function allows legacy role-based bypass of RBAC permissions\r\n * Use hasPermissionWithoutRoleBypass() from rbac-helpers.ts instead\r\n */\r\nexport async function hasPermissionOrRole(\r\n  userId: number,\r\n  permission: string,\r\n  allowedLegacyRoles: string[] = [\"admin\", \"project_manager\"],\r\n  projectId?: number\r\n): Promise<boolean> {\r\n  console.warn(\r\n    \"[RBAC] DEPRECATED: hasPermissionOrRole() called. Use hasPermissionWithoutRoleBypass() instead.\"\r\n  )\r\n  throw new Error(\r\n    \"hasPermissionOrRole is deprecated and must be replaced with hasPermissionWithoutRoleBypass(). \" +\r\n    \"This function bypasses RBAC security controls. See rbac-helpers.ts for proper authorization.\"\r\n  )\r\n}\r\n\r\n/**\r\n * Check if user has any of the specified permissions\r\n */\r\nexport async function hasAnyPermission(\r\n  userId: number,\r\n  permissions: string[],\r\n  projectId?: number\r\n): Promise<boolean> {\r\n  const userPermissions = await getUserPermissions(userId, projectId)\r\n  return permissions.some(perm => userPermissions.includes(perm))\r\n}\r\n\r\n/**\r\n * Check if user has all of the specified permissions\r\n */\r\nexport async function hasAllPermissions(\r\n  userId: number,\r\n  permissions: string[],\r\n  projectId?: number\r\n): Promise<boolean> {\r\n  const userPermissions = await getUserPermissions(userId, projectId)\r\n  return permissions.every(perm => userPermissions.includes(perm))\r\n}\r\n\r\n/**\r\n * Get user roles\r\n */\r\nexport async function getUserRoles(\r\n  userId: number,\r\n  projectId?: number\r\n): Promise<Array<{ role: any, scopeType: string | null, scopeId: number | null }>> {\r\n  const userRoles = await prisma.userRole.findMany({\r\n    where: {\r\n      userId,\r\n      OR: [\r\n        { scopeType: null },\r\n        { scopeType: \"global\" },\r\n        ...(projectId ? [{ scopeType: \"project\", scopeId: projectId }] : []),\r\n      ],\r\n    },\r\n    include: {\r\n      role: true,\r\n    },\r\n  })\r\n\r\n  return userRoles.map(ur => ({\r\n    role: ur.role,\r\n    scopeType: ur.scopeType,\r\n    scopeId: ur.scopeId,\r\n  }))\r\n}\r\n\r\n/**\r\n * Check if user has a specific role\r\n */\r\nexport async function hasRole(\r\n  userId: number,\r\n  roleName: string,\r\n  projectId?: number\r\n): Promise<boolean> {\r\n  const roles = await getUserRoles(userId, projectId)\r\n  return roles.some(r => r.role.name === roleName)\r\n}\r\n\r\n/**\r\n * Clear permission cache for a user\r\n */\r\nexport function clearPermissionCache(userId: number, projectId?: number) {\r\n  const cacheKey = `${userId}:${projectId || \"global\"}`\r\n  permissionCache.delete(cacheKey)\r\n}\r\n\r\n/**\r\n * Clear all permission caches\r\n */\r\nexport function clearAllPermissionCaches() {\r\n  permissionCache.clear()\r\n}\r\n\r\n/**\r\n * Require permission - throws error if user doesn't have permission\r\n */\r\nexport async function requirePermission(\r\n  userId: number,\r\n  permission: string,\r\n  projectId?: number\r\n): Promise<void> {\r\n  const has = await hasPermission(userId, permission, projectId)\r\n  if (!has) {\r\n    throw new Error(`Permission denied: ${permission}`)\r\n  }\r\n}\r\n\r\n/**\r\n * Require any permission - throws error if user doesn't have any of the permissions\r\n */\r\nexport async function requireAnyPermission(\r\n  userId: number,\r\n  permissions: string[],\r\n  projectId?: number\r\n): Promise<void> {\r\n  const has = await hasAnyPermission(userId, permissions, projectId)\r\n  if (!has) {\r\n    throw new Error(`Permission denied: requires one of [${permissions.join(\", \")}]`)\r\n  }\r\n}\r\n\r\n","\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { headers } from \"next/headers\"\r\n\r\nexport type ActionCategory =\r\n  | \"auth\"\r\n  | \"project\"\r\n  | \"task\"\r\n  | \"dependency\"\r\n  | \"settings\"\r\n  | \"notification\"\r\n  | \"today_task\"\r\n\r\nexport type ActionType =\r\n  // Auth\r\n  | \"user_login\"\r\n  | \"user_logout\"\r\n  | \"login_failed\"\r\n  | \"role_changed\"\r\n  | \"user_activated\"\r\n  | \"user_suspended\"\r\n  // RBAC\r\n  | \"role_created\"\r\n  | \"role_updated\"\r\n  | \"role_deleted\"\r\n  | \"role_assigned\"\r\n  | \"role_removed\"\r\n  // Project\r\n  | \"project_created\"\r\n  | \"project_updated\"\r\n  | \"project_archived\"\r\n  | \"project_manager_changed\"\r\n  | \"team_member_added\"\r\n  | \"team_member_removed\"\r\n  | \"project_settings_changed\"\r\n  | \"project_marked_urgent\"\r\n  | \"project_urgent_acknowledged\"\r\n  | \"project_urgent_removed\"\r\n  | \"project_assigned_to_team\"\r\n  | \"project_removed_from_team\"\r\n  | \"file_uploaded\"\r\n  | \"file_downloaded\"\r\n  | \"file_deleted\"\r\n  // Team\r\n  | \"team_created\"\r\n  | \"team_updated\"\r\n  | \"team_deleted\"\r\n  // Task\r\n  | \"task_created\"\r\n  | \"task_updated\"\r\n  | \"task_deleted\"\r\n  | \"task_assigned\"\r\n  | \"task_reassigned\"\r\n  | \"task_status_changed\"\r\n  | \"task_status_updated\"\r\n  | \"task_priority_changed\"\r\n  | \"subtask_created\"\r\n  | \"subtask_updated\"\r\n  | \"subtask_completed\"\r\n  // Dependency\r\n  | \"dependency_added\"\r\n  | \"dependency_removed\"\r\n  | \"task_blocked\"\r\n  | \"task_unblocked\"\r\n  // Today's Tasks\r\n  | \"today_task_assigned\"\r\n  | \"today_task_modified\"\r\n  | \"today_task_removed\"\r\n  | \"auto_carryover_executed\"\r\n  // Settings\r\n  | \"global_settings_updated\"\r\n  | \"project_settings_updated\"\r\n  | \"user_settings_updated\"\r\n  | \"project_type_created\"\r\n  | \"project_type_updated\"\r\n  | \"project_type_deleted\"\r\n  | \"project_type_toggled\"\r\n  | \"project_status_created\"\r\n  | \"project_status_updated\"\r\n  | \"project_status_deleted\"\r\n  | \"project_status_toggled\"\r\n  | \"project_statuses_reordered\"\r\n  | \"task_status_created\"\r\n  | \"task_status_updated\"\r\n  | \"task_status_deleted\"\r\n  | \"task_status_toggled\"\r\n  | \"task_statuses_reordered\"\r\n  // Notifications\r\n  | \"notification_settings_changed\"\r\n  | \"admin_override_executed\"\r\n  | \"manual_unblock\"\r\n\r\ninterface LogActivityParams {\r\n  actionType: ActionType\r\n  actionCategory: ActionCategory\r\n  actionSummary: string\r\n  actionDetails?: Record<string, any>\r\n  performedById: number\r\n  affectedUserId?: number\r\n  projectId?: number\r\n  entityType?: string\r\n  entityId?: number\r\n  ipAddress?: string\r\n  userAgent?: string\r\n}\r\n\r\n/**\r\n * Log an activity to the activity log\r\n * This function should be called after any important action\r\n */\r\nexport async function logActivity(params: LogActivityParams): Promise<void> {\r\n  console.log(\"[ActivityLogger] ====== START LOGGING ======\")\r\n  console.log(\"[ActivityLogger] Received params:\", JSON.stringify(params, null, 2))\r\n\r\n  try {\r\n    // Sanitize actionDetails to remove sensitive information\r\n    const sanitizedDetails = sanitizeActionDetails(params.actionDetails || {})\r\n\r\n    console.log(\"[ActivityLogger] Sanitized details:\", JSON.stringify(sanitizedDetails, null, 2))\r\n    console.log(\"[ActivityLogger] Logging activity:\", {\r\n      actionType: params.actionType,\r\n      actionCategory: params.actionCategory,\r\n      actionSummary: params.actionSummary,\r\n      performedById: params.performedById,\r\n    })\r\n\r\n    // Try to create with new schema first\r\n    try {\r\n      const result = await prisma.activityLog.create({\r\n        data: {\r\n          actionType: params.actionType,\r\n          actionCategory: params.actionCategory,\r\n          actionSummary: params.actionSummary,\r\n          actionDetails: Object.keys(sanitizedDetails).length > 0\r\n            ? JSON.stringify(sanitizedDetails)\r\n            : null,\r\n          performedById: params.performedById,\r\n          affectedUserId: params.affectedUserId || null,\r\n          projectId: params.projectId || null,\r\n          entityType: params.entityType || null,\r\n          entityId: params.entityId || null,\r\n          ipAddress: params.ipAddress || await getClientIP(),\r\n          userAgent: params.userAgent || await getUserAgent(),\r\n          // Legacy fields (required by database)\r\n          action: params.actionType, // Map actionType to legacy action field\r\n          description: params.actionSummary, // Map actionSummary to legacy description field\r\n          userId: params.performedById, // Map performedById to legacy userId field\r\n        },\r\n      })\r\n      console.log(\"[ActivityLogger] ✅ Successfully logged activity with ID:\", result.id)\r\n      console.log(\"[ActivityLogger] ====== END LOGGING (SUCCESS) ======\")\r\n      return\r\n    } catch (schemaError: any) {\r\n      console.error(\"[ActivityLogger] ❌ Schema error occurred:\")\r\n      console.error(\"[ActivityLogger] Error message:\", schemaError.message)\r\n      console.error(\"[ActivityLogger] Error code:\", schemaError.code)\r\n      console.error(\"[ActivityLogger] Error meta:\", JSON.stringify(schemaError.meta, null, 2))\r\n      // If new columns don't exist, fall back to old schema\r\n      if (schemaError.message?.includes('no such column') || schemaError.code === 'P2003' || schemaError.code === 'P2011') {\r\n        console.warn(\"[ActivityLogger] New columns not found, using legacy schema. Please run migration.\")\r\n        await prisma.$executeRawUnsafe(`\r\n          INSERT INTO activity_logs (action, description, entity_type, entity_id, ip_address, user_id, created_at)\r\n          VALUES (?, ?, ?, ?, ?, ?, datetime('now'))\r\n        `,\r\n          params.actionType,\r\n          params.actionSummary,\r\n          params.entityType || null,\r\n          params.entityId || null,\r\n          params.ipAddress || await getClientIP() || null,\r\n          params.performedById\r\n        )\r\n        console.log(\"[ActivityLogger] ✅ Logged using legacy schema\")\r\n        console.log(\"[ActivityLogger] ====== END LOGGING (LEGACY) ======\")\r\n        return\r\n      } else {\r\n        console.error(\"[ActivityLogger] ❌ Unknown schema error, rethrowing\")\r\n        throw schemaError\r\n      }\r\n    }\r\n  } catch (error: any) {\r\n    // Log errors but don't throw - activity logging should never break the main flow\r\n    console.error(\"[ActivityLogger] ❌❌❌ CRITICAL ERROR - Failed to log activity ❌❌❌\")\r\n    console.error(\"[ActivityLogger] Error message:\", error?.message || error)\r\n    console.error(\"[ActivityLogger] Error code:\", error?.code)\r\n    console.error(\"[ActivityLogger] Error meta:\", JSON.stringify(error?.meta, null, 2))\r\n    console.error(\"[ActivityLogger] Error stack:\", error?.stack)\r\n    console.error(\"[ActivityLogger] ====== END LOGGING (ERROR) ======\")\r\n  }\r\n}\r\n\r\n/**\r\n * Sanitize action details to remove sensitive information\r\n */\r\nfunction sanitizeActionDetails(details: Record<string, any>): Record<string, any> {\r\n  const sensitiveKeys = [\r\n    'password',\r\n    'passwordHash',\r\n    'password_hash',\r\n    'token',\r\n    'secret',\r\n    'apiKey',\r\n    'api_key',\r\n    'accessToken',\r\n    'refreshToken',\r\n  ]\r\n\r\n  const sanitized = { ...details }\r\n\r\n  for (const key of sensitiveKeys) {\r\n    if (key in sanitized) {\r\n      sanitized[key] = '[REDACTED]'\r\n    }\r\n  }\r\n\r\n  // Recursively sanitize nested objects\r\n  for (const key in sanitized) {\r\n    if (typeof sanitized[key] === 'object' && sanitized[key] !== null && !Array.isArray(sanitized[key])) {\r\n      sanitized[key] = sanitizeActionDetails(sanitized[key])\r\n    }\r\n  }\r\n\r\n  return sanitized\r\n}\r\n\r\n/**\r\n * Get client IP address from headers\r\n */\r\nasync function getClientIP(): Promise<string | null> {\r\n  try {\r\n    const headersList = await headers()\r\n    const forwarded = headersList.get('x-forwarded-for')\r\n    const realIP = headersList.get('x-real-ip')\r\n\r\n    if (forwarded) {\r\n      return forwarded.split(',')[0].trim()\r\n    }\r\n    if (realIP) {\r\n      return realIP\r\n    }\r\n    return null\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * Get user agent from headers\r\n */\r\nasync function getUserAgent(): Promise<string | null> {\r\n  try {\r\n    const headersList = await headers()\r\n    return headersList.get('user-agent') || null\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\n","/**\r\n * Permission definitions for RBAC system\r\n * Format: module.action or module.category.action\r\n */\r\n\r\nexport const PERMISSIONS = {\r\n  // User Management\r\n  USER: {\r\n    CREATE: \"user.create\",\r\n    READ: \"user.read\",\r\n    UPDATE: \"user.update\",\r\n    DELETE: \"user.delete\",\r\n    ASSIGN_ROLE: \"user.assign_role\",\r\n    ACTIVATE: \"user.activate\",\r\n    DEACTIVATE: \"user.deactivate\",\r\n  },\r\n\r\n  // Team Management\r\n  TEAM: {\r\n    CREATE: \"team.create\",\r\n    READ: \"team.read\",\r\n    UPDATE: \"team.update\",\r\n    DELETE: \"team.delete\",\r\n    ADD_MEMBER: \"team.add_member\",\r\n    REMOVE_MEMBER: \"team.remove_member\",\r\n    ASSIGN_PROJECT: \"team.assign_project\",\r\n    REMOVE_PROJECT: \"team.remove_project\",\r\n  },\r\n\r\n  // Project Management\r\n  PROJECT: {\r\n    CREATE: \"project.create\",\r\n    READ: \"project.read\",\r\n    UPDATE: \"project.update\",\r\n    DELETE: \"project.delete\",\r\n    ASSIGN_TEAM: \"project.assign_team\",\r\n    REMOVE_TEAM: \"project.remove_team\",\r\n    MANAGE_SETTINGS: \"project.manage_settings\",\r\n  },\r\n\r\n  // Task Management\r\n  TASK: {\r\n    CREATE: \"task.create\",\r\n    READ: \"task.read\",\r\n    UPDATE: \"task.update\",\r\n    DELETE: \"task.delete\",\r\n    ASSIGN: \"task.assign\",\r\n    CHANGE_STATUS: \"task.change_status\",\r\n    CHANGE_PRIORITY: \"task.change_priority\",\r\n  },\r\n\r\n  // Dependency Management\r\n  DEPENDENCY: {\r\n    CREATE: \"dependency.create\",\r\n    READ: \"dependency.read\",\r\n    UPDATE: \"dependency.update\",\r\n    DELETE: \"dependency.delete\",\r\n    MANUAL_UNBLOCK: \"dependency.manual_unblock\",\r\n  },\r\n\r\n  // Today's Tasks Management\r\n  TODAY_TASK: {\r\n    ASSIGN: \"today_task.assign\",\r\n    REMOVE: \"today_task.remove\",\r\n    REORDER: \"today_task.reorder\",\r\n    VIEW_ALL: \"today_task.view_all\",\r\n  },\r\n\r\n  // Settings Management\r\n  SETTINGS: {\r\n    GLOBAL_READ: \"settings.global.read\",\r\n    GLOBAL_EDIT: \"settings.global.edit\",\r\n    PROJECT_READ: \"settings.project.read\",\r\n    PROJECT_EDIT: \"settings.project.edit\",\r\n    USER_READ: \"settings.user.read\",\r\n    USER_EDIT: \"settings.user.edit\",\r\n    // Project Metadata Management\r\n    PROJECT_TYPE_MANAGE: \"settings.project_type.manage\",\r\n    PROJECT_STATUS_MANAGE: \"settings.project_status.manage\",\r\n    TASK_STATUS_MANAGE: \"settings.task_status.manage\",\r\n  },\r\n\r\n  // Notifications Management\r\n  NOTIFICATION: {\r\n    VIEW: \"notification.view\",\r\n    MANAGE: \"notification.manage\",\r\n    CONFIGURE: \"notification.configure\",\r\n  },\r\n\r\n  // Activity Logs & Audit\r\n  LOG: {\r\n    VIEW: \"log.view\",\r\n    EXPORT: \"log.export\",\r\n    VIEW_DETAILS: \"log.view_details\",\r\n  },\r\n\r\n  // Role Management\r\n  ROLE: {\r\n    CREATE: \"role.create\",\r\n    READ: \"role.read\",\r\n    UPDATE: \"role.update\",\r\n    DELETE: \"role.delete\",\r\n    ASSIGN: \"role.assign\",\r\n    MANAGE_PERMISSIONS: \"role.manage_permissions\",\r\n  },\r\n\r\n  // Reports & Exports\r\n  REPORT: {\r\n    VIEW: \"report.view\",\r\n    EXPORT: \"report.export\",\r\n    GENERATE: \"report.generate\",\r\n  },\r\n} as const\r\n\r\n/**\r\n * Permission modules\r\n */\r\nexport const PERMISSION_MODULES = {\r\n  USER: \"user\",\r\n  TEAM: \"team\",\r\n  PROJECT: \"project\",\r\n  TASK: \"task\",\r\n  DEPENDENCY: \"dependency\",\r\n  TODAY_TASK: \"today_task\",\r\n  SETTINGS: \"settings\",\r\n  NOTIFICATION: \"notification\",\r\n  LOG: \"log\",\r\n  ROLE: \"role\",\r\n  REPORT: \"report\",\r\n} as const\r\n\r\n/**\r\n * Default roles and their permissions\r\n */\r\nexport const DEFAULT_ROLES = {\r\n  SYSTEM_ADMIN: {\r\n    name: \"System Admin\",\r\n    description: \"Full system access with all permissions\",\r\n    isSystemRole: true,\r\n    permissions: Object.values(PERMISSIONS).flatMap(module => Object.values(module)),\r\n  },\r\n  PROJECT_MANAGER: {\r\n    name: \"Project Manager\",\r\n    description: \"Manage projects, tasks, teams, and dependencies\",\r\n    isSystemRole: true,\r\n    permissions: [\r\n      // Project Management\r\n      ...Object.values(PERMISSIONS.PROJECT),\r\n      // Task Management\r\n      ...Object.values(PERMISSIONS.TASK),\r\n      // Dependency Management\r\n      ...Object.values(PERMISSIONS.DEPENDENCY),\r\n      // Team Management (limited)\r\n      PERMISSIONS.TEAM.READ,\r\n      PERMISSIONS.TEAM.UPDATE,\r\n      PERMISSIONS.TEAM.ADD_MEMBER,\r\n      PERMISSIONS.TEAM.REMOVE_MEMBER,\r\n      PERMISSIONS.TEAM.ASSIGN_PROJECT,\r\n      PERMISSIONS.TEAM.REMOVE_PROJECT,\r\n      // Today's Tasks\r\n      ...Object.values(PERMISSIONS.TODAY_TASK),\r\n      // Settings (project-level)\r\n      PERMISSIONS.SETTINGS.PROJECT_READ,\r\n      PERMISSIONS.SETTINGS.PROJECT_EDIT,\r\n      PERMISSIONS.SETTINGS.PROJECT_TYPE_MANAGE,\r\n      PERMISSIONS.SETTINGS.PROJECT_STATUS_MANAGE,\r\n      PERMISSIONS.SETTINGS.TASK_STATUS_MANAGE,\r\n      // Notifications\r\n      PERMISSIONS.NOTIFICATION.VIEW,\r\n      PERMISSIONS.NOTIFICATION.MANAGE,\r\n      // Activity Logs\r\n      PERMISSIONS.LOG.VIEW,\r\n      PERMISSIONS.LOG.VIEW_DETAILS,\r\n      // User Management (read-only for assignment)\r\n      PERMISSIONS.USER.READ,\r\n      // Reports\r\n      PERMISSIONS.REPORT.VIEW,\r\n      PERMISSIONS.REPORT.EXPORT,\r\n      PERMISSIONS.REPORT.GENERATE,\r\n    ],\r\n  },\r\n  TEAM_LEAD: {\r\n    name: \"Team Lead\",\r\n    description: \"Manage team tasks, dependencies, and team members\",\r\n    isSystemRole: true,\r\n    permissions: [\r\n      // Project Management (read-only)\r\n      PERMISSIONS.PROJECT.READ,\r\n      // Task Management (for team tasks)\r\n      ...Object.values(PERMISSIONS.TASK),\r\n      // Dependency Management\r\n      ...Object.values(PERMISSIONS.DEPENDENCY),\r\n      // Team Management (own team only)\r\n      PERMISSIONS.TEAM.READ,\r\n      PERMISSIONS.TEAM.UPDATE,\r\n      PERMISSIONS.TEAM.ADD_MEMBER,\r\n      PERMISSIONS.TEAM.REMOVE_MEMBER,\r\n      // Today's Tasks\r\n      ...Object.values(PERMISSIONS.TODAY_TASK),\r\n      // Settings (read-only)\r\n      PERMISSIONS.SETTINGS.PROJECT_READ,\r\n      // Notifications\r\n      PERMISSIONS.NOTIFICATION.VIEW,\r\n      // Activity Logs (team scope)\r\n      PERMISSIONS.LOG.VIEW,\r\n      PERMISSIONS.LOG.VIEW_DETAILS,\r\n      // User Management (read-only for team members)\r\n      PERMISSIONS.USER.READ,\r\n      // Reports (view only)\r\n      PERMISSIONS.REPORT.VIEW,\r\n    ],\r\n  },\r\n  DEVELOPER: {\r\n    name: \"Developer\",\r\n    description: \"Basic task management and updates\",\r\n    isSystemRole: true,\r\n    permissions: [\r\n      // Project Management (read-only)\r\n      PERMISSIONS.PROJECT.READ,\r\n      // Task Management (assigned tasks only)\r\n      PERMISSIONS.TASK.READ,\r\n      PERMISSIONS.TASK.UPDATE,\r\n      PERMISSIONS.TASK.CHANGE_STATUS,\r\n      PERMISSIONS.TASK.CHANGE_PRIORITY,\r\n      // Dependency Management (read-only)\r\n      PERMISSIONS.DEPENDENCY.READ,\r\n      // Today's Tasks\r\n      ...Object.values(PERMISSIONS.TODAY_TASK),\r\n      // Notifications\r\n      PERMISSIONS.NOTIFICATION.VIEW,\r\n      // Activity Logs (own logs)\r\n      PERMISSIONS.LOG.VIEW,\r\n    ],\r\n  },\r\n} as const\r\n\r\n/**\r\n * Get all permission keys as a flat array\r\n */\r\nexport function getAllPermissions(): string[] {\r\n  return Object.values(PERMISSIONS).flatMap(module => Object.values(module))\r\n}\r\n\r\n/**\r\n * Get permissions by module\r\n */\r\nexport function getPermissionsByModule(module: string): string[] {\r\n  const moduleKey = module.toUpperCase() as keyof typeof PERMISSIONS\r\n  if (PERMISSIONS[moduleKey]) {\r\n    return Object.values(PERMISSIONS[moduleKey])\r\n  }\r\n  return []\r\n}\r\n\r\n","\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport { z } from \"zod\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { logActivity } from \"@/lib/activity-logger\"\r\nimport { clearPermissionCache } from \"@/lib/rbac\"\r\nimport { PERMISSIONS, DEFAULT_ROLES, getAllPermissions } from \"@/lib/permissions\"\r\nimport { requirePermission } from \"@/lib/rbac-helpers\"\r\n\r\nconst roleSchema = z.object({\r\n  name: z.string().min(1, \"Role name is required\"),\r\n  description: z.string().optional(),\r\n  permissionIds: z.array(z.number()).optional(),\r\n})\r\n\r\n/**\r\n * Get all roles\r\n */\r\nexport async function getRoles() {\r\n  const session = await getServerSession(authOptions)\r\n  if (!session) throw new Error(\"Unauthorized\")\r\n\r\n  // Enforce RBAC - no role-based bypasses\r\n  await requirePermission(parseInt(session.user.id), PERMISSIONS.ROLE.READ)\r\n\r\n  const roles = await prisma.role.findMany({\r\n    include: {\r\n      _count: {\r\n        select: {\r\n          permissions: true,\r\n          userRoles: true,\r\n        },\r\n      },\r\n      permissions: {\r\n        include: {\r\n          permission: true,\r\n        },\r\n      },\r\n    },\r\n    orderBy: { name: \"asc\" },\r\n  })\r\n\r\n  return roles\r\n}\r\n\r\n/**\r\n * Get a single role by ID\r\n */\r\nexport async function getRole(id: number) {\r\n  const session = await getServerSession(authOptions)\r\n  if (!session) throw new Error(\"Unauthorized\")\r\n\r\n  // Enforce RBAC - no role-based bypasses\r\n  await requirePermission(parseInt(session.user.id), PERMISSIONS.ROLE.READ)\r\n\r\n  const role = await prisma.role.findUnique({\r\n    where: { id },\r\n    include: {\r\n      permissions: {\r\n        include: {\r\n          permission: true,\r\n        },\r\n      },\r\n      userRoles: {\r\n        include: {\r\n          user: {\r\n            select: { id: true, username: true, email: true },\r\n          },\r\n        },\r\n      },\r\n    },\r\n  })\r\n\r\n  return role\r\n}\r\n\r\n/**\r\n * Create a new role\r\n */\r\nexport async function createRole(formData: FormData) {\r\n  const session = await getServerSession(authOptions)\r\n  if (!session) return { error: \"Unauthorized\" }\r\n\r\n  try {\r\n    // Enforce RBAC - no role-based bypasses\r\n    await requirePermission(parseInt(session.user.id), PERMISSIONS.ROLE.CREATE)\r\n  } catch (e) {\r\n    return { error: \"Permission denied\" }\r\n  }\r\n\r\n  const name = formData.get(\"name\") as string\r\n  const description = formData.get(\"description\") as string\r\n  const permissionIdsStr = formData.get(\"permissionIds\") as string\r\n\r\n  let permissionIds: number[] = []\r\n  if (permissionIdsStr) {\r\n    try {\r\n      permissionIds = JSON.parse(permissionIdsStr)\r\n    } catch {\r\n      // Ignore parse errors\r\n    }\r\n  }\r\n\r\n  const validated = roleSchema.safeParse({ name, description, permissionIds })\r\n\r\n  if (!validated.success) {\r\n    return { error: \"Validation failed\" }\r\n  }\r\n\r\n  try {\r\n    const role = await prisma.role.create({\r\n      data: {\r\n        name: validated.data.name,\r\n        description: validated.data.description || null,\r\n        permissions: validated.data.permissionIds && validated.data.permissionIds.length > 0 ? {\r\n          create: validated.data.permissionIds.map(permissionId => ({\r\n            permissionId,\r\n          })),\r\n        } : undefined,\r\n      },\r\n      include: {\r\n        permissions: {\r\n          include: { permission: true },\r\n        },\r\n      },\r\n    })\r\n\r\n    // Log activity\r\n    await logActivity({\r\n      actionType: \"role_created\",\r\n      actionCategory: \"settings\",\r\n      actionSummary: `Role \"${role.name}\" created`,\r\n      actionDetails: {\r\n        roleId: role.id,\r\n        roleName: role.name,\r\n        permissionCount: role.permissions.length,\r\n      },\r\n      performedById: parseInt(session.user.id),\r\n      entityType: \"role\",\r\n      entityId: role.id,\r\n    })\r\n\r\n    revalidatePath(\"/dashboard/admin/roles\")\r\n    return { success: true, role }\r\n  } catch (e: any) {\r\n    if (e.code === \"P2002\") {\r\n      return { error: \"Role with this name already exists\" }\r\n    }\r\n    console.error(e)\r\n    return { error: \"Failed to create role\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Update a role\r\n */\r\nexport async function updateRole(id: number, formData: FormData) {\r\n  const session = await getServerSession(authOptions)\r\n  if (!session) return { error: \"Unauthorized\" }\r\n\r\n  try {\r\n    // Enforce RBAC - no role-based bypasses\r\n    await requirePermission(parseInt(session.user.id), PERMISSIONS.ROLE.UPDATE)\r\n  } catch (e) {\r\n    return { error: \"Permission denied\" }\r\n  }\r\n\r\n  // Check if role is system role\r\n  const existingRole = await prisma.role.findUnique({\r\n    where: { id },\r\n    select: { isSystemRole: true, name: true },\r\n  })\r\n\r\n  if (existingRole?.isSystemRole && existingRole.name === \"System Admin\") {\r\n    return { error: \"Cannot modify System Admin role\" }\r\n  }\r\n\r\n  const name = formData.get(\"name\") as string\r\n  const description = formData.get(\"description\") as string\r\n  const permissionIdsStr = formData.get(\"permissionIds\") as string\r\n\r\n  let permissionIds: number[] = []\r\n  if (permissionIdsStr) {\r\n    try {\r\n      permissionIds = JSON.parse(permissionIdsStr)\r\n    } catch {\r\n      // Ignore parse errors\r\n    }\r\n  }\r\n\r\n  const validated = roleSchema.partial().safeParse({ name, description, permissionIds })\r\n\r\n  if (!validated.success) {\r\n    return { error: \"Validation failed\" }\r\n  }\r\n\r\n  try {\r\n    // Update role\r\n    const role = await prisma.role.update({\r\n      where: { id },\r\n      data: {\r\n        name: validated.data.name,\r\n        description: validated.data.description !== undefined ? validated.data.description : undefined,\r\n      },\r\n    })\r\n\r\n    // Update permissions if provided\r\n    if (validated.data.permissionIds !== undefined) {\r\n      // Remove all existing permissions\r\n      await prisma.rolePermission.deleteMany({\r\n        where: { roleId: id },\r\n      })\r\n\r\n      // Add new permissions (SQLite doesn't support createMany with unique constraints)\r\n      if (permissionIds.length > 0) {\r\n        for (const permissionId of permissionIds) {\r\n          try {\r\n            await prisma.rolePermission.create({\r\n              data: {\r\n                roleId: id,\r\n                permissionId,\r\n              },\r\n            })\r\n          } catch (e: any) {\r\n            // Skip if already exists\r\n            if (e.code !== 'P2002') {\r\n              throw e\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Clear permission caches for all users with this role\r\n      const usersWithRole = await prisma.userRole.findMany({\r\n        where: { roleId: id },\r\n        select: { userId: true, scopeId: true },\r\n      })\r\n\r\n      for (const userRole of usersWithRole) {\r\n        clearPermissionCache(userRole.userId, userRole.scopeId || undefined)\r\n      }\r\n    }\r\n\r\n    // Log activity\r\n    await logActivity({\r\n      actionType: \"role_updated\",\r\n      actionCategory: \"settings\",\r\n      actionSummary: `Role \"${role.name}\" updated`,\r\n      actionDetails: {\r\n        roleId: role.id,\r\n        roleName: role.name,\r\n      },\r\n      performedById: parseInt(session.user.id),\r\n      entityType: \"role\",\r\n      entityId: role.id,\r\n    })\r\n\r\n    revalidatePath(\"/dashboard/admin/roles\")\r\n    revalidatePath(`/dashboard/admin/roles/${id}`)\r\n    return { success: true }\r\n  } catch (e: any) {\r\n    if (e.code === \"P2002\") {\r\n      return { error: \"Role with this name already exists\" }\r\n    }\r\n    console.error(e)\r\n    return { error: \"Failed to update role\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Delete a role\r\n */\r\nexport async function deleteRole(id: number) {\r\n  const session = await getServerSession(authOptions)\r\n  if (!session) return { error: \"Unauthorized\" }\r\n\r\n  try {\r\n    // Enforce RBAC - no role-based bypasses\r\n    await requirePermission(parseInt(session.user.id), PERMISSIONS.ROLE.DELETE)\r\n  } catch (e) {\r\n    return { error: \"Permission denied\" }\r\n  }\r\n\r\n  // Check if role is system role\r\n  const role = await prisma.role.findUnique({\r\n    where: { id },\r\n    select: { isSystemRole: true, name: true },\r\n  })\r\n\r\n  if (role?.isSystemRole) {\r\n    return { error: \"Cannot delete system role\" }\r\n  }\r\n\r\n  // Check if any users have this role\r\n  const userCount = await prisma.userRole.count({\r\n    where: { roleId: id },\r\n  })\r\n\r\n  if (userCount > 0) {\r\n    return { error: `Cannot delete role: ${userCount} user(s) have this role assigned` }\r\n  }\r\n\r\n  try {\r\n    await prisma.role.delete({\r\n      where: { id },\r\n    })\r\n\r\n    // Log activity\r\n    await logActivity({\r\n      actionType: \"role_deleted\",\r\n      actionCategory: \"settings\",\r\n      actionSummary: `Role \"${role?.name}\" deleted`,\r\n      actionDetails: {\r\n        roleId: id,\r\n        roleName: role?.name,\r\n      },\r\n      performedById: parseInt(session.user.id),\r\n      entityType: \"role\",\r\n      entityId: id,\r\n    })\r\n\r\n    revalidatePath(\"/dashboard/admin/roles\")\r\n    return { success: true }\r\n  } catch (e) {\r\n    console.error(e)\r\n    return { error: \"Failed to delete role\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Get all permissions\r\n */\r\nexport async function getPermissions() {\r\n  const session = await getServerSession(authOptions)\r\n  if (!session) throw new Error(\"Unauthorized\")\r\n\r\n  const permissions = await prisma.permission.findMany({\r\n    orderBy: [{ module: \"asc\" }, { name: \"asc\" }],\r\n  })\r\n\r\n  // Group by module\r\n  const grouped: Record<string, typeof permissions> = {}\r\n  for (const perm of permissions) {\r\n    if (!grouped[perm.module]) {\r\n      grouped[perm.module] = []\r\n    }\r\n    grouped[perm.module].push(perm)\r\n  }\r\n\r\n  return { permissions, grouped }\r\n}\r\n\r\n/**\r\n * Assign role to user\r\n */\r\nexport async function assignRoleToUser(\r\n  userId: number,\r\n  roleId: number,\r\n  scopeType?: \"global\" | \"project\",\r\n  scopeId?: number\r\n) {\r\n  const session = await getServerSession(authOptions)\r\n  if (!session) return { error: \"Unauthorized\" }\r\n\r\n  try {\r\n    // Enforce RBAC - no role-based bypasses\r\n    await requirePermission(parseInt(session.user.id), PERMISSIONS.ROLE.ASSIGN)\r\n  } catch (e) {\r\n    return { error: \"Permission denied\" }\r\n  }\r\n\r\n  try {\r\n    await prisma.userRole.create({\r\n      data: {\r\n        userId,\r\n        roleId,\r\n        scopeType: scopeType || null,\r\n        scopeId: scopeId || null,\r\n        assignedBy: parseInt(session.user.id),\r\n      },\r\n    })\r\n\r\n    // Clear permission cache\r\n    clearPermissionCache(userId, scopeId)\r\n\r\n    // Log activity\r\n    await logActivity({\r\n      actionType: \"role_assigned\",\r\n      actionCategory: \"settings\",\r\n      actionSummary: `Role assigned to user`,\r\n      actionDetails: {\r\n        userId,\r\n        roleId,\r\n        scopeType,\r\n        scopeId,\r\n      },\r\n      performedById: parseInt(session.user.id),\r\n      affectedUserId: userId,\r\n      entityType: \"role\",\r\n      entityId: roleId,\r\n    })\r\n\r\n    revalidatePath(\"/dashboard/admin/users\")\r\n    return { success: true }\r\n  } catch (e: any) {\r\n    if (e.code === \"P2002\") {\r\n      return { error: \"User already has this role\" }\r\n    }\r\n    console.error(e)\r\n    return { error: \"Failed to assign role\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Remove role from user\r\n */\r\nexport async function removeRoleFromUser(\r\n  userId: number,\r\n  roleId: number,\r\n  scopeType?: \"global\" | \"project\",\r\n  scopeId?: number\r\n) {\r\n  const session = await getServerSession(authOptions)\r\n  if (!session) return { error: \"Unauthorized\" }\r\n\r\n  try {\r\n    // Enforce RBAC - no role-based bypasses\r\n    await requirePermission(parseInt(session.user.id), PERMISSIONS.ROLE.ASSIGN)\r\n  } catch (e) {\r\n    return { error: \"Permission denied\" }\r\n  }\r\n\r\n  try {\r\n    await prisma.userRole.deleteMany({\r\n      where: {\r\n        userId,\r\n        roleId,\r\n        scopeType: scopeType || null,\r\n        scopeId: scopeId || null,\r\n      },\r\n    })\r\n\r\n    // Clear permission cache\r\n    clearPermissionCache(userId, scopeId)\r\n\r\n    // Log activity\r\n    await logActivity({\r\n      actionType: \"role_removed\",\r\n      actionCategory: \"settings\",\r\n      actionSummary: `Role removed from user`,\r\n      actionDetails: {\r\n        userId,\r\n        roleId,\r\n        scopeType,\r\n        scopeId,\r\n      },\r\n      performedById: parseInt(session.user.id),\r\n      affectedUserId: userId,\r\n      entityType: \"role\",\r\n      entityId: roleId,\r\n    })\r\n\r\n    revalidatePath(\"/dashboard/admin/users\")\r\n    return { success: true }\r\n  } catch (e) {\r\n    console.error(e)\r\n    return { error: \"Failed to remove role\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Initialize default roles and permissions\r\n */\r\nexport async function initializeRBAC() {\r\n  try {\r\n    console.log(\"Initializing RBAC system...\")\r\n\r\n    // Create all permissions\r\n    const allPermissionKeys = getAllPermissions()\r\n    const permissionMap = new Map<string, number>()\r\n\r\n    for (const key of allPermissionKeys) {\r\n      const [module, ...actionParts] = key.split(\".\")\r\n      const action = actionParts.join(\".\")\r\n      const name = action.replace(/_/g, \" \").replace(/\\b\\w/g, l => l.toUpperCase())\r\n      const category = actionParts.length > 1 ? actionParts[0] : null\r\n\r\n      const permission = await prisma.permission.upsert({\r\n        where: { key },\r\n        update: {},\r\n        create: {\r\n          key,\r\n          name,\r\n          description: `Permission to ${action.replace(/_/g, \" \")}`,\r\n          module,\r\n          category,\r\n        },\r\n      })\r\n\r\n      permissionMap.set(key, permission.id)\r\n    }\r\n\r\n    console.log(`✅ Created/updated ${permissionMap.size} permissions`)\r\n\r\n    // STEP 1: Delete ALL user role assignments first\r\n    const userRoleCount = await prisma.userRole.count()\r\n    if (userRoleCount > 0) {\r\n      console.log(`🗑️  Removing ${userRoleCount} user role assignment(s)`)\r\n      await prisma.userRole.deleteMany({})\r\n      console.log(`✅ Deleted all user role assignments`)\r\n    }\r\n\r\n    // STEP 2: Delete ALL role permissions\r\n    const rolePermissionCount = await prisma.rolePermission.count()\r\n    if (rolePermissionCount > 0) {\r\n      console.log(`🗑️  Removing ${rolePermissionCount} role permission(s)`)\r\n      await prisma.rolePermission.deleteMany({})\r\n      console.log(`✅ Deleted all role permissions`)\r\n    }\r\n\r\n    // STEP 3: Delete ALL existing roles (including system roles)\r\n    // First, explicitly delete old role names that shouldn't exist\r\n    const oldRoleNames = [\"Super Admin\", \"Project Admin\", \"Audit Admin\"]\r\n    for (const oldRoleName of oldRoleNames) {\r\n      const deleted = await prisma.role.deleteMany({\r\n        where: { name: oldRoleName },\r\n      })\r\n      if (deleted.count > 0) {\r\n        console.log(`🗑️  Deleted old role: ${oldRoleName}`)\r\n      }\r\n    }\r\n\r\n    // Now delete ALL remaining roles\r\n    const existingRoleCount = await prisma.role.count()\r\n    if (existingRoleCount > 0) {\r\n      console.log(`🗑️  Deleting ${existingRoleCount} remaining role(s)...`)\r\n      const deletedRoles = await prisma.role.deleteMany({})\r\n      console.log(`✅ Deleted ${deletedRoles.count} role(s)`)\r\n      \r\n      // Verify deletion\r\n      const remainingRoles = await prisma.role.count()\r\n      if (remainingRoles > 0) {\r\n        console.log(`⚠️  Warning: ${remainingRoles} role(s) still exist after deletion`)\r\n        const remaining = await prisma.role.findMany({ select: { id: true, name: true } })\r\n        console.log(`   Remaining roles: ${remaining.map(r => r.name).join(\", \")}`)\r\n      }\r\n    } else {\r\n      console.log(`ℹ️  No existing roles to delete`)\r\n    }\r\n\r\n    // Create new default roles (all old roles have been deleted, so we use create)\r\n    for (const [roleKey, roleData] of Object.entries(DEFAULT_ROLES)) {\r\n      // Check if role already exists (shouldn't happen after delete, but just in case)\r\n      const existingRole = await prisma.role.findUnique({\r\n        where: { name: roleData.name },\r\n      })\r\n\r\n      let role\r\n      if (existingRole) {\r\n        // Update existing role if it somehow still exists\r\n        role = await prisma.role.update({\r\n          where: { id: existingRole.id },\r\n          data: {\r\n            description: roleData.description,\r\n            isSystemRole: roleData.isSystemRole,\r\n          },\r\n        })\r\n        // Clear existing permissions\r\n        await prisma.rolePermission.deleteMany({\r\n          where: { roleId: role.id },\r\n        })\r\n      } else {\r\n        // Create new role\r\n        role = await prisma.role.create({\r\n          data: {\r\n            name: roleData.name,\r\n            description: roleData.description,\r\n            isSystemRole: roleData.isSystemRole,\r\n          },\r\n        })\r\n      }\r\n\r\n      // Assign permissions to role\r\n      const permissionIds = roleData.permissions\r\n        .map(key => permissionMap.get(key))\r\n        .filter((id): id is number => id !== undefined)\r\n\r\n      // Remove existing permissions\r\n      await prisma.rolePermission.deleteMany({\r\n        where: { roleId: role.id },\r\n      })\r\n\r\n      // Add new permissions (SQLite doesn't support createMany with unique constraints)\r\n      if (permissionIds.length > 0) {\r\n        for (const permissionId of permissionIds) {\r\n          try {\r\n            await prisma.rolePermission.create({\r\n              data: {\r\n                roleId: role.id,\r\n                permissionId,\r\n              },\r\n            })\r\n          } catch (e: any) {\r\n            // Skip if already exists\r\n            if (e.code !== 'P2002') {\r\n              throw e\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      console.log(`✅ Created/updated role: ${role.name} with ${permissionIds.length} permissions`)\r\n    }\r\n\r\n    console.log(\"✅ RBAC initialization completed!\")\r\n    return { success: true }\r\n  } catch (error: any) {\r\n    console.error(\"❌ RBAC initialization failed:\", error)\r\n    return { error: error.message }\r\n  }\r\n}\r\n\r\n","/**\r\n * File upload validation and sanitization\r\n * Prevents malicious file uploads through MIME type checking, size limits, and magic bytes validation\r\n */\r\n\r\n// Allowed MIME types with max file sizes (whitelist approach)\r\nconst ALLOWED_MIME_TYPES: Record<string, { ext: string; maxSize: number }> = {\r\n  // Images\r\n  'image/jpeg': { ext: 'jpg', maxSize: 5 * 1024 * 1024 }, // 5MB\r\n  'image/png': { ext: 'png', maxSize: 5 * 1024 * 1024 },\r\n  'image/webp': { ext: 'webp', maxSize: 5 * 1024 * 1024 },\r\n  'image/gif': { ext: 'gif', maxSize: 5 * 1024 * 1024 },\r\n  'image/svg+xml': { ext: 'svg', maxSize: 2 * 1024 * 1024 },\r\n\r\n  // Documents\r\n  'application/pdf': { ext: 'pdf', maxSize: 10 * 1024 * 1024 }, // 10MB\r\n  'application/msword': { ext: 'doc', maxSize: 10 * 1024 * 1024 },\r\n  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': {\r\n    ext: 'docx',\r\n    maxSize: 10 * 1024 * 1024,\r\n  },\r\n  'application/vnd.ms-excel': { ext: 'xls', maxSize: 10 * 1024 * 1024 },\r\n  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': {\r\n    ext: 'xlsx',\r\n    maxSize: 10 * 1024 * 1024,\r\n  },\r\n  'text/plain': { ext: 'txt', maxSize: 5 * 1024 * 1024 },\r\n  'text/csv': { ext: 'csv', maxSize: 5 * 1024 * 1024 },\r\n}\r\n\r\n// Disallowed extensions (defense in depth - for additional security)\r\nconst DANGEROUS_EXTENSIONS = [\r\n  'exe',\r\n  'bat',\r\n  'cmd',\r\n  'com',\r\n  'scr',\r\n  'vbs',\r\n  'js',\r\n  'jar',\r\n  'zip',\r\n  'rar',\r\n  '7z',\r\n  'dll',\r\n  'msi',\r\n  'app',\r\n  'deb',\r\n  'rpm',\r\n  'dmg',\r\n  'pkg',\r\n  'run',\r\n  'sh',\r\n  'bash',\r\n  'zsh',\r\n  'ps1',\r\n  'psc1',\r\n  'msh',\r\n  'msh1',\r\n  'mshxml',\r\n  'msh1xml',\r\n  'pssc',\r\n  'psc2',\r\n  'msh2',\r\n  'msh2xml',\r\n  'psc3',\r\n  'msh3',\r\n  'msh3xml',\r\n  'aspx',\r\n  'asp',\r\n  'php',\r\n  'php3',\r\n  'php4',\r\n  'php5',\r\n  'jsp',\r\n  'jspx',\r\n  'jspf',\r\n  'jsw',\r\n  'jsv',\r\n  'jspx',\r\n  'wsh',\r\n  'wsf',\r\n  'py',\r\n  'pyc',\r\n  'pyo',\r\n  'rb',\r\n  'rbw',\r\n  'cgi',\r\n  'pl',\r\n  'ada',\r\n  'asm',\r\n  'bas',\r\n  'c',\r\n  'cpp',\r\n  'cxx',\r\n  'cc',\r\n  'h',\r\n  'hpp',\r\n  'cs',\r\n  'java',\r\n  'class',\r\n  'swift',\r\n  'kt',\r\n  'go',\r\n  'rs',\r\n  'ts',\r\n  'tsx',\r\n  'jsx',\r\n]\r\n\r\nexport interface ValidationResult {\r\n  valid: boolean\r\n  error?: string\r\n  suggestedExtension?: string\r\n}\r\n\r\n/**\r\n * Validate file before upload\r\n * Checks:\r\n * 1. MIME type is in allowlist\r\n * 2. File size doesn't exceed limit\r\n * 3. Extension is not in blocklist\r\n * 4. Extension matches MIME type\r\n *\r\n * @param file - File to validate\r\n * @returns ValidationResult with error if invalid\r\n *\r\n * @example\r\n * const result = validateFileUpload(file)\r\n * if (!result.valid) {\r\n *   return { error: result.error }\r\n * }\r\n */\r\nexport function validateFileUpload(file: File): ValidationResult {\r\n  if (!file) {\r\n    return {\r\n      valid: false,\r\n      error: 'No file provided',\r\n    }\r\n  }\r\n\r\n  // 1. Check if file has a name\r\n  if (!file.name || file.name.trim() === '') {\r\n    return {\r\n      valid: false,\r\n      error: 'File must have a name',\r\n    }\r\n  }\r\n\r\n  // 2. Check MIME type against allowlist\r\n  if (!ALLOWED_MIME_TYPES[file.type]) {\r\n    const allowedTypes = Object.keys(ALLOWED_MIME_TYPES).join(', ')\r\n    return {\r\n      valid: false,\r\n      error: `File type \"${file.type || 'unknown'}\" is not allowed. Supported types: ${allowedTypes}`,\r\n    }\r\n  }\r\n\r\n  // 3. Check file size\r\n  const maxSize = ALLOWED_MIME_TYPES[file.type].maxSize\r\n  if (file.size === 0) {\r\n    return {\r\n      valid: false,\r\n      error: 'File is empty',\r\n    }\r\n  }\r\n\r\n  if (file.size > maxSize) {\r\n    const maxSizeMB = (maxSize / 1024 / 1024).toFixed(2)\r\n    const fileSizeMB = (file.size / 1024 / 1024).toFixed(2)\r\n    return {\r\n      valid: false,\r\n      error: `File size ${fileSizeMB}MB exceeds maximum ${maxSizeMB}MB for this file type`,\r\n    }\r\n  }\r\n\r\n  // 4. Check file extension\r\n  const ext = getFileExtension(file.name).toLowerCase()\r\n  if (ext && DANGEROUS_EXTENSIONS.includes(ext)) {\r\n    return {\r\n      valid: false,\r\n      error: `File extension \".${ext}\" is not allowed for security reasons`,\r\n    }\r\n  }\r\n\r\n  // 5. Validate extension matches MIME type (warning only)\r\n  const expectedExt = ALLOWED_MIME_TYPES[file.type].ext\r\n  if (ext && ext !== expectedExt) {\r\n    // Allow but log warning - some systems use different extensions\r\n    console.warn(\r\n      `Warning: File extension \".${ext}\" may not match MIME type \"${file.type}\". Expected: \".${expectedExt}\"`\r\n    )\r\n  }\r\n\r\n  return { valid: true }\r\n}\r\n\r\n/**\r\n * Sanitize filename to prevent directory traversal and special characters\r\n *\r\n * @param filename - Filename to sanitize\r\n * @returns Safe filename\r\n */\r\nexport function sanitizeFilename(filename: string): string {\r\n  if (!filename) return 'file'\r\n\r\n  return (\r\n    filename\r\n      .replace(/\\\\/g, '') // Remove backslashes\r\n      .replace(/\\//g, '') // Remove forward slashes\r\n      .replace(/\\.\\./g, '') // Remove dot-dot\r\n      .replace(/[<>:\"|?*\\x00-\\x1f]/g, '') // Remove special/control characters\r\n      .replace(/\\s+/g, '_') // Replace whitespace with underscore\r\n      .substring(0, 255) // Limit filename length\r\n  )\r\n}\r\n\r\n/**\r\n * Generate safe filename for storage with unique identifier\r\n *\r\n * @param originalName - Original filename from upload\r\n * @param userId - User ID for tracking\r\n * @returns Safe unique filename\r\n */\r\nexport function generateSafeFilename(originalName: string, userId: number): string {\r\n  const ext = getFileExtension(originalName)\r\n  const timestamp = Date.now()\r\n  const random = Math.random().toString(36).substring(2, 8)\r\n\r\n  // Format: user_123_timestamp_random.ext\r\n  return `u${userId}_${timestamp}_${random}.${ext}`\r\n}\r\n\r\n/**\r\n * Get file extension from filename\r\n *\r\n * @param filename - Filename\r\n * @returns File extension without the dot\r\n */\r\nfunction getFileExtension(filename: string): string {\r\n  if (!filename) return ''\r\n  const parts = filename.split('.')\r\n  return parts.length > 1 ? parts[parts.length - 1] : ''\r\n}\r\n\r\n/**\r\n * Validate file content by checking magic bytes (file signature)\r\n * This prevents MIME type spoofing attacks\r\n *\r\n * @param buffer - File content as ArrayBuffer\r\n * @param mimeType - Expected MIME type\r\n * @returns True if magic bytes match expected type, false otherwise\r\n */\r\nexport async function validateFileContent(buffer: ArrayBuffer, mimeType: string): Promise<boolean> {\r\n  // Magic numbers for common file types\r\n  const magicNumbers: Record<string, number[]> = {\r\n    'image/jpeg': [0xff, 0xd8, 0xff], // JPEG starts with FFD8FF\r\n    'image/png': [0x89, 0x50, 0x4e, 0x47], // PNG starts with 89504E47\r\n    'image/gif': [0x47, 0x49, 0x46], // GIF starts with GIF\r\n    'image/webp': [0x52, 0x49, 0x46, 0x46], // WebP starts with RIFF\r\n    'application/pdf': [0x25, 0x50, 0x44, 0x46], // PDF starts with %PDF\r\n  }\r\n\r\n  const magic = magicNumbers[mimeType]\r\n  if (!magic) return true // No magic bytes defined for this type, skip validation\r\n\r\n  const bytes = new Uint8Array(buffer)\r\n\r\n  // Check if file has enough bytes\r\n  if (bytes.length < magic.length) {\r\n    return false\r\n  }\r\n\r\n  // Check if file starts with expected magic bytes\r\n  for (let i = 0; i < magic.length; i++) {\r\n    if (bytes[i] !== magic[i]) {\r\n      return false\r\n    }\r\n  }\r\n\r\n  return true\r\n}\r\n\r\n/**\r\n * Get human-readable file size\r\n *\r\n * @param bytes - Size in bytes\r\n * @returns Human-readable size string\r\n */\r\nexport function getReadableFileSize(bytes: number): string {\r\n  const units = ['B', 'KB', 'MB', 'GB']\r\n  let size = bytes\r\n  let unitIndex = 0\r\n\r\n  while (size >= 1024 && unitIndex < units.length - 1) {\r\n    size /= 1024\r\n    unitIndex++\r\n  }\r\n\r\n  return `${size.toFixed(2)} ${units[unitIndex]}`\r\n}\r\n\r\n/**\r\n * Get maximum allowed file size for a MIME type\r\n *\r\n * @param mimeType - MIME type\r\n * @returns Maximum file size in bytes\r\n */\r\nexport function getMaxFileSize(mimeType: string): number {\r\n  return ALLOWED_MIME_TYPES[mimeType]?.maxSize ?? 0\r\n}\r\n\r\n/**\r\n * Get list of allowed MIME types\r\n *\r\n * @returns Array of allowed MIME types\r\n */\r\nexport function getAllowedMimeTypes(): string[] {\r\n  return Object.keys(ALLOWED_MIME_TYPES)\r\n}\r\n\r\n/**\r\n * Check if MIME type is allowed\r\n *\r\n * @param mimeType - MIME type to check\r\n * @returns True if allowed, false otherwise\r\n */\r\nexport function isAllowedMimeType(mimeType: string): boolean {\r\n  return mimeType in ALLOWED_MIME_TYPES\r\n}\r\n","\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { hasPermissionWithoutRoleBypass } from \"@/lib/rbac-helpers\"\r\n\r\n// Check if user can manage settings (self or admin)\r\nasync function checkUserSettingsAccess(targetUserId: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) return { authorized: false, session: null, hasAdminPermission: false }\r\n\r\n    const userId = parseInt(session.user.id)\r\n    const hasAdminPermission = await hasPermissionWithoutRoleBypass(userId, \"admin.access\")\r\n    const isSelf = userId === targetUserId\r\n\r\n    // User can edit their own settings, admin can edit any user's settings\r\n    const authorized = isSelf || hasAdminPermission\r\n\r\n    return { authorized, session, hasAdminPermission, isSelf }\r\n}\r\n\r\n// Get all user settings\r\nexport async function getUserSettings(userId: number) {\r\n    const { authorized, session } = await checkUserSettingsAccess(userId)\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized: You can only view your own settings\" }\r\n    }\r\n\r\n    try {\r\n        // Check if UserSetting model exists in Prisma client\r\n        if (!prisma.userSetting) {\r\n            // Prisma client not regenerated yet - return empty settings\r\n            return { success: true, settings: {} }\r\n        }\r\n\r\n        const userSettings = await prisma.userSetting.findMany({\r\n            where: { userId },\r\n            orderBy: [\r\n                { category: \"asc\" },\r\n                { key: \"asc\" }\r\n            ],\r\n            include: {\r\n                updater: {\r\n                    select: {\r\n                        id: true,\r\n                        username: true,\r\n                        email: true\r\n                    }\r\n                }\r\n            }\r\n        })\r\n\r\n        // Group settings by category\r\n        const grouped: Record<string, any[]> = {}\r\n        userSettings.forEach(setting => {\r\n            if (!grouped[setting.category]) {\r\n                grouped[setting.category] = []\r\n            }\r\n            grouped[setting.category].push({\r\n                id: setting.id,\r\n                key: setting.key,\r\n                value: safeJsonParse(setting.value),\r\n                category: setting.category,\r\n                updatedAt: setting.updatedAt,\r\n                updatedBy: setting.updater\r\n            })\r\n        })\r\n\r\n        return { success: true, settings: grouped }\r\n    } catch (e: any) {\r\n        console.error(\"getUserSettings Error:\", e)\r\n        return { error: \"Failed to fetch user settings\", details: e.message }\r\n    }\r\n}\r\n\r\n// Get resolved settings (user → project → global)\r\nexport async function getResolvedUserSettings(userId: number, projectId?: number) {\r\n    const session = await getServerSession(authOptions)\r\n    if (!session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        // Check if UserSetting model exists in Prisma client\r\n        if (!prisma.userSetting) {\r\n            // Prisma client not regenerated yet - return system defaults\r\n            const resolved: Record<string, any> = {}\r\n            const categories = [\"preferences\", \"taskView\", \"todayTasks\", \"notifications\", \"workflow\"]\r\n            for (const category of categories) {\r\n                resolved[category] = {\r\n                    value: getSystemDefault(category),\r\n                    source: \"system\",\r\n                    enabled: false\r\n                }\r\n            }\r\n            return { success: true, settings: resolved }\r\n        }\r\n\r\n        // Get user settings\r\n        const userSettings = await prisma.userSetting.findMany({\r\n            where: { userId }\r\n        })\r\n\r\n        // Get project settings if projectId provided\r\n        let projectSettings: any[] = []\r\n        if (projectId) {\r\n            projectSettings = await prisma.projectSetting.findMany({\r\n                where: { projectId, enabled: true }\r\n            })\r\n        }\r\n\r\n        // Get global settings\r\n        const globalSettings = await prisma.systemSetting.findMany()\r\n\r\n        // Create a map of resolved settings\r\n        const resolved: Record<string, any> = {}\r\n\r\n        // Categories that always allow user override\r\n        const alwaysUserOverride = [\"preferences\", \"notifications\", \"workflow\"]\r\n\r\n        // Process each category\r\n        const categories = [\"preferences\", \"taskView\", \"todayTasks\", \"notifications\", \"workflow\"]\r\n\r\n        for (const category of categories) {\r\n            const userSetting = userSettings.find(s => s.category === category && s.key === category)\r\n            const projectSetting = projectSettings.find(s => s.category === category && s.key === category)\r\n            const globalSetting = globalSettings.find(s => s.category === category && s.key === category)\r\n\r\n            // Resolution priority: User (if allowed) → Project → Global → System Default\r\n            if (userSetting && alwaysUserOverride.includes(category)) {\r\n                // User override always allowed for these categories\r\n                resolved[category] = {\r\n                    value: safeJsonParse(userSetting.value),\r\n                    source: \"user\",\r\n                    enabled: true\r\n                }\r\n            } else if (projectSetting && projectSetting.enabled) {\r\n                // Project override\r\n                resolved[category] = {\r\n                    value: safeJsonParse(projectSetting.value),\r\n                    source: \"project\",\r\n                    enabled: true\r\n                }\r\n            } else if (userSetting) {\r\n                // User setting (for categories that don't always override)\r\n                resolved[category] = {\r\n                    value: safeJsonParse(userSetting.value),\r\n                    source: \"user\",\r\n                    enabled: true\r\n                }\r\n            } else if (globalSetting) {\r\n                // Global default\r\n                resolved[category] = {\r\n                    value: safeJsonParse(globalSetting.value),\r\n                    source: \"global\",\r\n                    enabled: false\r\n                }\r\n            } else {\r\n                // System default (would need to be defined)\r\n                resolved[category] = {\r\n                    value: getSystemDefault(category),\r\n                    source: \"system\",\r\n                    enabled: false\r\n                }\r\n            }\r\n        }\r\n\r\n        return { success: true, settings: resolved }\r\n    } catch (e: any) {\r\n        console.error(\"getResolvedUserSettings Error:\", e)\r\n        return { error: \"Failed to fetch resolved settings\", details: e.message }\r\n    }\r\n}\r\n\r\n// Get system defaults\r\nfunction getSystemDefault(category: string): any {\r\n    const defaults: Record<string, any> = {\r\n        preferences: {\r\n            timezone: \"Africa/Cairo\",\r\n            workingHours: { start: \"09:00\", end: \"17:00\" }\r\n        },\r\n        taskView: {\r\n            defaultView: \"list\",\r\n            defaultSort: { field: \"priority\", order: \"desc\" },\r\n            showCompleted: true,\r\n            showBlocked: true,\r\n            defaultProjectFilter: null\r\n        },\r\n        todayTasks: {\r\n            autoOpenOnLogin: false,\r\n            defaultView: \"compact\",\r\n            highlightBlocked: true,\r\n            showDependencyDetails: false\r\n        },\r\n        notifications: {\r\n            channels: { inApp: true, email: true },\r\n            grouping: \"realtime\",\r\n            priorityFilter: [\"low\", \"normal\", \"high\", \"urgent\"],\r\n            soundEnabled: true\r\n        },\r\n        workflow: {\r\n            defaultLandingPage: \"dashboard\",\r\n            defaultProjectContext: null,\r\n            standupSummaryDisplay: { enabled: false, format: \"compact\" }\r\n        }\r\n    }\r\n    return defaults[category] || null\r\n}\r\n\r\n// Get a specific user setting\r\nexport async function getUserSetting(userId: number, key: string) {\r\n    const { authorized, session } = await checkUserSettingsAccess(userId)\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        if (!prisma.userSetting) {\r\n            return { error: \"User settings not available. Please restart the development server.\" }\r\n        }\r\n\r\n        const setting = await prisma.userSetting.findUnique({\r\n            where: {\r\n                userId_key: {\r\n                    userId,\r\n                    key\r\n                }\r\n            },\r\n            include: {\r\n                updater: {\r\n                    select: {\r\n                        id: true,\r\n                        username: true,\r\n                        email: true\r\n                    }\r\n                }\r\n            }\r\n        })\r\n\r\n        if (!setting) {\r\n            return { error: \"Setting not found\" }\r\n        }\r\n\r\n        return {\r\n            success: true,\r\n            setting: {\r\n                id: setting.id,\r\n                key: setting.key,\r\n                value: safeJsonParse(setting.value),\r\n                category: setting.category,\r\n                updatedAt: setting.updatedAt,\r\n                updatedBy: setting.updater\r\n            }\r\n        }\r\n    } catch (e: any) {\r\n        console.error(\"getUserSetting Error:\", e)\r\n        return { error: \"Failed to fetch setting\", details: e.message }\r\n    }\r\n}\r\n\r\n// Update a user setting\r\nexport async function updateUserSetting(\r\n    userId: number,\r\n    key: string,\r\n    value: any,\r\n    reason?: string\r\n) {\r\n    const { authorized, session, hasAdminPermission } = await checkUserSettingsAccess(userId)\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        if (!prisma.userSetting || !prisma.userSettingsChangeLog) {\r\n            return { error: \"User settings not available. Please restart the development server.\" }\r\n        }\r\n\r\n        // Validate setting value based on category\r\n        const category = getCategoryFromKey(key)\r\n        if (!validateSettingValue(category, value)) {\r\n            return { error: `Invalid value for setting ${key}` }\r\n        }\r\n\r\n        // Get existing setting\r\n        const existing = await prisma.userSetting.findUnique({\r\n            where: {\r\n                userId_key: {\r\n                    userId,\r\n                    key\r\n                }\r\n            }\r\n        })\r\n\r\n        const oldValue = existing?.value || null\r\n        const newValue = JSON.stringify(value)\r\n\r\n        // Update or create setting\r\n        const updated = await prisma.userSetting.upsert({\r\n            where: {\r\n                userId_key: {\r\n                    userId,\r\n                    key\r\n                }\r\n            },\r\n            create: {\r\n                userId,\r\n                key,\r\n                category,\r\n                value: newValue,\r\n                updatedBy: parseInt(session.user.id)\r\n            },\r\n            update: {\r\n                value: newValue,\r\n                updatedBy: parseInt(session.user.id)\r\n            }\r\n        })\r\n\r\n        // Log the change\r\n        await prisma.userSettingsChangeLog.create({\r\n            data: {\r\n                userId,\r\n                settingKey: key,\r\n                category,\r\n                oldValue: oldValue,\r\n                newValue: newValue,\r\n                reason: reason || null,\r\n                changedBy: parseInt(session.user.id),\r\n                settingId: updated.id\r\n            }\r\n        })\r\n\r\n        revalidatePath(`/dashboard/settings`)\r\n        revalidatePath(`/dashboard`)\r\n\r\n        return { success: true }\r\n    } catch (e: any) {\r\n        console.error(\"updateUserSetting Error:\", e)\r\n        return { error: \"Failed to update setting\", details: e.message }\r\n    }\r\n}\r\n\r\n// Create a new user setting\r\nexport async function createUserSetting(\r\n    userId: number,\r\n    key: string,\r\n    category: string,\r\n    value: any,\r\n    description?: string\r\n) {\r\n    const { authorized, session } = await checkUserSettingsAccess(userId)\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        if (!prisma.userSetting) {\r\n            return { error: \"User settings not available. Please restart the development server.\" }\r\n        }\r\n\r\n        if (!validateSettingValue(category, value)) {\r\n            return { error: `Invalid value for setting ${key}` }\r\n        }\r\n\r\n        const setting = await prisma.userSetting.create({\r\n            data: {\r\n                userId,\r\n                key,\r\n                category,\r\n                value: JSON.stringify(value),\r\n                updatedBy: parseInt(session.user.id)\r\n            }\r\n        })\r\n\r\n        revalidatePath(`/dashboard/settings`)\r\n\r\n        return { success: true, setting }\r\n    } catch (e: any) {\r\n        console.error(\"createUserSetting Error:\", e)\r\n        return { error: \"Failed to create setting\", details: e.message }\r\n    }\r\n}\r\n\r\n// Reset a user setting to default\r\nexport async function resetUserSetting(userId: number, key: string) {\r\n    const { authorized, session } = await checkUserSettingsAccess(userId)\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        if (!prisma.userSetting) {\r\n            return { error: \"User settings not available. Please restart the development server.\" }\r\n        }\r\n\r\n        const category = getCategoryFromKey(key)\r\n        const defaultValue = getSystemDefault(category)\r\n\r\n        if (!defaultValue) {\r\n            return { error: \"No default value found for this setting\" }\r\n        }\r\n\r\n        // Delete the setting (will use system default)\r\n        await prisma.userSetting.delete({\r\n            where: {\r\n                userId_key: {\r\n                    userId,\r\n                    key\r\n                }\r\n            }\r\n        })\r\n\r\n        revalidatePath(`/dashboard/settings`)\r\n\r\n        return { success: true }\r\n    } catch (e: any) {\r\n        console.error(\"resetUserSetting Error:\", e)\r\n        return { error: \"Failed to reset setting\", details: e.message }\r\n    }\r\n}\r\n\r\n// Get change history\r\nexport async function getUserSettingsChangeLog(\r\n    userId: number,\r\n    settingKey?: string,\r\n    limit: number = 50,\r\n    offset: number = 0\r\n) {\r\n    const { authorized, session } = await checkUserSettingsAccess(userId)\r\n    if (!authorized || !session) {\r\n        return { error: \"Unauthorized\" }\r\n    }\r\n\r\n    try {\r\n        if (!prisma.userSettingsChangeLog) {\r\n            return { error: \"User settings not available. Please restart the development server.\" }\r\n        }\r\n\r\n        const where: any = { userId }\r\n        if (settingKey) {\r\n            where.settingKey = settingKey\r\n        }\r\n\r\n        const logs = await prisma.userSettingsChangeLog.findMany({\r\n            where,\r\n            orderBy: { createdAt: \"desc\" },\r\n            take: limit,\r\n            skip: offset,\r\n            include: {\r\n                changer: {\r\n                    select: {\r\n                        id: true,\r\n                        username: true,\r\n                        email: true\r\n                    }\r\n                }\r\n            }\r\n        })\r\n\r\n        return { success: true, logs }\r\n    } catch (e: any) {\r\n        console.error(\"getUserSettingsChangeLog Error:\", e)\r\n        return { error: \"Failed to fetch change log\", details: e.message }\r\n    }\r\n}\r\n\r\n// Helper functions\r\nfunction getCategoryFromKey(key: string): string {\r\n    // Map key to category\r\n    if (key.startsWith(\"preferences\")) return \"preferences\"\r\n    if (key.startsWith(\"taskView\")) return \"taskView\"\r\n    if (key.startsWith(\"todayTasks\")) return \"todayTasks\"\r\n    if (key.startsWith(\"notifications\")) return \"notifications\"\r\n    if (key.startsWith(\"workflow\")) return \"workflow\"\r\n    return key\r\n}\r\n\r\nfunction validateSettingValue(category: string, value: any): boolean {\r\n    // Basic validation - can be extended\r\n    try {\r\n        switch (category) {\r\n            case \"preferences\":\r\n                if (value.timezone && typeof value.timezone !== \"string\") return false\r\n                if (value.workingHours) {\r\n                    if (!value.workingHours.start || !value.workingHours.end) return false\r\n                }\r\n                return true\r\n            case \"taskView\":\r\n                if (value.defaultView && ![\"list\", \"kanban\"].includes(value.defaultView)) return false\r\n                if (value.defaultSort) {\r\n                    if (![\"priority\", \"dueDate\", \"createdAt\", \"title\"].includes(value.defaultSort.field)) return false\r\n                    if (![\"asc\", \"desc\"].includes(value.defaultSort.order)) return false\r\n                }\r\n                return true\r\n            case \"todayTasks\":\r\n                if (value.defaultView && ![\"compact\", \"detailed\"].includes(value.defaultView)) return false\r\n                return true\r\n            case \"notifications\":\r\n                if (value.channels) {\r\n                    if (typeof value.channels.inApp !== \"boolean\") return false\r\n                    if (typeof value.channels.email !== \"boolean\") return false\r\n                }\r\n                if (value.grouping && ![\"realtime\", \"dailyDigest\"].includes(value.grouping)) return false\r\n                return true\r\n            case \"workflow\":\r\n                if (value.defaultLandingPage && ![\"dashboard\", \"todayFocus\", \"projects\", \"tasks\"].includes(value.defaultLandingPage)) return false\r\n                return true\r\n            default:\r\n                return true\r\n        }\r\n    } catch {\r\n        return false\r\n    }\r\n}\r\n\r\nfunction safeJsonParse(value: string): any {\r\n    try {\r\n        return JSON.parse(value)\r\n    } catch {\r\n        // If parsing fails, return the original string\r\n        return value\r\n    }\r\n}\r\n\r\n","export {getPublicSystemSettings as '0033db22356cbf8845a3517099b63dfc38d1147299'} from 'ACTIONS_MODULE0'\nexport {getAllProjectsUnreadNotificationCount as '00686a7231b739e4fe9b8305b757bc0e83827b9865'} from 'ACTIONS_MODULE1'\nexport {getAllProjectsNotifications as '4004a0aae390e2c1aeb900c79065f312ac43d90f8d'} from 'ACTIONS_MODULE1'\nexport {markProjectNotificationAsRead as '60691655a7ad6aec29ab9691d8571a0d380be93da1'} from 'ACTIONS_MODULE1'\nexport {updateProfile as '4014896b5d2affbb03c83dbddeb66e1724203ab137'} from 'ACTIONS_MODULE0'\nexport {changePassword as '4030a94bd5b3ca5815ae2cd1d1725e523f9f88fa17'} from 'ACTIONS_MODULE0'\nexport {initializeRBAC as '00a7551eb825197a762c03325de2ebb2525343d67a'} from 'ACTIONS_MODULE2'\nexport {updateUserSetting as '7834670bad8c75d0bafc47394918473dedf1ef1d03'} from 'ACTIONS_MODULE3'\nexport {resetUserSetting as '6076a771c1b69db27eefc144c7f346084707e44c83'} from 'ACTIONS_MODULE3'\nexport {updateSetting as '7856a9cd98bf3a731a97f71b1b70c5ad4d859adbb2'} from 'ACTIONS_MODULE0'\nexport {uploadSystemLogo as '40dcf4e685022ac015152cc50e6096832ab9a723be'} from 'ACTIONS_MODULE4'\nexport {getUserSettings as '403d2efc75bc6ba729c53866f2f453379a75cef5f5'} from 'ACTIONS_MODULE3'\nexport {resetUserSetting as '6076a771c1b69db27eefc144c7f346084707e44c83'} from 'ACTIONS_MODULE3'\nexport {getUserSetting as '60855b7a48d2833280b6045fa247e66b6c48cfc569'} from 'ACTIONS_MODULE3'\nexport {getResolvedUserSettings as '60bbed07d8565ed1d735f9dfd76ca01fde097d7047'} from 'ACTIONS_MODULE3'\nexport {getUserSettingsChangeLog as '781b1c17ffbb4bbf724987c61e63a9e81654538327'} from 'ACTIONS_MODULE3'\nexport {updateUserSetting as '7834670bad8c75d0bafc47394918473dedf1ef1d03'} from 'ACTIONS_MODULE3'\nexport {createUserSetting as '7c2fc784d7c1019a5977faad96a4218f308a67fc6e'} from 'ACTIONS_MODULE3'\nexport {getRoles as '00315332eefe7e5ae034444c5aa3d0b43abd813c65'} from 'ACTIONS_MODULE2'\nexport {getPermissions as '004c2554a1592062d1a2d5dabdc6ce8941b8bf3a44'} from 'ACTIONS_MODULE2'\nexport {initializeRBAC as '00a7551eb825197a762c03325de2ebb2525343d67a'} from 'ACTIONS_MODULE2'\nexport {createRole as '4040b6468aa9508d1d4802a99825a53e6c660decfe'} from 'ACTIONS_MODULE2'\nexport {getRole as '4077386d824b9d6d8daac5a6f8bf4124f35c6f5f09'} from 'ACTIONS_MODULE2'\nexport {deleteRole as '40c034babb4ca926f97b6b4d48e79b952d57077416'} from 'ACTIONS_MODULE2'\nexport {updateRole as '605a370aec7719011993943417a0dd46a68cd1b815'} from 'ACTIONS_MODULE2'\nexport {removeRoleFromUser as '782b125d292e676b0aeedfa8f470593862cedc359d'} from 'ACTIONS_MODULE2'\nexport {assignRoleToUser as '787a1fbc130c3c6d92e3009448f9235df28bea0dee'} from 'ACTIONS_MODULE2'\nexport {logActivity as '40daa1d9c7314de4957a7669434db12aaa24630ba4'} from 'ACTIONS_MODULE5'\n","\"use server\"\r\n\r\nimport { writeFile, mkdir } from \"fs/promises\"\r\nimport { join } from \"path\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport {\r\n  validateFileUpload,\r\n  sanitizeFilename,\r\n  generateSafeFilename,\r\n  validateFileContent,\r\n  getReadableFileSize,\r\n} from \"@/lib/file-upload-validator\"\r\n\r\nexport async function uploadSystemLogo(formData: FormData) {\r\n  const session = await getServerSession(authOptions)\r\n  if (!session || session.user.role !== \"admin\") {\r\n    return { error: \"Unauthorized - Admin access required\", code: \"UNAUTHORIZED\" }\r\n  }\r\n\r\n  const file = formData.get(\"file\") as File | null\r\n  if (!file) {\r\n    return { error: \"No file provided\", code: \"MISSING_FILE\" }\r\n  }\r\n\r\n  try {\r\n    // 1. VALIDATE FILE - Use centralized validator\r\n    const validation = validateFileUpload(file)\r\n    if (!validation.valid) {\r\n      return { error: validation.error || \"Invalid file\", code: \"INVALID_FILE\" }\r\n    }\r\n\r\n    // 2. VALIDATE FILE CONTENT (Magic Bytes) - Prevent MIME type spoofing\r\n    const bytes = await file.arrayBuffer()\r\n    const contentValid = await validateFileContent(bytes, file.type)\r\n    if (!contentValid) {\r\n      return {\r\n        error: \"File content does not match declared type. Possible spoofing attempt.\",\r\n        code: \"CONTENT_MISMATCH\",\r\n      }\r\n    }\r\n\r\n    // 3. CREATE DIRECTORY IF IT DOESN'T EXIST\r\n    const uploadDir = join(process.cwd(), \"public\", \"uploads\", \"branding\")\r\n    await mkdir(uploadDir, { recursive: true })\r\n\r\n    // 4. GENERATE SAFE FILENAME\r\n    const safeFilename = generateSafeFilename(file.name, parseInt(session.user.id))\r\n    const filepath = join(uploadDir, safeFilename)\r\n\r\n    // 5. SAVE FILE TO DISK\r\n    const buffer = Buffer.from(bytes)\r\n    await writeFile(filepath, buffer)\r\n\r\n    // 6. LOG AND RETURN SUCCESS\r\n    console.log(\r\n      `[Logo Upload] Admin ${session.user.name || session.user.email} uploaded logo: ${safeFilename}`\r\n    )\r\n\r\n    return {\r\n      success: true,\r\n      url: `/uploads/branding/${safeFilename}`,\r\n      fileName: sanitizeFilename(file.name),\r\n      fileSize: getReadableFileSize(file.size),\r\n      code: \"UPLOAD_SUCCESS\",\r\n    }\r\n  } catch (error: any) {\r\n    console.error(\"Logo upload error:\", error)\r\n    return {\r\n      error: \"Failed to upload logo\",\r\n      code: \"UPLOAD_FAILED\",\r\n      details: error.message,\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"qlBAAA,EAAA,CAAA,CAAA,CAAA,KAAA,gBAAA,QAAA,QAAA,YAAA,oGAAA,SAAA,CAAA,OAAA,iBAAA,QAAA,YAAA,SAAA,UAAA,UAAA,WAAA,SAAA,WAAA,WAAA,QAAA,SAAA,OAAA,SAAA,WAAA,gBAAA,WAAA,CAAA,SAAA,yCAAA,WAAA,sBAAA,QAAA,CAAA,IAAA,mCAAA,EAAA,QAAA,MAAA,OAAA,oCAAA,QAAA,CAAA,MAAA,qBAAA,OAAA,kBAAA,QAAA,gBAAA,EAAA,KAAA,iBAAA,MAAA,qBAAA,MAAA,CAAA,MAAA,mBAAA,CAAA,QAAA,CAAA,OAAA,8EAAA,KAAA,yBAAA,EAAA,aAAA,CAAA,KAAA,UAAA,YAAA,SAAA,cAAA,SAAA,kBAAA,QAAA,EAAA,gBAAA,CAAA,cAAA,aAAA,kBAAA,UAAA,UAAA,SAAA,KAAA,SAAA,MAAA,UAAA,KAAA,UAAA,SAAA,SAAA,oBAAA,SAAA,MAAA,SAAA,WAAA,QAAA,EAAA,mBAAA,CAAA,QAAA,CAAA,cAAA,8CAAA,EAAA,MAAA,CAAA,CAAA,KAAA,OAAA,QAAA,UAAA,EAAA,CAAA,KAAA,MAAA,QAAA,OAAA,EAAA,CAAA,KAAA,QAAA,OAAA,CAAA,CAAA,EAAA,CAAA,KAAA,OAAA,OAAA,CAAA,CAAA,EAAA,CAAA,KAAA,QAAA,OAAA,CAAA,CAAA,EAAA,CAAA,KAAA,WAAA,QAAA,WAAA,OAAA,CAAA,CAAA,EAAA,CAAA,KAAA,OAAA,QAAA,cAAA,OAAA,CAAA,CAAA,EAAA,CAAA,KAAA,OAAA,OAAA,CAAA,CAAA,EAAA,CAAA,E,gCCOA,IAAA,EAAA,EAAA,CAAA,CAAA,QCGA,IAAM,EAAkB,IAAI,IAOrB,eAAe,EACpB,CAAc,CACd,CAAkB,EAElB,IAAM,EAAW,CAAA,EAAG,EAAO,CAAC,EAAE,GAAa,SAAA,CAAU,CAC/C,EAAS,EAAgB,GAAG,CAAC,GAEnC,GAAI,GAAU,EAAO,SAAS,CAAG,KAAK,GAAG,GACvC,CAD2C,MACpC,EAAO,WAAW,CAI3B,IAAM,EAAY,MAAM,EAAA,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAC/C,MAAO,QACL,EACA,GAAI,CACF,CAAE,UAAW,IAAK,EAClB,CAAE,UAAW,QAAS,KAClB,EAAY,CAAC,CAAE,UAAW,UAAW,QAAS,CAAU,EAAE,CAAG,EAAE,CACpE,AACH,EACA,QAAS,CACP,KAAM,CACJ,QAAS,CACP,YAAa,CACX,QAAS,CACP,YAAY,CACd,CACF,CACF,CACF,CACF,CACF,GAGM,EAAgB,IAAI,IAE1B,IAAK,IAAM,KAAY,EACrB,IAAK,IAD2B,AACrB,KAAkB,EAAS,IAAI,CAAC,WAAW,CAAE,AACtD,EAAc,GAAG,CAAC,EAAe,UAAU,CAAC,GAAG,EAInD,IAAM,EAAc,MAAM,IAAI,CAAC,GAQ/B,OALA,EAAgB,GAAG,CAAC,EAAU,aAC5B,EACA,UAAW,KAAK,GAAG,GArDL,EAqDU,CAC1B,CAtDoB,EAwDb,CACT,CA8EO,CAvIoB,KAAK,SAuIV,EACpB,CAAc,AAxI4B,CAyI1C,CAAkB,EAgBlB,MAAO,CAdW,MAAM,EAAA,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAC/C,MAAO,CACL,SACA,GAAI,CACF,CAAE,UAAW,IAAK,EAClB,CAAE,UAAW,QAAS,KAClB,EAAY,CAAC,CAAE,UAAW,UAAW,QAAS,CAAU,EAAE,CAAG,EAAE,CACpE,AACH,EACA,QAAS,CACP,MAAM,CACR,CACF,EAAA,EAEiB,GAAG,CAAC,IAAO,CAAD,AACzB,KAAM,EAAG,IAAI,CACb,UAAW,EAAG,SAAS,CACvB,QAAS,EAAG,OAAO,CACrB,CAAC,CACH,CAiBO,SAAS,EAAqB,CAAc,CAAE,CAAkB,EACrE,IAAM,EAAW,CAAA,EAAG,EAAO,CAAC,EAAE,GAAa,SAAA,CAAU,CACrD,EAAgB,MAAM,CAAC,EACzB,2FDjLO,OAAM,UAA0B,UACrC,aAAY,CAAe,CAAS,EAAe,cAAc,CAAE,CACjE,KAAK,CAAC,GAAA,IAAA,CAD4B,IAAA,CAAA,EAElC,IAAI,CAAC,IAAI,CAAG,mBACd,CACF,CAEO,MAAM,UAAuB,UAClC,aAAY,CAAe,CAAS,EAAe,WAAW,CAAE,CAC9D,KAAK,CAAC,GAAA,IAAA,CAD4B,IAAA,CAAA,EAElC,IAAI,CAAC,IAAI,CAAG,gBACd,CACF,CAEO,MAAM,UAAsB,UACjC,aAAY,CAAe,CAAS,EAAe,WAAW,CAAE,CAC9D,KAAK,CAAC,GAAA,IAAA,CAD4B,IAAA,CAAA,EAElC,IAAI,CAAC,IAAI,CAAG,eACd,CACF,CAcO,eAAe,EACpB,CAAc,CACd,CAAkB,CAClB,CAAkB,EAMlB,GAAI,CAFY,AAEX,MAFiB,EAA+B,CAEvC,CAF+C,EAAY,GAGvE,MAAM,IAAI,EAAkB,CAAC,mBAAmB,EAAE,EAAA,CAAY,CAAE,oBAEpE,CAqCO,eAAe,EACpB,CAAc,CACd,CAAkB,CAClB,CAAkB,EAMlB,GAAI,CAyBF,IAAK,IAAM,KAvBO,MAAM,CAuBD,CAvBC,MAAM,CAAC,EAuBG,MAvBK,CAAC,QAAQ,CAAC,CAC/C,MAAO,QACL,EACA,GAAI,CACF,CAAE,UAAW,IAAK,EAClB,CAAE,UAAW,QAAS,KAClB,EAAY,CAAC,CAAE,UAAW,UAAW,QAAS,CAAU,EAAE,CAAG,EAAE,CACpE,AACH,EACA,QAAS,CACP,KAAM,CACJ,QAAS,CACP,YAAa,CACX,QAAS,CACP,YAAY,CACd,CACF,CACF,CACF,CACF,CACF,EAAA,EAIE,IAAK,IAAM,KAAkB,EAAS,IAAI,CAAC,WAAW,CAAE,AACtD,GAAI,EAAe,UAAU,CAAC,GAAG,GAAK,EACpC,OAAO,EAKb,CANsD,MAM/C,CACT,CAAE,MAAO,EAAO,CAGd,OAFA,QAAQ,KAAK,CAAC,CAAC,0BAA0B,EAAE,EAAW,UAAU,EAAE,EAAO,CAAC,CAAC,CAAE,IAEtE,CACT,CACF,CA0JO,SAAS,EACd,CAAc,SAEd,AAAI,aAAiB,GAIjB,aAAiB,EAHZ,CAD+B,AAC7B,MAAO,EAAM,KAGa,EAHN,CAAE,KAAM,EAAM,IAAI,CAAE,OAAQ,IAAK,SAAS,CAAM,EAO3E,aAAiB,EACZ,CAAE,MAAO,EAAM,IADY,GACL,CAAE,KAAM,EAAM,IAAI,CAAE,OAAQ,IAAK,SAAS,CAAM,GAG/E,QAAQ,KAAK,CAAC,+BAAgC,GACvC,CACL,MAAO,uBACP,KAAM,sBACN,OAAQ,IACR,SAAS,CACX,EACF,2JE7TA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QA4GO,eAAe,EAAY,CAAyB,EACzD,QAAQ,GAAG,CAAC,gDACZ,QAAQ,GAAG,CAAC,oCAAqC,KAAK,SAAS,CAAC,EAAQ,KAAM,IAE9E,GAAI,CAEF,IAAM,EAAmB,AA6E7B,SAAS,EAAsB,CAA4B,EAazD,IAAM,EAAY,CAAE,GAAG,CAAQ,AAAD,EAE9B,IAAK,IAAM,IAdW,CACpB,EAagB,SAZhB,KAY+B,UAX/B,gBACA,QACA,SACA,SACA,UACA,cACA,eACD,CAKK,KAAO,IACT,CAAS,CAAC,EAAI,CAAG,EADG,UACH,EAKrB,IAAK,IAAM,KAAO,EACc,QADH,EACvB,OAAO,CAAS,CAAC,EAAI,EAAoC,OAAnB,CAAS,AAAkB,CAAjB,EAAI,EAAc,MAAM,OAAO,CAAC,CAAS,CAAC,EAAI,GAAG,CACnG,CAAS,CAAC,EAAI,CAAG,EAAsB,CAAS,CAAC,GAAI,EAIzD,OAAO,CACT,EA1GmD,EAAO,aAAa,EAAI,CAAC,GAExE,QAAQ,GAAG,CAAC,sCAAuC,KAAK,SAAS,CAAC,EAAkB,KAAM,IAC1F,QAAQ,GAAG,CAAC,qCAAsC,CAChD,WAAY,EAAO,UAAU,CAC7B,eAAgB,EAAO,cAAc,CACrC,cAAe,EAAO,aAAa,CACnC,cAAe,EAAO,aACxB,AADqC,GAIrC,GAAI,CACF,IAAM,EAAS,MAAM,EAAA,MAAM,CAAC,WAAW,CAAC,MAAM,CAAC,CAC7C,KAAM,CACJ,WAAY,EAAO,UAAU,CAC7B,eAAgB,EAAO,cAAc,CACrC,cAAe,EAAO,aAAa,CACnC,cAAe,OAAO,IAAI,CAAC,GAAkB,MAAM,CAAG,EAClD,KAAK,SAAS,CAAC,GACf,KACJ,cAAe,EAAO,aAAa,CACnC,eAAgB,EAAO,cAAc,EAAI,KACzC,UAAW,EAAO,SAAS,EAAI,KAC/B,WAAY,EAAO,UAAU,EAAI,KACjC,SAAU,EAAO,QAAQ,EAAI,KAC7B,UAAW,EAAO,SAAS,EAAI,MAAM,IACrC,UAAW,EAAO,SAAS,EAAI,MAAM,IAErC,OAAQ,EAAO,UAAU,CACzB,YAAa,EAAO,aAAa,CACjC,OAAQ,EAAO,aAAa,AAC9B,CACF,GACA,QAAQ,GAAG,CAAC,2DAA4D,EAAO,EAAE,EACjF,QAAQ,GAAG,CAAC,wDACZ,MACF,CAAE,MAAO,EAAkB,CAMzB,GALA,QAAQ,KAAK,CAAC,6CACd,QAAQ,KAAK,CAAC,kCAAmC,EAAY,OAAO,EACpE,QAAQ,KAAK,CAAC,+BAAgC,EAAY,IAAI,EAC9D,QAAQ,KAAK,CAAC,+BAAgC,KAAK,SAAS,CAAC,EAAY,IAAI,CAAE,KAAM,IAEjF,EAAY,OAAO,EAAE,SAAS,mBAA0C,UAArB,EAAY,IAAI,EAAqC,UAArB,EAAY,IAAI,CAAc,CACnH,QAAQ,IAAI,CAAC,sFACb,MAAM,EAAA,MAAM,CAAC,iBAAiB,CAAC,CAAC;;;QAGhC,CAAC,CACC,EAAO,UAAU,CACjB,EAAO,aAAa,CACpB,EAAO,UAAU,EAAI,KACrB,EAAO,QAAQ,EAAI,KACnB,EAAO,SAAS,EAAI,MAAM,KAAiB,KAC3C,EAAO,aAAa,EAEtB,QAAQ,GAAG,CAAC,iDACZ,QAAQ,GAAG,CAAC,uDACZ,MACF,CAEE,MADA,AADK,QACG,KAAK,CAAC,uDACR,CAEV,CACF,CAAE,MAAO,EAAY,CAEnB,QAAQ,KAAK,CAAC,oEACd,QAAQ,KAAK,CAAC,kCAAmC,GAAO,SAAW,GACnE,QAAQ,KAAK,CAAC,+BAAgC,GAAO,MACrD,QAAQ,KAAK,CAAC,+BAAgC,KAAK,SAAS,CAAC,GAAO,KAAM,KAAM,IAChF,QAAQ,KAAK,CAAC,gCAAiC,GAAO,OACtD,QAAQ,KAAK,CAAC,qDAChB,CACF,CAuCA,eAAe,IACb,GAAI,CACF,IAAM,EAAc,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,IAC3B,EAAY,EAAY,GAAG,CAAC,mBAC5B,EAAS,EAAY,GAAG,CAAC,aAE/B,GAAI,EACF,OAAO,EADM,AACI,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,GAErC,GAAI,EACF,MADU,CACH,EAET,OAAO,IACT,CAAE,KAAM,CACN,OAAO,IACT,CACF,CAKA,eAAe,IACb,GAAI,CAEF,MAAO,AADa,OAAM,CAAA,EAAA,EAAA,OAAA,AAAO,GAAA,EACd,GAAG,CAAC,eAAiB,IAC1C,CAAE,KAAM,CACN,OAAO,IACT,CACF,2CAjJsB,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,0DC1Gf,IAAM,EAAc,CAEzB,KAAM,CACJ,OAAQ,cACR,KAAM,YACN,OAAQ,cACR,OAAQ,cACR,YAAa,mBACb,SAAU,gBACV,WAAY,iBACd,EAGA,KAAM,CACJ,OAAQ,cACR,KAAM,YACN,OAAQ,cACR,OAAQ,cACR,WAAY,kBACZ,cAAe,qBACf,eAAgB,sBAChB,eAAgB,qBAClB,EAGA,QAAS,CACP,OAAQ,iBACR,KAAM,eACN,OAAQ,iBACR,OAAQ,iBACR,YAAa,sBACb,YAAa,sBACb,gBAAiB,yBACnB,EAGA,KAAM,CACJ,OAAQ,cACR,KAAM,YACN,OAAQ,cACR,OAAQ,cACR,OAAQ,cACR,cAAe,qBACf,gBAAiB,sBACnB,EAGA,WAAY,CACV,OAAQ,oBACR,KAAM,kBACN,OAAQ,oBACR,OAAQ,oBACR,eAAgB,2BAClB,EAGA,WAAY,CACV,OAAQ,oBACR,OAAQ,oBACR,QAAS,qBACT,SAAU,qBACZ,EAGA,SAAU,CACR,YAAa,uBACb,YAAa,uBACb,aAAc,wBACd,aAAc,wBACd,UAAW,qBACX,UAAW,qBAEX,oBAAqB,+BACrB,sBAAuB,iCACvB,mBAAoB,6BACtB,EAGA,aAAc,CACZ,KAAM,oBACN,OAAQ,sBACR,UAAW,wBACb,EAGA,IAAK,CACH,KAAM,WACN,OAAQ,aACR,aAAc,kBAChB,EAGA,KAAM,CACJ,OAAQ,cACR,KAAM,YACN,OAAQ,cACR,OAAQ,cACR,OAAQ,cACR,mBAAoB,yBACtB,EAGA,OAAQ,CACN,KAAM,cACN,OAAQ,gBACR,SAAU,iBACZ,CACF,EAsBa,EAAgB,CAC3B,aAAc,CACZ,KAAM,eACN,YAAa,0CACb,cAAc,EACd,YAAa,OAAO,MAAM,CAAC,GAAa,OAAO,CAAC,GAAU,OAAO,MAAM,CAAC,GAC1E,EACA,gBAAiB,CACf,KAAM,kBACN,YAAa,kDACb,cAAc,EACd,YAAa,IAER,OAAO,MAAM,CAAC,EAAY,OAAO,KAEjC,OAAO,MAAM,CAAC,EAAY,IAAI,KAE9B,OAAO,MAAM,CAAC,EAAY,UAAU,EAEvC,EAAY,IAAI,CAAC,IAAI,CACrB,EAAY,IAAI,CAAC,MAAM,CACvB,EAAY,IAAI,CAAC,UAAU,CAC3B,EAAY,IAAI,CAAC,aAAa,CAC9B,EAAY,IAAI,CAAC,cAAc,CAC/B,EAAY,IAAI,CAAC,cAAc,IAE5B,OAAO,MAAM,CAAC,EAAY,UAAU,EAEvC,EAAY,QAAQ,CAAC,YAAY,CACjC,EAAY,QAAQ,CAAC,YAAY,CACjC,EAAY,QAAQ,CAAC,mBAAmB,CACxC,EAAY,QAAQ,CAAC,qBAAqB,CAC1C,EAAY,QAAQ,CAAC,kBAAkB,CAEvC,EAAY,YAAY,CAAC,IAAI,CAC7B,EAAY,YAAY,CAAC,MAAM,CAE/B,EAAY,GAAG,CAAC,IAAI,CACpB,EAAY,GAAG,CAAC,YAAY,CAE5B,EAAY,IAAI,CAAC,IAAI,CAErB,EAAY,MAAM,CAAC,IAAI,CACvB,EAAY,MAAM,CAAC,MAAM,CACzB,EAAY,MAAM,CAAC,QAAQ,CAC5B,AACH,EACA,UAAW,CACT,KAAM,YACN,YAAa,oDACb,cAAc,EACd,YAAa,CAEX,EAAY,OAAO,CAAC,IAAI,IAErB,OAAO,MAAM,CAAC,EAAY,IAAI,KAE9B,OAAO,MAAM,CAAC,EAAY,UAAU,EAEvC,EAAY,IAAI,CAAC,IAAI,CACrB,EAAY,IAAI,CAAC,MAAM,CACvB,EAAY,IAAI,CAAC,UAAU,CAC3B,EAAY,IAAI,CAAC,aAAa,IAE3B,OAAO,MAAM,CAAC,EAAY,UAAU,EAEvC,EAAY,QAAQ,CAAC,YAAY,CAEjC,EAAY,YAAY,CAAC,IAAI,CAE7B,EAAY,GAAG,CAAC,IAAI,CACpB,EAAY,GAAG,CAAC,YAAY,CAE5B,EAAY,IAAI,CAAC,IAAI,CAErB,EAAY,MAAM,CAAC,IAAI,CACxB,AACH,EACA,UAAW,CACT,KAAM,YACN,YAAa,oCACb,cAAc,EACd,YAAa,CAEX,EAAY,OAAO,CAAC,IAAI,CAExB,EAAY,IAAI,CAAC,IAAI,CACrB,EAAY,IAAI,CAAC,MAAM,CACvB,EAAY,IAAI,CAAC,aAAa,CAC9B,EAAY,IAAI,CAAC,eAAe,CAEhC,EAAY,UAAU,CAAC,IAAI,IAExB,OAAO,MAAM,CAAC,EAAY,UAAU,EAEvC,EAAY,YAAY,CAAC,IAAI,CAE7B,EAAY,GAAG,CAAC,IAAI,CACrB,AACH,CACF,EAKO,SAAS,IACd,OAAO,OAAO,MAAM,CAAC,GAAa,OAAO,CAAC,GAAU,OAAO,MAAM,CAAC,GACpE,mHC/OA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,qBAEA,IAAM,EAAa,EAAA,CAAC,CAAC,MAAM,CAAC,CAC1B,KAAM,EAAA,CAAC,CAAC,MAAM,GAAG,GAAG,CAAC,EAAG,yBACxB,YAAa,EAAA,CAAC,CAAC,MAAM,GAAG,QAAQ,GAChC,cAAe,EAAA,CAAC,CAAC,KAAK,CAAC,EAAA,CAAC,CAAC,MAAM,IAAI,QAAQ,EAC7C,GAKO,eAAe,IACpB,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,EAAA,WAAW,EAClD,GAAI,CAAC,EAAS,MAAM,AAAI,MAAM,gBAsB9B,OAnBA,AAmBO,MAnBD,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,SAAS,EAAQ,IAAI,CAAC,EAAE,EAAG,EAAA,WAAW,CAAC,IAAI,CAAC,IAAI,EAE1D,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CACvC,QAAS,CACP,OAAQ,CACN,OAAQ,CACN,aAAa,EACb,WAAW,CACb,CACF,EACA,YAAa,CACX,QAAS,CACP,YAAY,CACd,CACF,CACF,EACA,QAAS,CAAE,KAAM,KAAM,CACzB,EAGF,CAKO,eAAe,EAAQ,CAAU,EACtC,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,EAAA,WAAW,EAClD,GAAI,CAAC,EAAS,MAAM,AAAI,MAAM,gBAuB9B,OApBA,AAoBO,MApBD,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,SAAS,EAAQ,IAAI,CAAC,EAAE,EAAG,EAAA,WAAW,CAAC,IAAI,CAAC,IAAI,EAE3D,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CACxC,MAAO,IAAE,CAAG,EACZ,QAAS,CACP,YAAa,CACX,QAAS,CACP,YAAY,CACd,CACF,EACA,UAAW,CACT,QAAS,CACP,KAAM,CACJ,OAAQ,CAAE,IAAI,EAAM,UAAU,EAAM,OAAO,CAAK,CAClD,CACF,CACF,CACF,CACF,EAGF,CAKO,eAAe,EAAW,CAAkB,EACjD,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,EAAA,WAAW,EAClD,GAAI,CAAC,EAAS,MAAO,CAAE,MAAO,cAAe,EAE7C,GAAI,CAEF,MAAM,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,SAAS,EAAQ,IAAI,CAAC,EAAE,EAAG,EAAA,WAAW,CAAC,IAAI,CAAC,MAAM,CAC5E,CAAE,MAAO,EAAG,CACV,MAAO,CAAE,MAAO,mBAAoB,CACtC,CAEA,IAAM,EAAO,EAAS,GAAG,CAAC,QACpB,EAAc,EAAS,GAAG,CAAC,eAC3B,EAAmB,EAAS,GAAG,CAAC,iBAElC,EAA0B,EAAE,CAChC,GAAI,EACF,GAAI,CACF,EAAgB,KAAK,KAFH,AAEQ,CAAC,EAC7B,CAAE,KAAM,CAER,CAGF,IAAM,EAAY,EAAW,SAAS,CAAC,MAAE,cAAM,gBAAa,CAAc,GAE1E,GAAI,CAAC,EAAU,OAAO,CACpB,CADsB,KACf,CAAE,MAAO,mBAAoB,EAGtC,GAAI,CACF,IAAM,EAAO,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CACpC,KAAM,CACJ,KAAM,EAAU,IAAI,CAAC,IAAI,CACzB,YAAa,EAAU,IAAI,CAAC,WAAW,EAAI,KAC3C,YAAa,EAAU,IAAI,CAAC,aAAa,EAAI,EAAU,IAAI,CAAC,aAAa,CAAC,MAAM,CAAG,EAAI,CACrF,OAAQ,EAAU,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAiB,WAAD,GACvD,EACF,CAAC,CACH,EAAI,MACN,EACA,QAAS,CACP,YAAa,CACX,QAAS,CAAE,YAAY,CAAK,CAC9B,CACF,CACF,GAkBA,OAfA,MAAM,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,CAChB,WAAY,eACZ,eAAgB,WAChB,cAAe,CAAC,MAAM,EAAE,EAAK,IAAI,CAAC,SAAS,CAAC,CAC5C,cAAe,CACb,OAAQ,EAAK,EAAE,CACf,SAAU,EAAK,IAAI,CACnB,gBAAiB,EAAK,WAAW,CAAC,MAAM,AAC1C,EACA,cAAe,SAAS,EAAQ,IAAI,CAAC,EAAE,EACvC,WAAY,OACZ,SAAU,EAAK,EAAE,AACnB,GAEA,CAAA,EAAA,EAAA,cAAc,AAAd,EAAe,0BACR,CAAE,SAAS,OAAM,CAAK,CAC/B,CAAE,MAAO,EAAQ,CACf,GAAI,AAAW,SAAS,GAAlB,IAAI,CACR,MAAO,CAAE,MAAO,oCAAqC,EAGvD,OADA,QAAQ,KAAK,CAAC,GACP,CAAE,MAAO,uBAAwB,CAC1C,CACF,CAKO,eAAe,EAAW,CAAU,CAAE,CAAkB,EAC7D,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,EAAA,WAAW,EAClD,GAAI,CAAC,EAAS,MAAO,CAAE,MAAO,cAAe,EAE7C,GAAI,CAEF,MAAM,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,SAAS,EAAQ,IAAI,CAAC,EAAE,EAAG,EAAA,WAAW,CAAC,IAAI,CAAC,MAAM,CAC5E,CAAE,MAAO,EAAG,CACV,MAAO,CAAE,MAAO,mBAAoB,CACtC,CAGA,IAAM,EAAe,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAChD,MAAO,IAAE,CAAG,EACZ,OAAQ,CAAE,cAAc,EAAM,MAAM,CAAK,CAC3C,GAEA,GAAI,GAAc,cAAsC,gBAAgB,CAAtC,EAAa,IAAI,CACjD,MAAO,CAAE,MAAO,iCAAkC,EAGpD,IAAM,EAAO,EAAS,GAAG,CAAC,QACpB,EAAc,EAAS,GAAG,CAAC,eAC3B,EAAmB,EAAS,GAAG,CAAC,iBAElC,EAA0B,EAAE,CAChC,GAAI,EACF,GAAI,CACF,EAAgB,KAAK,KAFH,AAEQ,CAAC,EAC7B,CAAE,KAAM,CAER,CAGF,IAAM,EAAY,EAAW,OAAO,GAAG,SAAS,CAAC,MAAE,cAAM,gBAAa,CAAc,GAEpF,GAAI,CAAC,EAAU,OAAO,CACpB,CADsB,KACf,CAAE,MAAO,mBAAoB,EAGtC,GAAI,CAEF,IAAM,EAAO,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CACpC,MAAO,IAAE,CAAG,EACZ,KAAM,CACJ,KAAM,EAAU,IAAI,CAAC,IAAI,CACzB,YAAa,KAA+B,MAArB,IAAI,CAAC,WAAW,CAAiB,EAAU,IAAI,CAAC,WAAW,MAAG,CACvF,CACF,GAGA,GAAqC,SAAjC,EAAU,IAAI,CAAC,aAAa,CAAgB,CAO9C,GALA,MAAM,EAAA,MAAM,CAAC,cAAc,CAAC,UAAU,CAAC,CACrC,MAAO,CAAE,OAAQ,CAAG,CACtB,GAGI,EAAc,MAAM,CAAG,EACzB,CAD4B,GACvB,IAAM,KAAgB,EACzB,GAAI,CACF,MAAM,EAFgC,AAEhC,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC,CACjC,KAAM,CACJ,OAAQ,eACR,CACF,CACF,EACF,CAAE,MAAO,EAAQ,CAEf,GAAe,SAAS,CAApB,EAAE,IAAI,CACR,MAAM,CAEV,CAUJ,IAAK,IAAM,KALW,MAAM,CAKL,CALK,MAAM,CAAC,MAKG,EALK,CAAC,QAAQ,CAAC,CACnD,MAAO,CAAE,OAAQ,CAAG,EACpB,OAAQ,CAAE,QAAQ,EAAM,QAAS,EAAK,CACxC,EAAA,EAGE,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAC,EAAS,MAAM,CAAE,EAAS,OAAO,OAAI,EAE9D,CAkBA,OAfA,MAAM,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,CAChB,WAAY,eACZ,eAAgB,WAChB,cAAe,CAAC,MAAM,EAAE,EAAK,IAAI,CAAC,SAAS,CAAC,CAC5C,cAAe,CACb,OAAQ,EAAK,EAAE,CACf,SAAU,EAAK,IAAI,AACrB,EACA,cAAe,SAAS,EAAQ,IAAI,CAAC,EAAE,EACvC,WAAY,OACZ,SAAU,EAAK,EAAE,AACnB,GAEA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,0BACf,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,CAAC,uBAAuB,EAAE,EAAA,CAAI,EACtC,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAQ,CACf,GAAe,SAAS,CAApB,EAAE,IAAI,CACR,MAAO,CAAE,MAAO,oCAAqC,EAGvD,OADA,QAAQ,KAAK,CAAC,GACP,CAAE,MAAO,uBAAwB,CAC1C,CACF,CAKO,eAAe,EAAW,CAAU,EACzC,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,EAAA,WAAW,EAClD,GAAI,CAAC,EAAS,MAAO,CAAE,MAAO,cAAe,EAE7C,GAAI,CAEF,MAAM,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,SAAS,EAAQ,IAAI,CAAC,EAAE,EAAG,EAAA,WAAW,CAAC,IAAI,CAAC,MAAM,CAC5E,CAAE,MAAO,EAAG,CACV,MAAO,CAAE,MAAO,mBAAoB,CACtC,CAGA,IAAM,EAAO,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CACxC,MAAO,IAAE,CAAG,EACZ,OAAQ,CAAE,cAAc,EAAM,MAAM,CAAK,CAC3C,GAEA,GAAI,GAAM,aACR,CADsB,KACf,CAAE,MAAO,2BAA4B,EAI9C,IAAM,EAAY,MAAM,EAAA,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC,CAC5C,MAAO,CAAE,OAAQ,CAAG,CACtB,GAEA,GAAI,EAAY,EACd,CADiB,KACV,CAAE,MAAO,CAAC,oBAAoB,EAAE,EAAU,gCAAgC,CAAC,AAAC,EAGrF,GAAI,CAoBF,OAnBA,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CACvB,MAAO,IAAE,CAAG,CACd,GAGA,MAAM,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,CAChB,WAAY,eACZ,eAAgB,WAChB,cAAe,CAAC,MAAM,EAAE,GAAM,KAAK,SAAS,CAAC,CAC7C,cAAe,CACb,OAAQ,EACR,SAAU,GAAM,IAClB,EACA,cAAe,SAAS,EAAQ,IAAI,CAAC,EAAE,EACvC,WAAY,OACZ,SAAU,CACZ,GAEA,CAAA,EAAA,EAAA,cAAc,AAAd,EAAe,0BACR,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAG,CAEV,OADA,QAAQ,KAAK,CAAC,GACP,CAAE,MAAO,uBAAwB,CAC1C,CACF,CAKO,eAAe,IAEpB,GAAI,CAAC,AADW,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,EAAA,WAAW,EACpC,MAAM,AAAI,MAAM,gBAE9B,IAAM,EAAc,MAAM,EAAA,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CACnD,QAAS,CAAC,CAAE,OAAQ,KAAM,EAAG,CAAE,KAAM,KAAM,EAAE,AAC/C,GAGM,EAA8C,CAAC,EACrD,IAAK,IAAM,KAAQ,EACb,AAAC,CAAO,CAAC,EAAK,MAAM,AADM,CACL,EAAE,CACzB,CAAO,CAAC,EAAK,MAAM,CAAC,CAAG,EAAA,AAAE,EAE3B,CAAO,CAAC,EAAK,MAAM,CAAC,CAAC,IAAI,CAAC,GAG5B,MAAO,CAAE,cAAa,SAAQ,CAChC,CAKO,eAAe,EACpB,CAAc,CACd,CAAc,CACd,CAAgC,CAChC,CAAgB,EAEhB,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,gBAAgB,AAAhB,EAAiB,EAAA,WAAW,EAClD,GAAI,CAAC,EAAS,MAAO,CAAE,MAAO,cAAe,EAE7C,GAAI,CAEF,MAAM,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,SAAS,EAAQ,IAAI,CAAC,EAAE,EAAG,EAAA,WAAW,CAAC,IAAI,CAAC,MAAM,CAC5E,CAAE,MAAO,EAAG,CACV,MAAO,CAAE,MAAO,mBAAoB,CACtC,CAEA,GAAI,CAgCF,OA/BA,MAAM,EAAA,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,CAC3B,KAAM,QACJ,SACA,EACA,UAAW,GAAa,KACxB,QAAS,GAAW,KACpB,WAAY,SAAS,EAAQ,IAAI,CAAC,EAAE,CACtC,CACF,GAGA,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAC,EAAQ,GAG7B,MAAM,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,CAChB,WAAY,gBACZ,eAAgB,WAChB,cAAe,CAAC,qBAAqB,CAAC,CACtC,cAAe,QACb,SACA,YACA,UACA,CACF,EACA,cAAe,SAAS,EAAQ,IAAI,CAAC,EAAE,EACvC,eAAgB,EAChB,WAAY,OACZ,SAAU,CACZ,GAEA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,0BACR,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAQ,CACf,GAAI,AAAW,SAAS,GAAlB,IAAI,CACR,MAAO,CAAE,MAAO,4BAA6B,EAG/C,OADA,QAAQ,KAAK,CAAC,GACP,CAAE,MAAO,uBAAwB,CAC1C,CACF,CAKO,eAAe,EACpB,CAAc,CACd,CAAc,CACd,CAAgC,CAChC,CAAgB,EAEhB,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,EAAA,WAAW,EAClD,GAAI,CAAC,EAAS,MAAO,CAAE,MAAO,cAAe,EAE7C,GAAI,CAEF,MAAM,CAAA,EAAA,EAAA,iBAAA,AAAiB,EAAC,SAAS,EAAQ,IAAI,CAAC,EAAE,EAAG,EAAA,WAAW,CAAC,IAAI,CAAC,MAAM,CAC5E,CAAE,MAAO,EAAG,CACV,MAAO,CAAE,MAAO,mBAAoB,CACtC,CAEA,GAAI,CA+BF,OA9BA,MAAM,EAAA,MAAM,CAAC,QAAQ,CAAC,UAAU,CAAC,CAC/B,MAAO,QACL,SACA,EACA,UAAW,GAAa,KACxB,QAAS,GAAW,IACtB,CACF,GAGA,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAC,EAAQ,GAG7B,MAAM,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,CAChB,WAAY,eACZ,eAAgB,WAChB,cAAe,CAAC,sBAAsB,CAAC,CACvC,cAAe,QACb,SACA,YACA,UACA,CACF,EACA,cAAe,SAAS,EAAQ,IAAI,CAAC,EAAE,EACvC,eAAgB,EAChB,WAAY,OACZ,SAAU,CACZ,GAEA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,0BACR,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAG,CAEV,OADA,QAAQ,KAAK,CAAC,GACP,CAAE,MAAO,uBAAwB,CAC1C,CACF,CAKO,eAAe,IACpB,GAAI,CACF,QAAQ,GAAG,CAAC,+BAGZ,IAAM,EAAoB,CAAA,EAAA,EAAA,iBAAA,AAAiB,IACrC,EAAgB,IAAI,IAE1B,IAAK,IAAM,KAAO,EAAmB,CACnC,GAAM,CAAC,EAAQ,GAAG,EAAY,CAAG,EAAI,KAAK,CAAC,KACrC,EAAS,EAAY,IAAI,CAAC,KAC1B,EAAO,EAAO,OAAO,CAAC,KAAM,KAAK,OAAO,CAAC,QAAS,GAAK,EAAE,WAAW,IACpE,EAAW,EAAY,MAAM,CAAG,EAAI,CAAW,CAAC,EAAE,CAAG,KAErD,EAAa,MAAM,EAAA,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,CAChD,MAAO,CAAE,KAAI,EACb,OAAQ,CAAC,EACT,OAAQ,KACN,OACA,EACA,YAAa,CAAC,cAAc,EAAE,EAAO,OAAO,CAAC,KAAM,KAAA,CAAM,QACzD,WACA,CACF,CACF,GAEA,EAAc,GAAG,CAAC,EAAK,EAAW,EAAE,CACtC,CAEA,QAAQ,GAAG,CAAC,CAAC,kBAAkB,EAAE,EAAc,IAAI,CAAC,YAAY,CAAC,EAGjE,IAAM,EAAgB,MAAM,EAAA,MAAM,CAAC,QAAQ,CAAC,KAAK,GAC7C,EAAgB,GAAG,CACrB,QAAQ,GAAG,CAAC,CAAC,cAAc,EAAE,EAAc,wBAAwB,CAAC,EACpE,MAAM,EAAA,MAAM,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,GAClC,QAAQ,GAAG,CAAC,CAAC,mCAAmC,CAAC,GAInD,IAAM,EAAsB,MAAM,EAAA,MAAM,CAAC,cAAc,CAAC,KAAK,GAU7D,IAAK,IAAM,KATP,EAAsB,GAAG,CAC3B,IAQwB,IARhB,GAAG,CAAC,CAAC,IAQyB,UARX,EAAE,EAAoB,mBAAmB,CAAC,EACrE,MAAM,EAAA,MAAM,CAAC,cAAc,CAAC,UAAU,CAAC,CAAC,GACxC,QAAQ,GAAG,CAAC,CAAC,8BAA8B,CAAC,GAKzB,CAAC,cAAe,gBAAiB,cAAc,EAK9D,CAHY,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAC3C,MAAO,CAAE,KAAM,CAAY,CAC7B,EAAA,EACY,KAAK,CAAG,GAAG,AACrB,QAAQ,GAAG,CAAC,CAAC,uBAAuB,EAAE,EAAA,CAAa,EAKvD,IAAM,EAAoB,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,KAAK,GACjD,GAAI,EAAoB,EAAG,CACzB,QAAQ,GAAG,CAAC,CAAC,cAAc,EAAE,EAAkB,qBAAqB,CAAC,EACrE,IAAM,EAAe,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,GACnD,QAAQ,GAAG,CAAC,CAAC,UAAU,EAAE,EAAa,KAAK,CAAC,QAAQ,CAAC,EAGrD,IAAM,EAAiB,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,KAAK,GAC9C,GAAI,EAAiB,EAAG,CACtB,QAAQ,GAAG,CAAC,CAAC,aAAa,EAAE,EAAe,mCAAmC,CAAC,EAC/E,IAAM,EAAY,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAE,OAAQ,CAAE,IAAI,EAAM,MAAM,CAAK,CAAE,GAChF,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,EAAU,GAAG,CAAC,GAAK,EAAE,IAAI,EAAE,IAAI,CAAC,MAAA,CAAO,CAC5E,CACF,MACE,CADK,OACG,GAAG,CAAC,CAAC,+BAA+B,CAAC,EAI/C,IAAK,GAAM,CAAC,EAAS,EAAS,GAAI,OAAO,OAAO,CAAC,EAAA,aAAa,EAAG,CAE/D,IAII,EAJE,EAAe,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CAChD,MAAO,CAAE,KAAM,EAAS,IAAI,AAAC,CAC/B,GAGI,GAEF,EAAO,MAAM,EAAA,CAFG,KAEG,CAAC,IAAI,CAAC,MAAM,CAAC,CAC9B,MAAO,CAAE,GAAI,EAAa,EAAE,AAAC,EAC7B,KAAM,CACJ,YAAa,EAAS,WAAW,CACjC,aAAc,EAAS,YAAY,AACrC,CACF,GAEA,MAAM,EAAA,MAAM,CAAC,cAAc,CAAC,UAAU,CAAC,CACrC,MAAO,CAAE,OAAQ,EAAK,EAAE,AAAC,CAC3B,IAGA,EAAO,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAC9B,KAAM,CACJ,KAAM,EAAS,IAAI,CACnB,YAAa,EAAS,WAAW,CACjC,aAAc,EAAS,YAAY,AACrC,CACF,GAIF,IAAM,EAAgB,EAAS,WAAW,CACvC,GAAG,CAAC,GAAO,EAAc,GAAG,CAAC,IAC7B,MAAM,CAAE,AAAD,QAA6B,IAAP,GAQhC,GALA,MAAM,EAAA,MAAM,CAAC,cAAc,CAAC,UAAU,CAAC,CACrC,MAAO,CAAE,OAAQ,EAAK,EAAE,AAAC,CAC3B,GAGI,EAAc,MAAM,CAAG,EACzB,CAD4B,GACvB,IAAM,KAAgB,EACzB,GAAI,CACF,MAAM,EAAA,AAFgC,MAE1B,CAAC,cAAc,CAAC,MAAM,CAAC,CACjC,KAAM,CACJ,OAAQ,EAAK,EAAE,CACf,cACF,CACF,EACF,CAAE,MAAO,EAAQ,CAEf,GAAe,SAAS,CAApB,EAAE,IAAI,CACR,MAAM,CAEV,CAIJ,QAAQ,GAAG,CAAC,CAAC,wBAAwB,EAAE,EAAK,IAAI,CAAC,MAAM,EAAE,EAAc,MAAM,CAAC,YAAY,CAAC,CAC7F,CAGA,OADA,QAAQ,GAAG,CAAC,oCACL,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAY,CAEnB,OADA,QAAQ,KAAK,CAAC,gCAAiC,GACxC,CAAE,MAAO,EAAM,OAAO,AAAC,CAChC,CACF,iCA1lBsB,EA8BA,EA+BA,EA6EA,EAoHA,EA4DA,EAuBA,EA6DA,EAyDA,IAvcA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA8BA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA+BA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA6EA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAoHA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA4DA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAuBA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA6DA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAyDA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,4SCtdtB,IAAM,EAAuE,CAE3E,aAAc,CAAE,IAAK,MAAO,QAAS,IAAI,GAAY,EACrD,EADgD,UACnC,CAAE,IAAK,MAAO,QAAS,IAAI,GAAY,EACpD,EAD+C,WACjC,CAAE,IAAK,OAAQ,QAAS,IAAI,GAAY,EACtD,EADiD,UACpC,CAAE,IAAK,MAAO,QAAS,IAAI,GAAY,EACpD,EAD+C,cAC9B,CAAE,IAAK,MAAO,QAAS,IAAI,GAAY,EAGxD,EAHmD,gBAGhC,CAAE,IAAK,MAAO,QAAS,KAAK,GAAY,EAC3D,EADsD,mBAChC,CAAE,IAAK,MAAO,QAAS,KAAK,GAAY,EAC9D,EADyD,wEACkB,CACzE,IAAK,OACL,QAAS,KAAK,GAChB,EACA,EAFuB,yBAEK,CAAE,IAAK,MAAO,QAAS,KAAK,GAAY,EACpE,EAD+D,kEACM,CACnE,IAAK,OACL,QAAS,KAAK,GAChB,EACA,EAFuB,WAET,CAAE,IAAK,MAAO,QAAS,IAAI,GAAY,EACrD,EADgD,SACpC,CAAE,IAAK,MAAO,QAAS,IAAI,GAAY,CACrD,EAGM,CAJ0C,CAInB,CAC3B,MACA,MACA,MACA,MACA,MACA,MACA,KACA,MACA,MACA,MACA,KACA,MACA,MACA,MACA,MACA,MACA,MACA,MACA,MACA,KACA,OACA,MACA,MACA,OACA,MACA,OACA,SACA,UACA,OACA,OACA,OACA,UACA,OACA,OACA,UACA,OACA,MACA,MACA,OACA,OACA,OACA,MACA,OACA,OACA,MACA,MACA,OACA,MACA,MACA,KACA,MACA,MACA,KACA,MACA,MACA,KACA,MACA,MACA,MACA,IACA,MACA,MACA,KACA,IACA,MACA,KACA,OACA,QACA,QACA,KACA,KACA,KACA,KACA,MACA,MACD,CAyBM,SAAS,EAAmB,CAAU,EAC3C,GAAI,CAAC,EACH,IADS,EACF,CACL,OAAO,EACP,MAAO,kBACT,EAIF,GAAI,CAAC,EAAK,IAAI,EAAyB,IAAI,CAAzB,EAAK,IAAI,CAAC,IAAI,GAC9B,MAAO,CACL,OAAO,EACP,MAAO,uBACT,EAIF,GAAI,CAAC,CAAkB,CAAC,EAAK,IAAI,CAAC,CAAE,CAClC,IAAM,EAAe,OAAO,IAAI,CAAC,GAAoB,IAAI,CAAC,MAC1D,MAAO,CACL,OAAO,EACP,MAAO,CAAC,WAAW,EAAE,EAAK,IAAI,EAAI,UAAU,mCAAmC,EAAE,EAAA,CAAc,AACjG,CACF,CAGA,IAAM,EAAU,CAAkB,CAAC,EAAK,IAAI,CAAC,CAAC,OAAO,CACrD,GAAkB,GAAG,CAAjB,EAAK,IAAI,CACX,MAAO,CACL,OAAO,EACP,MAAO,eACT,EAGF,GAAI,EAAK,IAAI,CAAG,EAAS,CACvB,IAAM,EAAY,CAAC,EAAU,KAAO,IAAA,CAAI,CAAE,OAAO,CAAC,GAC5C,EAAa,CAAC,EAAK,IAAI,CAAG,KAAO,IAAA,CAAI,CAAE,OAAO,CAAC,GACrD,MAAO,CACL,OAAO,EACP,MAAO,CAAC,UAAU,EAAE,EAAW,mBAAmB,EAAE,EAAU,qBAAqB,CAAC,AACtF,CACF,CAGA,IAAM,EAAM,EAAiB,EAAK,IAAI,EAAE,WAAW,GACnD,GAAI,GAAO,EAAqB,QAAQ,CAAC,GACvC,GAD6C,GACtC,CACL,OAAO,EACP,MAAO,CAAC,iBAAiB,EAAE,EAAI,qCAAqC,CACtE,AADuE,EAKzE,IAAM,EAAc,CAAkB,CAAC,EAAK,IAAI,CAAC,CAAC,GAAG,CAQrD,OAPI,GAAO,IAAQ,GAEjB,QAAQ,EAFsB,EAElB,CACV,CAAC,0BAA0B,EAAE,EAAI,2BAA2B,EAAE,EAAK,IAAI,CAAC,eAAe,EAAE,EAAY,CAAC,CAAC,EAIpG,CAAE,OAAO,CAAK,CACvB,CAQO,SAAS,EAAiB,CAAgB,SAC/C,AAAK,EAGH,EACG,AAJD,MAAW,CAIH,CAAC,MAAO,IAAI,AACnB,OAAO,CAAC,MAAO,IAAI,AACnB,GAFwC,IAEjC,CAAC,QAAS,IAAI,AACrB,KAF4C,EAErC,CAAC,SAD8B,aACP,IAAI,AACnC,OAAO,CAAC,OAAQ,KAAK,AACrB,SAAS,CAAC,EAAG,IAF0D,CAErD,AATD,MAWxB,CASO,SAAS,EAAqB,CAAoB,CAAE,AAZM,CAYQ,EACvE,CAZ+C,GAYzC,EAAM,EAAiB,GACvB,EAAY,KAAK,GAAG,GACpB,EAAS,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,EAAG,GAGvD,MAAO,CAAC,CAAC,EAAE,EAAO,CAAC,EAAE,EAAU,CAAC,EAAE,EAAO,CAAC,EAAE,EAAA,CAAK,AACnD,CAQA,SAAS,EAAiB,CAAgB,EACxC,GAAI,CAAC,EAAU,MAAO,GACtB,IAAM,EAAQ,EAAS,KAAK,CAAC,KAC7B,OAAO,EAAM,MAAM,CAAG,EAAI,CAAK,CAAC,EAAM,MAAM,CAAG,EAAE,CAAG,EACtD,CAUO,eAAe,EAAoB,CAAmB,CAAE,CAAgB,EAU7E,IAAM,EARyC,AAQjC,CAPZ,aAAc,CAAC,IAAM,IAAM,IAAK,CAChC,YAAa,CAAC,IAAM,GAAM,GAAM,GAAK,CACrC,YAAa,CAAC,GAAM,GAAM,GAAK,CAC/B,aAAc,CAAC,GAAM,GAAM,GAAM,GAAK,CACtC,kBAAmB,CAAC,GAAM,GAAM,GAAM,GAAK,AAC7C,CAE0B,CAAC,EAAS,CACpC,GAAI,CAAC,EAAO,OAAO,EAEnB,GAFwB,CAElB,EAAQ,IAAI,WAAW,GAG7B,GAAI,EAAM,MAAM,CAAG,EAAM,MAAM,CAC7B,CAD+B,MACxB,EAIT,IAAK,CAV2E,GAUvE,EAAI,EAAG,EAAI,EAAM,MAAM,CAAE,IAAK,AACrC,GAAI,CAAK,CAAC,EAAE,GAAK,CAAK,CAAC,EAAE,CACvB,CADyB,MAClB,EAIX,OAAO,CACT,CAQO,SAAS,EAAoB,CAAa,EAC/C,IAAM,EAAQ,CAAC,IAAK,KAAM,KAAM,KAAK,CACjC,EAAO,EACP,EAAY,EAEhB,KAAO,GAAQ,MAAQ,EAAY,EAAM,MAAM,CAAG,EAAG,CACnD,GAAQ,KACR,IAGF,MAAO,CAAA,EAAG,EAAK,OAAO,CAAC,GAAG,CAAC,EAAE,CAAK,CAAC,EAAU,CAAA,CAAE,AACjD,4LCzSA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,OAGA,eAAe,EAAwB,CAAoB,EACvD,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,EAAA,WAAW,EAClD,GAAI,CAAC,EAAS,MAAO,CAAE,YAAY,EAAO,QAAS,KAAM,mBAAoB,EAAM,EAEnF,IAAM,EAAS,SAAS,EAAQ,IAAI,CAAC,EAAE,EACjC,EAAqB,MAAM,CAAA,EAAA,EAAA,8BAAA,AAA8B,EAAC,EAAQ,gBAClE,EAAS,IAAW,EAK1B,MAAO,CAAE,WAFU,GAAU,UAER,qBAAS,SAAoB,CAAO,CAC7D,CAGO,eAAe,EAAgB,CAAc,EAChD,GAAM,YAAE,CAAU,CAAE,SAAO,CAAE,CAAG,MAAM,EAAwB,GAC9D,GAAI,CAAC,GAAc,CAAC,EAChB,MAAO,CADkB,AAChB,MAAO,mDAAoD,EAGxE,GAAI,CAEA,GAAI,CAAC,EAAA,MAAM,CAAC,WAAW,CAEnB,CAFqB,KAEd,CAAE,SAAS,EAAM,SAAU,CAAC,CAAE,EAGzC,IAAM,EAAe,MAAM,EAAA,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,CACnD,MAAO,QAAE,CAAO,EAChB,QAAS,CACL,CAAE,SAAU,KAAM,EAClB,CAAE,IAAK,KAAM,EAChB,CACD,QAAS,CACL,QAAS,CACL,OAAQ,CACJ,IAAI,EACJ,UAAU,EACV,OAAO,CACX,CACJ,CACJ,CACJ,GAGM,EAAiC,CAAC,EAexC,OAdA,EAAa,OAAO,CAAC,IACb,AAAC,CAAO,CAAC,EAAQ,QAAQ,CAAC,EAAE,CAC5B,CAAO,CAAC,EAAQ,QAAQ,CAAC,CAAG,EAAA,AAAE,EAElC,CAAO,CAAC,EAAQ,QAAQ,CAAC,CAAC,IAAI,CAAC,CAC3B,GAAI,EAAQ,EAAE,CACd,IAAK,EAAQ,GAAG,CAChB,MAAO,EAAc,EAAQ,KAAK,EAClC,SAAU,EAAQ,QAAQ,CAC1B,UAAW,EAAQ,SAAS,CAC5B,UAAW,EAAQ,OAAO,AAC9B,EACJ,GAEO,CAAE,SAAS,EAAM,SAAU,CAAQ,CAC9C,CAAE,MAAO,EAAQ,CAEb,OADA,QAAQ,KAAK,CAAC,yBAA0B,GACjC,CAAE,MAAO,gCAAiC,QAAS,EAAE,OAAO,AAAC,CACxE,CACJ,CAGO,eAAe,EAAwB,CAAc,CAAE,CAAkB,EAE5E,GAAI,CADY,AACX,MADiB,CAAA,EAAA,AACR,EADQ,gBAAA,AAAgB,EAAC,EAAA,WAAW,EAE9C,MAAO,CAAE,MAAO,cAAe,EAGnC,GAAI,CAEA,GAAI,CAAC,EAAA,MAAM,CAAC,WAAW,CAAE,CAErB,IAAM,EAAgC,CAAC,EAEvC,IAAK,IAAM,IADQ,CAAC,OACG,OADY,IACA,OADY,aAAc,gBAAiB,WAAW,CAErF,CAAQ,CAAC,EAAS,CAAG,CACjB,MAAO,EAAiB,GACxB,OAAQ,SACR,QAAS,EACb,EAEJ,MAAO,CAAE,SAAS,EAAM,SAAU,CAAS,CAC/C,CAGA,IAAM,EAAe,MAAM,EAAA,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,CACnD,MAAO,QAAE,CAAO,CACpB,GAGI,EAAyB,EAAE,CAC3B,IACA,EAAkB,KADP,CACa,EAAA,MAAM,CAAC,cAAc,CAAC,QAAQ,CAAC,CACnD,MAAO,CAAE,YAAW,SAAS,CAAK,CACtC,EAAA,EAIJ,IAAM,EAAiB,MAAM,EAAA,MAAM,CAAC,aAAa,CAAC,QAAQ,GAGpD,EAAgC,CAAC,EAGjC,EAAqB,CAAC,cAAe,gBAAiB,WAAW,CAKvE,IAAK,IAAM,IAFQ,CAAC,OAEG,OAFY,WAAY,aAAc,gBAAiB,WAAW,CAEtD,CAC/B,IAAM,EAAc,EAAa,IAAI,CAAC,GAAK,EAAE,QAAQ,GAAK,GAAY,EAAE,GAAG,GAAK,GAC1E,EAAiB,EAAgB,IAAI,CAAC,GAAK,EAAE,QAAQ,GAAK,GAAY,EAAE,GAAG,GAAK,GAChF,EAAgB,EAAe,IAAI,CAAC,GAAK,EAAE,QAAQ,GAAK,GAAY,EAAE,GAAG,GAAK,GAGhF,GAAe,EAAmB,QAAQ,CAAC,GAE3C,CAAQ,CAAC,EAAS,CAAG,CACjB,EAHkD,IAG3C,EAAc,EAAY,KAAK,EACtC,OAAQ,OACR,SAAS,CACb,EACO,GAAkB,EAAe,OAAO,CAE/C,CAFiD,AAEzC,CAAC,EAAS,CAAG,CACjB,MAAO,EAAc,EAAe,KAAK,EACzC,OAAQ,UACR,SAAS,CACb,EACO,EAEP,CAAQ,CAAC,EAAS,CAAG,CACjB,KAHgB,CAGT,EAAc,EAAY,KAAK,EACtC,OAAQ,OACR,QAAS,EACb,EACO,EAEP,CAAQ,CAAC,EAAS,CAAG,CACjB,MAAO,CAHW,CAGG,EAAc,KAAK,EACxC,OAAQ,SACR,SAAS,CACb,EAGA,CAAQ,CAAC,EAAS,CAAG,CACjB,MAAO,EAAiB,GACxB,OAAQ,SACR,SAAS,CACb,CAER,CAEA,MAAO,CAAE,SAAS,EAAM,SAAU,CAAS,CAC/C,CAAE,MAAO,EAAQ,CAEb,OADA,QAAQ,KAAK,CAAC,iCAAkC,GACzC,CAAE,MAAO,oCAAqC,QAAS,EAAE,OAAO,AAAC,CAC5E,CACJ,CAGA,SAAS,EAAiB,CAAgB,EA+BtC,MAAO,CA9B+B,CAClC,YAAa,CACT,SAAU,eACV,aAAc,CAAE,MAAO,QAAS,IAAK,OAAQ,CACjD,EACA,SAAU,CACN,YAAa,OACb,YAAa,CAAE,MAAO,WAAY,MAAO,MAAO,EAChD,eAAe,EACf,aAAa,EACb,qBAAsB,IAC1B,EACA,WAAY,CACR,iBAAiB,EACjB,YAAa,UACb,kBAAkB,EAClB,uBAAuB,CAC3B,EACA,cAAe,CACX,SAAU,CAAE,MAAO,GAAM,OAAO,CAAK,EACrC,SAAU,WACV,eAAgB,CAAC,MAAO,SAAU,OAAQ,SAAS,CACnD,cAAc,CAClB,EACA,SAAU,CACN,mBAAoB,YACpB,sBAAuB,KACvB,sBAAuB,CAAE,SAAS,EAAO,OAAQ,SAAU,CAC/D,EACJ,CACe,CAAC,EAAS,EAAI,IACjC,CAGO,eAAe,EAAe,CAAc,CAAE,CAAW,EAC5D,GAAM,YAAE,CAAU,SAAE,CAAO,CAAE,CAAG,MAAM,EAAwB,GAC9D,GAAI,CAAC,GAAc,CAAC,EAChB,MAAO,CADkB,AAChB,MAAO,cAAe,EAGnC,GAAI,CACA,GAAI,CAAC,EAAA,MAAM,CAAC,WAAW,CACnB,CADqB,KACd,CAAE,MAAO,qEAAsE,EAG1F,IAAM,EAAU,MAAM,EAAA,MAAM,CAAC,WAAW,CAAC,UAAU,CAAC,CAChD,MAAO,CACH,WAAY,QACR,MACA,CACJ,CACJ,EACA,QAAS,CACL,QAAS,CACL,OAAQ,CACJ,IAAI,EACJ,UAAU,EACV,OAAO,CACX,CACJ,CACJ,CACJ,GAEA,GAAI,CAAC,EACD,MAAO,CADG,AACD,MAAO,mBAAoB,EAGxC,MAAO,CACH,SAAS,EACT,QAAS,CACL,GAAI,EAAQ,EAAE,CACd,IAAK,EAAQ,GAAG,CAChB,MAAO,EAAc,EAAQ,KAAK,EAClC,SAAU,EAAQ,QAAQ,CAC1B,UAAW,EAAQ,SAAS,CAC5B,UAAW,EAAQ,OAAO,AAC9B,CACJ,CACJ,CAAE,MAAO,EAAQ,CAEb,OADA,QAAQ,KAAK,CAAC,wBAAyB,GAChC,CAAE,MAAO,0BAA2B,QAAS,EAAE,OAAO,AAAC,CAClE,CACJ,CAGO,eAAe,EAClB,CAAc,CACd,CAAW,CACX,CAAU,CACV,CAAe,EAEf,GAAM,YAAE,CAAU,SAAE,CAAO,oBAAE,CAAkB,CAAE,CAAG,MAAM,EAAwB,GAClF,GAAI,CAAC,GAAc,CAAC,EAChB,MAAO,CADkB,AAChB,MAAO,cAAe,EAGnC,GAAI,CACA,GAAI,CAAC,EAAA,MAAM,CAAC,WAAW,EAAI,CAAC,EAAA,MAAM,CAAC,qBAAqB,CACpD,CADsD,KAC/C,CAAE,MAAO,qEAAsE,EAI1F,IAAM,EAAW,EAAmB,GACpC,GAAI,CAAC,EAAqB,EAAU,GAChC,KADwC,CACjC,CAAE,MAAO,CAAC,0BAA0B,EAAE,EAAA,CAAK,AAAC,EAIvD,IAAM,EAAW,MAAM,EAAA,MAAM,CAAC,WAAW,CAAC,UAAU,CAAC,CACjD,MAAO,CACH,WAAY,QACR,MACA,CACJ,CACJ,CACJ,GAEM,EAAW,GAAU,OAAS,KAC9B,EAAW,KAAK,SAAS,CAAC,GAG1B,EAAU,MAAM,EAAA,MAAM,CAAC,WAAW,CAAC,MAAM,CAAC,CAC5C,MAAO,CACH,WAAY,CACR,aACA,CACJ,CACJ,EACA,OAAQ,QACJ,MACA,WACA,EACA,MAAO,EACP,UAAW,SAAS,EAAQ,IAAI,CAAC,EAAE,CACvC,EACA,OAAQ,CACJ,MAAO,EACP,UAAW,SAAS,EAAQ,IAAI,CAAC,EAAE,CACvC,CACJ,GAmBA,OAhBA,MAAM,EAAA,MAAM,CAAC,qBAAqB,CAAC,MAAM,CAAC,CACtC,KAAM,QACF,EACA,WAAY,WACZ,EACA,SAAU,EACV,SAAU,EACV,OAAQ,GAAU,KAClB,UAAW,SAAS,EAAQ,IAAI,CAAC,EAAE,EACnC,UAAW,EAAQ,EAAE,AACzB,CACJ,GAEA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,CAAC,mBAAmB,CAAC,EACpC,CAAA,EAAA,EAAA,cAAc,AAAd,EAAe,CAAC,UAAU,CAAC,EAEpB,CAAE,SAAS,CAAK,CAC3B,CAAE,MAAO,EAAQ,CAEb,OADA,QAAQ,KAAK,CAAC,2BAA4B,GACnC,CAAE,MAAO,2BAA4B,QAAS,EAAE,OAAO,AAAC,CACnE,CACJ,CAGO,eAAe,EAClB,CAAc,CACd,CAAW,CACX,CAAgB,CAChB,CAAU,CACV,CAAoB,EAEpB,GAAM,YAAE,CAAU,SAAE,CAAO,CAAE,CAAG,MAAM,EAAwB,GAC9D,GAAI,CAAC,GAAc,CAAC,EAChB,MAAO,CADkB,AAChB,MAAO,cAAe,EAGnC,GAAI,CACA,GAAI,CAAC,EAAA,MAAM,CAAC,WAAW,CACnB,CADqB,KACd,CAAE,MAAO,qEAAsE,EAG1F,GAAI,CAAC,EAAqB,EAAU,GAChC,KADwC,CACjC,CAAE,MAAO,CAAC,0BAA0B,EAAE,EAAA,CAAK,AAAC,EAGvD,IAAM,EAAU,MAAM,EAAA,MAAM,CAAC,WAAW,CAAC,MAAM,CAAC,CAC5C,KAAM,QACF,MACA,WACA,EACA,MAAO,KAAK,SAAS,CAAC,GACtB,UAAW,SAAS,EAAQ,IAAI,CAAC,EAAE,CACvC,CACJ,GAIA,MAFA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,CAAC,mBAAmB,CAAC,EAE7B,CAAE,SAAS,UAAM,CAAQ,CACpC,CAAE,MAAO,EAAQ,CAEb,OADA,QAAQ,KAAK,CAAC,2BAA4B,GACnC,CAAE,MAAO,2BAA4B,QAAS,EAAE,OAAQ,AAAD,CAClE,CACJ,CAGO,eAAe,EAAiB,CAAc,CAAE,CAAW,EAC9D,GAAM,YAAE,CAAU,SAAE,CAAO,CAAE,CAAG,MAAM,EAAwB,GAC9D,GAAI,CAAC,GAAc,CAAC,EAChB,MAAO,CADkB,AAChB,MAAO,cAAe,EAGnC,GAAI,CACA,GAAI,CAAC,EAAA,MAAM,CAAC,WAAW,CACnB,CADqB,KACd,CAAE,MAAO,qEAAsE,EAG1F,IAAM,EAAW,EAAmB,GAGpC,GAAI,CAAC,AAFgB,EAAiB,GAGlC,MAAO,CAAE,EADM,IACC,yCAA0C,EAe9D,OAXA,MAAM,EAAA,MAAM,CAAC,WAAW,CAAC,MAAM,CAAC,CAC5B,MAAO,CACH,WAAY,QACR,MACA,CACJ,CACJ,CACJ,GAEA,CAAA,EAAA,EAAA,cAAc,AAAd,EAAe,CAAC,mBAAmB,CAAC,EAE7B,CAAE,QAAS,EAAK,CAC3B,CAAE,MAAO,EAAQ,CAEb,OADA,QAAQ,KAAK,CAAC,0BAA2B,GAClC,CAAE,MAAO,0BAA2B,QAAS,EAAE,OAAO,AAAC,CAClE,CACJ,CAGO,eAAe,EAClB,CAAc,CACd,CAAmB,CACnB,EAAgB,EAAE,CAClB,EAAiB,CAAC,EAElB,GAAM,YAAE,CAAU,SAAE,CAAO,CAAE,CAAG,MAAM,EAAwB,GAC9D,GAAI,CAAC,GAAc,CAAC,EAChB,MAAO,CAAE,AADgB,MACT,cAAe,EAGnC,GAAI,CACA,GAAI,CAAC,EAAA,MAAM,CAAC,qBAAqB,CAC7B,CAD+B,KACxB,CAAE,MAAO,qEAAsE,EAG1F,IAAM,EAAa,QAAE,CAAO,EACxB,IACA,EAAM,MADM,IACI,CAAG,CAAA,EAGvB,IAAM,EAAO,MAAM,EAAA,MAAM,CAAC,qBAAqB,CAAC,QAAQ,CAAC,OACrD,EACA,QAAS,CAAE,UAAW,MAAO,EAC7B,KAAM,EACN,KAAM,EACN,QAAS,CACL,QAAS,CACL,OAAQ,CACJ,IAAI,EACJ,UAAU,EACV,OAAO,CACX,CACJ,CACJ,CACJ,GAEA,MAAO,CAAE,SAAS,OAAM,CAAK,CACjC,CAAE,MAAO,EAAQ,CAEb,OADA,QAAQ,KAAK,CAAC,kCAAmC,GAC1C,CAAE,MAAO,6BAA8B,QAAS,EAAE,OAAO,AAAC,CACrE,CACJ,CAGA,SAAS,EAAmB,CAAW,SAEnC,AAAI,EAAI,UAAU,CAAC,eAAuB,CAAP,aAC/B,EAAI,UAAU,CAAC,YAAoB,CAAP,UAC5B,EAAI,UAAU,CAAC,cAAsB,CAAP,YAC9B,EAAI,UAAU,CAAC,iBAAyB,CAAP,eACjC,EAAI,UAAU,CAAC,YAAoB,CAAP,UACzB,CACX,CAEA,SAAS,EAAqB,CAAgB,CAAE,CAAU,EAEtD,GAAI,CACA,OAAQ,GACJ,IAAK,cACD,GAAI,EAAM,QAAQ,EAA8B,UAA1B,OAAO,EAAM,QAAQ,EACvC,EAAM,YAAY,EAAE,CAChB,CAAC,EAAM,YAAY,CAAC,KAAK,EAAI,CAAC,EAAM,YAAY,CAAC,GAAA,AAAG,EAAE,AAFJ,OAEW,AAFJ,EAIjE,OAAO,CACX,KAAK,WACD,GAAI,EAAM,WAAW,EAAI,CAAC,CAAC,OAAQ,SAAS,CAAC,QAAQ,CAAC,EAAM,WAAW,GACnE,EAAM,WAAW,EAAE,CACf,CAAC,CAAC,WAAY,UAAW,YAAa,QAAQ,CAAC,QAAQ,CAAC,EAAM,WAAW,CAAC,KAAK,GAAG,AAClF,CAAC,CAAC,KADuF,CAChF,OAAO,CAAC,QAAQ,CAAC,EAAM,WAAW,CAAC,KAAK,GAAG,AAHc,OAGP,AAHc,EAKjF,OAAO,CACX,KAAK,aACD,GAAI,EAAM,WAAW,EAAI,CAAC,CAAC,UAAW,WAAW,CAAC,QAAQ,CAAC,EAAM,WAAW,EAAG,OAAO,EACtF,MAAO,EACX,KAAK,gBACD,GAAI,EAAM,QAAQ,EAAE,CACoB,WAAhC,OAAO,EAAM,QAAQ,CAAC,KAAK,EACK,WAAW,AAA3C,OAAkD,AAA3C,EAAM,QAAQ,CAAC,KAAK,GAE/B,EAAM,QAAQ,EAAI,CAAC,CAAC,WAAY,cAAc,CAAC,QAAQ,CAAC,EAAM,QAAQ,EAHvB,CAG0B,MAHnB,CAG0B,CACpF,OAAO,CACX,KAAK,WACD,GAAI,EAAM,kBAAkB,EAAI,CAAC,CAAC,YAAa,aAAc,WAAY,QAAQ,CAAC,QAAQ,CAAC,EAAM,kBAAkB,EAAG,OAAO,EAC7H,OAAO,CACX,SACI,OAAO,CACf,CACJ,CAAE,KAAM,CACJ,OAAO,CACX,CACJ,CAEA,SAAS,EAAc,CAAa,EAChC,GAAI,CACA,OAAO,KAAK,KAAK,CAAC,EACtB,CAAE,KAAM,CAEJ,OAAO,CACX,CACJ,2CAnfsB,EAsDA,EAsIA,EAmDA,EAiFA,EAyCA,EAsCA,IA/YA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAsDA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAsIA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAmDA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAiFA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAyCA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAsCA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,mOCvatB,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAKA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,sBCLA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAQO,eAAe,EAAiB,CAAkB,EACvD,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,gBAAgB,AAAhB,EAAiB,EAAA,WAAW,EAClD,GAAI,CAAC,GAAiC,SAAS,CAA/B,EAAQ,IAAI,CAAC,IAAI,CAC/B,MAAO,CAAE,MAAO,uCAAwC,KAAM,cAAe,EAG/E,IAAM,EAAO,EAAS,GAAG,CAAC,QAC1B,GAAI,CAAC,EACH,IADS,EACF,CAAE,MAAO,mBAAoB,KAAM,cAAe,EAG3D,GAAI,CAEF,IAAM,EAAa,CAAA,EAAA,EAAA,kBAAA,AAAkB,EAAC,GACtC,GAAI,CAAC,EAAW,KAAK,CACnB,CADqB,KACd,CAAE,MAAO,EAAW,KAAK,EAAI,eAAgB,KAAM,cAAe,EAI3E,IAAM,EAAQ,MAAM,EAAK,WAAW,GAEpC,GAAI,CAAC,AADgB,MAAM,CAAA,EAAA,EAAA,GACR,gBADQ,AAAmB,EAAC,EAAO,EAAK,IAAI,EAE7D,MAAO,CACL,MAAO,wEACP,KAAM,kBACR,EAIF,IAAM,EAAY,CAAA,EAAA,EAAA,IAAA,AAAI,EAAC,QAAQ,GAAG,GAAI,SAAU,UAAW,WAC3D,OAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,EAAW,CAAE,WAAW,CAAK,GAGzC,IAAM,EAAe,CAAA,EAAA,EAAA,oBAAA,AAAoB,EAAC,EAAK,IAAI,CAAE,SAAS,EAAQ,IAAI,CAAC,EAAE,GACvE,EAAW,CAAA,EAAA,EAAA,IAAA,AAAI,EAAC,EAAW,GAG3B,EAAS,OAAO,IAAI,CAAC,GAQ3B,OAPA,MAAM,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,EAAU,GAG1B,QAAQ,GAAG,CACT,CAAC,oBAAoB,EAAE,EAAQ,IAAI,CAAC,IAAI,EAAI,EAAQ,IAAI,CAAC,KAAK,CAAC,gBAAgB,EAAE,EAAA,CAAc,EAG1F,CACL,SAAS,EACT,IAAK,CAAC,kBAAkB,EAAE,EAAA,CAAc,CACxC,SAAU,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,EAAK,IAAI,EACpC,SAAU,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,EAAK,IAAI,EACvC,KAAM,gBACR,CACF,CAAE,MAAO,EAAY,CAEnB,OADA,QAAQ,KAAK,CAAC,qBAAsB,GAC7B,CACL,MAAO,wBACP,KAAM,gBACN,QAAS,EAAM,OAAO,AACxB,CACF,CACF,2CA5DsB,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MDatB,IAAA,EAAA,EAAA,CAAA,CAAA"}