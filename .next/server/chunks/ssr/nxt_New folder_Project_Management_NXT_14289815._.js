module.exports=[153544,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(449597);async function g(a,b){try{let f=await (0,d.getServerSession)(e.authOptions);if(!f?.user?.id)return{success:!1,error:"Unauthorized"};let g=parseInt(f.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:g,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let h=b?.limit||20,i=b?.offset||0,j={projectId:a,userId:g};b?.type&&(j.type=b.type),b?.isRead!==void 0&&(j.isRead=b.isRead);let[k,l]=await Promise.all([c.prisma.projectNotification.findMany({where:j,orderBy:[{isUrgent:"desc"},{requiresAcknowledgment:"desc"},{createdAt:"desc"}],take:h,skip:i}),c.prisma.projectNotification.count({where:j})]);return{success:!0,notifications:k,total:l}}catch(a){return console.error("Error fetching project notifications:",a),{success:!1,error:"Failed to fetch notifications"}}}async function h(){try{let a=await (0,d.getServerSession)(e.authOptions);if(!a?.user?.id)return{success:!1,error:"Unauthorized"};let b=parseInt(a.user.id),f=await c.prisma.projectUser.findMany({where:{userId:b,leftAt:null},select:{projectId:!0}}),g=[];try{g=await c.prisma.task.findMany({where:{assignees:{some:{id:b}}},select:{projectId:!0}})}catch(a){console.warn("[Notifications] Could not fetch tasks, using only ProjectUser:",a?.message),g=[]}let h=f.map(a=>a.projectId),i=g.map(a=>a.projectId),j=[...new Set([...h,...i])];if(0===j.length)return{success:!0,count:0};let k=0;try{k=await c.prisma.projectNotification.count({where:{projectId:{in:j},userId:b,isRead:!1}})}catch(a){return console.error("[Notifications] ProjectNotification model not available. Please run 'npx prisma generate':",a?.message),{success:!0,count:0}}return{success:!0,count:k}}catch(a){return console.error("Error fetching all projects unread count:",a),console.error("Error details:",{message:a?.message,stack:a?.stack,name:a?.name}),{success:!1,error:a?.message||"Failed to fetch unread count",details:a?.stack}}}async function i(a=15){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id),g=await c.prisma.projectUser.findMany({where:{userId:f,leftAt:null},select:{projectId:!0}}),h=[];try{h=await c.prisma.task.findMany({where:{assignees:{some:{id:f}}},select:{projectId:!0}})}catch(a){console.warn("[Notifications] Could not fetch tasks, using only ProjectUser:",a?.message),h=[]}let i=g.map(a=>a.projectId),j=h.map(a=>a.projectId),k=[...new Set([...i,...j])];if(console.log(`[Notifications] User ${f} has access to projects:`,k),0===k.length)return console.log(`[Notifications] No projects found for user ${f}`),{success:!0,notifications:[]};if(!c.prisma.projectNotification)return console.error("[Notifications] ProjectNotification model not found. Please run 'npx prisma generate'"),{success:!0,notifications:[]};let l=[];try{l=await c.prisma.projectNotification.findMany({where:{projectId:{in:k},userId:f},include:{project:{select:{id:!0,name:!0}}},orderBy:{createdAt:"desc"},take:a})}catch(a){return console.error("[Notifications] Error accessing ProjectNotification model. Please run 'npx prisma generate':",a?.message),{success:!0,notifications:[]}}return console.log(`[Notifications] Found ${l.length} notifications for user ${f}`),{success:!0,notifications:l}}catch(a){return console.error("Error fetching all projects notifications:",a),console.error("Error details:",{message:a?.message,stack:a?.stack,name:a?.name}),{success:!1,error:a?.message||"Failed to fetch notifications",details:a?.stack}}}async function j(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:f,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let g=await c.prisma.projectNotification.count({where:{projectId:a,userId:f,isRead:!1}});return{success:!0,count:g}}catch(a){return console.error("Error fetching unread count:",a),{success:!1,error:"Failed to fetch unread count"}}}async function k(a,b){try{let g=await (0,d.getServerSession)(e.authOptions);if(!g?.user?.id)return{success:!1,error:"Unauthorized"};let h=parseInt(g.user.id),i=await c.prisma.projectNotification.findFirst({where:{id:b,projectId:a,userId:h}});if(!i)return{success:!1,error:"Notification not found"};if(i.isUrgent&&i.requiresAcknowledgment&&!i.acknowledgedAt)return{success:!1,error:"Urgent notifications cannot be marked as read until acknowledged. Please acknowledge the urgent project first."};return await c.prisma.projectNotification.update({where:{id:b},data:{isRead:!0}}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error marking notification as read:",a),{success:!1,error:"Failed to mark notification as read"}}}async function l(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let g=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:g,leftAt:null}}))return{success:!1,error:"Access denied to this project"};return await c.prisma.projectNotification.updateMany({where:{projectId:a,userId:g,isRead:!1,OR:[{isUrgent:!1},{requiresAcknowledgment:!1},{acknowledgedAt:{not:null}}]},data:{isRead:!0}}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error marking all notifications as read:",a),{success:!1,error:"Failed to mark all notifications as read"}}}async function m(a){try{let b=await (0,d.getServerSession)(e.authOptions);if(!b?.user?.id)return{success:!1,error:"Unauthorized"};let f=parseInt(b.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:f,leftAt:null}}))return{success:!1,error:"Access denied to this project"};let g=await c.prisma.projectNotificationPreference.findUnique({where:{projectId_userId:{projectId:a,userId:f}}});return g||(g=await c.prisma.projectNotificationPreference.create({data:{projectId:a,userId:f,soundEnabled:!0,taskNotifications:!0,dependencyNotifications:!0,todayTaskNotifications:!0,projectAdminNotifications:!0}})),{success:!0,preferences:g}}catch(a){return console.error("Error fetching notification preferences:",a),{success:!1,error:"Failed to fetch preferences"}}}async function n(a,b){try{let g=await (0,d.getServerSession)(e.authOptions);if(!g?.user?.id)return{success:!1,error:"Unauthorized"};let h=parseInt(g.user.id);if(!await c.prisma.projectUser.findFirst({where:{projectId:a,userId:h,leftAt:null}}))return{success:!1,error:"Access denied to this project"};return await c.prisma.projectNotificationPreference.upsert({where:{projectId_userId:{projectId:a,userId:h}},create:{projectId:a,userId:h,soundEnabled:b.soundEnabled??!0,taskNotifications:b.taskNotifications??!0,dependencyNotifications:b.dependencyNotifications??!0,todayTaskNotifications:b.todayTaskNotifications??!0,projectAdminNotifications:b.projectAdminNotifications??!0},update:b}),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0}}catch(a){return console.error("Error updating notification preferences:",a),{success:!1,error:"Failed to update preferences"}}}async function o(a,b,d){let{type:e,entityType:g,entityId:h,title:i,message:j,soundRequired:k=!1,isUrgent:l=!1,requiresAcknowledgment:m=!1}=d;try{let d=await c.prisma.projectUser.findFirst({where:{projectId:a,userId:b,leftAt:null}});if(!d&&("task"===g||"comment_mention"===g)&&h){if(!await c.prisma.task.findFirst({where:{id:h,projectId:a,assignees:{some:{id:b}}}}))return{success:!1,error:"User not in project or assigned to task"};d=null}else if(!d&&"comment"===g&&h){let e=await c.prisma.comment.findUnique({where:{id:h},select:{taskId:!0}});if(!e||!e.taskId)return{success:!1,error:"Comment or related task not found"};if(!await c.prisma.task.findFirst({where:{id:e.taskId,projectId:a,assignees:{some:{id:b}}}}))return{success:!1,error:"User not assigned to the task related to this comment"};d=null}else if(!d)return{success:!1,error:"User not in project"};let n=await c.prisma.projectNotificationPreference.findUnique({where:{projectId_userId:{projectId:a,userId:b}}}),o=!0;if(!k)switch(e){case"task":n&&!n.taskNotifications&&(o=!1);break;case"dependency":n&&!n.dependencyNotifications&&(o=!1);break;case"today_task":n&&!n.todayTaskNotifications&&(o=!1);break;case"project_admin":n&&!n.projectAdminNotifications&&(o=!1)}if(!o)return{success:!0,skipped:!0};let p=await c.prisma.projectNotification.create({data:{projectId:a,userId:b,type:e,entityType:g,entityId:h,title:i,message:j,soundRequired:k,isUrgent:l,requiresAcknowledgment:m}});return console.log(`[Notifications] Created notification for user ${b} in project ${a}:`,{id:p.id,type:e,title:i,soundRequired:k}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)(`/dashboard/projects/${a}/notifications`),{success:!0,notification:p}}catch(a){return console.error("Error creating project notification:",a),{success:!1,error:"Failed to create notification"}}}(0,a.i(287907).ensureServerEntryExports)([g,h,i,j,k,l,m,n,o]),(0,b.registerServerReference)(g,"60e11d18f808d2843f4d06a35ea4ad9027dd8b4de1",null),(0,b.registerServerReference)(h,"00686a7231b739e4fe9b8305b757bc0e83827b9865",null),(0,b.registerServerReference)(i,"4004a0aae390e2c1aeb900c79065f312ac43d90f8d",null),(0,b.registerServerReference)(j,"40c45036bf2dcfbc3a3b624285c3d3d3366fc5ed73",null),(0,b.registerServerReference)(k,"60691655a7ad6aec29ab9691d8571a0d380be93da1",null),(0,b.registerServerReference)(l,"40c086aae8b4c1ddec14829c213410ee4c5d2ec0b4",null),(0,b.registerServerReference)(m,"4073df5af18efe51e33e158abaa2dd30f11932484d",null),(0,b.registerServerReference)(n,"60d7258dffa20b5ae58a4ac333313c2a6cc4aeb7a7",null),(0,b.registerServerReference)(o,"705f7777ed9cdc6c32f418ba57dcb7f4b84f8c002a",null),a.s(["createProjectNotification",()=>o,"getAllProjectsNotifications",()=>i,"getAllProjectsUnreadNotificationCount",()=>h,"getProjectNotificationPreferences",()=>m,"getProjectNotifications",()=>g,"getProjectUnreadNotificationCount",()=>j,"markAllProjectNotificationsAsRead",()=>l,"markProjectNotificationAsRead",()=>k,"updateProjectNotificationPreferences",()=>n])},843320,a=>{"use strict";var b=a.i(962460),c=a.i(153544);a.s([],894060),a.i(894060),a.s(["0033db22356cbf8845a3517099b63dfc38d1147299",()=>b.getPublicSystemSettings,"00686a7231b739e4fe9b8305b757bc0e83827b9865",()=>c.getAllProjectsUnreadNotificationCount,"4004a0aae390e2c1aeb900c79065f312ac43d90f8d",()=>c.getAllProjectsNotifications,"40c086aae8b4c1ddec14829c213410ee4c5d2ec0b4",()=>c.markAllProjectNotificationsAsRead,"60691655a7ad6aec29ab9691d8571a0d380be93da1",()=>c.markProjectNotificationAsRead,"60e11d18f808d2843f4d06a35ea4ad9027dd8b4de1",()=>c.getProjectNotifications],843320)}];

//# sourceMappingURL=nxt_New%20folder_Project_Management_NXT_14289815._.js.map