module.exports=[792509,(a,b,c)=>{b.exports=a.x("url",()=>require("url"))},921517,(a,b,c)=>{b.exports=a.x("http",()=>require("http"))},254799,(a,b,c)=>{b.exports=a.x("crypto",()=>require("crypto"))},449719,(a,b,c)=>{b.exports=a.x("assert",()=>require("assert"))},145706,(a,b,c)=>{b.exports=a.x("querystring",()=>require("querystring"))},500874,(a,b,c)=>{b.exports=a.x("buffer",()=>require("buffer"))},406461,(a,b,c)=>{b.exports=a.x("zlib",()=>require("zlib"))},524836,(a,b,c)=>{b.exports=a.x("https",()=>require("https"))},427699,(a,b,c)=>{b.exports=a.x("events",()=>require("events"))},504166,a=>{a.v({name:"openid-client",version:"5.7.1",description:"OpenID Connect Relying Party (RP, Client) implementation for Node.js runtime, supports passportjs",keywords:["auth","authentication","basic","certified","client","connect","dynamic","electron","hybrid","identity","implicit","oauth","oauth2","oidc","openid","passport","relying party","strategy"],homepage:"https://github.com/panva/openid-client",repository:"panva/openid-client",funding:{url:"https://github.com/sponsors/panva"},license:"MIT",author:"Filip Skokan <panva.ip@gmail.com>",exports:{types:"./types/index.d.ts",import:"./lib/index.mjs",require:"./lib/index.js"},main:"./lib/index.js",types:"./types/index.d.ts",files:["lib","types/index.d.ts"],scripts:{format:"npx prettier --loglevel silent --write ./lib ./test ./certification ./types",test:"mocha test/**/*.test.js"},dependencies:{jose:"^4.15.9","lru-cache":"^6.0.0","object-hash":"^2.2.0","oidc-token-hash":"^5.0.3"},devDependencies:{"@types/node":"^16.18.106","@types/passport":"^1.0.16",base64url:"^3.0.1",chai:"^4.5.0",mocha:"^10.7.3",nock:"^13.5.5",prettier:"^2.8.8","readable-mock-req":"^0.2.2",sinon:"^9.2.4",timekeeper:"^2.3.1"},"standard-version":{scripts:{postchangelog:"sed -i '' -e 's/### \\[/## [/g' CHANGELOG.md"},types:[{type:"feat",section:"Features"},{type:"fix",section:"Fixes"},{type:"chore",hidden:!0},{type:"docs",hidden:!0},{type:"style",hidden:!0},{type:"refactor",section:"Refactor",hidden:!1},{type:"perf",section:"Performance",hidden:!1},{type:"test",hidden:!0}]}})},57693,662338,a=>{"use strict";var b=a.i(347656);let c=new Map;async function d(a,d){let e=`${a}:${d||"global"}`,f=c.get(e);if(f&&f.expiresAt>Date.now())return f.permissions;let g=await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...d?[{scopeType:"project",scopeId:d}]:[]]},include:{role:{include:{permissions:{include:{permission:!0}}}}}}),h=new Set;for(let a of g)for(let b of a.role.permissions)h.add(b.permission.key);let i=Array.from(h);return c.set(e,{permissions:i,expiresAt:Date.now()+3e5}),i}async function e(a,c){return(await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...c?[{scopeType:"project",scopeId:c}]:[]]},include:{role:!0}})).map(a=>({role:a.role,scopeType:a.scopeType,scopeId:a.scopeId}))}function f(a,b){let d=`${a}:${b||"global"}`;c.delete(d)}a.s(["clearPermissionCache",()=>f,"getUserPermissions",()=>d,"getUserRoles",()=>e],662338);class g extends Error{code;constructor(a,b="UNAUTHORIZED"){super(a),this.code=b,this.name="UnauthorizedError"}}class h extends Error{code;constructor(a,b="FORBIDDEN"){super(a),this.code=b,this.name="ForbiddenError"}}class i extends Error{code;constructor(a,b="NOT_FOUND"){super(a),this.code=b,this.name="NotFoundError"}}async function j(a,b,c){if(!await k(a,b,c))throw new g(`Permission denied: ${b}`,"PERMISSION_DENIED")}async function k(a,c,d){try{for(let e of(await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...d?[{scopeType:"project",scopeId:d}]:[]]},include:{role:{include:{permissions:{include:{permission:!0}}}}}})))for(let a of e.role.permissions)if(a.permission.key===c)return!0;return!1}catch(b){return console.error(`Error checking permission ${c} for user ${a}:`,b),!1}}function l(a){return a instanceof g||a instanceof h?{error:a.message,code:a.code,status:403,success:!1}:a instanceof i?{error:a.message,code:a.code,status:404,success:!1}:(console.error("Unknown authorization error:",a),{error:"Authorization failed",code:"AUTHORIZATION_ERROR",status:500,success:!1})}a.s(["handleAuthorizationError",()=>l,"hasPermissionWithoutRoleBypass",()=>k,"requirePermission",()=>j],57693)},126695,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(541265);async function e(a){console.log("[ActivityLogger] ====== START LOGGING ======"),console.log("[ActivityLogger] Received params:",JSON.stringify(a,null,2));try{let b=function a(b){let c={...b};for(let a of["password","passwordHash","password_hash","token","secret","apiKey","api_key","accessToken","refreshToken"])a in c&&(c[a]="[REDACTED]");for(let b in c)"object"!=typeof c[b]||null===c[b]||Array.isArray(c[b])||(c[b]=a(c[b]));return c}(a.actionDetails||{});console.log("[ActivityLogger] Sanitized details:",JSON.stringify(b,null,2)),console.log("[ActivityLogger] Logging activity:",{actionType:a.actionType,actionCategory:a.actionCategory,actionSummary:a.actionSummary,performedById:a.performedById});try{let d=await c.prisma.activityLog.create({data:{actionType:a.actionType,actionCategory:a.actionCategory,actionSummary:a.actionSummary,actionDetails:Object.keys(b).length>0?JSON.stringify(b):null,performedById:a.performedById,affectedUserId:a.affectedUserId||null,projectId:a.projectId||null,entityType:a.entityType||null,entityId:a.entityId||null,ipAddress:a.ipAddress||await f(),userAgent:a.userAgent||await g(),action:a.actionType,description:a.actionSummary,userId:a.performedById}});console.log("[ActivityLogger] âœ… Successfully logged activity with ID:",d.id),console.log("[ActivityLogger] ====== END LOGGING (SUCCESS) ======");return}catch(b){if(console.error("[ActivityLogger] âŒ Schema error occurred:"),console.error("[ActivityLogger] Error message:",b.message),console.error("[ActivityLogger] Error code:",b.code),console.error("[ActivityLogger] Error meta:",JSON.stringify(b.meta,null,2)),b.message?.includes("no such column")||"P2003"===b.code||"P2011"===b.code){console.warn("[ActivityLogger] New columns not found, using legacy schema. Please run migration."),await c.prisma.$executeRawUnsafe(`
          INSERT INTO activity_logs (action, description, entity_type, entity_id, ip_address, user_id, created_at)
          VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
        `,a.actionType,a.actionSummary,a.entityType||null,a.entityId||null,a.ipAddress||await f()||null,a.performedById),console.log("[ActivityLogger] âœ… Logged using legacy schema"),console.log("[ActivityLogger] ====== END LOGGING (LEGACY) ======");return}throw console.error("[ActivityLogger] âŒ Unknown schema error, rethrowing"),b}}catch(a){console.error("[ActivityLogger] âŒâŒâŒ CRITICAL ERROR - Failed to log activity âŒâŒâŒ"),console.error("[ActivityLogger] Error message:",a?.message||a),console.error("[ActivityLogger] Error code:",a?.code),console.error("[ActivityLogger] Error meta:",JSON.stringify(a?.meta,null,2)),console.error("[ActivityLogger] Error stack:",a?.stack),console.error("[ActivityLogger] ====== END LOGGING (ERROR) ======")}}async function f(){try{let a=await (0,d.headers)(),b=a.get("x-forwarded-for"),c=a.get("x-real-ip");if(b)return b.split(",")[0].trim();if(c)return c;return null}catch{return null}}async function g(){try{return(await (0,d.headers)()).get("user-agent")||null}catch{return null}}(0,a.i(287907).ensureServerEntryExports)([e]),(0,b.registerServerReference)(e,"40daa1d9c7314de4957a7669434db12aaa24630ba4",null),a.s(["logActivity",()=>e])},766050,a=>{"use strict";let b={USER:{CREATE:"user.create",READ:"user.read",UPDATE:"user.update",DELETE:"user.delete",ASSIGN_ROLE:"user.assign_role",ACTIVATE:"user.activate",DEACTIVATE:"user.deactivate"},TEAM:{CREATE:"team.create",READ:"team.read",UPDATE:"team.update",DELETE:"team.delete",ADD_MEMBER:"team.add_member",REMOVE_MEMBER:"team.remove_member",ASSIGN_PROJECT:"team.assign_project",REMOVE_PROJECT:"team.remove_project"},PROJECT:{CREATE:"project.create",READ:"project.read",UPDATE:"project.update",DELETE:"project.delete",ASSIGN_TEAM:"project.assign_team",REMOVE_TEAM:"project.remove_team",MANAGE_SETTINGS:"project.manage_settings"},TASK:{CREATE:"task.create",READ:"task.read",UPDATE:"task.update",DELETE:"task.delete",ASSIGN:"task.assign",CHANGE_STATUS:"task.change_status",CHANGE_PRIORITY:"task.change_priority"},DEPENDENCY:{CREATE:"dependency.create",READ:"dependency.read",UPDATE:"dependency.update",DELETE:"dependency.delete",MANUAL_UNBLOCK:"dependency.manual_unblock"},TODAY_TASK:{ASSIGN:"today_task.assign",REMOVE:"today_task.remove",REORDER:"today_task.reorder",VIEW_ALL:"today_task.view_all"},SETTINGS:{GLOBAL_READ:"settings.global.read",GLOBAL_EDIT:"settings.global.edit",PROJECT_READ:"settings.project.read",PROJECT_EDIT:"settings.project.edit",USER_READ:"settings.user.read",USER_EDIT:"settings.user.edit",PROJECT_TYPE_MANAGE:"settings.project_type.manage",PROJECT_STATUS_MANAGE:"settings.project_status.manage",TASK_STATUS_MANAGE:"settings.task_status.manage"},NOTIFICATION:{VIEW:"notification.view",MANAGE:"notification.manage",CONFIGURE:"notification.configure"},LOG:{VIEW:"log.view",EXPORT:"log.export",VIEW_DETAILS:"log.view_details"},ROLE:{CREATE:"role.create",READ:"role.read",UPDATE:"role.update",DELETE:"role.delete",ASSIGN:"role.assign",MANAGE_PERMISSIONS:"role.manage_permissions"},REPORT:{VIEW:"report.view",EXPORT:"report.export",GENERATE:"report.generate"}},c={SYSTEM_ADMIN:{name:"System Admin",description:"Full system access with all permissions",isSystemRole:!0,permissions:Object.values(b).flatMap(a=>Object.values(a))},PROJECT_MANAGER:{name:"Project Manager",description:"Manage projects, tasks, teams, and dependencies",isSystemRole:!0,permissions:[...Object.values(b.PROJECT),...Object.values(b.TASK),...Object.values(b.DEPENDENCY),b.TEAM.READ,b.TEAM.UPDATE,b.TEAM.ADD_MEMBER,b.TEAM.REMOVE_MEMBER,b.TEAM.ASSIGN_PROJECT,b.TEAM.REMOVE_PROJECT,...Object.values(b.TODAY_TASK),b.SETTINGS.PROJECT_READ,b.SETTINGS.PROJECT_EDIT,b.SETTINGS.PROJECT_TYPE_MANAGE,b.SETTINGS.PROJECT_STATUS_MANAGE,b.SETTINGS.TASK_STATUS_MANAGE,b.NOTIFICATION.VIEW,b.NOTIFICATION.MANAGE,b.LOG.VIEW,b.LOG.VIEW_DETAILS,b.USER.READ,b.REPORT.VIEW,b.REPORT.EXPORT,b.REPORT.GENERATE]},TEAM_LEAD:{name:"Team Lead",description:"Manage team tasks, dependencies, and team members",isSystemRole:!0,permissions:[b.PROJECT.READ,...Object.values(b.TASK),...Object.values(b.DEPENDENCY),b.TEAM.READ,b.TEAM.UPDATE,b.TEAM.ADD_MEMBER,b.TEAM.REMOVE_MEMBER,...Object.values(b.TODAY_TASK),b.SETTINGS.PROJECT_READ,b.NOTIFICATION.VIEW,b.LOG.VIEW,b.LOG.VIEW_DETAILS,b.USER.READ,b.REPORT.VIEW]},DEVELOPER:{name:"Developer",description:"Basic task management and updates",isSystemRole:!0,permissions:[b.PROJECT.READ,b.TASK.READ,b.TASK.UPDATE,b.TASK.CHANGE_STATUS,b.TASK.CHANGE_PRIORITY,b.DEPENDENCY.READ,...Object.values(b.TODAY_TASK),b.NOTIFICATION.VIEW,b.LOG.VIEW]}};function d(){return Object.values(b).flatMap(a=>Object.values(a))}a.s(["DEFAULT_ROLES",0,c,"PERMISSIONS",0,b,"getAllPermissions",()=>d])},866236,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(661698),g=a.i(449597),h=a.i(126695),i=a.i(662338),j=a.i(766050),k=a.i(57693),l=a.i(287907);let m=f.z.object({name:f.z.string().min(1,"Role name is required"),description:f.z.string().optional(),permissionIds:f.z.array(f.z.number()).optional()});async function n(){let a=await (0,d.getServerSession)(e.authOptions);if(!a)throw Error("Unauthorized");return await (0,k.requirePermission)(parseInt(a.user.id),j.PERMISSIONS.ROLE.READ),await c.prisma.role.findMany({include:{_count:{select:{permissions:!0,userRoles:!0}},permissions:{include:{permission:!0}}},orderBy:{name:"asc"}})}async function o(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)throw Error("Unauthorized");return await (0,k.requirePermission)(parseInt(b.user.id),j.PERMISSIONS.ROLE.READ),await c.prisma.role.findUnique({where:{id:a},include:{permissions:{include:{permission:!0}},userRoles:{include:{user:{select:{id:!0,username:!0,email:!0}}}}}})}async function p(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};try{await (0,k.requirePermission)(parseInt(b.user.id),j.PERMISSIONS.ROLE.CREATE)}catch(a){return{error:"Permission denied"}}let f=a.get("name"),i=a.get("description"),l=a.get("permissionIds"),n=[];if(l)try{n=JSON.parse(l)}catch{}let o=m.safeParse({name:f,description:i,permissionIds:n});if(!o.success)return{error:"Validation failed"};try{let a=await c.prisma.role.create({data:{name:o.data.name,description:o.data.description||null,permissions:o.data.permissionIds&&o.data.permissionIds.length>0?{create:o.data.permissionIds.map(a=>({permissionId:a}))}:void 0},include:{permissions:{include:{permission:!0}}}});return await (0,h.logActivity)({actionType:"role_created",actionCategory:"settings",actionSummary:`Role "${a.name}" created`,actionDetails:{roleId:a.id,roleName:a.name,permissionCount:a.permissions.length},performedById:parseInt(b.user.id),entityType:"role",entityId:a.id}),(0,g.revalidatePath)("/dashboard/admin/roles"),{success:!0,role:a}}catch(a){if("P2002"===a.code)return{error:"Role with this name already exists"};return console.error(a),{error:"Failed to create role"}}}async function q(a,b){let f=await (0,d.getServerSession)(e.authOptions);if(!f)return{error:"Unauthorized"};try{await (0,k.requirePermission)(parseInt(f.user.id),j.PERMISSIONS.ROLE.UPDATE)}catch(a){return{error:"Permission denied"}}let l=await c.prisma.role.findUnique({where:{id:a},select:{isSystemRole:!0,name:!0}});if(l?.isSystemRole&&"System Admin"===l.name)return{error:"Cannot modify System Admin role"};let n=b.get("name"),o=b.get("description"),p=b.get("permissionIds"),q=[];if(p)try{q=JSON.parse(p)}catch{}let r=m.partial().safeParse({name:n,description:o,permissionIds:q});if(!r.success)return{error:"Validation failed"};try{let b=await c.prisma.role.update({where:{id:a},data:{name:r.data.name,description:void 0!==r.data.description?r.data.description:void 0}});if(void 0!==r.data.permissionIds){if(await c.prisma.rolePermission.deleteMany({where:{roleId:a}}),q.length>0)for(let b of q)try{await c.prisma.rolePermission.create({data:{roleId:a,permissionId:b}})}catch(a){if("P2002"!==a.code)throw a}for(let b of(await c.prisma.userRole.findMany({where:{roleId:a},select:{userId:!0,scopeId:!0}})))(0,i.clearPermissionCache)(b.userId,b.scopeId||void 0)}return await (0,h.logActivity)({actionType:"role_updated",actionCategory:"settings",actionSummary:`Role "${b.name}" updated`,actionDetails:{roleId:b.id,roleName:b.name},performedById:parseInt(f.user.id),entityType:"role",entityId:b.id}),(0,g.revalidatePath)("/dashboard/admin/roles"),(0,g.revalidatePath)(`/dashboard/admin/roles/${a}`),{success:!0}}catch(a){if("P2002"===a.code)return{error:"Role with this name already exists"};return console.error(a),{error:"Failed to update role"}}}async function r(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};try{await (0,k.requirePermission)(parseInt(b.user.id),j.PERMISSIONS.ROLE.DELETE)}catch(a){return{error:"Permission denied"}}let f=await c.prisma.role.findUnique({where:{id:a},select:{isSystemRole:!0,name:!0}});if(f?.isSystemRole)return{error:"Cannot delete system role"};let i=await c.prisma.userRole.count({where:{roleId:a}});if(i>0)return{error:`Cannot delete role: ${i} user(s) have this role assigned`};try{return await c.prisma.role.delete({where:{id:a}}),await (0,h.logActivity)({actionType:"role_deleted",actionCategory:"settings",actionSummary:`Role "${f?.name}" deleted`,actionDetails:{roleId:a,roleName:f?.name},performedById:parseInt(b.user.id),entityType:"role",entityId:a}),(0,g.revalidatePath)("/dashboard/admin/roles"),{success:!0}}catch(a){return console.error(a),{error:"Failed to delete role"}}}async function s(){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");let a=await c.prisma.permission.findMany({orderBy:[{module:"asc"},{name:"asc"}]}),b={};for(let c of a)b[c.module]||(b[c.module]=[]),b[c.module].push(c);return{permissions:a,grouped:b}}async function t(a,b,f,l){let m=await (0,d.getServerSession)(e.authOptions);if(!m)return{error:"Unauthorized"};try{await (0,k.requirePermission)(parseInt(m.user.id),j.PERMISSIONS.ROLE.ASSIGN)}catch(a){return{error:"Permission denied"}}try{return await c.prisma.userRole.create({data:{userId:a,roleId:b,scopeType:f||null,scopeId:l||null,assignedBy:parseInt(m.user.id)}}),(0,i.clearPermissionCache)(a,l),await (0,h.logActivity)({actionType:"role_assigned",actionCategory:"settings",actionSummary:"Role assigned to user",actionDetails:{userId:a,roleId:b,scopeType:f,scopeId:l},performedById:parseInt(m.user.id),affectedUserId:a,entityType:"role",entityId:b}),(0,g.revalidatePath)("/dashboard/admin/users"),{success:!0}}catch(a){if("P2002"===a.code)return{error:"User already has this role"};return console.error(a),{error:"Failed to assign role"}}}async function u(a,b,f,l){let m=await (0,d.getServerSession)(e.authOptions);if(!m)return{error:"Unauthorized"};try{await (0,k.requirePermission)(parseInt(m.user.id),j.PERMISSIONS.ROLE.ASSIGN)}catch(a){return{error:"Permission denied"}}try{return await c.prisma.userRole.deleteMany({where:{userId:a,roleId:b,scopeType:f||null,scopeId:l||null}}),(0,i.clearPermissionCache)(a,l),await (0,h.logActivity)({actionType:"role_removed",actionCategory:"settings",actionSummary:"Role removed from user",actionDetails:{userId:a,roleId:b,scopeType:f,scopeId:l},performedById:parseInt(m.user.id),affectedUserId:a,entityType:"role",entityId:b}),(0,g.revalidatePath)("/dashboard/admin/users"),{success:!0}}catch(a){return console.error(a),{error:"Failed to remove role"}}}async function v(){try{console.log("Initializing RBAC system...");let a=(0,j.getAllPermissions)(),b=new Map;for(let d of a){let[a,...e]=d.split("."),f=e.join("."),g=f.replace(/_/g," ").replace(/\b\w/g,a=>a.toUpperCase()),h=e.length>1?e[0]:null,i=await c.prisma.permission.upsert({where:{key:d},update:{},create:{key:d,name:g,description:`Permission to ${f.replace(/_/g," ")}`,module:a,category:h}});b.set(d,i.id)}console.log(`âœ… Created/updated ${b.size} permissions`);let d=await c.prisma.userRole.count();d>0&&(console.log(`ðŸ—‘ï¸  Removing ${d} user role assignment(s)`),await c.prisma.userRole.deleteMany({}),console.log(`âœ… Deleted all user role assignments`));let e=await c.prisma.rolePermission.count();for(let a of(e>0&&(console.log(`ðŸ—‘ï¸  Removing ${e} role permission(s)`),await c.prisma.rolePermission.deleteMany({}),console.log(`âœ… Deleted all role permissions`)),["Super Admin","Project Admin","Audit Admin"]))(await c.prisma.role.deleteMany({where:{name:a}})).count>0&&console.log(`ðŸ—‘ï¸  Deleted old role: ${a}`);let f=await c.prisma.role.count();if(f>0){console.log(`ðŸ—‘ï¸  Deleting ${f} remaining role(s)...`);let a=await c.prisma.role.deleteMany({});console.log(`âœ… Deleted ${a.count} role(s)`);let b=await c.prisma.role.count();if(b>0){console.log(`âš ï¸  Warning: ${b} role(s) still exist after deletion`);let a=await c.prisma.role.findMany({select:{id:!0,name:!0}});console.log(`   Remaining roles: ${a.map(a=>a.name).join(", ")}`)}}else console.log(`â„¹ï¸  No existing roles to delete`);for(let[a,d]of Object.entries(j.DEFAULT_ROLES)){let a,e=await c.prisma.role.findUnique({where:{name:d.name}});e?(a=await c.prisma.role.update({where:{id:e.id},data:{description:d.description,isSystemRole:d.isSystemRole}}),await c.prisma.rolePermission.deleteMany({where:{roleId:a.id}})):a=await c.prisma.role.create({data:{name:d.name,description:d.description,isSystemRole:d.isSystemRole}});let f=d.permissions.map(a=>b.get(a)).filter(a=>void 0!==a);if(await c.prisma.rolePermission.deleteMany({where:{roleId:a.id}}),f.length>0)for(let b of f)try{await c.prisma.rolePermission.create({data:{roleId:a.id,permissionId:b}})}catch(a){if("P2002"!==a.code)throw a}console.log(`âœ… Created/updated role: ${a.name} with ${f.length} permissions`)}return console.log("âœ… RBAC initialization completed!"),{success:!0}}catch(a){return console.error("âŒ RBAC initialization failed:",a),{error:a.message}}}(0,l.ensureServerEntryExports)([n,o,p,q,r,s,t,u,v]),(0,b.registerServerReference)(n,"00315332eefe7e5ae034444c5aa3d0b43abd813c65",null),(0,b.registerServerReference)(o,"4077386d824b9d6d8daac5a6f8bf4124f35c6f5f09",null),(0,b.registerServerReference)(p,"4040b6468aa9508d1d4802a99825a53e6c660decfe",null),(0,b.registerServerReference)(q,"605a370aec7719011993943417a0dd46a68cd1b815",null),(0,b.registerServerReference)(r,"40c034babb4ca926f97b6b4d48e79b952d57077416",null),(0,b.registerServerReference)(s,"004c2554a1592062d1a2d5dabdc6ce8941b8bf3a44",null),(0,b.registerServerReference)(t,"787a1fbc130c3c6d92e3009448f9235df28bea0dee",null),(0,b.registerServerReference)(u,"782b125d292e676b0aeedfa8f470593862cedc359d",null),(0,b.registerServerReference)(v,"00a7551eb825197a762c03325de2ebb2525343d67a",null),a.s(["assignRoleToUser",()=>t,"createRole",()=>p,"deleteRole",()=>r,"getPermissions",()=>s,"getRole",()=>o,"getRoles",()=>n,"initializeRBAC",()=>v,"removeRoleFromUser",()=>u,"updateRole",()=>q])},924868,(a,b,c)=>{b.exports=a.x("fs/promises",()=>require("fs/promises"))},942722,a=>{"use strict";let b={"image/jpeg":{ext:"jpg",maxSize:5242880},"image/png":{ext:"png",maxSize:5242880},"image/webp":{ext:"webp",maxSize:5242880},"image/gif":{ext:"gif",maxSize:5242880},"image/svg+xml":{ext:"svg",maxSize:2097152},"application/pdf":{ext:"pdf",maxSize:0xa00000},"application/msword":{ext:"doc",maxSize:0xa00000},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{ext:"docx",maxSize:0xa00000},"application/vnd.ms-excel":{ext:"xls",maxSize:0xa00000},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":{ext:"xlsx",maxSize:0xa00000},"text/plain":{ext:"txt",maxSize:5242880},"text/csv":{ext:"csv",maxSize:5242880}},c=["exe","bat","cmd","com","scr","vbs","js","jar","zip","rar","7z","dll","msi","app","deb","rpm","dmg","pkg","run","sh","bash","zsh","ps1","psc1","msh","msh1","mshxml","msh1xml","pssc","psc2","msh2","msh2xml","psc3","msh3","msh3xml","aspx","asp","php","php3","php4","php5","jsp","jspx","jspf","jsw","jsv","jspx","wsh","wsf","py","pyc","pyo","rb","rbw","cgi","pl","ada","asm","bas","c","cpp","cxx","cc","h","hpp","cs","java","class","swift","kt","go","rs","ts","tsx","jsx"];function d(a){if(!a)return{valid:!1,error:"No file provided"};if(!a.name||""===a.name.trim())return{valid:!1,error:"File must have a name"};if(!b[a.type]){let c=Object.keys(b).join(", ");return{valid:!1,error:`File type "${a.type||"unknown"}" is not allowed. Supported types: ${c}`}}let d=b[a.type].maxSize;if(0===a.size)return{valid:!1,error:"File is empty"};if(a.size>d){let b=(d/1024/1024).toFixed(2),c=(a.size/1024/1024).toFixed(2);return{valid:!1,error:`File size ${c}MB exceeds maximum ${b}MB for this file type`}}let e=g(a.name).toLowerCase();if(e&&c.includes(e))return{valid:!1,error:`File extension ".${e}" is not allowed for security reasons`};let f=b[a.type].ext;return e&&e!==f&&console.warn(`Warning: File extension ".${e}" may not match MIME type "${a.type}". Expected: ".${f}"`),{valid:!0}}function e(a){return a?a.replace(/\\/g,"").replace(/\//g,"").replace(/\.\./g,"").replace(/[<>:"|?*\x00-\x1f]/g,"").replace(/\s+/g,"_").substring(0,255):"file"}function f(a,b){let c=g(a),d=Date.now(),e=Math.random().toString(36).substring(2,8);return`u${b}_${d}_${e}.${c}`}function g(a){if(!a)return"";let b=a.split(".");return b.length>1?b[b.length-1]:""}async function h(a,b){let c={"image/jpeg":[255,216,255],"image/png":[137,80,78,71],"image/gif":[71,73,70],"image/webp":[82,73,70,70],"application/pdf":[37,80,68,70]}[b];if(!c)return!0;let d=new Uint8Array(a);if(d.length<c.length)return!1;for(let a=0;a<c.length;a++)if(d[a]!==c[a])return!1;return!0}function i(a){let b=["B","KB","MB","GB"],c=a,d=0;for(;c>=1024&&d<b.length-1;)c/=1024,d++;return`${c.toFixed(2)} ${b[d]}`}a.s(["generateSafeFilename",()=>f,"getReadableFileSize",()=>i,"sanitizeFilename",()=>e,"validateFileContent",()=>h,"validateFileUpload",()=>d])},225552,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(449597),g=a.i(57693);async function h(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{authorized:!1,session:null,hasAdminPermission:!1};let c=parseInt(b.user.id),f=await (0,g.hasPermissionWithoutRoleBypass)(c,"admin.access"),h=c===a;return{authorized:h||f,session:b,hasAdminPermission:f,isSelf:h}}async function i(a){let{authorized:b,session:d}=await h(a);if(!b||!d)return{error:"Unauthorized: You can only view your own settings"};try{if(!c.prisma.userSetting)return{success:!0,settings:{}};let b=await c.prisma.userSetting.findMany({where:{userId:a},orderBy:[{category:"asc"},{key:"asc"}],include:{updater:{select:{id:!0,username:!0,email:!0}}}}),d={};return b.forEach(a=>{d[a.category]||(d[a.category]=[]),d[a.category].push({id:a.id,key:a.key,value:s(a.value),category:a.category,updatedAt:a.updatedAt,updatedBy:a.updater})}),{success:!0,settings:d}}catch(a){return console.error("getUserSettings Error:",a),{error:"Failed to fetch user settings",details:a.message}}}async function j(a,b){if(!await (0,d.getServerSession)(e.authOptions))return{error:"Unauthorized"};try{if(!c.prisma.userSetting){let a={};for(let b of["preferences","taskView","todayTasks","notifications","workflow"])a[b]={value:k(b),source:"system",enabled:!1};return{success:!0,settings:a}}let d=await c.prisma.userSetting.findMany({where:{userId:a}}),e=[];b&&(e=await c.prisma.projectSetting.findMany({where:{projectId:b,enabled:!0}}));let f=await c.prisma.systemSetting.findMany(),g={},h=["preferences","notifications","workflow"];for(let a of["preferences","taskView","todayTasks","notifications","workflow"]){let b=d.find(b=>b.category===a&&b.key===a),c=e.find(b=>b.category===a&&b.key===a),i=f.find(b=>b.category===a&&b.key===a);b&&h.includes(a)?g[a]={value:s(b.value),source:"user",enabled:!0}:c&&c.enabled?g[a]={value:s(c.value),source:"project",enabled:!0}:b?g[a]={value:s(b.value),source:"user",enabled:!0}:i?g[a]={value:s(i.value),source:"global",enabled:!1}:g[a]={value:k(a),source:"system",enabled:!1}}return{success:!0,settings:g}}catch(a){return console.error("getResolvedUserSettings Error:",a),{error:"Failed to fetch resolved settings",details:a.message}}}function k(a){return({preferences:{timezone:"Africa/Cairo",workingHours:{start:"09:00",end:"17:00"}},taskView:{defaultView:"list",defaultSort:{field:"priority",order:"desc"},showCompleted:!0,showBlocked:!0,defaultProjectFilter:null},todayTasks:{autoOpenOnLogin:!1,defaultView:"compact",highlightBlocked:!0,showDependencyDetails:!1},notifications:{channels:{inApp:!0,email:!0},grouping:"realtime",priorityFilter:["low","normal","high","urgent"],soundEnabled:!0},workflow:{defaultLandingPage:"dashboard",defaultProjectContext:null,standupSummaryDisplay:{enabled:!1,format:"compact"}}})[a]||null}async function l(a,b){let{authorized:d,session:e}=await h(a);if(!d||!e)return{error:"Unauthorized"};try{if(!c.prisma.userSetting)return{error:"User settings not available. Please restart the development server."};let d=await c.prisma.userSetting.findUnique({where:{userId_key:{userId:a,key:b}},include:{updater:{select:{id:!0,username:!0,email:!0}}}});if(!d)return{error:"Setting not found"};return{success:!0,setting:{id:d.id,key:d.key,value:s(d.value),category:d.category,updatedAt:d.updatedAt,updatedBy:d.updater}}}catch(a){return console.error("getUserSetting Error:",a),{error:"Failed to fetch setting",details:a.message}}}async function m(a,b,d,e){let{authorized:g,session:i,hasAdminPermission:j}=await h(a);if(!g||!i)return{error:"Unauthorized"};try{if(!c.prisma.userSetting||!c.prisma.userSettingsChangeLog)return{error:"User settings not available. Please restart the development server."};let g=q(b);if(!r(g,d))return{error:`Invalid value for setting ${b}`};let h=await c.prisma.userSetting.findUnique({where:{userId_key:{userId:a,key:b}}}),j=h?.value||null,k=JSON.stringify(d),l=await c.prisma.userSetting.upsert({where:{userId_key:{userId:a,key:b}},create:{userId:a,key:b,category:g,value:k,updatedBy:parseInt(i.user.id)},update:{value:k,updatedBy:parseInt(i.user.id)}});return await c.prisma.userSettingsChangeLog.create({data:{userId:a,settingKey:b,category:g,oldValue:j,newValue:k,reason:e||null,changedBy:parseInt(i.user.id),settingId:l.id}}),(0,f.revalidatePath)("/dashboard/settings"),(0,f.revalidatePath)("/dashboard"),{success:!0}}catch(a){return console.error("updateUserSetting Error:",a),{error:"Failed to update setting",details:a.message}}}async function n(a,b,d,e,g){let{authorized:i,session:j}=await h(a);if(!i||!j)return{error:"Unauthorized"};try{if(!c.prisma.userSetting)return{error:"User settings not available. Please restart the development server."};if(!r(d,e))return{error:`Invalid value for setting ${b}`};let g=await c.prisma.userSetting.create({data:{userId:a,key:b,category:d,value:JSON.stringify(e),updatedBy:parseInt(j.user.id)}});return(0,f.revalidatePath)("/dashboard/settings"),{success:!0,setting:g}}catch(a){return console.error("createUserSetting Error:",a),{error:"Failed to create setting",details:a.message}}}async function o(a,b){let{authorized:d,session:e}=await h(a);if(!d||!e)return{error:"Unauthorized"};try{if(!c.prisma.userSetting)return{error:"User settings not available. Please restart the development server."};let d=q(b);if(!k(d))return{error:"No default value found for this setting"};return await c.prisma.userSetting.delete({where:{userId_key:{userId:a,key:b}}}),(0,f.revalidatePath)("/dashboard/settings"),{success:!0}}catch(a){return console.error("resetUserSetting Error:",a),{error:"Failed to reset setting",details:a.message}}}async function p(a,b,d=50,e=0){let{authorized:f,session:g}=await h(a);if(!f||!g)return{error:"Unauthorized"};try{if(!c.prisma.userSettingsChangeLog)return{error:"User settings not available. Please restart the development server."};let f={userId:a};b&&(f.settingKey=b);let g=await c.prisma.userSettingsChangeLog.findMany({where:f,orderBy:{createdAt:"desc"},take:d,skip:e,include:{changer:{select:{id:!0,username:!0,email:!0}}}});return{success:!0,logs:g}}catch(a){return console.error("getUserSettingsChangeLog Error:",a),{error:"Failed to fetch change log",details:a.message}}}function q(a){return a.startsWith("preferences")?"preferences":a.startsWith("taskView")?"taskView":a.startsWith("todayTasks")?"todayTasks":a.startsWith("notifications")?"notifications":a.startsWith("workflow")?"workflow":a}function r(a,b){try{switch(a){case"preferences":if(b.timezone&&"string"!=typeof b.timezone||b.workingHours&&(!b.workingHours.start||!b.workingHours.end))return!1;return!0;case"taskView":if(b.defaultView&&!["list","kanban"].includes(b.defaultView)||b.defaultSort&&(!["priority","dueDate","createdAt","title"].includes(b.defaultSort.field)||!["asc","desc"].includes(b.defaultSort.order)))return!1;return!0;case"todayTasks":if(b.defaultView&&!["compact","detailed"].includes(b.defaultView))return!1;return!0;case"notifications":if(b.channels&&("boolean"!=typeof b.channels.inApp||"boolean"!=typeof b.channels.email)||b.grouping&&!["realtime","dailyDigest"].includes(b.grouping))return!1;return!0;case"workflow":if(b.defaultLandingPage&&!["dashboard","todayFocus","projects","tasks"].includes(b.defaultLandingPage))return!1;return!0;default:return!0}}catch{return!1}}function s(a){try{return JSON.parse(a)}catch{return a}}(0,a.i(287907).ensureServerEntryExports)([i,j,l,m,n,o,p]),(0,b.registerServerReference)(i,"403d2efc75bc6ba729c53866f2f453379a75cef5f5",null),(0,b.registerServerReference)(j,"60bbed07d8565ed1d735f9dfd76ca01fde097d7047",null),(0,b.registerServerReference)(l,"60855b7a48d2833280b6045fa247e66b6c48cfc569",null),(0,b.registerServerReference)(m,"7834670bad8c75d0bafc47394918473dedf1ef1d03",null),(0,b.registerServerReference)(n,"7c2fc784d7c1019a5977faad96a4218f308a67fc6e",null),(0,b.registerServerReference)(o,"6076a771c1b69db27eefc144c7f346084707e44c83",null),(0,b.registerServerReference)(p,"781b1c17ffbb4bbf724987c61e63a9e81654538327",null),a.s(["createUserSetting",()=>n,"getResolvedUserSettings",()=>j,"getUserSetting",()=>l,"getUserSettings",()=>i,"getUserSettingsChangeLog",()=>p,"resetUserSetting",()=>o,"updateUserSetting",()=>m])},536418,a=>{"use strict";var b=a.i(962460),c=a.i(153544),d=a.i(866236),e=a.i(225552),f=a.i(184251),g=a.i(924868),h=a.i(814747),i=a.i(450246),j=a.i(915929),k=a.i(942722);async function l(a){let b=await (0,i.getServerSession)(j.authOptions);if(!b||"admin"!==b.user.role)return{error:"Unauthorized - Admin access required",code:"UNAUTHORIZED"};let c=a.get("file");if(!c)return{error:"No file provided",code:"MISSING_FILE"};try{let a=(0,k.validateFileUpload)(c);if(!a.valid)return{error:a.error||"Invalid file",code:"INVALID_FILE"};let d=await c.arrayBuffer();if(!await (0,k.validateFileContent)(d,c.type))return{error:"File content does not match declared type. Possible spoofing attempt.",code:"CONTENT_MISMATCH"};let e=(0,h.join)(process.cwd(),"public","uploads","branding");await (0,g.mkdir)(e,{recursive:!0});let f=(0,k.generateSafeFilename)(c.name,parseInt(b.user.id)),i=(0,h.join)(e,f),j=Buffer.from(d);return await (0,g.writeFile)(i,j),console.log(`[Logo Upload] Admin ${b.user.name||b.user.email} uploaded logo: ${f}`),{success:!0,url:`/uploads/branding/${f}`,fileName:(0,k.sanitizeFilename)(c.name),fileSize:(0,k.getReadableFileSize)(c.size),code:"UPLOAD_SUCCESS"}}catch(a){return console.error("Logo upload error:",a),{error:"Failed to upload logo",code:"UPLOAD_FAILED",details:a.message}}}(0,a.i(287907).ensureServerEntryExports)([l]),(0,f.registerServerReference)(l,"40dcf4e685022ac015152cc50e6096832ab9a723be",null);var m=a.i(126695);a.s([],425920),a.i(425920),a.s(["00315332eefe7e5ae034444c5aa3d0b43abd813c65",()=>d.getRoles,"0033db22356cbf8845a3517099b63dfc38d1147299",()=>b.getPublicSystemSettings,"004c2554a1592062d1a2d5dabdc6ce8941b8bf3a44",()=>d.getPermissions,"00686a7231b739e4fe9b8305b757bc0e83827b9865",()=>c.getAllProjectsUnreadNotificationCount,"00a7551eb825197a762c03325de2ebb2525343d67a",()=>d.initializeRBAC,"4004a0aae390e2c1aeb900c79065f312ac43d90f8d",()=>c.getAllProjectsNotifications,"4014896b5d2affbb03c83dbddeb66e1724203ab137",()=>b.updateProfile,"4030a94bd5b3ca5815ae2cd1d1725e523f9f88fa17",()=>b.changePassword,"403d2efc75bc6ba729c53866f2f453379a75cef5f5",()=>e.getUserSettings,"4040b6468aa9508d1d4802a99825a53e6c660decfe",()=>d.createRole,"4077386d824b9d6d8daac5a6f8bf4124f35c6f5f09",()=>d.getRole,"40c034babb4ca926f97b6b4d48e79b952d57077416",()=>d.deleteRole,"40daa1d9c7314de4957a7669434db12aaa24630ba4",()=>m.logActivity,"40dcf4e685022ac015152cc50e6096832ab9a723be",()=>l,"605a370aec7719011993943417a0dd46a68cd1b815",()=>d.updateRole,"60691655a7ad6aec29ab9691d8571a0d380be93da1",()=>c.markProjectNotificationAsRead,"6076a771c1b69db27eefc144c7f346084707e44c83",()=>e.resetUserSetting,"60855b7a48d2833280b6045fa247e66b6c48cfc569",()=>e.getUserSetting,"60bbed07d8565ed1d735f9dfd76ca01fde097d7047",()=>e.getResolvedUserSettings,"781b1c17ffbb4bbf724987c61e63a9e81654538327",()=>e.getUserSettingsChangeLog,"782b125d292e676b0aeedfa8f470593862cedc359d",()=>d.removeRoleFromUser,"7834670bad8c75d0bafc47394918473dedf1ef1d03",()=>e.updateUserSetting,"7856a9cd98bf3a731a97f71b1b70c5ad4d859adbb2",()=>b.updateSetting,"787a1fbc130c3c6d92e3009448f9235df28bea0dee",()=>d.assignRoleToUser,"7c2fc784d7c1019a5977faad96a4218f308a67fc6e",()=>e.createUserSetting],536418)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__5848c571._.js.map