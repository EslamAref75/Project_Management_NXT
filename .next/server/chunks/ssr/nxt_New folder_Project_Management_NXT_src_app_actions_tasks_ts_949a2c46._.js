module.exports=[6588,723212,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(661698),g=a.i(449597),h=a.i(153544),i=a.i(126695),j=a.i(57693),k=a.i(766050),l=a.i(287907);let m=f.z.object({taskId:f.z.coerce.number(),dependsOnTaskId:f.z.coerce.number(),dependencyType:f.z.enum(["finish_to_start"]).default("finish_to_start")});async function n(a,b){if(a===b||await c.prisma.taskDependency.findUnique({where:{taskId_dependsOnTaskId:{taskId:b,dependsOnTaskId:a}}}))return!0;let d=new Set,e=[b];for(;e.length>0;){let b=e.pop();if(b===a)return!0;if(!d.has(b))for(let a of(d.add(b),await c.prisma.taskDependency.findMany({where:{taskId:b},select:{dependsOnTaskId:!0}})))d.has(a.dependsOnTaskId)||e.push(a.dependsOnTaskId)}return!1}async function o(a){let b=await c.prisma.taskDependency.findMany({where:{taskId:a},include:{dependsOnTask:{select:{status:!0}}}});return 0===b.length||b.every(a=>"completed"===a.dependsOnTask.status)}async function p(a){let b=await c.prisma.task.findUnique({where:{id:a},include:{dependencies:{include:{dependsOnTask:{select:{status:!0,id:!0,title:!0}}}},project:{select:{id:!0}}}});if(!b)return;let d=await o(a),e=b.dependencies.length>0;if(console.log(`Checking blocking status for task ${a}:`,{hasDependencies:e,allCompleted:d,currentStatus:b.status}),e&&!d){if("waiting"!==b.status&&"completed"!==b.status){let d=await c.prisma.task.update({where:{id:a},data:{status:"waiting"},include:{assignees:!0}});for(let c of(console.log("Updated task to WAITING:",d.id),d.assignees))await (0,h.createProjectNotification)(b.project.id,c.id,{type:"dependency",entityType:"task",entityId:a,title:"Task Blocked",message:`Task "${b.title}" is now blocked by incomplete dependencies`,soundRequired:!0})}}else if(e&&d&&"waiting"===b.status){let d=await c.prisma.task.update({where:{id:a},data:{status:"pending"},include:{assignees:!0}});for(let c of(console.log("Updated task to PENDING (unblocked):",d.id),d.assignees))await (0,h.createProjectNotification)(b.project.id,c.id,{type:"dependency",entityType:"task",entityId:a,title:"Task Unblocked",message:`Task "${b.title}" is no longer blocked. All prerequisites are completed.`,soundRequired:!0})}}async function q(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};let f=a.get("taskId"),j=a.get("dependsOnTaskId"),k=a.get("dependencyType")||"finish_to_start",l=m.safeParse({taskId:f,dependsOnTaskId:j,dependencyType:k});if(!l.success)return{error:"Validation failed",details:l.error.format()};try{let[a,d]=await Promise.all([c.prisma.task.findUnique({where:{id:l.data.taskId},select:{projectId:!0,id:!0,title:!0}}),c.prisma.task.findUnique({where:{id:l.data.dependsOnTaskId},select:{projectId:!0,id:!0,title:!0,assignees:!0}})]);if(!a||!d)return{error:"One or both tasks not found"};if(a.projectId!==d.projectId)return{error:"Tasks must belong to the same project"};if(l.data.taskId===l.data.dependsOnTaskId)return{error:"A task cannot depend on itself."};if(await n(l.data.taskId,l.data.dependsOnTaskId))return{error:"Circular dependency detected. Cannot create this dependency."};if(await c.prisma.taskDependency.findUnique({where:{taskId_dependsOnTaskId:{taskId:l.data.taskId,dependsOnTaskId:l.data.dependsOnTaskId}}}))return(0,g.revalidatePath)(`/dashboard/projects/${a.projectId}`),(0,g.revalidatePath)(`/dashboard/projects/${a.projectId}/tasks/${l.data.taskId}`),{error:"Dependency already exists",success:!0};let e=await c.prisma.taskDependency.create({data:{taskId:l.data.taskId,dependsOnTaskId:l.data.dependsOnTaskId,dependencyType:l.data.dependencyType,createdById:parseInt(b.user.id)},include:{dependsOnTask:{select:{id:!0,title:!0,status:!0}}}});console.log("✅ Dependency created successfully:",{taskId:e.taskId,dependsOnTaskId:e.dependsOnTaskId,dependsOnTaskTitle:e.dependsOnTask.title}),await p(l.data.taskId);let f=await c.prisma.task.findUnique({where:{id:l.data.taskId},include:{assignees:!0}});for(let b of d.assignees)await (0,h.createProjectNotification)(a.projectId,b.id,{type:"dependency",entityType:"task",entityId:d.id,title:"Task Dependency Added",message:`Task "${a.title}" now depends on your task "${d.title}"`,soundRequired:!1});if(f){for(let b of f.assignees)await (0,h.createProjectNotification)(a.projectId,b.id,{type:"dependency",entityType:"task",entityId:l.data.taskId,title:"Task Blocked by Dependency",message:`Your task "${a.title}" is now waiting for "${d.title}" to be completed`,soundRequired:!0});await (0,i.logActivity)({actionType:"task_blocked",actionCategory:"dependency",actionSummary:`Task "${a.title}" blocked by dependency`,actionDetails:{taskId:a.id,taskTitle:a.title,dependsOnTaskId:d.id,dependsOnTaskTitle:d.title},performedById:parseInt(b.user.id),affectedUserId:f.assignees.map(a=>a.id)[0]||void 0,projectId:a.projectId,entityType:"task",entityId:l.data.taskId})}await (0,i.logActivity)({actionType:"dependency_added",actionCategory:"dependency",actionSummary:`Dependency added: Task "${a.title}" depends on "${d.title}"`,actionDetails:{taskId:a.id,taskTitle:a.title,dependsOnTaskId:d.id,dependsOnTaskTitle:d.title},performedById:parseInt(b.user.id),projectId:a.projectId,entityType:"task_dependency",entityId:l.data.taskId});let j=await c.prisma.taskDependency.findUnique({where:{taskId_dependsOnTaskId:{taskId:l.data.taskId,dependsOnTaskId:l.data.dependsOnTaskId}},include:{dependsOnTask:{select:{id:!0,title:!0}}}});if(!j)return console.error("❌ Dependency creation verification failed!"),{error:"Dependency was not created successfully"};return console.log("✅ Dependency verified:",{taskId:j.taskId,dependsOnTaskId:j.dependsOnTaskId,dependsOnTaskTitle:j.dependsOnTask.title}),(0,g.revalidatePath)(`/dashboard/projects/${a.projectId}`),(0,g.revalidatePath)(`/dashboard/projects/${a.projectId}/tasks/${l.data.taskId}`),{success:!0}}catch(a){return console.error("Dependency Creation Error:",a),{error:"Failed to create dependency",details:a.message}}}async function r(a,b){let f=await (0,d.getServerSession)(e.authOptions);if(!f)return{error:"Unauthorized"};let h=Number(a),j=Number(b);console.log(`Attempting to remove dependency: Task ${h} depends on ${j}`);try{let a=await c.prisma.taskDependency.findUnique({where:{taskId_dependsOnTaskId:{taskId:h,dependsOnTaskId:j}},include:{task:{select:{projectId:!0,id:!0,title:!0}},dependsOnTask:{select:{id:!0,title:!0}}}});if(!a)return console.error(`Dependency not found: Task ${h} -> ${j}`),{error:"Dependency not found"};return await c.prisma.taskDependency.delete({where:{taskId_dependsOnTaskId:{taskId:h,dependsOnTaskId:j}}}),console.log(`Successfully removed dependency: Task ${h} -> ${j}`),await p(h),await (0,i.logActivity)({actionType:"dependency_removed",actionCategory:"dependency",actionSummary:`Dependency removed: Task "${a.task.title}" no longer depends on "${a.dependsOnTask.title}"`,actionDetails:{taskId:a.task.id,taskTitle:a.task.title,dependsOnTaskId:a.dependsOnTask.id,dependsOnTaskTitle:a.dependsOnTask.title},performedById:parseInt(f.user.id),projectId:a.task.projectId,entityType:"task_dependency",entityId:h}),(0,g.revalidatePath)(`/dashboard/projects/${a.task.projectId}`),(0,g.revalidatePath)(`/dashboard/projects/${a.task.projectId}/tasks/${h}`),{success:!0}}catch(a){return console.error("Dependency Removal Error:",a),{error:"Failed to remove dependency",details:a.message}}}async function s(a){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");return await c.prisma.taskDependency.findMany({where:{taskId:a},include:{dependsOnTask:{select:{id:!0,title:!0,status:!0,assignees:{select:{id:!0,username:!0,avatarUrl:!0,team:{select:{id:!0,name:!0}}}},team:{select:{id:!0,name:!0}}}}},orderBy:{createdAt:"desc"}})}async function t(a){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");return await c.prisma.taskDependency.findMany({where:{dependsOnTaskId:a},include:{task:{select:{id:!0,title:!0,status:!0,assignees:{select:{id:!0,username:!0,avatarUrl:!0,team:{select:{id:!0,name:!0}}}},team:{select:{id:!0,name:!0}}}}},orderBy:{createdAt:"desc"}})}async function u(a){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");let b=await c.prisma.task.findUnique({where:{id:a},select:{projectId:!0}});if(!b)throw Error("Task not found");let f=await c.prisma.task.findMany({where:{projectId:b.projectId,id:{not:a}},select:{id:!0,title:!0,status:!0,assignees:{select:{id:!0,username:!0,avatarUrl:!0,team:{select:{id:!0,name:!0}}}},team:{select:{id:!0,name:!0}}},orderBy:{createdAt:"desc"}});return console.log(`Found ${f.length} tasks in project ${b.projectId} for task ${a}`),f}async function v(a){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");let b=await o(a);return await c.prisma.taskDependency.count({where:{taskId:a}})>0&&!b}(0,l.ensureServerEntryExports)([q,r,s,t,u,v]),(0,b.registerServerReference)(q,"40b408831ea3954e375d99f8ba4ff27359527e7e4b",null),(0,b.registerServerReference)(r,"604f3a4a12d21d9ff500f2582d8b0d2c84fbc7c29b",null),(0,b.registerServerReference)(s,"401205bebba1cf3dc7d8ff35126dbeee53f67d0ee7",null),(0,b.registerServerReference)(t,"4009825537fe252354e189caeeedab8c017606c70b",null),(0,b.registerServerReference)(u,"40dd61ff2058f534f42f49da426a52f160b4b04ec1",null),(0,b.registerServerReference)(v,"402619b555ef898d642e1eaa38261c5090360b7909",null),a.s(["createTaskDependency",()=>q,"getAvailableDependencyTasks",()=>u,"getTaskDependencies",()=>s,"getTaskDependents",()=>t,"isTaskBlocked",()=>v,"removeTaskDependency",()=>r],723212);let w=f.z.object({title:f.z.string().min(1,"Title is required"),description:f.z.string().optional(),priority:f.z.string().default("normal"),projectId:f.z.coerce.number(),assigneeIds:f.z.string().optional().transform((a,b)=>{if(!a||""===a||"[]"===a)return[];try{let b=JSON.parse(a);return Array.isArray(b)?b:[]}catch(a){return[]}}),dueDate:f.z.string().optional()});async function x(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};let{search:f="",projectId:g=[],status:h=[],priority:i=[],assigneeId:j,dependencyState:k,startDate:l,endDate:m,dateFilterType:n="dueDate",page:o=1,limit:p=20}=a;try{let a={},d=[];f&&d.push({title:{contains:f}},{project:{name:{contains:f}}},{assignees:{some:{username:{contains:f}}}}),g.length>0&&(a.projectId={in:g.map(a=>parseInt(a))});let e=[];if(h.length>0){let a=[],b=[];h.forEach(c=>{let d=parseInt(c);isNaN(d)?b.push(c):a.push(d)}),a.length>0&&e.push({taskStatusId:{in:a}}),b.length>0&&e.push({status:{in:b},taskStatusId:null})}if(d.length>0&&e.length>0?a.AND=[{OR:d},{OR:e}]:d.length>0?a.OR=d:e.length>0&&(a.OR=e),i.length>0&&(a.priority={in:i}),j&&("me"===j?a.assignees={some:{id:parseInt(b.user.id)}}:a.assignees={some:{id:parseInt(j)}}),l||m){let b="createdDate"===n?"createdAt":"dueDate",c=[];l&&c.push({[b]:{gte:new Date(l)}}),m&&c.push({[b]:{lte:new Date(m)}}),c.length>0&&(a.AND=[...a.AND||[],...c])}if(k&&"all"!==k&&("blocked"===k?a.OR=[...a.OR||[],{status:"waiting"},{dependencies:{some:{dependsOnTask:{status:{not:"completed"}}}}}]:"free"===k?(a.dependencies={none:{}},a.status={not:"waiting"}):"blocking"===k&&(a.dependents={some:{}})),"admin"!==b.user.role){let c=[{assignees:{some:{id:parseInt(b.user.id)}}},{createdById:parseInt(b.user.id)}];a.OR?(a.AND=[...a.AND||[],{OR:[...a.OR,...c]}],delete a.OR):a.OR=c}let[q,r]=await Promise.all([c.prisma.task.findMany({where:a,skip:(o-1)*p,take:p,orderBy:{createdAt:"desc"},select:{id:!0,title:!0,description:!0,priority:!0,status:!0,dueDate:!0,projectId:!0,createdAt:!0,createdById:!0,assignees:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}},project:{select:{id:!0,name:!0}},_count:{select:{dependencies:!0,dependents:!0}}}}),c.prisma.task.count({where:a})]);return{success:!0,tasks:q,total:r,page:o,limit:p}}catch(a){return console.error("Error fetching tasks with filters:",a),{error:a.message||"Failed to fetch tasks"}}}async function y(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};let f=a.get("projectId"),l=f?parseInt(f):void 0;if(!await (0,j.hasPermissionWithoutRoleBypass)(parseInt(b.user.id),k.PERMISSIONS.TASK.CREATE,l))return{error:"Permission denied: You don't have permission to create tasks"};let m=a.get("title"),n=a.get("description"),o=a.get("priority"),p=a.get("assigneeIds"),q=a.get("dueDate"),r=w.safeParse({title:m,description:n,priority:o,projectId:f,assigneeIds:p,dueDate:q});if(!r.success)return console.error("Validation errors:",r.error.format()),{error:"Validation failed"};try{let a=r.data.assigneeIds&&r.data.assigneeIds.length>0?r.data.assigneeIds:[],d=await c.prisma.task.create({data:{title:r.data.title,description:r.data.description,priority:r.data.priority,projectId:r.data.projectId,createdById:parseInt(b.user.id),dueDate:r.data.dueDate?new Date(r.data.dueDate):null,...a.length>0&&{assignees:{connect:a.map(a=>({id:a}))}}},include:{assignees:!0,project:!0}});if(a.length>0)for(let b of a)await (0,h.createProjectNotification)(r.data.projectId,b,{type:"task",entityType:"task",entityId:d.id,title:"Task Assigned",message:`You have been assigned to task "${d.title}"`,soundRequired:!0});return await (0,i.logActivity)({actionType:"task_created",actionCategory:"task",actionSummary:`Task "${d.title}" created`,actionDetails:{taskId:d.id,taskTitle:d.title,projectId:r.data.projectId},performedById:parseInt(b.user.id),projectId:r.data.projectId,entityType:"task",entityId:d.id}),(0,g.revalidatePath)(`/dashboard/projects/${r.data.projectId}`),(0,g.revalidatePath)("/dashboard/tasks"),{success:!0}}catch(a){return console.error(a),{error:"Failed to create task",details:a.message}}}async function z(a){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");return await c.prisma.task.findUnique({where:{id:a},select:{id:!0,title:!0,description:!0,priority:!0,status:!0,dueDate:!0,projectId:!0,createdAt:!0,createdById:!0,startedAt:!0,completedAt:!0,taskStatusId:!0,teamId:!0,assignees:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}},project:{select:{id:!0,name:!0}},taskStatus:{select:{id:!0,name:!0,color:!0}},team:{select:{id:!0,name:!0}},creator:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}},attachments:{select:{id:!0,fileName:!0,fileUrl:!0,fileSize:!0,uploadedAt:!0}},comments:{select:{id:!0,content:!0,createdAt:!0,author:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}}},orderBy:{createdAt:"desc"}},subtasks:{select:{id:!0,title:!0,status:!0,createdAt:!0,assignedTo:{select:{id:!0,username:!0,avatarUrl:!0}}},orderBy:{createdAt:"asc"}},dependencies:{select:{dependsOnTaskId:!0,dependsOnTask:{select:{id:!0,title:!0,status:!0,assignees:{select:{id:!0,username:!0,avatarUrl:!0}}}}},orderBy:{createdAt:"desc"}},dependents:{select:{taskId:!0,task:{select:{id:!0,title:!0,status:!0,assignees:{select:{id:!0,username:!0,avatarUrl:!0}}}}}},_count:{select:{subtasks:!0,dependencies:!0,dependents:!0,comments:!0}}}})}async function A(){if(!await (0,d.getServerSession)(e.authOptions))throw Error("Unauthorized");return await c.prisma.task.findMany({select:{id:!0,title:!0,description:!0,priority:!0,status:!0,dueDate:!0,projectId:!0,createdAt:!0,createdById:!0,assignees:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}},project:{select:{id:!0,name:!0,status:!0}},_count:{select:{subtasks:!0,dependencies:!0}}},orderBy:{dueDate:"asc"}})}async function B(){let a=await (0,d.getServerSession)(e.authOptions);if(!a)throw Error("Unauthorized");let b=parseInt(a.user.id);return await c.prisma.task.findMany({where:{assignees:{some:{id:b}}},select:{id:!0,title:!0,description:!0,priority:!0,status:!0,dueDate:!0,projectId:!0,createdAt:!0,assignees:{select:{id:!0,username:!0,email:!0,avatarUrl:!0}},project:{select:{id:!0,name:!0}},_count:{select:{dependencies:!0}}},orderBy:{dueDate:"asc"}})}let C=f.z.object({title:f.z.string().min(1,"Title is required").optional().or(f.z.literal("")),description:f.z.string().optional().nullable(),priority:f.z.enum(["normal","urgent","high","low"]).optional(),status:f.z.enum(["pending","waiting","in_progress","review","completed"]).optional(),dueDate:f.z.string().optional().or(f.z.literal("")),assigneeIds:f.z.string().transform((a,b)=>{try{let b=JSON.parse(a);return Array.isArray(b)?b:[]}catch(a){return[]}}).optional()});async function D(a,b){let f=await (0,d.getServerSession)(e.authOptions);if(!f)return{error:"Unauthorized"};let l=await c.prisma.task.findUnique({where:{id:a},select:{id:!0,createdById:!0,projectId:!0,assignees:{select:{id:!0}}}});if(!l)return{error:"Task not found"};let m=await (0,j.hasPermissionWithoutRoleBypass)(parseInt(f.user.id),k.PERMISSIONS.TASK.UPDATE,l.projectId),n=l.createdById===parseInt(f.user.id),o=l.assignees.some(a=>a.id===parseInt(f.user.id));if(!m&&!n&&!o)return{error:"Permission denied: You don't have permission to update this task"};let p=b.get("title"),q=b.get("description"),r=b.get("priority"),s=b.get("status"),t=b.get("dueDate"),u=b.get("assigneeIds");if(r&&!await (0,j.hasPermissionWithoutRoleBypass)(parseInt(f.user.id),k.PERMISSIONS.TASK.CHANGE_PRIORITY,l.projectId)&&!n)return{error:"Permission denied: You don't have permission to change task priority"};if(s&&!await (0,j.hasPermissionWithoutRoleBypass)(parseInt(f.user.id),k.PERMISSIONS.TASK.CHANGE_STATUS,l.projectId)&&!n&&!o)return{error:"Permission denied: You don't have permission to change task status"};let v=C.safeParse({title:p||void 0,description:q||void 0,priority:r||void 0,status:s||void 0,dueDate:t||void 0,assigneeIds:u||void 0});if(!v.success)return console.error("Validation errors:",v.error.format()),{error:"Validation failed",details:JSON.stringify(v.error.format(),null,2)};try{let b=await c.prisma.task.findUnique({where:{id:a},select:{id:!0,title:!0,description:!0,priority:!0,status:!0,dueDate:!0,assignees:{select:{id:!0}},project:{select:{id:!0}}}});if(!b)return{error:"Task not found"};let d={};if(void 0!==v.data.title&&""!==v.data.title.trim()&&(d.title=v.data.title.trim()),void 0!==v.data.description&&(d.description=v.data.description||null),void 0!==v.data.priority&&(d.priority=v.data.priority),void 0!==v.data.status&&(d.status=v.data.status),void 0!==v.data.dueDate&&(v.data.dueDate&&""!==v.data.dueDate.trim()?d.dueDate=new Date(v.data.dueDate):d.dueDate=null),void 0!==v.data.assigneeIds){if(!await (0,j.hasPermissionWithoutRoleBypass)(parseInt(f.user.id),k.PERMISSIONS.TASK.ASSIGN,l.projectId)&&!n)return{error:"Permission denied: You don't have permission to assign tasks"};let c=v.data.assigneeIds,e=b.assignees.map(a=>a.id);if(c.length!==e.length||!c.every(a=>e.includes(a))||!e.every(a=>c.includes(a))){d.assignees={set:c.map(a=>({id:a}))};let f=c.filter(a=>!e.includes(a)),g=e.filter(a=>!c.includes(a));for(let c of f)await (0,h.createProjectNotification)(l.projectId,c,{type:"task",entityType:"task",entityId:a,title:"Task Assigned",message:`You have been assigned to task "${b.title||"this task"}"`,soundRequired:!0});for(let c of g)await (0,h.createProjectNotification)(l.projectId,c,{type:"task",entityType:"task",entityId:a,title:"Task Assignment Removed",message:`You have been removed from task "${b.title||"this task"}"`,soundRequired:!1})}}if(0===Object.keys(d).length)return{error:"No changes to update"};let e=await c.prisma.task.update({where:{id:a},data:d,include:{assignees:!0}});return await (0,i.logActivity)({actionType:"task_updated",actionCategory:"task",actionSummary:`Task "${e.title||b.title}" updated`,actionDetails:{taskId:a},performedById:parseInt(f.user.id),projectId:l.projectId,entityType:"task",entityId:a}),(0,g.revalidatePath)(`/dashboard/projects/${l.projectId}`),(0,g.revalidatePath)(`/dashboard/projects/${l.projectId}/tasks/${a}`),(0,g.revalidatePath)("/dashboard/tasks"),{success:!0}}catch(a){return console.error("Task update error:",a),{error:"Failed to update task",details:a.message||"Unknown error occurred. Check console for details."}}}async function E(a,b,f){let l=await (0,d.getServerSession)(e.authOptions);if(!l)return{error:"Unauthorized"};let m=await (0,j.hasPermissionWithoutRoleBypass)(parseInt(l.user.id),k.PERMISSIONS.TASK.CHANGE_STATUS,f);try{let d=await c.prisma.task.findUnique({where:{id:a},select:{id:!0,title:!0,createdById:!0,completedAt:!0,startedAt:!0,taskStatusId:!0,assignees:{select:{id:!0,username:!0}},taskStatus:{select:{id:!0,name:!0,isActive:!0,isFinal:!0,isBlocking:!0}}}});if(!d)return{error:"Task not found"};let e=d.createdById===parseInt(l.user.id),j=d.assignees.some(a=>a.id===parseInt(l.user.id));if(!m&&!e&&!j)return{error:"Permission denied: You don't have permission to change task status"};if(!d)return{error:"Task not found"};let k="number"==typeof b?b:parseInt(b),n=!isNaN(k)&&k>0,o=b,p={};if(n){let b=await c.prisma.taskStatus.findUnique({where:{id:k},select:{name:!0,isActive:!0,isFinal:!0,isBlocking:!0}});if(!b)return{error:"Task status not found"};if(!b.isActive)return{error:"Cannot assign inactive task status"};if(b.isFinal&&await v(a))return{error:"Cannot complete task: This task is blocked by incomplete dependencies."};b.isFinal?(p.completedAt=new Date,p.status="completed"):(d.completedAt&&(p.completedAt=null,p.status="in_progress"),("in_progress"===b.name||b.isBlocking)&&!d.startedAt&&(p.startedAt=new Date)),p.taskStatusId=k,("pending"===b.name||"waiting"===b.name||"in_progress"===b.name||"review"===b.name||"completed"===b.name)&&(o=b.name,p.status=o)}else{if("completed"===o&&await v(a))return{error:"Cannot complete task: This task is blocked by incomplete dependencies."};p={status:o}}for(let e of(await c.prisma.task.update({where:{id:a},data:p}),d.assignees))await (0,h.createProjectNotification)(f,e.id,{type:"task",entityType:"task",entityId:a,title:"Task Status Updated",message:`Task "${d.title}" status changed to ${b}`,soundRequired:"completed"===b||"waiting"===b});return await (0,i.logActivity)({actionType:"task_status_updated",actionCategory:"task",actionSummary:`Task "${d.title}" status updated to ${b}`,actionDetails:{taskId:a,status:b},performedById:parseInt(l.user.id),projectId:f,entityType:"task",entityId:a}),(0,g.revalidatePath)(`/dashboard/projects/${f}`),(0,g.revalidatePath)(`/dashboard/projects/${f}/tasks/${a}`),(0,g.revalidatePath)("/dashboard/tasks"),{success:!0}}catch(a){return console.error(a),{error:"Failed to update task status",details:a.message}}}async function F(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};let f=await c.prisma.task.findUnique({where:{id:a},select:{id:!0,createdById:!0,projectId:!0,title:!0}});if(!f)return{error:"Task not found"};let h=await (0,j.hasPermissionWithoutRoleBypass)(parseInt(b.user.id),k.PERMISSIONS.TASK.DELETE,f.projectId),l=f.createdById===parseInt(b.user.id);if(!h&&!l)return{error:"Permission denied: You don't have permission to delete this task"};try{return await c.prisma.task.delete({where:{id:a}}),await (0,i.logActivity)({actionType:"task_deleted",actionCategory:"task",actionSummary:`Task "${f.title}" deleted`,actionDetails:{taskId:a,taskTitle:f.title},performedById:parseInt(b.user.id),projectId:f.projectId,entityType:"task",entityId:a}),(0,g.revalidatePath)(`/dashboard/projects/${f.projectId}`),(0,g.revalidatePath)("/dashboard/tasks"),{success:!0}}catch(a){return console.error(a),{error:"Failed to delete task",details:a.message}}}(0,l.ensureServerEntryExports)([x,y,z,A,B,D,E,F]),(0,b.registerServerReference)(x,"403db43b4fa87e3c4395d96062ae591067c02e1975",null),(0,b.registerServerReference)(y,"402d88094f0d43ffbbdb2cc55981130389e939c098",null),(0,b.registerServerReference)(z,"408efdebfc4004ac6153e7e7c6e1bfcf2efead0da8",null),(0,b.registerServerReference)(A,"000fbd81a81ae8a8928c77cb3ace462c34a924fe15",null),(0,b.registerServerReference)(B,"00176f3ab9f7a89d717fcba315d11e24c1f7818b0b",null),(0,b.registerServerReference)(D,"6066449d29d31fc61eee331d63571737ef28220e06",null),(0,b.registerServerReference)(E,"709a22b83fb95b514103e9a68c206c65a10f984982",null),(0,b.registerServerReference)(F,"40db1cdcc45db655c6914f09995d8097bcc488bbce",null),a.s(["createTask",()=>y,"deleteTask",()=>F,"getAllTasks",()=>A,"getMyTasks",()=>B,"getTask",()=>z,"getTasksWithFilters",()=>x,"updateTask",()=>D,"updateTaskStatus",()=>E],6588)}];

//# sourceMappingURL=nxt_New%20folder_Project_Management_NXT_src_app_actions_tasks_ts_949a2c46._.js.map