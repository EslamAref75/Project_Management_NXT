module.exports=[792509,(a,b,c)=>{b.exports=a.x("url",()=>require("url"))},921517,(a,b,c)=>{b.exports=a.x("http",()=>require("http"))},254799,(a,b,c)=>{b.exports=a.x("crypto",()=>require("crypto"))},449719,(a,b,c)=>{b.exports=a.x("assert",()=>require("assert"))},145706,(a,b,c)=>{b.exports=a.x("querystring",()=>require("querystring"))},500874,(a,b,c)=>{b.exports=a.x("buffer",()=>require("buffer"))},406461,(a,b,c)=>{b.exports=a.x("zlib",()=>require("zlib"))},524836,(a,b,c)=>{b.exports=a.x("https",()=>require("https"))},427699,(a,b,c)=>{b.exports=a.x("events",()=>require("events"))},504166,a=>{a.v({name:"openid-client",version:"5.7.1",description:"OpenID Connect Relying Party (RP, Client) implementation for Node.js runtime, supports passportjs",keywords:["auth","authentication","basic","certified","client","connect","dynamic","electron","hybrid","identity","implicit","oauth","oauth2","oidc","openid","passport","relying party","strategy"],homepage:"https://github.com/panva/openid-client",repository:"panva/openid-client",funding:{url:"https://github.com/sponsors/panva"},license:"MIT",author:"Filip Skokan <panva.ip@gmail.com>",exports:{types:"./types/index.d.ts",import:"./lib/index.mjs",require:"./lib/index.js"},main:"./lib/index.js",types:"./types/index.d.ts",files:["lib","types/index.d.ts"],scripts:{format:"npx prettier --loglevel silent --write ./lib ./test ./certification ./types",test:"mocha test/**/*.test.js"},dependencies:{jose:"^4.15.9","lru-cache":"^6.0.0","object-hash":"^2.2.0","oidc-token-hash":"^5.0.3"},devDependencies:{"@types/node":"^16.18.106","@types/passport":"^1.0.16",base64url:"^3.0.1",chai:"^4.5.0",mocha:"^10.7.3",nock:"^13.5.5",prettier:"^2.8.8","readable-mock-req":"^0.2.2",sinon:"^9.2.4",timekeeper:"^2.3.1"},"standard-version":{scripts:{postchangelog:"sed -i '' -e 's/### \\[/## [/g' CHANGELOG.md"},types:[{type:"feat",section:"Features"},{type:"fix",section:"Fixes"},{type:"chore",hidden:!0},{type:"docs",hidden:!0},{type:"style",hidden:!0},{type:"refactor",section:"Refactor",hidden:!1},{type:"perf",section:"Performance",hidden:!1},{type:"test",hidden:!0}]}})},57693,662338,a=>{"use strict";var b=a.i(347656);let c=new Map;async function d(a,d){let e=`${a}:${d||"global"}`,f=c.get(e);if(f&&f.expiresAt>Date.now())return f.permissions;let g=await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...d?[{scopeType:"project",scopeId:d}]:[]]},include:{role:{include:{permissions:{include:{permission:!0}}}}}}),h=new Set;for(let a of g)for(let b of a.role.permissions)h.add(b.permission.key);let i=Array.from(h);return c.set(e,{permissions:i,expiresAt:Date.now()+3e5}),i}async function e(a,c){return(await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...c?[{scopeType:"project",scopeId:c}]:[]]},include:{role:!0}})).map(a=>({role:a.role,scopeType:a.scopeType,scopeId:a.scopeId}))}function f(a,b){let d=`${a}:${b||"global"}`;c.delete(d)}a.s(["clearPermissionCache",()=>f,"getUserPermissions",()=>d,"getUserRoles",()=>e],662338);class g extends Error{code;constructor(a,b="UNAUTHORIZED"){super(a),this.code=b,this.name="UnauthorizedError"}}class h extends Error{code;constructor(a,b="FORBIDDEN"){super(a),this.code=b,this.name="ForbiddenError"}}class i extends Error{code;constructor(a,b="NOT_FOUND"){super(a),this.code=b,this.name="NotFoundError"}}async function j(a,b,c){if(!await k(a,b,c))throw new g(`Permission denied: ${b}`,"PERMISSION_DENIED")}async function k(a,c,d){try{for(let e of(await b.prisma.userRole.findMany({where:{userId:a,OR:[{scopeType:null},{scopeType:"global"},...d?[{scopeType:"project",scopeId:d}]:[]]},include:{role:{include:{permissions:{include:{permission:!0}}}}}})))for(let a of e.role.permissions)if(a.permission.key===c)return!0;return!1}catch(b){return console.error(`Error checking permission ${c} for user ${a}:`,b),!1}}function l(a){return a instanceof g||a instanceof h?{error:a.message,code:a.code,status:403,success:!1}:a instanceof i?{error:a.message,code:a.code,status:404,success:!1}:(console.error("Unknown authorization error:",a),{error:"Authorization failed",code:"AUTHORIZATION_ERROR",status:500,success:!1})}a.s(["handleAuthorizationError",()=>l,"hasPermissionWithoutRoleBypass",()=>k,"requirePermission",()=>j],57693)},126695,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(541265);async function e(a){console.log("[ActivityLogger] ====== START LOGGING ======"),console.log("[ActivityLogger] Received params:",JSON.stringify(a,null,2));try{let b=function a(b){let c={...b};for(let a of["password","passwordHash","password_hash","token","secret","apiKey","api_key","accessToken","refreshToken"])a in c&&(c[a]="[REDACTED]");for(let b in c)"object"!=typeof c[b]||null===c[b]||Array.isArray(c[b])||(c[b]=a(c[b]));return c}(a.actionDetails||{});console.log("[ActivityLogger] Sanitized details:",JSON.stringify(b,null,2)),console.log("[ActivityLogger] Logging activity:",{actionType:a.actionType,actionCategory:a.actionCategory,actionSummary:a.actionSummary,performedById:a.performedById});try{let d=await c.prisma.activityLog.create({data:{actionType:a.actionType,actionCategory:a.actionCategory,actionSummary:a.actionSummary,actionDetails:Object.keys(b).length>0?JSON.stringify(b):null,performedById:a.performedById,affectedUserId:a.affectedUserId||null,projectId:a.projectId||null,entityType:a.entityType||null,entityId:a.entityId||null,ipAddress:a.ipAddress||await f(),userAgent:a.userAgent||await g(),action:a.actionType,description:a.actionSummary,userId:a.performedById}});console.log("[ActivityLogger] âœ… Successfully logged activity with ID:",d.id),console.log("[ActivityLogger] ====== END LOGGING (SUCCESS) ======");return}catch(b){if(console.error("[ActivityLogger] âŒ Schema error occurred:"),console.error("[ActivityLogger] Error message:",b.message),console.error("[ActivityLogger] Error code:",b.code),console.error("[ActivityLogger] Error meta:",JSON.stringify(b.meta,null,2)),b.message?.includes("no such column")||"P2003"===b.code||"P2011"===b.code){console.warn("[ActivityLogger] New columns not found, using legacy schema. Please run migration."),await c.prisma.$executeRawUnsafe(`
          INSERT INTO activity_logs (action, description, entity_type, entity_id, ip_address, user_id, created_at)
          VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
        `,a.actionType,a.actionSummary,a.entityType||null,a.entityId||null,a.ipAddress||await f()||null,a.performedById),console.log("[ActivityLogger] âœ… Logged using legacy schema"),console.log("[ActivityLogger] ====== END LOGGING (LEGACY) ======");return}throw console.error("[ActivityLogger] âŒ Unknown schema error, rethrowing"),b}}catch(a){console.error("[ActivityLogger] âŒâŒâŒ CRITICAL ERROR - Failed to log activity âŒâŒâŒ"),console.error("[ActivityLogger] Error message:",a?.message||a),console.error("[ActivityLogger] Error code:",a?.code),console.error("[ActivityLogger] Error meta:",JSON.stringify(a?.meta,null,2)),console.error("[ActivityLogger] Error stack:",a?.stack),console.error("[ActivityLogger] ====== END LOGGING (ERROR) ======")}}async function f(){try{let a=await (0,d.headers)(),b=a.get("x-forwarded-for"),c=a.get("x-real-ip");if(b)return b.split(",")[0].trim();if(c)return c;return null}catch{return null}}async function g(){try{return(await (0,d.headers)()).get("user-agent")||null}catch{return null}}(0,a.i(287907).ensureServerEntryExports)([e]),(0,b.registerServerReference)(e,"40daa1d9c7314de4957a7669434db12aaa24630ba4",null),a.s(["logActivity",()=>e])},766050,a=>{"use strict";let b={USER:{CREATE:"user.create",READ:"user.read",UPDATE:"user.update",DELETE:"user.delete",ASSIGN_ROLE:"user.assign_role",ACTIVATE:"user.activate",DEACTIVATE:"user.deactivate"},TEAM:{CREATE:"team.create",READ:"team.read",UPDATE:"team.update",DELETE:"team.delete",ADD_MEMBER:"team.add_member",REMOVE_MEMBER:"team.remove_member",ASSIGN_PROJECT:"team.assign_project",REMOVE_PROJECT:"team.remove_project"},PROJECT:{CREATE:"project.create",READ:"project.read",UPDATE:"project.update",DELETE:"project.delete",ASSIGN_TEAM:"project.assign_team",REMOVE_TEAM:"project.remove_team",MANAGE_SETTINGS:"project.manage_settings"},TASK:{CREATE:"task.create",READ:"task.read",UPDATE:"task.update",DELETE:"task.delete",ASSIGN:"task.assign",CHANGE_STATUS:"task.change_status",CHANGE_PRIORITY:"task.change_priority"},DEPENDENCY:{CREATE:"dependency.create",READ:"dependency.read",UPDATE:"dependency.update",DELETE:"dependency.delete",MANUAL_UNBLOCK:"dependency.manual_unblock"},TODAY_TASK:{ASSIGN:"today_task.assign",REMOVE:"today_task.remove",REORDER:"today_task.reorder",VIEW_ALL:"today_task.view_all"},SETTINGS:{GLOBAL_READ:"settings.global.read",GLOBAL_EDIT:"settings.global.edit",PROJECT_READ:"settings.project.read",PROJECT_EDIT:"settings.project.edit",USER_READ:"settings.user.read",USER_EDIT:"settings.user.edit",PROJECT_TYPE_MANAGE:"settings.project_type.manage",PROJECT_STATUS_MANAGE:"settings.project_status.manage",TASK_STATUS_MANAGE:"settings.task_status.manage"},NOTIFICATION:{VIEW:"notification.view",MANAGE:"notification.manage",CONFIGURE:"notification.configure"},LOG:{VIEW:"log.view",EXPORT:"log.export",VIEW_DETAILS:"log.view_details"},ROLE:{CREATE:"role.create",READ:"role.read",UPDATE:"role.update",DELETE:"role.delete",ASSIGN:"role.assign",MANAGE_PERMISSIONS:"role.manage_permissions"},REPORT:{VIEW:"report.view",EXPORT:"report.export",GENERATE:"report.generate"}},c={SYSTEM_ADMIN:{name:"System Admin",description:"Full system access with all permissions",isSystemRole:!0,permissions:Object.values(b).flatMap(a=>Object.values(a))},PROJECT_MANAGER:{name:"Project Manager",description:"Manage projects, tasks, teams, and dependencies",isSystemRole:!0,permissions:[...Object.values(b.PROJECT),...Object.values(b.TASK),...Object.values(b.DEPENDENCY),b.TEAM.READ,b.TEAM.UPDATE,b.TEAM.ADD_MEMBER,b.TEAM.REMOVE_MEMBER,b.TEAM.ASSIGN_PROJECT,b.TEAM.REMOVE_PROJECT,...Object.values(b.TODAY_TASK),b.SETTINGS.PROJECT_READ,b.SETTINGS.PROJECT_EDIT,b.SETTINGS.PROJECT_TYPE_MANAGE,b.SETTINGS.PROJECT_STATUS_MANAGE,b.SETTINGS.TASK_STATUS_MANAGE,b.NOTIFICATION.VIEW,b.NOTIFICATION.MANAGE,b.LOG.VIEW,b.LOG.VIEW_DETAILS,b.USER.READ,b.REPORT.VIEW,b.REPORT.EXPORT,b.REPORT.GENERATE]},TEAM_LEAD:{name:"Team Lead",description:"Manage team tasks, dependencies, and team members",isSystemRole:!0,permissions:[b.PROJECT.READ,...Object.values(b.TASK),...Object.values(b.DEPENDENCY),b.TEAM.READ,b.TEAM.UPDATE,b.TEAM.ADD_MEMBER,b.TEAM.REMOVE_MEMBER,...Object.values(b.TODAY_TASK),b.SETTINGS.PROJECT_READ,b.NOTIFICATION.VIEW,b.LOG.VIEW,b.LOG.VIEW_DETAILS,b.USER.READ,b.REPORT.VIEW]},DEVELOPER:{name:"Developer",description:"Basic task management and updates",isSystemRole:!0,permissions:[b.PROJECT.READ,b.TASK.READ,b.TASK.UPDATE,b.TASK.CHANGE_STATUS,b.TASK.CHANGE_PRIORITY,b.DEPENDENCY.READ,...Object.values(b.TODAY_TASK),b.NOTIFICATION.VIEW,b.LOG.VIEW]}};function d(){return Object.values(b).flatMap(a=>Object.values(a))}a.s(["DEFAULT_ROLES",0,c,"PERMISSIONS",0,b,"getAllPermissions",()=>d])},194893,407716,555163,a=>{"use strict";let b=Symbol.for("constructDateFrom");function c(a,c){return"function"==typeof a?a(c):a&&"object"==typeof a&&b in a?a[b](c):a instanceof Date?new a.constructor(c):new Date(c)}function d(a,b){return c(b||a,a)}a.s(["constructFromSymbol",0,b,"millisecondsInDay",0,864e5,"millisecondsInHour",0,36e5,"millisecondsInWeek",0,6048e5,"minutesInDay",0,1440,"minutesInMonth",0,43200],407716),a.s(["constructFrom",()=>c],555163),a.s(["toDate",()=>d],194893)},114678,a=>{"use strict";var b=a.i(194893);function c(a,c){let d=(0,b.toDate)(a,c?.in);return d.setHours(0,0,0,0),d}a.s(["startOfDay",()=>c])},416219,a=>{"use strict";var b=a.i(194893);function c(a,c){let d=(0,b.toDate)(a,c?.in);return d.setHours(23,59,59,999),d}a.s(["endOfDay",()=>c])},285839,443585,a=>{"use strict";var b=a.i(555163),c=a.i(194893);function d(a,d,e){let f=(0,c.toDate)(a,e?.in);return isNaN(d)?(0,b.constructFrom)(e?.in||a,NaN):(d&&f.setDate(f.getDate()+d),f)}function e(a,b,c){return d(a,-b,c)}a.s(["addDays",()=>d],443585),a.s(["subDays",()=>e],285839)},263919,a=>{"use strict";var b=a.i(347656),c=a.i(114678),d=a.i(285839),e=a.i(443585);async function f(a,d,e,f){let g=(0,c.startOfDay)(new Date),h=await b.prisma.statSnapshot.findFirst({where:{entityType:a,entityId:d,metricKey:e,date:g}});h?h.value!==f&&await b.prisma.statSnapshot.update({where:{id:h.id},data:{value:f}}):await b.prisma.statSnapshot.create({data:{entityType:a,entityId:d,metricKey:e,value:f,date:g}})}async function g(a,i,j,k,l="daily"){let m,n=(0,c.startOfDay)(new Date);if("daily"===l)m=(0,d.subDays)(n,1);else m=(0,e.addDays)(n,-7,void 0);await f(a,i,j,k);let o=await b.prisma.statSnapshot.findFirst({where:{entityType:a,entityId:i,metricKey:j,date:m}});if(!o){let c=await b.prisma.statSnapshot.findFirst({where:{entityType:a,entityId:i,metricKey:j,date:{lt:n}},orderBy:{date:"desc"}});return c?h(k,c.value):null}return h(k,o.value)}function h(a,b){if(0===b)return{direction:a>0?"up":"neutral",value:a,percentage:100*(a>0)};let c=a-b,d=Math.round(c/b*100),e="neutral";return c>0&&(e="up"),c<0&&(e="down"),{direction:e,value:Math.abs(c),percentage:Math.abs(d)}}a.s(["getStatTrend",()=>g],263919)},590187,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(449597),g=a.i(126695),h=a.i(153544),i=a.i(661698),j=a.i(57693),k=a.i(287907);let l=i.z.object({projectId:i.z.coerce.number(),reason:i.z.string().min(10,"Reason must be at least 10 characters")});async function m(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};let i=a.get("projectId"),k=a.get("reason"),m=l.safeParse({projectId:i,reason:k});if(!m.success)return{error:"Validation failed",details:m.error.format()};try{let a=await c.prisma.project.findUnique({where:{id:m.data.projectId},include:{projectManager:!0,projectUsers:!0,projectTeams:{include:{team:{include:{teamLead:!0,members:!0}}}}}});if(!a)return{error:"Project not found"};let d=parseInt(b.user.id),e=await (0,j.hasPermissionWithoutRoleBypass)(d,"project.markUrgent",m.data.projectId),i=a.projectManagerId===d||a.createdById===d;if(!e&&!i)return{error:"Unauthorized: You don't have permission to mark this project as urgent"};let k=await c.prisma.project.update({where:{id:m.data.projectId},data:{priority:"urgent",urgentReason:m.data.reason,urgentMarkedAt:new Date,urgentMarkedById:d},include:{projectManager:!0,projectUsers:{select:{userId:!0}},projectTeams:{include:{team:{select:{teamLeadId:!0,members:{select:{userId:!0}}}}}}}}),l=new Set;k.projectManagerId&&l.add(k.projectManagerId),k.projectUsers.forEach(a=>{l.add(a.userId)}),k.projectTeams.forEach(a=>{a.team.teamLeadId&&l.add(a.team.teamLeadId),a.team.members.forEach(a=>{l.add(a.userId)})}),(await c.prisma.user.findMany({where:{role:"admin"},select:{id:!0}})).forEach(a=>l.add(a.id));let n=Array.from(l).map(a=>(0,h.createProjectNotification)(m.data.projectId,a,{type:"project_urgent",entityType:"project",entityId:m.data.projectId,title:`ðŸš¨ URGENT: ${k.name}`,message:`This project has been marked as URGENT. Reason: ${m.data.reason}`,soundRequired:!0,isUrgent:!0,requiresAcknowledgment:!0}));return await Promise.all(n),await (0,g.logActivity)({actionType:"project_marked_urgent",actionCategory:"project",actionSummary:`Project "${k.name}" marked as URGENT`,actionDetails:{projectId:k.id,projectName:k.name,reason:m.data.reason,notifiedUsers:Array.from(l).length},performedById:d,projectId:m.data.projectId,entityType:"project",entityId:m.data.projectId}),(0,f.revalidatePath)(`/dashboard/projects/${m.data.projectId}`),(0,f.revalidatePath)("/dashboard"),(0,f.revalidatePath)("/dashboard/projects"),{success:!0,project:k}}catch(a){return console.error("Error marking project as urgent:",a),{error:"Failed to mark project as urgent",details:a.message}}}async function n(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};let h=parseInt(b.user.id);try{let b=await c.prisma.project.findUnique({where:{id:a}});if(!b)return{error:"Project not found"};if("urgent"!==b.priority)return{error:"Project is not marked as urgent"};return await c.prisma.urgentProjectAcknowledgement.upsert({where:{projectId_userId:{projectId:a,userId:h}},create:{projectId:a,userId:h},update:{acknowledgedAt:new Date}}),await c.prisma.projectNotification.updateMany({where:{projectId:a,userId:h,isUrgent:!0,requiresAcknowledgment:!0},data:{acknowledgedAt:new Date,isRead:!0}}),await (0,g.logActivity)({actionType:"project_urgent_acknowledged",actionCategory:"project",actionSummary:`Acknowledged urgent project "${b.name}"`,actionDetails:{projectId:b.id,projectName:b.name},performedById:h,projectId:a,entityType:"project",entityId:a}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)("/dashboard"),{success:!0}}catch(a){return console.error("Error acknowledging urgent project:",a),{error:"Failed to acknowledge urgent project",details:a.message}}}async function o(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return{error:"Unauthorized"};let h=parseInt(b.user.id);try{let b=await c.prisma.project.findUnique({where:{id:a}});if(!b)return{error:"Project not found"};let d=await (0,j.hasPermissionWithoutRoleBypass)(h,"project.removeUrgent",a),e=b.projectManagerId===h||b.createdById===h;if(!d&&!e)return{error:"Unauthorized: You don't have permission to remove urgent priority from this project"};return await c.prisma.project.update({where:{id:a},data:{priority:"normal",urgentReason:null,urgentMarkedAt:null,urgentMarkedById:null}}),await c.prisma.projectNotification.updateMany({where:{projectId:a,isUrgent:!0},data:{isRead:!0,acknowledgedAt:new Date}}),await (0,g.logActivity)({actionType:"project_urgent_removed",actionCategory:"project",actionSummary:`Removed urgent priority from project "${b.name}"`,actionDetails:{projectId:b.id,projectName:b.name},performedById:h,projectId:a,entityType:"project",entityId:a}),(0,f.revalidatePath)(`/dashboard/projects/${a}`),(0,f.revalidatePath)("/dashboard"),(0,f.revalidatePath)("/dashboard/projects"),{success:!0}}catch(a){return console.error("Error removing urgent priority:",a),{error:"Failed to remove urgent priority",details:a.message}}}async function p(){let a=await (0,d.getServerSession)(e.authOptions);if(!a)return{error:"Unauthorized"};let b=parseInt(a.user.id),f=a.user.role||"developer";try{let a={priority:"urgent"};"admin"!==f&&(a.OR=[{projectManagerId:b},{createdById:b},{projectUsers:{some:{userId:b}}},{projectTeams:{some:{team:{teamLeadId:b}}}},{projectTeams:{some:{team:{members:{some:{userId:b}}}}}}]);let d=await c.prisma.project.findMany({where:a,include:{projectManager:{select:{id:!0,username:!0,avatarUrl:!0}},urgentMarkedBy:{select:{id:!0,username:!0}},urgentAcknowledgments:{where:{userId:b},select:{acknowledgedAt:!0}}},orderBy:{urgentMarkedAt:"desc"}});return{success:!0,projects:d}}catch(a){return console.error("Error fetching urgent projects:",a),{error:"Failed to fetch urgent projects",details:a.message}}}async function q(a){let b=await (0,d.getServerSession)(e.authOptions);if(!b)return!1;let f=parseInt(b.user.id);try{return!!await c.prisma.urgentProjectAcknowledgement.findUnique({where:{projectId_userId:{projectId:a,userId:f}}})}catch(a){return console.error("Error checking acknowledgment:",a),!1}}(0,k.ensureServerEntryExports)([m,n,o,p,q]),(0,b.registerServerReference)(m,"409f63a3c373c5a1d91cbdece6bed64e7ad1bb9de3",null),(0,b.registerServerReference)(n,"40271b869aa95cc70186c7d92a799fd4ff185374b6",null),(0,b.registerServerReference)(o,"40a1ef9e59469b9018d9dca101e2d6830cd362dfa4",null),(0,b.registerServerReference)(p,"002d971c7f5a3882ee40ebedc20527bd73b0bb1658",null),(0,b.registerServerReference)(q,"406dc0bd8d7e9cdb49e1d05a07a97ade94458c58d0",null),a.s(["acknowledgeUrgentProject",()=>n,"getUrgentProjects",()=>p,"hasAcknowledgedUrgent",()=>q,"markProjectUrgent",()=>m,"removeUrgentPriority",()=>o])},301161,a=>{"use strict";var b=a.i(184251),c=a.i(347656),d=a.i(450246),e=a.i(915929),f=a.i(114678),g=a.i(416219),h=a.i(263919),i=a.i(449597),j=a.i(287907);async function k(a,b){let d,e,i,j,k=(0,f.startOfDay)(new Date),l=(0,g.endOfDay)(new Date),[m,n]=await Promise.all([c.prisma.projectStatus?.findMany({where:{isActive:!0},orderBy:{orderIndex:"asc"},select:{id:!0,name:!0,color:!0}}).catch(()=>[]),c.prisma.taskStatus?.findMany({where:{isActive:!0},orderBy:{orderIndex:"asc"},select:{id:!0,name:!0,color:!0,isBlocking:!0,isFinal:!0}}).catch(()=>[])]),o=m||[],p=n||[],q=p.find(a=>a.isBlocking),r=q?.id,s=p.find(a=>a.isFinal),t=s?.id,u=b?{}:{OR:[{projectManagerId:a},{createdById:a},{projectUsers:{some:{userId:a}}}]},v={};if(o.length>0)for(let a of(await c.prisma.project.groupBy({by:["projectStatusId"],where:{...u,projectStatusId:{in:o.map(a=>a.id)}},_count:{id:!0}})))a.projectStatusId&&(v[a.projectStatusId]=a._count.id);let w=await c.prisma.project.count({where:{...u,status:"active",projectStatusId:null}}),x=await c.prisma.project.count({where:{...u,status:"on_hold",projectStatusId:null}}),y=b?{}:{project:{OR:[{projectManagerId:a},{createdById:a},{projectUsers:{some:{userId:a}}}]}},z={};if(p.length>0)for(let a of(await c.prisma.task.groupBy({by:["taskStatusId"],where:{...y,taskStatusId:{in:p.map(a=>a.id)}},_count:{id:!0}})))a.taskStatusId&&(z[a.taskStatusId]=a._count.id);let[A,B,C,D,E,F,G,H]=await Promise.all([c.prisma.project.count({where:u}),c.prisma.task.count({where:b?{}:{project:{OR:[{projectManagerId:a},{createdById:a},{projectUsers:{some:{userId:a}}}]}}}),c.prisma.task.count({where:{assignees:{some:{id:a}}}}),c.prisma.task.count({where:{OR:(d=[],r&&d.push({taskStatusId:r}),d.push({status:"waiting",taskStatusId:null}),d),...b?{}:{project:{OR:[{projectManagerId:a},{createdById:a},{projectUsers:{some:{userId:a}}}]}}}}),c.prisma.task.count({where:{dueDate:{lt:new Date},OR:(e=[],t&&e.push({taskStatusId:{not:t}}),e.push({status:{not:"completed"},taskStatusId:null}),e),...b?{}:{OR:[{assignees:{some:{id:a}}},{project:{OR:[{projectManagerId:a},{createdById:a}]}}]}}}),c.prisma.task.count({where:{assignees:{some:{id:a}},plannedDate:{gte:k,lte:l},OR:(i=[],t&&i.push({taskStatusId:{not:t}}),i.push({status:{not:"completed"},taskStatusId:null}),i)}}),c.prisma.task.count({where:{assignees:{some:{id:a}},updatedAt:{gte:k,lte:l},OR:(j=[],t&&j.push({taskStatusId:t}),j.push({status:"completed",taskStatusId:null}),j)}}),c.prisma.activityLog.findMany({where:b?{}:{OR:[{performedById:a},{affectedUserId:a},{project:{OR:[{projectManagerId:a},{createdById:a},{projectUsers:{some:{userId:a}}}]}}]},select:{id:!0,actionType:!0,actionSummary:!0,actionDetails:!0,createdAt:!0,performedById:!0,projectId:!0,performedBy:{select:{id:!0,username:!0,avatarUrl:!0}},project:{select:{id:!0,name:!0}}},orderBy:{createdAt:"desc"},take:10})]),I=b?"global":"user_dashboard",J=b?null:a,[K,L,M,N,O,P,Q]=await Promise.all([(0,h.getStatTrend)(I,J,"total_projects",A),(0,h.getStatTrend)(I,J,"total_tasks",B),(0,h.getStatTrend)("user_dashboard",a,"my_tasks",C),(0,h.getStatTrend)(I,J,"blocked_tasks",D),(0,h.getStatTrend)(I,J,"overdue_tasks",E),(0,h.getStatTrend)("user_dashboard",a,"todays_tasks_total",F),(0,h.getStatTrend)("user_dashboard",a,"todays_tasks_completed",G)]);return{success:!0,projects:{total:A,trend:K,statusCounts:v,legacyActive:w,legacyOnHold:x},projectStatuses:o.map(a=>({id:a.id,name:a.name,color:a.color})),tasks:{total:B,trend:L,myTasks:C,myTasksTrend:M,blocked:D,blockedTrend:N,overdue:E,overdueTrend:O,statusCounts:z},taskStatuses:p.map(a=>({id:a.id,name:a.name,color:a.color,isBlocking:a.isBlocking,isFinal:a.isFinal})),todayTasks:{total:F,totalTrend:P,completed:G,completedTrend:Q},recentActivities:H}}let l=(0,i.unstable_cache)(k,["dashboard-summary"],{revalidate:60,tags:["dashboard"]});async function m(){let a=await (0,d.getServerSession)(e.authOptions);if(!a)return{error:"Unauthorized",success:!1};let b=parseInt(a.user.id),c=a.user.role||"developer";try{return await l(b,"admin"===c)}catch(a){return console.error("Error fetching dashboard summary:",a),{error:"Failed to fetch dashboard data",details:a.message,success:!1}}}async function n(a){let b=(0,f.startOfDay)(new Date),d=(0,g.endOfDay)(new Date);return{success:!0,tasks:await c.prisma.task.findMany({where:{assignees:{some:{id:a}},plannedDate:{gte:b,lte:d}},select:{id:!0,title:!0,description:!0,priority:!0,status:!0,dueDate:!0,plannedDate:!0,createdAt:!0,projectId:!0,project:{select:{id:!0,name:!0}},assignees:{select:{id:!0,username:!0,avatarUrl:!0}},dependencies:{select:{taskId:!0,dependsOnTaskId:!0,dependencyType:!0,dependsOnTask:{select:{id:!0,status:!0,title:!0}}}},_count:{select:{comments:!0,attachments:!0}}},orderBy:[{priority:"desc"},{createdAt:"asc"}]})}}let o=(0,i.unstable_cache)(n,["dashboard-focus-tasks"],{revalidate:60,tags:["dashboard","tasks"]});async function p(){let a=await (0,d.getServerSession)(e.authOptions);if(!a)return{error:"Unauthorized",success:!1};let b=parseInt(a.user.id);try{return await o(b)}catch(a){return console.error("Error fetching today's focus tasks:",a),{error:"Failed to fetch today's tasks",details:a.message,success:!1}}}(0,j.ensureServerEntryExports)([m,p]),(0,b.registerServerReference)(m,"0059cd3e195cf85d3e59a91eb54091d7bf4cbae302",null),(0,b.registerServerReference)(p,"0060f55b20101b46209916d322e57fe57b7697ebe9",null),a.s(["getDashboardSummary",()=>m,"getTodaysFocusTasks",()=>p])},897850,a=>{"use strict";var b=a.i(962460),c=a.i(153544),d=a.i(301161),e=a.i(6588),f=a.i(590187);a.s([],424107),a.i(424107),a.s(["002d971c7f5a3882ee40ebedc20527bd73b0bb1658",()=>f.getUrgentProjects,"0033db22356cbf8845a3517099b63dfc38d1147299",()=>b.getPublicSystemSettings,"0059cd3e195cf85d3e59a91eb54091d7bf4cbae302",()=>d.getDashboardSummary,"0060f55b20101b46209916d322e57fe57b7697ebe9",()=>d.getTodaysFocusTasks,"00686a7231b739e4fe9b8305b757bc0e83827b9865",()=>c.getAllProjectsUnreadNotificationCount,"4004a0aae390e2c1aeb900c79065f312ac43d90f8d",()=>c.getAllProjectsNotifications,"40271b869aa95cc70186c7d92a799fd4ff185374b6",()=>f.acknowledgeUrgentProject,"60691655a7ad6aec29ab9691d8571a0d380be93da1",()=>c.markProjectNotificationAsRead,"709a22b83fb95b514103e9a68c206c65a10f984982",()=>e.updateTaskStatus],897850)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__43e43e94._.js.map