{"version":3,"sources":["../../../../../../nxt/New%20folder/Project_Management_NXT/node_modules/next/src/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server.ts","../../../../../../nxt/New%20folder/Project_Management_NXT/node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../../../nxt/New%20folder/Project_Management_NXT/node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../../../nxt/New%20folder/Project_Management_NXT/src/lib/activity-logger.ts"],"sourcesContent":["module.exports = (\n  require('../../module.compiled') as typeof import('../../module.compiled')\n).vendored['react-rsc']!.ReactServerDOMTurbopackServer\n","/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","\"use server\"\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { headers } from \"next/headers\"\r\n\r\nexport type ActionCategory =\r\n  | \"auth\"\r\n  | \"project\"\r\n  | \"task\"\r\n  | \"dependency\"\r\n  | \"settings\"\r\n  | \"notification\"\r\n  | \"today_task\"\r\n\r\nexport type ActionType =\r\n  // Auth\r\n  | \"user_login\"\r\n  | \"user_logout\"\r\n  | \"login_failed\"\r\n  | \"role_changed\"\r\n  | \"user_activated\"\r\n  | \"user_suspended\"\r\n  // RBAC\r\n  | \"role_created\"\r\n  | \"role_updated\"\r\n  | \"role_deleted\"\r\n  | \"role_assigned\"\r\n  | \"role_removed\"\r\n  // Project\r\n  | \"project_created\"\r\n  | \"project_updated\"\r\n  | \"project_archived\"\r\n  | \"project_manager_changed\"\r\n  | \"team_member_added\"\r\n  | \"team_member_removed\"\r\n  | \"project_settings_changed\"\r\n  | \"project_marked_urgent\"\r\n  | \"project_urgent_acknowledged\"\r\n  | \"project_urgent_removed\"\r\n  | \"project_assigned_to_team\"\r\n  | \"project_removed_from_team\"\r\n  | \"file_uploaded\"\r\n  | \"file_downloaded\"\r\n  | \"file_deleted\"\r\n  // Team\r\n  | \"team_created\"\r\n  | \"team_updated\"\r\n  | \"team_deleted\"\r\n  // Task\r\n  | \"task_created\"\r\n  | \"task_updated\"\r\n  | \"task_deleted\"\r\n  | \"task_assigned\"\r\n  | \"task_reassigned\"\r\n  | \"task_status_changed\"\r\n  | \"task_status_updated\"\r\n  | \"task_priority_changed\"\r\n  | \"subtask_created\"\r\n  | \"subtask_updated\"\r\n  | \"subtask_completed\"\r\n  // Dependency\r\n  | \"dependency_added\"\r\n  | \"dependency_removed\"\r\n  | \"task_blocked\"\r\n  | \"task_unblocked\"\r\n  // Today's Tasks\r\n  | \"today_task_assigned\"\r\n  | \"today_task_modified\"\r\n  | \"today_task_removed\"\r\n  | \"auto_carryover_executed\"\r\n  // Settings\r\n  | \"global_settings_updated\"\r\n  | \"project_settings_updated\"\r\n  | \"user_settings_updated\"\r\n  | \"project_type_created\"\r\n  | \"project_type_updated\"\r\n  | \"project_type_deleted\"\r\n  | \"project_type_toggled\"\r\n  | \"project_status_created\"\r\n  | \"project_status_updated\"\r\n  | \"project_status_deleted\"\r\n  | \"project_status_toggled\"\r\n  | \"project_statuses_reordered\"\r\n  | \"task_status_created\"\r\n  | \"task_status_updated\"\r\n  | \"task_status_deleted\"\r\n  | \"task_status_toggled\"\r\n  | \"task_statuses_reordered\"\r\n  // Notifications\r\n  | \"notification_settings_changed\"\r\n  | \"admin_override_executed\"\r\n  | \"manual_unblock\"\r\n\r\ninterface LogActivityParams {\r\n  actionType: ActionType\r\n  actionCategory: ActionCategory\r\n  actionSummary: string\r\n  actionDetails?: Record<string, any>\r\n  performedById: number\r\n  affectedUserId?: number\r\n  projectId?: number\r\n  entityType?: string\r\n  entityId?: number\r\n  ipAddress?: string\r\n  userAgent?: string\r\n}\r\n\r\n/**\r\n * Log an activity to the activity log\r\n * This function should be called after any important action\r\n */\r\nexport async function logActivity(params: LogActivityParams): Promise<void> {\r\n  console.log(\"[ActivityLogger] ====== START LOGGING ======\")\r\n  console.log(\"[ActivityLogger] Received params:\", JSON.stringify(params, null, 2))\r\n\r\n  try {\r\n    // Sanitize actionDetails to remove sensitive information\r\n    const sanitizedDetails = sanitizeActionDetails(params.actionDetails || {})\r\n\r\n    console.log(\"[ActivityLogger] Sanitized details:\", JSON.stringify(sanitizedDetails, null, 2))\r\n    console.log(\"[ActivityLogger] Logging activity:\", {\r\n      actionType: params.actionType,\r\n      actionCategory: params.actionCategory,\r\n      actionSummary: params.actionSummary,\r\n      performedById: params.performedById,\r\n    })\r\n\r\n    // Try to create with new schema first\r\n    try {\r\n      const result = await prisma.activityLog.create({\r\n        data: {\r\n          actionType: params.actionType,\r\n          actionCategory: params.actionCategory,\r\n          actionSummary: params.actionSummary,\r\n          actionDetails: Object.keys(sanitizedDetails).length > 0\r\n            ? JSON.stringify(sanitizedDetails)\r\n            : null,\r\n          performedById: params.performedById,\r\n          affectedUserId: params.affectedUserId || null,\r\n          projectId: params.projectId || null,\r\n          entityType: params.entityType || null,\r\n          entityId: params.entityId || null,\r\n          ipAddress: params.ipAddress || await getClientIP(),\r\n          userAgent: params.userAgent || await getUserAgent(),\r\n          // Legacy fields (required by database)\r\n          action: params.actionType, // Map actionType to legacy action field\r\n          description: params.actionSummary, // Map actionSummary to legacy description field\r\n          userId: params.performedById, // Map performedById to legacy userId field\r\n        },\r\n      })\r\n      console.log(\"[ActivityLogger] ✅ Successfully logged activity with ID:\", result.id)\r\n      console.log(\"[ActivityLogger] ====== END LOGGING (SUCCESS) ======\")\r\n      return\r\n    } catch (schemaError: any) {\r\n      console.error(\"[ActivityLogger] ❌ Schema error occurred:\")\r\n      console.error(\"[ActivityLogger] Error message:\", schemaError.message)\r\n      console.error(\"[ActivityLogger] Error code:\", schemaError.code)\r\n      console.error(\"[ActivityLogger] Error meta:\", JSON.stringify(schemaError.meta, null, 2))\r\n      // If new columns don't exist, fall back to old schema\r\n      if (schemaError.message?.includes('no such column') || schemaError.code === 'P2003' || schemaError.code === 'P2011') {\r\n        console.warn(\"[ActivityLogger] New columns not found, using legacy schema. Please run migration.\")\r\n        await prisma.$executeRawUnsafe(`\r\n          INSERT INTO activity_logs (action, description, entity_type, entity_id, ip_address, user_id, created_at)\r\n          VALUES (?, ?, ?, ?, ?, ?, datetime('now'))\r\n        `,\r\n          params.actionType,\r\n          params.actionSummary,\r\n          params.entityType || null,\r\n          params.entityId || null,\r\n          params.ipAddress || await getClientIP() || null,\r\n          params.performedById\r\n        )\r\n        console.log(\"[ActivityLogger] ✅ Logged using legacy schema\")\r\n        console.log(\"[ActivityLogger] ====== END LOGGING (LEGACY) ======\")\r\n        return\r\n      } else {\r\n        console.error(\"[ActivityLogger] ❌ Unknown schema error, rethrowing\")\r\n        throw schemaError\r\n      }\r\n    }\r\n  } catch (error: any) {\r\n    // Log errors but don't throw - activity logging should never break the main flow\r\n    console.error(\"[ActivityLogger] ❌❌❌ CRITICAL ERROR - Failed to log activity ❌❌❌\")\r\n    console.error(\"[ActivityLogger] Error message:\", error?.message || error)\r\n    console.error(\"[ActivityLogger] Error code:\", error?.code)\r\n    console.error(\"[ActivityLogger] Error meta:\", JSON.stringify(error?.meta, null, 2))\r\n    console.error(\"[ActivityLogger] Error stack:\", error?.stack)\r\n    console.error(\"[ActivityLogger] ====== END LOGGING (ERROR) ======\")\r\n  }\r\n}\r\n\r\n/**\r\n * Sanitize action details to remove sensitive information\r\n */\r\nfunction sanitizeActionDetails(details: Record<string, any>): Record<string, any> {\r\n  const sensitiveKeys = [\r\n    'password',\r\n    'passwordHash',\r\n    'password_hash',\r\n    'token',\r\n    'secret',\r\n    'apiKey',\r\n    'api_key',\r\n    'accessToken',\r\n    'refreshToken',\r\n  ]\r\n\r\n  const sanitized = { ...details }\r\n\r\n  for (const key of sensitiveKeys) {\r\n    if (key in sanitized) {\r\n      sanitized[key] = '[REDACTED]'\r\n    }\r\n  }\r\n\r\n  // Recursively sanitize nested objects\r\n  for (const key in sanitized) {\r\n    if (typeof sanitized[key] === 'object' && sanitized[key] !== null && !Array.isArray(sanitized[key])) {\r\n      sanitized[key] = sanitizeActionDetails(sanitized[key])\r\n    }\r\n  }\r\n\r\n  return sanitized\r\n}\r\n\r\n/**\r\n * Get client IP address from headers\r\n */\r\nasync function getClientIP(): Promise<string | null> {\r\n  try {\r\n    const headersList = await headers()\r\n    const forwarded = headersList.get('x-forwarded-for')\r\n    const realIP = headersList.get('x-real-ip')\r\n\r\n    if (forwarded) {\r\n      return forwarded.split(',')[0].trim()\r\n    }\r\n    if (realIP) {\r\n      return realIP\r\n    }\r\n    return null\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * Get user agent from headers\r\n */\r\nasync function getUserAgent(): Promise<string | null> {\r\n  try {\r\n    const headersList = await headers()\r\n    return headersList.get('user-agent') || null\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\n"],"names":["module","exports","require","vendored","ReactServerDOMTurbopackServer","registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"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","ignoreList":[0,1,2]}